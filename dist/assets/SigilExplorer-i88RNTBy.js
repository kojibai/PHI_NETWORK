import{$t as e,Bt as t,C as n,Cn as r,Dn as i,En as a,Gn as o,Gt as s,H as c,Ht as l,Jt as u,Kt as d,On as f,Qr as p,Qt as m,S as h,Sn as g,Tn as _,Ut as v,Vt as y,Wt as b,Xn as ee,Xt as te,Yt as x,Zt as S,_n as C,_r as w,an as T,b as E,bn as ne,cn as D,dn as O,en as re,fn as ie,gn as ae,hn as k,in as A,kn as oe,ln as j,mn as M,nn as se,on as ce,pi as le,pn as ue,qn as de,qt as fe,rn as N,si as P,sn as F,tn as pe,un as I,vn as L,wn as me,x as he,xn as ge,yn as _e,zt as ve}from"./index-DG4ihHt7.js";var R=le(P(),1);const ye={root:`#ff3b3b`,sacral:`#ff8a3d`,solar:`#ffd54a`,heart:`#3dff9a`,throat:`#46d3ff`,thirdEye:`#6b6cff`,crown:`#c18bff`};function be(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`root`)?`root`:t.includes(`sacral`)?`sacral`:t.includes(`solar`)||t.includes(`plexus`)||t.includes(`sun`)?`solar`:t.includes(`heart`)?`heart`:t.includes(`throat`)?`throat`:t.includes(`third`)||t.includes(`eye`)||t.includes(`indigo`)?`thirdEye`:t.includes(`crown`)||t.includes(`krown`)||t.includes(`violet`)?`crown`:t===`1`?`root`:t===`2`?`sacral`:t===`3`?`solar`:t===`4`?`heart`:t===`5`?`throat`:t===`6`?`thirdEye`:t===`7`?`crown`:null:null}function xe(e){let t=be(e),n=t?ye[t]:`var(--sx-accent)`;return{"--sx-chakra":n}}function z(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function B(e){if(typeof e==`number`)return!Number.isFinite(e)||Math.abs(e)<1e-12?void 0:Math.abs(e);if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&Math.abs(t)>=1e-12)return Math.abs(t)}}function V(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`receive`)||t.includes(`received`)||t.includes(`inhale`)?`receive`:t.includes(`send`)||t.includes(`sent`)||t.includes(`exhale`)?`send`:null:null}function H(e){if(typeof e==`number`)return!Number.isFinite(e)||e<=0?void 0:e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function U(e){if(typeof e==`number`&&Number.isFinite(e)&&e>0)return e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function W(e){let t=e,n=z(t.feed)?t.feed:null,r=e=>e?V(e.phiDirection)||V(e.transferDirection)||V(e.transferMode)||V(e.transferKind):null,i=e=>{if(e)return e.phiDelta??e.phiSigned??e.phiChange},a=e=>e?B(e.transferAmountPhi)??B(e.transferPhi)??B(e.amountPhi)??B(e.phiAmount)??B(e.childAllocationPhi)??B(e.branchBasePhi):void 0,o=e=>e?H(e.amountUsd)??H(e.usdAmount)??H(e.usdValue)??H(e.valueUsd)??H(e.usd):void 0,s=e=>e?H(e.usdPerPhi)??H(e.fxUsdPerPhi)??H(e.usd_per_phi):void 0,c=e=>e?U(e.atPulse)??U(e.sentPulse)??U(e.senderKaiPulse)??U(e.transferPulse):void 0,l=r(t)??r(n),u=i(t)??i(n),d=typeof u==`number`?u:void 0;d===void 0&&typeof u==`string`&&(d=Number(u));let f=l??(typeof d==`number`&&Number.isFinite(d)?d>=0?`receive`:`send`:null);if(!f)return;let p=a(t)??a(n)??(z(t.preview)?B(t.preview.amountPhi):void 0)??(z(n?.preview)?B(n.preview.amountPhi):void 0)??(typeof d==`number`&&Number.isFinite(d)?Math.abs(d):void 0);if(p===void 0)return;let m=o(t)??o(n)??(z(t.preview)?H(t.preview.amountUsd):void 0)??(z(n?.preview)?H(n.preview.amountUsd):void 0),h=s(t)??s(n)??(z(t.preview)?H(t.preview.usdPerPhi):void 0)??(z(n?.preview)?H(n.preview.usdPerPhi):void 0),g=c(t)??c(n)??(z(t.preview)?U(t.preview.atPulse):void 0)??(z(n?.preview)?U(n.preview.atPulse):void 0);return{direction:f,amount:p,amountUsd:m??(h===void 0?void 0:p*h),sentPulse:g,source:`payload`}}function G(e){for(let t of[`transferUrl`,`transferURL`,`transferLink`,`transfer_link`,`sealUrl`,`sealURL`,`sigilTransferUrl`]){let n=e[t];if(typeof n!=`string`||!n.trim())continue;let r=ue(n.trim());if(!r)continue;let i=W(r);if(i)return i}}function Se(e,t){if(!e)return;let n=t.get(e.toLowerCase());if(!n)return;let r=B(n.amountPhi);if(r!==void 0)return{direction:n.direction,amount:r,amountUsd:H(n.amountUsd),sentPulse:U(n.sentPulse),source:`registry`}}function Ce(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function we(e,t){if(!Ce(e))return;let n=e[t];return typeof n==`string`&&n.trim().length>0?n.trim():void 0}function Te(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`receive`)||t.includes(`received`)||t.includes(`inhale`)?`receive`:t.includes(`send`)||t.includes(`sent`)||t.includes(`exhale`)?`send`:null:null}function Ee(e){let t=e,n=Ce(t.feed)?t.feed:null,r=e=>e?Te(e.transferDirection)||Te(e.transferMode)||Te(e.transferKind)||Te(e.phiDirection):null,i=!!(r(t)??r(n)),a=!!(typeof t.transferNonce==`string`||typeof t.nonce==`string`||typeof t.transferToken==`string`||typeof t.token==`string`||n&&(typeof n.transferNonce==`string`||typeof n.nonce==`string`||typeof n.transferToken==`string`||typeof n.token==`string`)),o=!!(typeof t.parentUrl==`string`||typeof t.parentHash==`string`||typeof t.parentCanonical==`string`||n&&(typeof n.parentUrl==`string`||typeof n.parentHash==`string`||typeof n.parentCanonical==`string`));return i||a||o}function De(e){return e.kind!==`post`||!C(e.primaryUrl)||W(e.payload)?!1:!Ee(e.payload)}function Oe(e){let t=new Map,n=new Map;for(let[r,i]of e){let e=j(r),a=O(e),o=I(e,i),s=ae(e,i);t.set(e,o);let c=n.get(o);if(!c){n.set(o,{payload:i,urls:new Set([e]),kind:a,momentKey:s});continue}N(i,c.payload)>0&&(c.payload=i),c.urls.add(e);let l=c.momentKey,u=s;l.startsWith(`u:`)&&!u.startsWith(`u:`)&&(c.momentKey=u),l.startsWith(`h:`)&&(u.startsWith(`k:`)||u.startsWith(`sig:`)||u.startsWith(`tok:`))&&(c.momentKey=u)}let r=new Map;for(let[e,t]of n){let n=L(Array.from(t.urls),t.kind);r.set(e,{id:e,payload:t.payload,urls:t.urls,primaryUrl:n,kind:t.kind,momentKey:t.momentKey})}let i=new Map;for(let e of r.values()){let t=e.momentKey;i.has(t)||i.set(t,[]),i.get(t).push(e.id)}let a=new Map,o=new Map,s=new Map,c=new Map;for(let e of r.values()){let t=C(e.primaryUrl);t&&!c.has(t)&&c.set(t,e.id)}for(let[e,t]of i){let n=t.map(e=>r.get(e)).filter(Boolean),i=n.filter(e=>e.kind===`post`),c;c=i.length>0?i.slice().sort((e,t)=>_e(t.primaryUrl,`post`)-_e(e.primaryUrl,`post`))[0]:n.slice().sort((e,t)=>_e(t.primaryUrl,t.kind)-_e(e.primaryUrl,e.kind))[0];let l=c?.id??t[0];a.set(e,l);for(let e of t)o.set(e,l);for(let e of t){let t=r.get(e);if(t)for(let e of t.urls)s.set(e,l)}}let l=new Map,u=new Map;for(let e of r.values()){if(!De(e))continue;let t=C(e.primaryUrl);t&&(u.has(t)||u.set(t,e.id))}for(let e of r.values()){let n=o.get(e.id)??e.id;if(e.id!==n)continue;let r=we(e.payload,`originUrl`),i=r?j(r):M(e.primaryUrl)??e.primaryUrl,a=C(i),d=t.get(i)??(a?c.get(a):void 0),f=(a?u.get(a):void 0)??d??s.get(i);l.set(n,f??n)}let d=new Map;for(let e of r.values()){let n=o.get(e.id)??e.id,r=l.get(n)??n,i,a=we(e.payload,`parentUrl`);if(a){let n=j(a),r=C(n),o=t.get(n)??(r?c.get(r):void 0)??s.get(n);o&&o!==e.id&&(i=o)}!i&&e.id!==n&&(i=n),d.set(e.id,{id:e.id,payload:e.payload,urls:e.urls,primaryUrl:e.primaryUrl,kind:e.kind,momentKey:e.momentKey,parentId:i,originId:r,momentParentId:n})}return d}function ke(e,t){let n=[];for(let[r,i]of t)i.parentId===e&&n.push(r);return n.sort((e,n)=>N(t.get(n).payload,t.get(e).payload)),n}function Ae(e,t,n=new Set){let r=t.get(e);if(!r)return null;if(n.has(e))return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:[]};n.add(e);let i=ke(e,t).map(e=>Ae(e,t,n)).filter(Boolean);return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:i}}function je(e){let t=0,n=e.payload,r=e=>{t+=1,N(e.payload,n)>0&&(n=e.payload),e.children.forEach(r)};return r(e),{nodeCount:t,latest:n}}function Me(e){let t=Oe(e),n=new Map;for(let[e,r]of t){let t=r.originId;n.has(t)||n.set(t,[]),n.get(t).push(e)}let r=[];for(let e of n.keys()){let n=Ae(e,t);if(!n)continue;let i=je(n);r.push({root:n,nodeCount:i.nodeCount,latest:i.latest})}return r.sort((e,t)=>{let n=N(t.latest,e.latest);return n===0?t.nodeCount===e.nodeCount?N(t.root.payload,e.root.payload):t.nodeCount-e.nodeCount:n}),r.map(e=>e.root)}function K(e){let t=e.payload;if(Ce(t)&&typeof t.canonicalHash==`string`)return t.canonicalHash;let n=C(e.url);if(n)return n;for(let t of e.urls){let e=C(t);if(e)return e;let n=ue(t);if(!n)continue;let r=n;if(Ce(r)&&typeof r.canonicalHash==`string`)return r.canonicalHash}}var q=le(y(),1),J=typeof window<`u`,Ne=`sigil:explorer:open`,Pe=`sigil:explorer:bc:v1`,Fe=520,Ie=900,Le=80,Re=80,ze=25e4,Be=18,Ve=3236,He=2e3;function Ue(){let e;for(let[,t]of u){let n=t.pulse;typeof n!=`number`||!Number.isFinite(n)||(e==null||n>e)&&(e=n)}return e}function We(e){let t=e?.pulse??e?.latestPulse??e?.latest_pulse;if(!(typeof t!=`number`||!Number.isFinite(t)))return t}var Ge=`/phi.svg`,Y=`phi`;function X({className:e}){return(0,q.jsx)(`img`,{className:[`phi-mark`,e].filter(Boolean).join(` `),src:Ge,alt:Y,decoding:`async`,loading:`lazy`,draggable:!1})}function Z(e,t){return(0,q.jsxs)(`span`,{className:[`phi-amount`,t?.className].filter(Boolean).join(` `),children:[t?.sign?(0,q.jsx)(`span`,{className:`phi-amount__sign`,children:t.sign}):null,(0,q.jsx)(`span`,{className:`phi-amount__value`,children:A(e)}),(0,q.jsx)(X,{className:[`phi-amount__mark`,t?.markClassName].filter(Boolean).join(` `)})]})}function Q(){return Date.now()}function Ke(){return J?new Promise(e=>{if(typeof window.requestAnimationFrame==`function`){window.requestAnimationFrame(()=>e());return}window.setTimeout(e,0)}):Promise.resolve()}function qe(e){let t=(J?window:null)?.CSS?.escape;return typeof t==`function`?t(e):e.replace(/["\\]/g,`\\$&`)}function Je(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function Ye(e,t){return Je(e)&&typeof e[t]==`string`}function $(e){if(typeof e==`number`&&Number.isFinite(e))return e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&Number.isFinite(t))return t}}function Xe(e){if(typeof e==`boolean`)return e}function Ze(e){if(e===`low`||e===`med`||e===`high`)return e}function Qe(e){let t=e,n=$(e.stepsPerBeat),r=Array.isArray(t.transfers)?t.transfers:void 0,i=Array.isArray(t.segments)?t.segments:void 0,a=Je(t.ip)?t.ip:void 0;return{pulse:e.pulse,kaiPulse:e.pulse,beat:e.beat,stepIndex:e.stepIndex,stepsPerBeat:$(t.stepsPerBeat)??n,kaiSignature:e.kaiSignature,userPhiKey:e.userPhiKey,chakraDay:e.chakraDay,chakraGate:typeof t.chakraGate==`string`?t.chakraGate:void 0,seriesSize:$(t.seriesSize),quality:Ze(t.quality),creatorVerified:Xe(t.creatorVerified),creatorRep:$(t.creatorRep),frequencyHz:$(t.frequencyHz),transfers:r,cumulativeTransfers:$(t.cumulativeTransfers),segments:i,segmentsMerkleRoot:typeof t.segmentsMerkleRoot==`string`?t.segmentsMerkleRoot:void 0,transfersWindowRoot:typeof t.transfersWindowRoot==`string`?t.transfersWindowRoot:void 0,ip:a}}function $e(e,t){if(t==null||!Number.isFinite(t))return null;try{let{unsigned:n}=w(Qe(e),t);return Number.isFinite(n.valuePhi)?n.valuePhi:null}catch{return null}}function et(e,n){if(n==null||!Number.isFinite(n))return null;try{let r=t({meta:Qe(e),nowPulse:n,usd:100,currentStreakDays:0,lifetimeUsdSoFar:0},ve);return Number.isFinite(r.usdPerPhi)?r.usdPerPhi:null}catch{return null}}function tt(e){if(!J||typeof Worker>`u`||e.length<ze)return Promise.resolve(JSON.parse(e));let t=null,n=``;try{let e=new Blob([`
    self.onmessage = (event) => {
      try {
        const parsed = JSON.parse(event.data);
        self.postMessage({ ok: true, value: parsed });
      } catch (err) {
        self.postMessage({ ok: false, error: err && err.message ? err.message : "parse-failed" });
      }
    };
  `],{type:`text/javascript`});n=URL.createObjectURL(e),t=new Worker(n)}catch{return n&&URL.revokeObjectURL(n),Promise.resolve(JSON.parse(e))}return new Promise((r,i)=>{let a=()=>{t?.terminate(),n&&URL.revokeObjectURL(n)};t.onmessage=e=>{let t=e.data;a(),t?.ok?r(t.value):i(Error(t?.error??`parse-failed`))},t.onerror=()=>{a(),i(Error(`parse-failed`))},t.postMessage(e)})}function nt(e){let t=O(e.url);return t===`stream`?`inhale`:t===`post`?`exhale`:null}function rt(e,t){let n=Se(K(e),t);if(n)return n;let r=W(e.payload);if(r)return r;let i=e.payload,a=G(i);if(a)return a;if(Je(i.feed)){let e=G(i.feed);if(e)return e}for(let t of e.urls){let e=ue(t);if(!e)continue;let n=W(e);if(n)return n;let r=G(e);if(r)return r}}function it(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`receive`)||t.includes(`received`)||t.includes(`inhale`)?`receive`:t.includes(`send`)||t.includes(`sent`)||t.includes(`exhale`)?`send`:null:null}function at(e){let t=e;return it(t.transferDirection)||it(t.transferMode)||it(t.transferKind)||it(t.phiDirection)}function ot(e){let t=e,n=t.transferNonce??t.nonce;return typeof n==`string`&&n.trim()?n.trim():null}function st(e){let t=e,n=t.canonicalHash??t.childHash??t.hash;return typeof n==`string`&&n.trim()?n.trim().toLowerCase():null}function ct(e){let t=new Set,n=new Set;for(let r of e.values()){if(at(r)!==`receive`)continue;let e=ot(r);e&&t.add(e);let i=st(r);i&&n.add(i)}return{nonces:t,canonicals:n}}function lt(e,t,n){let r=rt(e,t);if(!r)return null;if(r.direction===`receive`)return`received`;let i=ot(e.payload);if(i&&n.nonces.has(i))return`received`;let a=K(e);return a&&n.canonicals.has(a)?`received`:`pending`}function ut(e,t,n,r,i){let a=e.payload,o=[],s=new Set,c=rt(e,n),l=c?lt(e,n,r):null,u=l===`pending`&&c?c.amount:i?.netPhi??null,d=l===`pending`&&c?c.amountUsd??(i?.usdPerPhi==null?null:c.amount*i.usdPerPhi):i?.usdValue??null;u!=null&&o.push({label:(0,q.jsxs)(`span`,{className:`phi-detail__label`,children:[`Live `,(0,q.jsx)(X,{className:`phi-detail__mark`}),` value`]}),value:Z(u),valueText:`${A(u)} ${Y}`}),d!=null&&o.push({label:`Live USD`,value:`$${T(d)}`});let f=i?.pendingFromChildren??0,p=i?.pendingFromParent??0,m=e.children.length>0?f:f+p;m>0&&o.push({label:`Exhale (pending)`,value:Z(m,{sign:`-`}),valueText:`-${A(m)} ${Y}`});let h=i?.receivedFromChildren??0;h>0&&o.push({label:(0,q.jsxs)(`span`,{className:`phi-detail__label`,children:[(0,q.jsx)(X,{className:`phi-detail__mark`}),` Exhaled`]}),value:Z(h,{sign:`-`}),valueText:`-${A(h)} ${Y}`});let g=ce(e.payload);if(g!==void 0&&o.push({label:(0,q.jsxs)(`span`,{className:`phi-detail__label`,children:[`This glyph `,(0,q.jsx)(X,{className:`phi-detail__mark`})]}),value:Z(g),valueText:`${A(g)} ${Y}`}),c){let e=c.direction===`receive`?`Inhaled`:`Exhaled`,t=c.direction===`receive`?`Inhale (pending)`:`Exhale (pending)`,n=c.sentPulse===void 0?``:` • pulse ${c.sentPulse}`,r=c.sentPulse===void 0?``:` (pulse ${c.sentPulse})`;l&&o.push({label:`Transfer status`,value:`${l===`pending`?t:e}${n}`}),l===`received`&&o.push({label:(0,q.jsxs)(`span`,{className:`phi-detail__label`,children:[(0,q.jsx)(X,{className:`phi-detail__mark`}),` `,e,r]}),value:Z(c.amount,{sign:`+`}),valueText:`+${A(c.amount)} ${Y}`}),c.amountUsd!==void 0&&o.push({label:`USD value`,value:`$${T(c.amountUsd)}`}),c.sentPulse!==void 0&&o.push({label:`Sent pulse`,value:String(c.sentPulse)});let i=c;Ye(i,`txHash`)&&o.push({label:`Tx hash`,value:i.txHash})}let _=a.feed,v=typeof _?.author==`string`?_.author:typeof a.author==`string`?a.author:void 0,y=_?_.usernameClaim:void 0,b=y?ee(y.payload?.normalized||y.payload?.username||``):``,te=ee(v??``),x=b||te;if(x){let e=t[x],n=typeof v==`string`&&v.trim().length>0?v.trim():`@${x}`;e?(o.push({label:`Username (claimed)`,value:`${n} → glyph ${F(e.claimHash,10)}`}),o.push({label:`Claim glyph`,value:D(e.claimUrl)})):o.push({label:`Username`,value:n})}let S=(e,t)=>{let n=a[e];typeof n==`string`&&n.trim().length>0&&!s.has(e)&&(o.push({label:t,value:n.trim()}),s.add(e))};S(`userPhiKey`,`PhiKey`),S(`phiKey`,`PhiKey`),S(`phikey`,`PhiKey`),S(`kaiSignature`,`Kai Signature`),typeof a.parentUrl==`string`&&a.parentUrl.length>0&&o.push({label:`Parent URL`,value:D(a.parentUrl)}),typeof a.originUrl==`string`&&a.originUrl.length>0&&o.push({label:`Origin URL`,value:D(a.originUrl)});let C=a.label??a.title??a.type??a.note??a.description;typeof C==`string`&&C.trim().length>0&&o.push({label:`Label / Type`,value:C.trim()}),o.push({label:`Primary URL`,value:D(e.url)});let w=e.urls.filter(e=>!k(e)).map(e=>D(e));return e.urls.length>1&&o.push({label:`URL variants`,value:w.length===0?`${e.urls.length} urls (kept in data; hidden from browser view)`:w.length<=3?w.join(` | `):`${e.urls.length} urls (kept in data; rendered once)`}),o.slice(0,12)}async function dt(e){if(J){try{if(navigator.clipboard&&typeof navigator.clipboard.writeText==`function`){await navigator.clipboard.writeText(e);return}}catch{}try{let t=document.createElement(`textarea`);t.value=e,t.setAttribute(`readonly`,`true`),t.style.position=`fixed`,t.style.left=`-9999px`,t.style.top=`-9999px`,document.body.appendChild(t),t.select(),document.execCommand(`copy`),document.body.removeChild(t)}catch{}}}async function ft(e){if(J)try{await fetch(e,{method:`GET`,cache:`force-cache`,mode:`cors`,credentials:`omit`,redirect:`follow`})}catch{}}function pt({p:e}){let t=typeof e.pulse==`number`?e.pulse:0,n=typeof e.stepsPerBeat==`number`&&e.stepsPerBeat>0?e.stepsPerBeat:44,r=typeof e.stepIndex==`number`?e.stepIndex:typeof e.pulse==`number`?p(e.pulse,n):0,i=typeof e.beat==`number`?e.beat:0;return(0,q.jsxs)(`span`,{className:`k-stamp`,title:`pulse ${t} • beat ${i} • step ${r}`,children:[(0,q.jsxs)(`span`,{className:`k-pill`,children:[`☤KAI `,t]}),(0,q.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,q.jsxs)(`span`,{className:`k-pill`,children:[`beat `,i]}),(0,q.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,q.jsxs)(`span`,{className:`k-pill`,children:[`step `,r]})]})}function mt({node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a,receiveLocks:o,valueSnapshots:s}){let c=t.has(e.id),l=K(e),u=e.payload.kaiSignature,d=e.payload.chakraDay,f=typeof e.payload.pulse==`number`?e.payload.pulse:void 0,p=f==null?void 0:r.get(f),m=ie(e.url),h=s.get(e.id)??null,g=c?ut(e,i,a,o,h):[],_=rt(e,a),v=lt(e,a,o),y=nt(e),b=!(e.children.length>0),ee=h?.netPhi??null,te=h?.usdValue??null,x=v===`pending`&&_?_.amount:ee,S=v===`pending`&&_?_.amountUsd??(h?.usdPerPhi==null?null:_.amount*h.usdPerPhi):te,C=h?.pendingFromChildren??0,w=h?.pendingFromParent??0,E=h?.receivedFromChildren??0,ne=C+E,D=ne>0?E/ne:0,O=C>0&&E>0?{"--exhale-rgb":`${Math.round(255*(.85+.15*D))},${Math.round(140*(1-D)+75*D)},${Math.round(80*(1-D)+110*D)}`}:void 0,re=C>0?`Exhale (pending) children: -${A(C)} ${Y}${x===null?``:` • Live ${A(Math.max(0,x))} ${Y}`}`:void 0,ae=w>0?`Exhale (pending) send: -${A(w)} ${Y}${x===null?``:` • Live ${A(Math.max(0,x))} ${Y}`}`:void 0,k=b&&w>0&&v!==`pending`,oe=E>0?`Exhaled: -${A(E)} ${Y}${x===null?``:` • Live ${A(Math.max(0,x))} ${Y}`}`:void 0,j=x===null?void 0:`Live value: ${A(x)} ${Y}${S===null?``:` • $${T(S)}`}`,M=_&&v===`received`?{direction:`send`,sign:`-`,titleVerb:_.direction===`receive`?`inhaled`:`exhaled`}:_?{direction:`pending`,sign:`-`,titleVerb:_.direction===`receive`?`inhaled`:`exhaled`}:null;return(0,q.jsxs)(`div`,{className:`node`,style:xe(d),"data-chakra":String(d??``),"data-node-id":e.id,children:[(0,q.jsxs)(`div`,{className:`node-row`,children:[(0,q.jsxs)(`div`,{className:`node-main`,children:[(0,q.jsx)(`button`,{className:`twirl`,"aria-label":c?`Collapse memories`:`Expand memories`,"aria-expanded":c,onClick:()=>n(e.id),title:c?`Collapse`:`Expand`,type:`button`,children:(0,q.jsx)(`span`,{className:`tw ${c?`open`:``}`})}),(0,q.jsx)(`a`,{className:`node-link`,href:m,target:`_blank`,rel:`noopener noreferrer`,title:m,children:(0,q.jsx)(`span`,{children:F(u??l??`glyph`,12)})})]}),(0,q.jsxs)(`div`,{className:`node-meta`,children:[(0,q.jsx)(pt,{p:e.payload}),d&&(0,q.jsx)(`span`,{className:`chakra`,title:String(d),children:String(d)}),b&&_&&M&&(0,q.jsxs)(`span`,{className:`phi-move phi-move--${M.direction}`,title:`Phi ${M.titleVerb}${v===`pending`?` (pending)`:``}: ${A(_.amount)} ${Y}${_.amountUsd===void 0?``:` • $${T(_.amountUsd)}`}${_.sentPulse===void 0?``:` • sent pulse ${_.sentPulse}`}`,children:[(0,q.jsx)(`span`,{className:`phi-move__sign`,"aria-hidden":`true`,children:M.sign}),Z(_.amount,{className:`phi-move__amount`,markClassName:`phi-move__mark`}),v===`received`&&_.amountUsd!==void 0&&(0,q.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,T(_.amountUsd)]}),v===`received`&&_.amountUsd===void 0&&h?.usdPerPhi!=null&&(0,q.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,T(_.amount*h.usdPerPhi)]}),v===`pending`&&h?.usdPerPhi!=null&&(0,q.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,T(_.amount*h.usdPerPhi)]})]}),b&&_&&v===`pending`&&(0,q.jsx)(`span`,{className:`phi-status phi-status--pending`,title:`Exhale pending`,children:`Exhale`}),b&&_&&y===`exhale`&&v===`received`&&(0,q.jsx)(`span`,{className:`phi-status phi-status--received`,title:`Exhale received`,children:`Exhaled`}),!_&&y!==`inhale`&&ne>0&&(0,q.jsx)(`span`,{className:`phi-status phi-status--${C>0&&E>0?`exhale-mix`:`received`}`,title:C>0&&E>0?`Exhale mix: ${A(E)} exhaled • ${A(C)} pending`:C>0?`Exhale pending: ${A(C)} ${Y}`:`Exhaled: ${A(E)} ${Y}`,style:O,children:`Exhale`}),y===`inhale`&&(0,q.jsx)(`span`,{className:`phi-status phi-status--inhale`,title:`Inhale`,children:`Inhale`}),x!==null&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--live`,title:j,children:[(0,q.jsxs)(`span`,{className:`phi-pill__label`,children:[(0,q.jsx)(X,{className:`phi-pill__mark`}),y===`inhale`?`+`:`live:`]}),Z(x)]}),S!==null&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--usd`,title:j,children:[`$`,T(S)]}),E>0&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--drain`,title:oe,children:[`Exhaled `,Z(E,{sign:`-`})]}),C>0&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--pending`,title:re,children:[`Exhale (pending) `,Z(C,{sign:`-`})]}),k&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--pending`,title:ae,children:[`Exhale (pending) `,Z(w,{sign:`-`})]}),b&&v===`received`&&_&&y===`exhale`&&(0,q.jsx)(`span`,{className:`phi-pill phi-pill--drain`,title:`Exhaled: ${A(_.amount)} ${Y}${_.amountUsd===void 0?``:` • $${T(_.amountUsd)}`}`,children:`Exhaled`}),p!==void 0&&(0,q.jsxs)(`span`,{className:`phi-pill`,title:`Total ${Y} on pulse ${e.payload.pulse??``}`,children:[(0,q.jsxs)(`span`,{className:`phi-pill__label`,children:[(0,q.jsx)(X,{className:`phi-pill__mark`}),`pulse:`]}),Z(p)]}),(0,q.jsx)(`button`,{className:`node-copy`,"aria-label":`Copy URL`,onClick:()=>void dt(m),title:`Copy URL`,type:`button`,children:`⧉`})]})]}),c&&(0,q.jsxs)(`div`,{className:`node-open`,children:[(0,q.jsx)(`div`,{className:`node-detail`,children:g.length===0?(0,q.jsx)(`div`,{className:`node-detail-empty`,children:`No additional memory fields recorded on this glyph.`}):(0,q.jsx)(`div`,{className:`node-detail-grid`,children:g.map((e,t)=>(0,q.jsxs)(R.Fragment,{children:[(0,q.jsx)(`div`,{className:`detail-label`,children:e.label}),(0,q.jsx)(`div`,{className:`detail-value`,title:e.valueText??(typeof e.value==`string`?e.value:void 0),children:e.value})]},t))})}),e.children.length>0&&(0,q.jsx)(`div`,{className:`node-children`,"aria-label":`Memory Imprints`,children:e.children.map(e=>(0,q.jsx)(mt,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a,receiveLocks:o,valueSnapshots:s},e.id))})]})]})}function ht({root:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a,receiveLocks:o,valueSnapshots:s}){let c=(0,R.useMemo)(()=>{let t=0,n=e=>{t+=1,e.children.forEach(n)};return n(e),t},[e]),l=C(e.url),u=e.payload.kaiSignature,d=ie(e.url),f=e.payload.chakraDay,p=s.get(e.id)??null,m=(0,R.useMemo)(()=>{let t=0,n=p?.pendingFromParent??0;for(let r of e.children){let e=s.get(r.id);e?.receivedAmount&&(t+=e.receivedAmount),e?.pendingFromParent&&(n+=e.pendingFromParent)}let r=p?.basePhi??null,i=p?.netPhi??null,a=p?.usdPerPhi??null;return{basePhi:r,netPhi:i,usdValue:i!=null&&a!=null?i*a:null,derivedPhi:t,pendingPhi:n}},[e,p,s]),h=(0,R.useMemo)(()=>{let t=0,n=0,r=0,i=e=>{let r=O(e.url),c=s.get(e.id)??null;if(r===`stream`&&c?.netPhi!=null&&(t+=c.netPhi),r===`post`){let t=rt(e,a);(t?lt(e,a,o):null)===`received`&&t&&(n+=t.amount)}e.children.forEach(i)};i(e);for(let t of e.children){if(O(t.url)!==`post`)continue;let e=rt(t,a);(e?lt(t,a,o):null)===`pending`&&e&&(r+=e.amount)}return{inhaleTotal:t,exhaleTotal:n,pendingTotal:r}},[o,e,a,s]),g=m.netPhi==null?void 0:`Live origin value: ${A(m.netPhi)} ${Y}${m.usdValue==null?``:` • $${T(m.usdValue)}`}`;return(0,q.jsxs)(`section`,{className:`origin`,"aria-label":`Sigil origin stream`,style:xe(f),"data-chakra":String(f??``),"data-node-id":e.id,children:[(0,q.jsxs)(`header`,{className:`origin-head`,children:[(0,q.jsxs)(`div`,{className:`o-meta`,children:[(0,q.jsx)(`span`,{className:`o-title`,children:`Origin`}),(0,q.jsx)(`a`,{className:`o-link`,href:d,target:`_blank`,rel:`noopener noreferrer`,title:d,children:F(u??l??`origin`,14)}),f&&(0,q.jsx)(`span`,{className:`o-chakra`,title:String(f),children:String(f)})]}),(0,q.jsxs)(`div`,{className:`o-right`,children:[(0,q.jsx)(pt,{p:e.payload}),m.netPhi!=null&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--live`,title:g,children:[(0,q.jsxs)(`span`,{className:`phi-pill__label`,children:[(0,q.jsx)(X,{className:`phi-pill__mark`}),`live:`]}),Z(m.netPhi)]}),m.usdValue!=null&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--usd`,title:g,children:[`$`,T(m.usdValue)]}),h.inhaleTotal>0&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--lift`,title:`Inhales from memory: +${A(h.inhaleTotal)} ${Y}`,children:[`Inhale `,Z(h.inhaleTotal,{sign:`+`})]}),h.exhaleTotal>0&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--drain`,title:`Exhaled: -${A(h.exhaleTotal)} ${Y}`,children:[`Exhaled `,Z(h.exhaleTotal,{sign:`-`})]}),h.pendingTotal>0&&(0,q.jsxs)(`span`,{className:`phi-pill phi-pill--pending`,title:`Exhale (pending): -${A(h.pendingTotal)} ${Y}`,children:[`Exhale (pending) `,Z(h.pendingTotal,{sign:`-`})]}),(0,q.jsxs)(`span`,{className:`o-count`,title:`Total content keys in this lineage`,children:[c,` keys`]}),(0,q.jsx)(`button`,{className:`o-copy`,onClick:()=>void dt(d),title:`Copy origin URL`,type:`button`,children:`Remember Origin`})]})]}),(0,q.jsx)(`div`,{className:`origin-body`,children:e.children.length===0?(0,q.jsx)(`div`,{className:`kx-empty`,children:`No memories yet. The stream begins here.`}):(0,q.jsx)(`div`,{className:`tree`,children:e.children.map(e=>(0,q.jsx)(mt,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a,receiveLocks:o,valueSnapshots:s},e.id))})})]})}function gt({onAdd:e,onImport:t,onExport:n,total:r,lastAdded:i}){let[a,o]=(0,R.useState)(``);return(0,q.jsx)(`div`,{className:`kx-toolbar`,role:`region`,"aria-label":`Explorer toolbar`,children:(0,q.jsxs)(`div`,{className:`kx-toolbar-inner`,children:[(0,q.jsxs)(`div`,{className:`kx-brand`,children:[(0,q.jsx)(`div`,{className:`kx-glyph`,"aria-hidden":!0,children:(0,q.jsx)(`img`,{className:`kx-glyph__mark`,src:Ge,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`eager`,draggable:!1})}),(0,q.jsxs)(`div`,{className:`kx-title`,children:[(0,q.jsxs)(`h1`,{children:[`KAIROS `,(0,q.jsx)(`span`,{children:`Keystream`})]}),(0,q.jsxs)(`div`,{className:`kx-tagline`,children:[`Sovereign Lineage • No DB • Pure `,(0,q.jsx)(X,{className:`phi-tagline__mark`})]})]})]}),(0,q.jsxs)(`div`,{className:`kx-controls`,children:[(0,q.jsxs)(`form`,{className:`kx-add-form`,onSubmit:t=>{t.preventDefault(),a.trim()&&(e(a.trim()),o(``))},children:[(0,q.jsx)(`input`,{className:`kx-input`,placeholder:`Inhale a sigil (or memory)…`,spellCheck:!1,value:a,onChange:e=>o(e.target.value),"aria-label":`Sigil Key`}),(0,q.jsx)(`button`,{className:`kx-button`,type:`submit`,children:`Inhale`})]}),(0,q.jsxs)(`div`,{className:`kx-io`,role:`group`,"aria-label":`Import and export`,children:[(0,q.jsxs)(`label`,{className:`kx-import`,title:`Import a JSON list of Keys (or krystals)`,children:[(0,q.jsx)(`input`,{type:`file`,accept:`application/json`,onChange:e=>{let n=e.target.files?.[0];n&&t(n)},"aria-label":`Import JSON`}),`Inhale`]}),(0,q.jsx)(`button`,{className:`kx-export`,onClick:n,"aria-label":`Export registry to JSON`,type:`button`,children:`Exhale`})]}),(0,q.jsxs)(`div`,{className:`kx-stats`,"aria-live":`polite`,children:[(0,q.jsxs)(`span`,{className:`kx-pill`,title:`Total KEYS in registry (includes variants)`,children:[r,` KEYS`]}),i&&(0,q.jsxs)(`span`,{className:`kx-pill subtle`,title:i,children:[`Last: `,F(i,8)]})]})]})]})})}var _t=()=>{let[t,p]=(0,R.useState)(()=>d()?1:0),[h,y]=(0,R.useState)(0),[ee,C]=(0,R.useState)(void 0),[w,T]=(0,R.useState)(()=>o()),[k,A]=(0,R.useState)(()=>c(new Date)),M=(0,R.useRef)(!1),le=(0,R.useRef)(new Set),N=(0,R.useRef)(null),P=(0,R.useRef)(!1),F=(0,R.useRef)(null),I=(0,R.useRef)(0),L=(0,R.useRef)(null),ve=(0,R.useRef)(!1),ye=(0,R.useRef)(void 0),be=(0,R.useRef)(0),xe=(0,R.useRef)(null),z=(0,R.useRef)([]),B=(0,R.useRef)(null),V=(0,R.useCallback)(e=>{let t=Q()+e;t>I.current&&(I.current=t)},[]),H=(0,R.useCallback)(()=>{if(!J||M.current)return;let e=Q(),t=I.current-e;if(t>0){L.current!=null&&window.clearTimeout(L.current),L.current=window.setTimeout(()=>{L.current=null,H()},t+Le);return}let n=z.current.splice(0);if(n.length>0&&(0,R.startTransition)(()=>{T(e=>{let t=e;for(let e of n){let n=t[e.normalized];n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===(e.originHash??n.originHash)&&n.ownerHint===(e.ownerHint??n.ownerHint)||(t={...t,[e.normalized]:{...n,normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash??n?.originHash,ownerHint:e.ownerHint??n?.ownerHint??null,updatedAt:n?.updatedAt??0}})}return t})}),ye.current!==void 0){let e=ye.current;ye.current=void 0,(0,R.startTransition)(()=>C(e))}if(xe.current!==null){let e=xe.current;xe.current=null,(0,R.startTransition)(()=>A(e))}if(be.current>0){let e=be.current;be.current=0,(0,R.startTransition)(()=>y(t=>t+e))}ve.current&&(ve.current=!1,(0,R.startTransition)(()=>p(e=>e+1)))},[V]),U=(0,R.useCallback)(()=>{if(!J||L.current!=null)return;let e=Q(),t=I.current-e,n=Math.max(0,t)+Le;L.current=window.setTimeout(()=>{L.current=null,H()},n)},[H]),W=(0,R.useCallback)(()=>{if(!M.current){if(Q()<I.current||P.current){ve.current=!0,U();return}(0,R.startTransition)(()=>p(e=>e+1))}},[U]),G=(0,R.useCallback)(e=>{if(!M.current){if(Q()<I.current||P.current){ye.current=e,U();return}(0,R.startTransition)(()=>C(e))}},[U]),Se=(0,R.useCallback)((e=1)=>{if(!M.current){if(Q()<I.current||P.current){be.current+=e,U();return}(0,R.startTransition)(()=>y(t=>t+e))}},[U]),Ce=(0,R.useCallback)(e=>{if(!M.current){if(Q()<I.current||P.current){xe.current=e,U();return}(0,R.startTransition)(()=>A(e))}},[U]),we=(0,R.useRef)(null),[Te,Ee]=(0,R.useState)(()=>new Set),De=(0,R.useCallback)(e=>{V(Ie);let t=N.current;if(t){let n=`[data-node-id="${qe(e)}"]`,r=t.querySelector(n);we.current={id:e,scrollTop:t.scrollTop,rectTop:r?r.getBoundingClientRect().top:0}}Ee(t=>{let n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n}),U()},[V,U]);(0,R.useEffect)(()=>{if(!J)return;let e=window.setInterval(()=>Ce(c(new Date)),6e3);return()=>window.clearInterval(e)},[Ce]),(0,R.useEffect)(()=>{if(!J)return;let e=document.documentElement,t=document.body,n=document.scrollingElement||document.documentElement,r={htmlOverscroll:e?.style.overscrollBehavior??``,htmlOverscrollY:e?.style.overscrollBehaviorY??``,bodyOverscroll:t?.style.overscrollBehavior??``,bodyOverscrollY:t?.style.overscrollBehaviorY??``,rootOverscroll:n?.style.overscrollBehavior??``,rootOverscrollY:n?.style.overscrollBehaviorY??``};return e&&(e.style.overscrollBehavior=`none`,e.style.overscrollBehaviorY=`none`),t&&(t.style.overscrollBehavior=`none`,t.style.overscrollBehaviorY=`none`),n&&(n.style.overscrollBehavior=`none`,n.style.overscrollBehaviorY=`none`),()=>{e&&(e.style.overscrollBehavior=r.htmlOverscroll,e.style.overscrollBehaviorY=r.htmlOverscrollY),t&&(t.style.overscrollBehavior=r.bodyOverscroll,t.style.overscrollBehaviorY=r.bodyOverscrollY),n&&(n.style.overscrollBehavior=r.rootOverscroll,n.style.overscrollBehaviorY=r.rootOverscrollY)}},[]),(0,R.useEffect)(()=>{if(!J)return;let e=N.current;if(!e)return;let t=0,n=0,r=e=>{e.touches.length===1&&(t=e.touches[0]?.clientY??0,n=e.touches[0]?.clientX??0)},i=r=>{if(!r.cancelable||r.touches.length!==1)return;let i=r.touches[0]?.clientY??0,a=r.touches[0]?.clientX??0,o=i-t,s=a-n;if(t=i,n=a,Math.abs(o)<=Math.abs(s))return;let c=e.scrollHeight-e.clientHeight;if(c<=0)return;let l=e.scrollTop<=0,u=e.scrollTop>=c-1,d=o>0,f=o<0;(l&&d&&window.scrollY<=0||u&&f)&&r.preventDefault()};return e.addEventListener(`touchstart`,r,{passive:!0}),e.addEventListener(`touchmove`,i,{passive:!1}),()=>{e.removeEventListener(`touchstart`,r),e.removeEventListener(`touchmove`,i)}},[]),(0,R.useEffect)(()=>{if(!J)return;let e=N.current;if(!e)return;let t=()=>{P.current=!0,V(Fe),F.current!=null&&window.clearTimeout(F.current),F.current=window.setTimeout(()=>{P.current=!1,F.current=null,U()},180)};return e.addEventListener(`scroll`,t,{passive:!0}),()=>{e.removeEventListener(`scroll`,t),F.current!=null&&window.clearTimeout(F.current),F.current=null,P.current=!1}},[V,U]),(0,R.useLayoutEffect)(()=>{let e=we.current;if(!e)return;we.current=null;let t=N.current;if(!t)return;let n=`[data-node-id="${qe(e.id)}"]`,r=t.querySelector(n);if(!r)return;let i=r.getBoundingClientRect().top-e.rectTop;Number.isFinite(i)&&Math.abs(i)>1&&(t.scrollTop=Math.max(0,e.scrollTop+i))},[Te]);let Oe=(0,R.useRef)(null),ke=(0,R.useRef)(!1),Ae=(0,R.useRef)(null);(0,R.useEffect)(()=>{if(M.current=!1,a(),i(),ne(),re(),d()&&W(),J){let e=j(window.location.href);if(ue(e)){let t=s(e,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0});G(D(e)),t&&W()}}let e=window.__SIGIL__?.registerSigilUrl,t=window.__SIGIL__?.registerSend;window.__SIGIL__||(window.__SIGIL__={}),window.__SIGIL__.registerSigilUrl=oe,window.__SIGIL__.registerSend=e=>{if(!e||typeof e!=`object`)return;let t=e.url;typeof t!=`string`||!t.trim()||s(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(G(D(t)),W())};let n=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&s(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(G(D(t)),W())};window.addEventListener(`sigil:url-registered`,n);let r=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&s(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(G(D(t)),W())};window.addEventListener(`sigil:minted`,r);let o=J&&`BroadcastChannel`in window?new BroadcastChannel(Pe):null,c=e=>{let t=e.data;t?.type===`sigil:add`&&typeof t.url==`string`&&s(t.url,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0})&&(G(D(t.url)),W())};o?.addEventListener(`message`,c);let u=e=>{if(!e.key)return;let t=e.key===b,n=e.key===v;if(e.key===`kai:sigil-transfer:v1`){Se();return}if(!(!t&&!n)&&e.newValue)try{let t=JSON.parse(e.newValue);if(!Array.isArray(t))return;let n=!1;for(let e of t)typeof e==`string`&&s(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:!0})&&(n=!0);G(void 0),n&&(te(),W())}catch{}};window.addEventListener(`storage`,u);let p=()=>Se();window.addEventListener(he,p);let h=J&&`BroadcastChannel`in window?new BroadcastChannel(E):null,g=e=>{e.data?.type===`transfer:update`&&Se()};h?.addEventListener(`message`,g);let y=()=>{pe(),m()};window.addEventListener(`pagehide`,y);let ee=de(e=>{if(Q()<I.current||P.current){z.current.push({normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash,ownerHint:e.ownerHint}),U();return}(0,R.startTransition)(()=>{T(t=>{let n=t[e.normalized];return n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===e.originHash&&n.ownerHint===e.ownerHint?t:{...t,[e.normalized]:e}})})}),x=new AbortController,S=async e=>{M.current||fe()&&(P.current||Q()<I.current&&(e===`pulse`||e===`import`)||await m())},C=async e=>{if(!M.current&&fe()&&!ke.current&&!P.current&&!(Q()<I.current&&(e===`pulse`||e===`import`))){ke.current=!0;try{let t=Oe.current,n=await _(e=>f(e,me),{method:`GET`,cache:`no-store`,signal:x.signal,headers:void 0});if(!n||n.status===304||!n.ok)return;let r=``,i;try{let e=await n.json();r=typeof e?.seal==`string`?e.seal:``,i=We(e)}catch{return}let a=i==null?void 0:Ue();if(t&&r&&t===r&&!(i!=null&&(a==null||i>a))){Oe.current=r;return}let o=await l(x.signal);o.pulled&&(Oe.current=o.remoteSeal??r??t??null),o.imported>0&&(G(void 0),W());let s=Oe.current;(e===`open`||(e===`visible`||e===`focus`||e===`online`||e===`import`)&&s!==Ae.current)&&(se(),Ae.current=s,await m())}finally{ke.current=!1}}};B.current=C,se(),S(`open`),C(`open`);let w=null,O=null,ie=()=>{J&&(M.current||(w!=null&&window.clearInterval(w),w=window.setInterval(()=>{document.visibilityState===`visible`&&fe()&&S(`pulse`)},Ve)))},ae=()=>{J&&(M.current||(O!=null&&window.clearInterval(O),O=window.setInterval(()=>{document.visibilityState===`visible`&&fe()&&C(`pulse`)},He)))},k=()=>{ie(),ae()};k();let A=()=>{document.visibilityState===`visible`&&(k(),S(`visible`),C(`visible`))};document.addEventListener(`visibilitychange`,A);let ce=()=>{k(),S(`focus`),C(`focus`)},le=()=>{k(),S(`online`),C(`online`)};return window.addEventListener(`focus`,ce),window.addEventListener(`online`,le),()=>{window.__SIGIL__&&(window.__SIGIL__.registerSigilUrl=e,window.__SIGIL__.registerSend=t),window.removeEventListener(`sigil:url-registered`,n),window.removeEventListener(`sigil:minted`,r),window.removeEventListener(`storage`,u),window.removeEventListener(he,p),h?.removeEventListener(`message`,g),h?.close(),window.removeEventListener(`pagehide`,y),window.removeEventListener(`focus`,ce),window.removeEventListener(`online`,le),document.removeEventListener(`visibilitychange`,A),o?.removeEventListener(`message`,c),o?.close(),typeof ee==`function`&&ee(),L.current!=null&&window.clearTimeout(L.current),L.current=null,w!=null&&window.clearInterval(w),w=null,O!=null&&window.clearInterval(O),O=null,x.abort(),B.current=null,M.current=!0}},[W,V,U,G]);let je=(0,R.useCallback)(e=>{let t=B.current;t&&t(e)},[]);(0,R.useEffect)(()=>{if(!J)return;let e=()=>je(`visible`);return window.addEventListener(Ne,e),()=>window.removeEventListener(Ne,e)},[je]);let K=(0,R.useMemo)(()=>Me(u),[t]),ze=(0,R.useMemo)(()=>n(),[h]),Ge=(0,R.useMemo)(()=>ct(u),[t,h]),Y=(0,R.useMemo)(()=>{let e=0;for(let[,]of u)e+=1;return e},[t]),X=(0,R.useMemo)(()=>{let e=new Map,t=n=>{let r=$e(n.payload,k),i=et(n.payload,k),a=rt(n,ze)??null,o=lt(n,ze,Ge),s=o===`received`&&a?a.amount:0,c=s>0?s:r??0,l=0,u=0,d=0;for(let e of n.children){let n=t(e);l+=n.receivedFromParent,u+=n.pendingFromParent,d+=n.liftToParent}let f=o===`pending`&&a?.direction===`send`?a.amount:0,p=Math.max(0,c+d-l),m=o===`received`&&a?.amountUsd?a.amountUsd:i==null?null:p*i,h=f,g=O(n.url)===`stream`?p:0;return e.set(n.id,{basePhi:r,netPhi:Number.isFinite(p)?p:null,usdValue:m,usdPerPhi:i,transferMove:a,receivedAmount:s,receivedFromChildren:l,pendingFromChildren:u,pendingFromParent:h}),{receivedFromParent:s,pendingFromParent:h,liftToParent:g}};for(let e of K)t(e);return e},[K,k,Ge,ze]),Z=(0,R.useMemo)(()=>{let e=new Map,t=new Map;for(let[n,r]of u){let i=typeof r.pulse==`number`?r.pulse:void 0;if(i==null)continue;let a=ae(j(n),r),o=t.get(i);if(o||(o=new Set,t.set(i,o)),o.has(a))continue;o.add(a);let s=ce(r);s!==void 0&&e.set(i,(e.get(i)??0)+s)}return e},[t]),Je=(0,R.useMemo)(()=>{let e=[];for(let[t]of u){let n=j(ie(t));e.includes(n)||e.push(n)}return e},[t]);(0,R.useEffect)(()=>{if(!J||Je.length===0)return;let e=Je.filter(e=>!le.current.has(e));if(e.length===0)return;let t=!1,n=async()=>{for(let n of e){if(t)break;le.current.add(n),await ft(n)}},r=window,i=null;if(typeof r.requestIdleCallback==`function`){let e=r.requestIdleCallback(()=>void n(),{timeout:1e3});i=()=>r.cancelIdleCallback?.(e)}else{let e=window.setTimeout(()=>void n(),120);i=()=>window.clearTimeout(e)}return()=>{t=!0,i?.()}},[Je]);let Ye=(0,R.useCallback)(async()=>{if(!J||P.current||!fe()||Q()<I.current)return;let e=[],t=n=>{if(n.urls.length>1){let t=O(n.url),i=[...n.urls].map(e=>j(D(e))).filter((e,t,n)=>n.indexOf(e)===t).sort((e,n)=>_e(n,t)-_e(e,t));for(let t of i.slice(0,2)){let n=j(t);!r.has(n)&&!e.includes(n)&&e.push(n)}}n.children.forEach(t)};for(let e of K)t(e);if(e.length!==0)for(let t of e.slice(0,Be)){let e=await ge(t);e===`ok`&&g(t,1),e===`bad`&&g(t,-1)}},[K]);(0,R.useEffect)(()=>{if(!J)return;let e=!1,t=()=>{e||Ye()},n=window,r=null;if(typeof n.requestIdleCallback==`function`){let e=n.requestIdleCallback(t,{timeout:900});r=()=>n.cancelIdleCallback?.(e)}else{let e=window.setTimeout(t,250);r=()=>window.clearTimeout(e)}return()=>{e=!0,r?.()}},[t,Ye]);let $=(0,R.useCallback)(e=>{V(Ie),s(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(G(D(e)),W())},[W,V,G]),Xe=(0,R.useCallback)(async t=>{V(0);let n=await t.text(),r;try{r=await tt(n)}catch{return}let{urls:i,rawKrystals:a}=x(r);if(i.length===0&&a.length===0)return;let o=!1;for(let e=0;e<a.length;e+=Re){for(let t of a.slice(e,e+Re))S(t);e+Re<a.length&&await Ke()}for(let e=0;e<i.length;e+=Re){for(let t of i.slice(e,e+Re))s(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`import`,enqueueToApi:!0})&&(o=!0);o&&(G(void 0),W()),e+Re<i.length&&await Ke()}i.length>0&&e(i),o&&(G(void 0),W()),je(`import`)},[W,V,je,G]),Ze=(0,R.useCallback)(()=>{V(Ie);let e=[];for(let[t]of u)e.push(t);let t=new Blob([JSON.stringify({urls:e},null,2)],{type:`application/json`}),n=document.createElement(`a`);n.href=URL.createObjectURL(t),n.download=`sigil-registry-${Date.now()}.json`,n.click(),URL.revokeObjectURL(n.href)},[V]);return(0,q.jsxs)(`div`,{className:`sigil-explorer`,"aria-label":`Kairos Keystream Explorer`,children:[(0,q.jsx)(gt,{onAdd:$,onImport:Xe,onExport:Ze,total:Y,lastAdded:ee}),(0,q.jsx)(`div`,{className:`explorer-scroll`,ref:N,role:`region`,"aria-label":`Explorer scroll viewport`,children:(0,q.jsxs)(`div`,{className:`explorer-inner`,children:[K.length===0?(0,q.jsxs)(`div`,{className:`kx-empty`,children:[(0,q.jsx)(`p`,{children:`No sigil-glyphs in your keystream yet.`}),(0,q.jsxs)(`ol`,{children:[(0,q.jsx)(`li`,{children:`Import your keystream memories.`}),(0,q.jsx)(`li`,{children:`Seal a moment — auto-registered here.`}),(0,q.jsx)(`li`,{children:`Inhale any sigil-glyph or memory key above — lineage aligns instantly.`})]})]}):(0,q.jsx)(`div`,{className:`forest`,"aria-label":`Sigil forest`,children:K.map(e=>(0,q.jsx)(ht,{root:e,expanded:Te,toggle:De,phiTotalsByPulse:Z,usernameClaims:w,transferRegistry:ze,receiveLocks:Ge,valueSnapshots:X},e.id))}),(0,q.jsx)(`footer`,{className:`kx-footer`,"aria-label":`Explorer footer`,children:(0,q.jsxs)(`span`,{className:`row`,children:[(0,q.jsx)(`span`,{children:`Determinate • Stateless • Kairos-Memory`}),(0,q.jsx)(`span`,{className:`dot`,children:`•`}),(0,q.jsx)(`span`,{children:fe()?`online`:`offline`}),(0,q.jsx)(`span`,{className:`dot`,children:`•`}),(0,q.jsxs)(`span`,{children:[Y,` keys`]})]})})]})})]})};export{_t as default};