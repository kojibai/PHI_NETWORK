import{Br as e,Cr as t,Dr as n,Er as r,Or as i,Sr as a,Tr as o,Ur as s,_r as c,br as l,gr as u,hi as d,kr as f,li as p,wr as m,xr as h,yr as g}from"./index-BZ0fAeMD.js";var _=d(p(),1);function v(){let[t,n]=(0,_.useState)(null),[r,i]=(0,_.useState)(e),a=(0,_.useRef)(null),o=(0,_.useRef)(null);return(0,_.useEffect)(()=>{let t=null,r=()=>{let t=s(new Date),r=Date.now();if(o.current==null||t.pulse!==o.current)o.current=t.pulse,a.current=r,n(t.pulse),i(e);else{let o=a.current,s=o==null?e:Math.max(0,e-(r-o));n(t.pulse),i(s)}};return t=window.setInterval(r,50),r(),()=>{t!=null&&window.clearInterval(t)}},[]),{pulse:t,msToNextPulse:r}}function y(){return(0,_.useMemo)(()=>async e=>{let t=new TextEncoder().encode(e),n=await crypto.subtle.digest(`SHA-256`,t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,`0`)).join(``)},[])}function b({payload:e,urlSearchParams:s,currentPulse:d}){let[p,v]=(0,_.useState)(null),[b,x]=(0,_.useState)(null),[S,C]=(0,_.useState)(null),w=(0,_.useRef)(null),T=(0,_.useRef)(null),E=y(),D=s?.get(`vpol`)??``;(0,_.useEffect)(()=>{let t=!0;return(async()=>{if(!e||!Number.isFinite(d??NaN)){if(!t)return;v(e=>e===null?e:null),x(e=>e===null?e:null),C(e=>e===null?e:null),w.current=null,T.current=null;return}let{seal:n}=await u({pulse:e.pulse,kaiPulse:e.pulse,beat:e.beat,stepIndex:e.stepIndex,stepsPerBeat:e.stepsPerBeat,seriesSize:e.seriesSize,quality:e.quality,creatorVerified:e.creatorVerified,creatorRep:e.creatorRep,frequencyHz:e.frequencyHz,chakraDay:e.chakraDay,chakraGate:e.chakraGate,transfers:e.transfers,cumulativeTransfers:e.cumulativeTransfers,segments:e.segments,segmentsMerkleRoot:e.segmentsMerkleRoot,transfersWindowRoot:e.transfersWindowRoot,ip:e.ip,kaiSignature:e.kaiSignature,userPhiKey:e.userPhiKey,valuationPolicyId:D||void 0},d,E);if(!t)return;T.current!==n.stamp&&(v(e=>e&&e.stamp===n.stamp?e:n),T.current=n.stamp);let r=n.valuePhi,i=w.current;i!==r&&(x(e=>e===r?e:r),i!=null&&Math.abs(r-i)>1e-9?C(e=>e===`up`&&r>i?e:r>i?`up`:`down`):C(e=>e===null?e:null),w.current=r)})(),()=>{t=!1}},[e,d,D,E]);let O=(0,_.useMemo)(()=>e?.pulse,[e]),k=(0,_.useMemo)(()=>Number.isFinite(O??NaN)?{score:m(O),lines:a(O)}:{score:null,lines:[]},[O]),A=(0,_.useMemo)(()=>{if(!Number.isFinite(O??NaN)||!Number.isFinite(d??NaN))return null;let t=p?.inputs?.pulsesPerBeat?Math.max(1,Math.round(p.inputs.pulsesPerBeat/11)):e?.stepsPerBeat??44,n=p?.inputs?.cadenceRegularity??1,r=p?.inputs?.resonancePhi??.5,i=e?.stepIndex;return h(O,d,{stepsPerBeat:t,cadenceRegularity:n,resonancePhi:r,stepIndexClaimOverride:i})},[O,d,p,e]),j=(0,_.useMemo)(()=>{let t=e?.transfers;return!t||!t.length?[`No closed transfers yet â€” lineage still forming.`]:l(t,{stepsPerBeat:e?.stepsPerBeat??44})},[e]);return{valSeal:p,livePrice:b,priceFlash:S,rarity:k,oscillation:A,lineageNarrative:j,trust:(0,_.useMemo)(()=>p?g(p.inputs):null,[p]),marketTier:(0,_.useMemo)(()=>Number.isFinite(O??NaN)?c(O,p??void 0):null,[O,p]),kairos:(0,_.useMemo)(()=>Number.isFinite(d??NaN)?{window:i(d,144,1,{stepsPerBeat:e?.stepsPerBeat??44})}:{window:[]},[d,e]),visuals:(0,_.useMemo)(()=>{if(!p||!Number.isFinite(O??NaN))return{spiralSVG:null,scrollSVG:null,scrollText:null,scrollHTML:null};let e=o(O),{scrollSVG:t,scrollText:n}=f(p,{title:`Kai-Sigil Valuation Scroll`});return{spiralSVG:e,scrollSVG:t,scrollText:n,scrollHTML:r(p,{title:`Kai-Sigil Valuation Scroll`})}},[p,O]),audio:(0,_.useMemo)(()=>{if(!Number.isFinite(O??NaN))return{dataURI:null,renderWav:void 0};let{dataURI:e}=n(O,2,44100,{stereo:!0});return{dataURI:e,renderWav:(e=2,t=44100,r)=>n(O,e,t,r)}},[O]),motifSimilarityWith:(0,_.useMemo)(()=>e=>!Number.isFinite(e??NaN)||!Number.isFinite(O??NaN)?null:t(O,e),[O]),helpers:(0,_.useMemo)(()=>({explainRarity:()=>k.lines,explainLineage:()=>j,scanKairos:(t,n,r=1,a)=>i(t,n,r,{stepsPerBeat:a??e?.stepsPerBeat??44}),makeScroll:e=>p?f(p,{title:e??`Kai-Sigil Valuation Scroll`}):null,makeScrollHTML:e=>p?r(p,{title:e}):null,makeSpiral:e=>Number.isFinite(e??O)?o(e??O):null}),[k.lines,j,e,p,O])}}export{v as n,b as t};