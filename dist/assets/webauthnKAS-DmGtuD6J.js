import{_ as e,a as t,b as n,v as r,y as i}from"./index-COEJlIOZ.js";var a=`kai:kas1:passkey:`;function o(){return typeof window<`u`&&typeof navigator<`u`&&typeof PublicKeyCredential<`u`&&typeof navigator.credentials?.create==`function`&&typeof navigator.credentials?.get==`function`}function s(e){if(typeof window>`u`)return null;let t=window.localStorage.getItem(`${a}${e}`);if(!t)return null;try{let e=JSON.parse(t);return typeof e?.credId!=`string`||!e.pubKeyJwk?null:e}catch(e){throw Error(`Failed to read passkey cache: ${e instanceof Error?e.message:String(e)}`)}}function c(e,t){typeof window>`u`||window.localStorage.setItem(`${a}${e}`,JSON.stringify(t))}function l(e){if(e.length<37)throw Error(`AuthData too short to contain attested credential data.`);let t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(!(e[32]&64))throw Error(`Attestation missing credential data (AT flag not set).`);let n=37;n+=16;let r=t.getUint16(n,!1);n+=2;let i=e.slice(n,n+r);n+=r;let a=e.slice(n);if(!a.length)throw Error(`Credential public key missing from attestation data.`);return{credentialId:i,credentialPublicKey:a}}function u(e,t){if(e instanceof Map)return e.get(t);if(typeof e==`object`&&e){let n=e;return n[t]??n[String(t)]}}function d(e){if(e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer||Array.isArray(e))return new Uint8Array(e);throw Error(`Invalid COSE coordinate data.`)}function f(e){let t=d(u(e,-2)),n=d(u(e,-3));return{kty:`EC`,crv:`P-256`,x:r(t),y:r(n),ext:!0}}async function p(e){if(!o())throw Error(`WebAuthn is not available in this browser.`);let i=s(e);if(i)return i;let a=(await n(`KAS-1|phiKey|${e}`)).slice(0,16),u=crypto.getRandomValues(new Uint8Array(32)),d=await navigator.credentials.create({publicKey:{challenge:u,rp:{name:`Kai-Voh`,id:window.location.hostname},user:{id:a,name:e,displayName:e},pubKeyCredParams:[{type:`public-key`,alg:-7}],authenticatorSelection:{userVerification:`required`,residentKey:`required`,requireResidentKey:!0},timeout:6e4,attestation:`none`}});if(!d)throw Error(`Passkey creation was canceled or failed.`);let p=d.response,m=t(new Uint8Array(p.attestationObject)),h=m instanceof Map?m.get(`authData`):null;if(!h)throw Error(`Attestation missing authData.`);let g=f(t(l(h instanceof Uint8Array?h:h instanceof ArrayBuffer?new Uint8Array(h):(()=>{throw Error(`Attestation authData is not a byte array.`)})()).credentialPublicKey)),_={credId:r(new Uint8Array(d.rawId)),pubKeyJwk:g};return c(e,_),_}async function m(t,n){if(!o())throw Error(`WebAuthn is not available in this browser.`);let a=s(t);if(!a)throw Error(`No passkey found for this Î¦-Key. Please register first.`);let c=e(a.credId),l=i(n),u=l.slice(),d=c.slice(),f=await navigator.credentials.get({publicKey:{challenge:u,allowCredentials:[{id:d,type:`public-key`}],userVerification:`required`}});if(!f)throw Error(`Signature request was canceled or failed.`);let p=f.response;return{v:`KAS-1`,alg:`webauthn-es256`,credId:a.credId,pubKeyJwk:a.pubKeyJwk,challenge:r(l),signature:r(new Uint8Array(p.signature)),authenticatorData:r(new Uint8Array(p.authenticatorData)),clientDataJSON:r(new Uint8Array(p.clientDataJSON))}}function h(e,t){let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}function g(e){let t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(e),t}function _(e,t){if(e.length<8||e[0]!==48||e[1]+2!==e.length)return null;let n=2;if(e[n]!==2)return null;let r=e[n+1];n+=2;let i=e.slice(n,n+r);if(n+=r,e[n]!==2)return null;let a=e[n+1];n+=2;let o=e.slice(n,n+a),s=i[0]===0?i.slice(1):i,c=o[0]===0?o.slice(1):o;if(s.length>t||c.length>t)return null;let l=new Uint8Array(t*2);return l.set(s,t-s.length),l.set(c,t*2-c.length),l}async function v(e){return crypto.subtle.importKey(`jwk`,e,{name:`ECDSA`,namedCurve:`P-256`},!1,[`verify`])}async function y(t,a){try{let o=r(i(t));if(a.challenge!==o)return!1;let s=null;try{let t=e(a.clientDataJSON),n=new TextDecoder().decode(t);s=JSON.parse(n)}catch{return!1}if(!s||s.challenge!==o)return!1;let c=h(e(a.authenticatorData),await n(e(a.clientDataJSON))),l=e(a.signature),u=await v(a.pubKeyJwk);if(await crypto.subtle.verify({name:`ECDSA`,hash:`SHA-256`},u,g(l),g(c)))return!0;let d=_(l,32);return d?crypto.subtle.verify({name:`ECDSA`,hash:`SHA-256`},u,g(d),g(c)):!1}catch{return!1}}function b(){return o()}export{y as i,b as n,m as r,p as t};