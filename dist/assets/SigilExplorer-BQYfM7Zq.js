import{Bt as e,J as t,On as n,Pn as r,X as i,et as a,i as o,n as s,on as c,r as l,sn as u,t as d,zt as f}from"./index-CUbK5tzX.js";import{a as p,n as m,o as h,r as ee,t as te}from"./usernameClaimRegistry-51L_mFlg.js";var g=r(n(),1);const _=typeof window<`u`;(3+Math.sqrt(5))*1e3;var v=typeof window<`u`,y=v&&window.localStorage!==void 0;const b=`https://align.kaiklok.com`,x=`https://m.phi.network`;var S=b,C=x,w=`kai:lahmahtorBase:v1`,T=`kai:lahmahtorBackupDeadUntil:v1`,E=120*1e3,D=0;function O(){return Date.now()}function ne(){if(!y)return;let e=localStorage.getItem(T);if(!e)return;let t=Number(e);Number.isFinite(t)&&t>0&&(D=t)}function k(){if(y)try{localStorage.setItem(T,String(D))}catch{}}function A(){return O()<D}function re(){D!==0&&(D=0,k())}function ie(){D=O()+E,k(),j===C&&(j=S,oe())}var j=S;function ae(){if(!y)return;let e=localStorage.getItem(w);if(e===S){j=e;return}e===C&&(j=A()?S:e)}function oe(){if(y)try{localStorage.setItem(w,j)}catch{}}function se(){let e=j===C&&!A()?[C,S]:[S,C];if(!v)return A()?e.filter(e=>e!==C):e;let t=window.location.protocol===`https:`?e.filter(e=>e.startsWith(`https://`)):e;return A()?t.filter(e=>e!==C):t}function M(e){return e===0||e===404||e===408||e===429||e>=500}async function ce(e,t){let n=se(),r=null;for(let i of n){let n=e(i);try{let e=await fetch(n,t);if(r=e,e.ok||e.status===304)return i===C&&re(),j=i,oe(),e;if(i===C&&M(e.status)&&ie(),!M(e.status))return e}catch{i===C&&ie();continue}}return r}async function N(e,t){let n=await ce(e,t);if(!n)return{ok:!1,status:0};if(!n.ok)return{ok:!1,status:n.status};try{return{ok:!0,value:await n.json(),status:n.status}}catch{return{ok:!1,status:0}}}var le=`kai:urlHealth:v1`,ue=2200,de=typeof window<`u`,fe=de&&window.localStorage!==void 0;const P=new Map;function pe(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function me(){if(!fe)return;let e=localStorage.getItem(le);if(e)try{let t=JSON.parse(e);if(!pe(t))return;P.clear();for(let[e,n]of Object.entries(t))(n===1||n===-1)&&P.set(I(e),n)}catch{}}function he(){if(!fe)return;let e={};for(let[t,n]of P)e[t]=n;try{localStorage.setItem(le,JSON.stringify(e))}catch{}}function ge(e,t){let n=I(e);return P.get(n)===t?!1:(P.set(n,t),he(),!0)}function _e(e){let t=new URL(b).host,n=new URL(x).host,r=new URL(F()).host,i=new URL(ye).host;return e===t||e===n||e===r||e===i}async function ve(e){if(!de)return`unknown`;let t=L(e),n;try{if(n=new URL(t,F()),!_e(n.host))return`unknown`;if(n.pathname.toLowerCase()===`/stream`)return`ok`}catch{return`unknown`}try{let e=new AbortController,t=window.setTimeout(()=>e.abort(),ue),r=t=>fetch(n.toString(),{method:t,cache:`no-store`,signal:e.signal,redirect:`follow`,mode:`cors`}),i;try{i=await r(`HEAD`)}catch{i=await r(`GET`)}finally{window.clearTimeout(t)}return i.ok?`ok`:`bad`}catch{return`unknown`}}const ye=`https://phi.network`;function F(){return _?window.location.origin:ye}function I(e){try{let t=F(),n=new URL(e,t);return new URL(`${n.pathname}${n.search}${n.hash}`,t).toString()}catch{return e}}function be(e){try{let t=new URL(e,F()).pathname.match(/\/s\/([^/]+)/u);return t?.[1]?decodeURIComponent(t[1]):void 0}catch{return}}function xe(e){try{return new URL(e,F()).pathname.toLowerCase().startsWith(`/p~`)}catch{return e.toLowerCase().includes(`/p~`)}}function Se(e){try{return decodeURIComponent(e)}catch{return e}}function Ce(e){let t=e.trim();return t.length<16?!1:/^[A-Za-z0-9_-]+$/u.test(t)}function we(e){let t=F();return new URL(`/stream/p/${e}`,t).toString()}function Te(e){let t=F(),n=new URL(`/stream`,t),r=new URLSearchParams;return r.set(`p`,e),n.hash=`#${r.toString()}`,n.toString()}function Ee(e){try{let t=F(),n=new URL(e,t),r=n.pathname.match(/\/stream\/p\/([^/]+)/u);if(!r?.[1])return e;let i=decodeURIComponent(r[1]),a=new URL(`/stream`,t);a.search=n.search;let o=n.hash.startsWith(`#`)?n.hash.slice(1):``,s=new URLSearchParams(o);return s.set(`p`,i),a.hash=`#${s.toString()}`,a.toString()}catch{return e}}function De(e){try{let t=new URL(e,F()),n=t.pathname,r=n.match(/\/stream\/p\/([^/]+)/u);if(r?.[1])return decodeURIComponent(r[1]);let i=n.match(/^\/p~([^/]+)/u);if(i?.[1])return decodeURIComponent(i[1]);let a=t.searchParams.get(`p`);if(a)return a;let o=t.hash.startsWith(`#`)?t.hash.slice(1):``;return new URLSearchParams(o).get(`p`)||void 0}catch{let t=e.toLowerCase().match(/\/p~([^/?#]+)/u);return t?.[1]?Se(t[1]):void 0}}function L(e){let t=I(e);if(xe(t)){let e=De(t);return e?I(Te(e)):t}let n=Ee(t);return n===t?t:I(n)}function Oe(e){if(!_)return L(e);let t=L(e),n=window.location.origin;try{let e=new URL(t,n);return`${n}${e.pathname}${e.search}${e.hash}`}catch{let e=t.match(/^(?:https?:\/\/[^/]+)?(\/.*)$/i);return`${n}${(e?.[1]??t).startsWith(`/`)?e?.[1]??t:`/${e?.[1]??t}`}`}}const R=t,ke=i;function Ae(e){try{let t=new URL(e,F()),n=t.pathname.toLowerCase();if(n.includes(`/s/`))return`postS`;if(n.startsWith(`/p~`))return`streamP`;if(!n.includes(`/stream`))return`other`;if(n.includes(`/stream/p/`))return`streamP`;let r=t.searchParams.get(`t`);if(r&&r.trim())return`streamT`;let i=t.hash.startsWith(`#`)?t.hash.slice(1):``,a=new URLSearchParams(i),o=a.get(`t`);if(o&&o.trim()||n.includes(`/stream/t`))return`streamT`;let s=t.searchParams.get(`p`);if(s&&s.trim())return`streamQ`;let c=a.get(`p`);return c&&c.trim()?`streamQ`:`stream`}catch{let t=e.toLowerCase();return t.includes(`/s/`)?`postS`:t.includes(`/p~`)||t.includes(`/stream/p/`)?`streamP`:t.includes(`/stream/t`)||/[?&#]t=/.test(t)?`streamT`:t.includes(`/stream`)&&/[?&#]p=/.test(t)?`streamQ`:t.includes(`/stream`)?`stream`:`other`}}function je(e){let t=Ae(e);return t===`postS`?`post`:t.startsWith(`stream`)?`stream`:`other`}function Me(e){let t=e;return typeof t.userPhiKey==`string`&&t.userPhiKey||typeof t.phiKey==`string`&&t.phiKey||typeof t.phikey==`string`&&t.phikey||``}function Ne(e,t){let n=Me(t),r=Number.isFinite(t.pulse??NaN)?t.pulse:null;if(n&&r!=null)return`k:${n}|${r}`;let i=typeof t.kaiSignature==`string`?t.kaiSignature.trim():``;if(i)return`sig:${i}`;let a=De(e);if(a&&a.trim())return`tok:${a.trim()}`;let o=be(e)??``;return o?`h:${o}`:`u:${I(e)}`}function Pe(e,t){let n=je(e),r=be(e)??``;if(n===`post`&&r)return`post:${r}`;let i=Me(t),a=Number.isFinite(t.pulse??NaN)?t.pulse:null;if(n===`stream`&&i&&a!=null)return`stream:${i}|${a}`;let o=typeof t.kaiSignature==`string`?t.kaiSignature.trim():``;if(o)return`${n}:sig:${o}`;let s=De(e);return s&&s.trim()?`${n}:tok:${s.trim()}`:`${n}:u:${I(e)}`}var Fe=e=>{let t=e.toLowerCase();if(!t.includes(`/stream`))return!1;let n=t.includes(`root=`)||t.includes(`&seg=`)||t.includes(`&add=`),r=t.includes(`/stream#`)||t.includes(`#v=`);return n&&r};function z(e,t){if(xe(e))return-1e9;let n=e.toLowerCase(),r=Ae(e),i=0;Fe(n)&&(i-=1e4),t===`post`?r===`postS`?i+=220:i-=25:t===`stream`?r===`streamT`?i+=220:r===`streamP`?i+=190:r===`streamQ`?i+=175:r===`stream`?i+=160:r===`postS`?i+=80:i-=25:(r===`postS`&&(i+=120),r===`streamT`&&(i+=125),r===`streamP`&&(i+=105),(r===`streamQ`||r===`stream`)&&(i+=95));let a=F().toLowerCase();n.startsWith(a)&&(i+=12),n.startsWith(`https://align.kaiklok.com`)&&(i+=10),n.startsWith(`https://m.phi.network`)&&(i+=10);let o=P.get(I(e));return o===1&&(i+=200),o===-1&&(i-=200),i+=Math.max(0,20-Math.floor(e.length/40)),i}function Ie(e,t){let n=e.filter(e=>!xe(e)),r=n.length>0?n:e;if(n.length===0&&e.length>0){let t=De(e[0]??``);if(t)return I(Te(t))}let i=r[0]??``,a=-1e9;for(let e of r){let n=z(e,t);(n>a||n===a&&e.length<i.length)&&(i=e,a=n)}return i}function Le(e,t=10){return e?e.length<=t*2+3?e:`${e.slice(0,t)}…${e.slice(-t)}`:`—`}function Re(e,t){return(e.pulse??0)===(t.pulse??0)?(e.beat??0)===(t.beat??0)?(e.stepIndex??0)-(t.stepIndex??0):(e.beat??0)-(t.beat??0):(e.pulse??0)-(t.pulse??0)}function ze(e){return e.toFixed(6).replace(/0+$/u,``).replace(/\.$/u,``)}var Be=new Intl.NumberFormat(`en-US`,{minimumFractionDigits:2,maximumFractionDigits:2});function Ve(e){return Number.isFinite(e)?Be.format(e):`0.00`}function He(e){let t=e;for(let e of[`phiSent`,`sentPhi`,`phi_amount`,`amountPhi`,`phi`,`phiValue`,`phi_amount_sent`,`childAllocationPhi`,`branchBasePhi`]){let n=t[e];if(typeof n==`number`){if(!Number.isFinite(n)||Math.abs(n)<1e-12)continue;return n}if(typeof n==`string`){let e=Number(n);if(!Number.isNaN(e)&&Math.abs(e)>=1e-12)return e}}}var B=typeof window<`u`,Ue=200,We=180,Ge=1200,Ke=12e3;const qe=`kai:inhaleQueue:v1`;var V=new Map,H=null,Je=!1,Ye=0,Xe=B&&typeof window.matchMedia==`function`&&window.matchMedia(`(pointer: coarse)`).matches;function Ze(){return!B||!Xe||typeof document>`u`?!1:document.visibilityState===`visible`}function Qe(){if(!Ze())return;let e=()=>void U();typeof queueMicrotask==`function`?queueMicrotask(e):window.setTimeout(e,0)}function $e(){return B&&typeof window.crypto?.randomUUID==`function`?window.crypto.randomUUID():Math.random().toString(16).slice(2)}function et(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function tt(){if(B)try{let e=JSON.stringify([...V.entries()]);localStorage.setItem(qe,e)}catch{}}function nt(){if(!B)return;let e=localStorage.getItem(qe);if(e)try{let t=JSON.parse(e);if(!Array.isArray(t))return;V.clear();for(let e of t){if(!Array.isArray(e)||e.length!==2)continue;let[t,n]=e;typeof t!=`string`||!et(n)||V.set(I(t),n)}}catch{}}function rt(e){let t=e.url;if(typeof t!=`string`||!t.trim())return;let n=I(t.trim());V.set(n,{...e,url:n}),tt(),B&&(H!=null&&window.clearTimeout(H),H=window.setTimeout(()=>{H=null,U()},We),Qe())}function it(e,t){let n=I(e),r={url:n,...t};V.set(n,r),tt(),B&&(H!=null&&window.clearTimeout(H),H=window.setTimeout(()=>{H=null,U()},We),Qe())}function at(){for(let[e,t]of W){let n=I(e),r=t;V.set(n,{url:n,...r})}tt()}function ot(e){try{return decodeURIComponent(e)}catch{return e}}function st(e){try{let t=new URL(e,window.location.origin),n=t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n),i=[...t.searchParams.getAll(`add`),...r.getAll(`add`)],a=[];for(let e of i){let t=ot(String(e)).trim();if(!t)continue;if(Ce(t)){let e=I(we(t));a.includes(e)||a.push(e);continue}let n=I(t);if(xe(n)){let e=De(n);e&&(n=I(we(e)))}a.includes(n)||a.push(n)}return a.slice(-512)}catch{return[]}}function ct(e){let t=st(e);return t.length===0?{chain:[]}:{chain:t,originUrl:t[0],parentUrl:t[t.length-1]}}function lt(e,t){let n={...e};return t.originUrl&&!n.originUrl&&(n.originUrl=t.originUrl),t.parentUrl&&!n.parentUrl&&(n.parentUrl=t.parentUrl),n}function ut(e){for(let t of e){let e=I(t),n=W.get(e)??R(e);n&&it(e,lt(n,ct(e)))}U()}async function U(){if(B&&G()&&!Je&&V.size!==0){Je=!0;try{let e=[],t=[];for(let[n,r]of V)if(e.push(r),t.push(n),e.length>=Ue)break;let n=JSON.stringify(e),r=new Blob([n],{type:`application/json`}),i=new FormData;i.append(`file`,r,`sigils_${$e()}.json`);let a=await ce(e=>{let t=new URL(`/sigils/inhale`,e);return t.searchParams.set(`include_state`,`false`),t.searchParams.set(`include_urls`,`false`),t.toString()},{method:`POST`,body:i});if(!a||!a.ok)throw Error(`inhale failed: ${a?.status??0}`);try{await a.json()}catch{}for(let e of t)V.delete(e);tt(),Ye=0,V.size>0&&(H=window.setTimeout(()=>{H=null,U()},10))}catch{Ye=Math.min(Ye?Ye*2:Ge,Ke),H=window.setTimeout(()=>{H=null,U()},Ye)}finally{Je=!1}}}const dt=`kai:sigils:v1`,ft=`sigil:urls`;var pt=`kai-sigil-registry`,mt=512,ht=typeof window<`u`,gt=ht&&window.localStorage!==void 0;const W=new Map;var _t=ht&&`BroadcastChannel`in window?new BroadcastChannel(pt):null;function G(){return ht?typeof navigator>`u`?!0:navigator.onLine:!1}function vt(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function yt(e,t){if(!vt(e))return;let n=e[t];return typeof n==`string`&&n.trim()||void 0}function bt(e){try{return decodeURIComponent(e)}catch{return e}}function xt(e){try{let t=new URL(e,window.location.origin),n=t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n),i=[...t.searchParams.getAll(`add`),...r.getAll(`add`)],a=[];for(let e of i){let t=bt(String(e)).trim();if(!t)continue;if(Ce(t)){let e=I(we(t));a.includes(e)||a.push(e);continue}let n=I(t);if(xe(n)){let e=De(n);e&&(n=I(we(e)))}a.includes(n)||a.push(n)}return a.slice(-mt)}catch{return[]}}function St(e){let t=xt(e);return t.length===0?{chain:[]}:{chain:t,originUrl:t[0],parentUrl:t[t.length-1]}}function Ct(e,t){let n={...e};return t.originUrl&&!n.originUrl&&(n.originUrl=t.originUrl),t.parentUrl&&!n.parentUrl&&(n.parentUrl=t.parentUrl),n}function wt(e){let t=e,n=e.parentUrl,r=e.originUrl,i=yt(t,`parentHash`)??yt(t,`parentCanonical`);!n&&i&&(n=I(`/s/${i}`));let a=yt(t,`originHash`)??yt(t,`originCanonical`);return!r&&a&&(r=I(`/s/${a}`)),!r&&n&&(r=n),n===e.parentUrl&&r===e.originUrl?e:{...e,parentUrl:n,originUrl:r}}function Tt(e,t){let n=t.feed;if(!n)return;let r=n.usernameClaim,i=r?h(r.payload?.normalized||r.payload?.username||``):``,a=h(n.author??``),o=i||a;if(!o||!r)return;let s=p(r.hash??``),c=r.url?.trim()||e;if(!s||!c)return;let l=r.payload;if(!l||l.kind!==`username_claim`)return;let u=h(l.normalized||l.username||``)||o;if(u!==o)return;let d=r.ownerHint??l.ownerHint??null;m({hash:s,url:I(c),payload:{...l,normalized:u},ownerHint:d})}function Et(e,t){let n=I(e);Tt(n,t);let r=W.get(n);if(!r)return W.set(n,t),!0;let i=r.parentUrl??``,a=r.originUrl??``,o=t.parentUrl??``,s=t.originUrl??``,c=i!==o||a!==s,l=Object.keys(r).length,u=Object.keys(t).length!==l,d=Re(r,t)!==0;return c||u||d?(W.set(n,t),!0):!1}function Dt(e){let t=I(e),n=R(t);return n?Et(t,Ct(n,St(t))):!1}function Ot(e,t){if(e.length===0)return!1;let n=I(e[0]),r=!1;r=Dt(n)||r;{let e=W.get(n);if(e){let t={...e};t.originUrl||=n,r=Et(n,t)||r}}for(let t=1;t<e.length;t++){let i=I(e[t]),a=I(e[t-1]);r=Dt(i)||r;let o=W.get(i);if(o){let e={...o};e.originUrl||=n,e.parentUrl||=a,r=Et(i,e)||r}}let i=I(t),a=W.get(i);if(a){let t={...a};t.originUrl||=n,t.parentUrl||=I(e[e.length-1]),r=Et(i,t)||r}return r}function kt(){if(!gt)return;let e=Array.from(W.keys());try{localStorage.setItem(dt,JSON.stringify(e))}catch{}}function At(){if(!ht)return!1;let e=e=>{if(!e)return!1;try{let t=JSON.parse(e);if(!Array.isArray(t))return!1;let n=!1;for(let e of t)typeof e==`string`&&K(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`hydrate`,enqueueToApi:!1})&&(n=!0);return n}catch{return!1}},t=gt?e(localStorage.getItem(dt)):!1,n=gt?e(localStorage.getItem(ft)):!1,r=e(JSON.stringify(f()));return(t||n||r)&&kt(),t||n||r}function K(e,t){let n=I(e),r=R(n);if(!r)return!1;let i=t?.includeAncestry??!0,o=t?.broadcast??!0,s=t?.persist??!0,c=t?.source??`local`,l=t?.enqueueToApi??c===`local`,u=!1,d=St(n);if(u=Et(n,Ct(wt(r),d))||u,i&&d.chain.length>0){for(let e of d.chain)u=Dt(e)||u;u=Ot(d.chain,n)||u}if(i){let e=a(n);for(let t of e){let e=I(t),n=R(e);n&&(u=Et(e,Ct(n,St(e)))||u)}}if(u&&(s&&kt(),_t&&o&&_t.postMessage({type:`sigil:add`,url:n}),l)){let e=W.get(n);e&&it(n,e)}return u}function jt(e){let t=[],n=[],r=e=>{let n=I(e);t.includes(n)||t.push(n)};if(Array.isArray(e)){for(let i of e){if(typeof i==`string`){i.trim()&&r(i.trim());continue}if(vt(i)){let e=i.url;if(typeof e==`string`&&e.trim()){let r=I(e.trim());t.includes(r)||t.push(r),n.push({...i,url:r})}}}return{urls:t,rawKrystals:n}}if(vt(e)){let i=e.urls;if(Array.isArray(i))for(let e of i)typeof e==`string`&&e.trim()&&r(e.trim());let a=e.url;if(typeof a==`string`&&a.trim()){let r=I(a.trim());t.includes(r)||t.push(r),n.push({...e,url:r})}return{urls:t,rawKrystals:n}}return{urls:t,rawKrystals:n}}const Mt={root:`#ff3b3b`,sacral:`#ff8a3d`,solar:`#ffd54a`,heart:`#3dff9a`,throat:`#46d3ff`,thirdEye:`#6b6cff`,crown:`#c18bff`};function Nt(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`root`)?`root`:t.includes(`sacral`)?`sacral`:t.includes(`solar`)||t.includes(`plexus`)||t.includes(`sun`)?`solar`:t.includes(`heart`)?`heart`:t.includes(`throat`)?`throat`:t.includes(`third`)||t.includes(`eye`)||t.includes(`indigo`)?`thirdEye`:t.includes(`crown`)||t.includes(`krown`)||t.includes(`violet`)?`crown`:t===`1`?`root`:t===`2`?`sacral`:t===`3`?`solar`:t===`4`?`heart`:t===`5`?`throat`:t===`6`?`thirdEye`:t===`7`?`crown`:null:null}function Pt(e){let t=Nt(e),n=t?Mt[t]:`var(--sx-accent)`;return{"--sx-chakra":n}}var Ft=5e3,It=24;async function Lt(e){let t=0,n,r;for(let i=0;i<It;i++){let a=i*Ft,o=await N(e=>{let t=new URL(`/sigils/urls`,e);return t.searchParams.set(`offset`,String(a)),t.searchParams.set(`limit`,String(Ft)),t.toString()},{method:`GET`,signal:e,cache:`no-store`});if(!o.ok)break;n=o.value.state_seal,r=o.value.total;let s=o.value.urls;if(!Array.isArray(s)||s.length===0)break;for(let e of s){if(typeof e!=`string`)continue;let n=I(e);W.has(n)||K(n,{includeAncestry:!0,broadcast:!1,persist:!1,source:`remote`,enqueueToApi:!1})&&(t+=1)}if(s.length<Ft||r!=null&&a+s.length>=r)break}return t>0&&kt(),{imported:t,remoteSeal:n,remoteTotal:r}}function q(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function J(e){if(typeof e==`number`)return!Number.isFinite(e)||Math.abs(e)<1e-12?void 0:Math.abs(e);if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&Math.abs(t)>=1e-12)return Math.abs(t)}}function Rt(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`receive`)||t.includes(`received`)||t.includes(`inhale`)?`receive`:t.includes(`send`)||t.includes(`sent`)||t.includes(`exhale`)?`send`:null:null}function Y(e){if(typeof e==`number`)return!Number.isFinite(e)||e<=0?void 0:e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function X(e){if(typeof e==`number`&&Number.isFinite(e)&&e>0)return e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function zt(e){let t=e,n=q(t.feed)?t.feed:null,r=e=>e?Rt(e.phiDirection)||Rt(e.transferDirection)||Rt(e.transferMode)||Rt(e.transferKind):null,i=e=>{if(e)return e.phiDelta??e.phiSigned??e.phiChange},a=e=>e?J(e.transferAmountPhi)??J(e.transferPhi)??J(e.amountPhi)??J(e.phiAmount)??J(e.childAllocationPhi)??J(e.branchBasePhi):void 0,o=e=>e?Y(e.amountUsd)??Y(e.usdAmount)??Y(e.usdValue)??Y(e.valueUsd)??Y(e.usd):void 0,s=e=>e?Y(e.usdPerPhi)??Y(e.fxUsdPerPhi)??Y(e.usd_per_phi):void 0,c=e=>e?X(e.atPulse)??X(e.sentPulse)??X(e.senderKaiPulse)??X(e.transferPulse):void 0,l=r(t)??r(n),u=i(t)??i(n),d=typeof u==`number`?u:void 0;d===void 0&&typeof u==`string`&&(d=Number(u));let f=l??(typeof d==`number`&&Number.isFinite(d)?d>=0?`receive`:`send`:null);if(!f)return;let p=a(t)??a(n)??(q(t.preview)?J(t.preview.amountPhi):void 0)??(q(n?.preview)?J(n.preview.amountPhi):void 0)??(typeof d==`number`&&Number.isFinite(d)?Math.abs(d):void 0);if(p===void 0)return;let m=o(t)??o(n)??(q(t.preview)?Y(t.preview.amountUsd):void 0)??(q(n?.preview)?Y(n.preview.amountUsd):void 0),h=s(t)??s(n)??(q(t.preview)?Y(t.preview.usdPerPhi):void 0)??(q(n?.preview)?Y(n.preview.usdPerPhi):void 0),ee=c(t)??c(n)??(q(t.preview)?X(t.preview.atPulse):void 0)??(q(n?.preview)?X(n.preview.atPulse):void 0);return{direction:f,amount:p,amountUsd:m??(h===void 0?void 0:p*h),sentPulse:ee,source:`payload`}}function Bt(e){for(let t of[`transferUrl`,`transferURL`,`transferLink`,`transfer_link`,`sealUrl`,`sealURL`,`sigilTransferUrl`]){let n=e[t];if(typeof n!=`string`||!n.trim())continue;let r=R(n.trim());if(!r)continue;let i=zt(r);if(i)return i}}function Vt(e,t){if(!e)return;let n=t.get(e.toLowerCase());if(!n)return;let r=J(n.amountPhi);if(r!==void 0)return{direction:n.direction,amount:r,amountUsd:Y(n.amountUsd),sentPulse:X(n.sentPulse),source:`registry`}}function Ht(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function Ut(e,t){if(!Ht(e))return;let n=e[t];return typeof n==`string`&&n.trim().length>0?n.trim():void 0}function Wt(e){let t=new Map,n=new Map;for(let[r,i]of e){let e=I(r),a=je(e),o=Pe(e,i),s=Ne(e,i);t.set(e,o);let c=n.get(o);if(!c){n.set(o,{payload:i,urls:new Set([e]),kind:a,momentKey:s});continue}Re(i,c.payload)>0&&(c.payload=i),c.urls.add(e);let l=c.momentKey,u=s;l.startsWith(`u:`)&&!u.startsWith(`u:`)&&(c.momentKey=u),l.startsWith(`h:`)&&(u.startsWith(`k:`)||u.startsWith(`sig:`)||u.startsWith(`tok:`))&&(c.momentKey=u)}let r=new Map;for(let[e,t]of n){let n=Ie(Array.from(t.urls),t.kind);r.set(e,{id:e,payload:t.payload,urls:t.urls,primaryUrl:n,kind:t.kind,momentKey:t.momentKey})}let i=new Map;for(let e of r.values()){let t=e.momentKey;i.has(t)||i.set(t,[]),i.get(t).push(e.id)}let a=new Map,o=new Map,s=new Map;for(let[e,t]of i){let n=t.map(e=>r.get(e)).filter(Boolean),i=n.filter(e=>e.kind===`post`),c;c=i.length>0?i.slice().sort((e,t)=>z(t.primaryUrl,`post`)-z(e.primaryUrl,`post`))[0]:n.slice().sort((e,t)=>z(t.primaryUrl,t.kind)-z(e.primaryUrl,e.kind))[0];let l=c?.id??t[0];a.set(e,l);for(let e of t)o.set(e,l);for(let e of t){let t=r.get(e);if(t)for(let e of t.urls)s.set(e,l)}}let c=new Map;for(let e of r.values()){let n=o.get(e.id)??e.id;if(e.id!==n)continue;let r=Ut(e.payload,`originUrl`),i=r?I(r):ke(e.primaryUrl)??e.primaryUrl,a=t.get(i),l=s.get(i)??(a?o.get(a):void 0);c.set(n,l??n)}let l=new Map;for(let e of r.values()){let n=o.get(e.id)??e.id,r=c.get(n)??n,i;if(e.id!==n)i=n;else{let n=Ut(e.payload,`parentUrl`);if(n){let r=I(n),a=t.get(r),c=s.get(r)??(a?o.get(a):void 0);c&&c!==e.id&&(i=c)}}l.set(e.id,{id:e.id,payload:e.payload,urls:e.urls,primaryUrl:e.primaryUrl,kind:e.kind,momentKey:e.momentKey,parentId:i,originId:r,momentParentId:n})}return l}function Gt(e,t){let n=[];for(let[r,i]of t)i.parentId===e&&n.push(r);return n.sort((e,n)=>Re(t.get(n).payload,t.get(e).payload)),n}function Kt(e,t,n=new Set){let r=t.get(e);if(!r)return null;if(n.has(e))return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:[]};n.add(e);let i=Gt(e,t).map(e=>Kt(e,t,n)).filter(Boolean);return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:i}}function qt(e){let t=0,n=e.payload,r=e=>{t+=1,Re(e.payload,n)>0&&(n=e.payload),e.children.forEach(r)};return r(e),{nodeCount:t,latest:n}}function Jt(e){let t=Wt(e),n=new Map;for(let[e,r]of t){let t=r.originId;n.has(t)||n.set(t,[]),n.get(t).push(e)}let r=[];for(let e of n.keys()){let n=Kt(e,t);if(!n)continue;let i=qt(n);r.push({root:n,nodeCount:i.nodeCount,latest:i.latest})}return r.sort((e,t)=>{let n=Re(t.latest,e.latest);return n===0?t.nodeCount===e.nodeCount?Re(t.root.payload,e.root.payload):t.nodeCount-e.nodeCount:n}),r.map(e=>e.root)}function Yt(e){let t=e.payload;if(Ht(t)&&typeof t.canonicalHash==`string`)return t.canonicalHash;let n=be(e.url);if(n)return n;for(let t of e.urls){let e=be(t);if(e)return e;let n=R(t);if(!n)continue;let r=n;if(Ht(r)&&typeof r.canonicalHash==`string`)return r.canonicalHash}}var Z=r(u(),1),Q=typeof window<`u`,Xt=`sigil:explorer:open`,Zt=`sigil:explorer:bc:v1`,Qt=520,$t=900,en=80,tn=18,nn=3236,rn=2e3,an=`/phi.svg`;function $(){return Date.now()}function on(e){let t=(Q?window:null)?.CSS?.escape;return typeof t==`function`?t(e):e.replace(/["\\]/g,`\\$&`)}function sn(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function cn(e,t){return sn(e)&&typeof e[t]==`string`}function ln(e,t){let n=Vt(Yt(e),t);if(n)return n;let r=zt(e.payload);if(r)return r;let i=e.payload,a=Bt(i);if(a)return a;if(sn(i.feed)){let e=Bt(i.feed);if(e)return e}for(let t of e.urls){let e=R(t);if(!e)continue;let n=zt(e);if(n)return n;let r=Bt(e);if(r)return r}}function un(e,t,n){let r=e.payload,i=[],a=new Set,o=He(e.payload);o!==void 0&&i.push({label:`This glyph Φ`,value:`${ze(o)} Φ`});let s=ln(e,n);if(s){i.push({label:`Φ ${s.direction===`receive`?`Received`:`Sent`}`,value:`${s.direction===`receive`?`+`:`-`}${ze(s.amount)} Φ`}),s.amountUsd!==void 0&&i.push({label:`USD value`,value:`$${Ve(s.amountUsd)}`}),s.sentPulse!==void 0&&i.push({label:`Sent pulse`,value:String(s.sentPulse)});let e=s;cn(e,`txHash`)&&i.push({label:`Tx hash`,value:e.txHash})}let c=r.feed,l=typeof c?.author==`string`?c.author:typeof r.author==`string`?r.author:void 0,u=c?c.usernameClaim:void 0,d=u?h(u.payload?.normalized||u.payload?.username||``):``,f=h(l??``),p=d||f;if(p){let e=t[p],n=typeof l==`string`&&l.trim().length>0?l.trim():`@${p}`;e?(i.push({label:`Username (claimed)`,value:`${n} → glyph ${Le(e.claimHash,10)}`}),i.push({label:`Claim glyph`,value:L(e.claimUrl)})):i.push({label:`Username`,value:n})}let m=(e,t)=>{let n=r[e];typeof n==`string`&&n.trim().length>0&&!a.has(e)&&(i.push({label:t,value:n.trim()}),a.add(e))};m(`userPhiKey`,`PhiKey`),m(`phiKey`,`PhiKey`),m(`phikey`,`PhiKey`),m(`kaiSignature`,`Kai Signature`),typeof r.parentUrl==`string`&&r.parentUrl.length>0&&i.push({label:`Parent URL`,value:L(r.parentUrl)}),typeof r.originUrl==`string`&&r.originUrl.length>0&&i.push({label:`Origin URL`,value:L(r.originUrl)});let ee=r.label??r.title??r.type??r.note??r.description;typeof ee==`string`&&ee.trim().length>0&&i.push({label:`Label / Type`,value:ee.trim()}),i.push({label:`Primary URL`,value:L(e.url)});let te=e.urls.filter(e=>!xe(e)).map(e=>L(e));return e.urls.length>1&&i.push({label:`URL variants`,value:te.length===0?`${e.urls.length} urls (kept in data; hidden from browser view)`:te.length<=3?te.join(` | `):`${e.urls.length} urls (kept in data; rendered once)`}),i.slice(0,12)}async function dn(e){if(Q){try{if(navigator.clipboard&&typeof navigator.clipboard.writeText==`function`){await navigator.clipboard.writeText(e);return}}catch{}try{let t=document.createElement(`textarea`);t.value=e,t.setAttribute(`readonly`,`true`),t.style.position=`fixed`,t.style.left=`-9999px`,t.style.top=`-9999px`,document.body.appendChild(t),t.select(),document.execCommand(`copy`),document.body.removeChild(t)}catch{}}}async function fn(e){if(Q)try{await fetch(e,{method:`GET`,cache:`force-cache`,mode:`cors`,credentials:`omit`,redirect:`follow`})}catch{}}function pn({p:e}){let t=typeof e.pulse==`number`?e.pulse:0,n=typeof e.beat==`number`?e.beat:0,r=typeof e.stepIndex==`number`?e.stepIndex:0;return(0,Z.jsxs)(`span`,{className:`k-stamp`,title:`pulse ${t} • beat ${n} • step ${r}`,children:[(0,Z.jsxs)(`span`,{className:`k-pill`,children:[`☤KAI `,t]}),(0,Z.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,Z.jsxs)(`span`,{className:`k-pill`,children:[`beat `,n]}),(0,Z.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,Z.jsxs)(`span`,{className:`k-pill`,children:[`step `,r]})]})}function mn({node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a}){let o=t.has(e.id),s=Yt(e),c=e.payload.kaiSignature,l=e.payload.chakraDay,u=typeof e.payload.pulse==`number`?e.payload.pulse:void 0,d=u==null?void 0:r.get(u),f=Oe(e.url),p=o?un(e,i,a):[],m=ln(e,a);return(0,Z.jsxs)(`div`,{className:`node`,style:Pt(l),"data-chakra":String(l??``),"data-node-id":e.id,children:[(0,Z.jsxs)(`div`,{className:`node-row`,children:[(0,Z.jsxs)(`div`,{className:`node-main`,children:[(0,Z.jsx)(`button`,{className:`twirl`,"aria-label":o?`Collapse memories`:`Expand memories`,"aria-expanded":o,onClick:()=>n(e.id),title:o?`Collapse`:`Expand`,type:`button`,children:(0,Z.jsx)(`span`,{className:`tw ${o?`open`:``}`})}),(0,Z.jsx)(`a`,{className:`node-link`,href:f,target:`_blank`,rel:`noopener noreferrer`,title:f,children:(0,Z.jsx)(`span`,{children:Le(c??s??`glyph`,12)})})]}),(0,Z.jsxs)(`div`,{className:`node-meta`,children:[(0,Z.jsx)(pn,{p:e.payload}),l&&(0,Z.jsx)(`span`,{className:`chakra`,title:String(l),children:String(l)}),m&&(0,Z.jsxs)(`span`,{className:`phi-move phi-move--${m.direction}`,title:`Φ ${m.direction===`receive`?`received`:`sent`}: ${ze(m.amount)} Φ${m.amountUsd===void 0?``:` • $${Ve(m.amountUsd)}`}${m.sentPulse===void 0?``:` • sent pulse ${m.sentPulse}`}`,children:[(0,Z.jsx)(`img`,{className:`phi-move__mark`,src:an,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`lazy`,draggable:!1}),(0,Z.jsx)(`span`,{className:`phi-move__sign`,"aria-hidden":`true`,children:m.direction===`receive`?`+`:`-`}),(0,Z.jsxs)(`span`,{className:`phi-move__amount`,children:[ze(m.amount),` Φ`]}),m.amountUsd!==void 0&&(0,Z.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,Ve(m.amountUsd)]})]}),d!==void 0&&(0,Z.jsxs)(`span`,{className:`phi-pill`,title:`Total Φ on pulse ${e.payload.pulse??``}`,children:[`Φ pulse: `,ze(d),`Φ`]}),(0,Z.jsx)(`button`,{className:`node-copy`,"aria-label":`Copy URL`,onClick:()=>void dn(f),title:`Copy URL`,type:`button`,children:`⧉`})]})]}),o&&(0,Z.jsxs)(`div`,{className:`node-open`,children:[(0,Z.jsx)(`div`,{className:`node-detail`,children:p.length===0?(0,Z.jsx)(`div`,{className:`node-detail-empty`,children:`No additional memory fields recorded on this glyph.`}):(0,Z.jsx)(`div`,{className:`node-detail-grid`,children:p.map(e=>(0,Z.jsxs)(g.Fragment,{children:[(0,Z.jsx)(`div`,{className:`detail-label`,children:e.label}),(0,Z.jsx)(`div`,{className:`detail-value`,title:e.value,children:e.value})]},e.label))})}),e.children.length>0&&(0,Z.jsx)(`div`,{className:`node-children`,"aria-label":`Memory Imprints`,children:e.children.map(e=>(0,Z.jsx)(mn,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a},e.id))})]})]})}function hn({root:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a}){let o=(0,g.useMemo)(()=>{let t=0,n=e=>{t+=1,e.children.forEach(n)};return n(e),t},[e]),s=be(e.url),c=e.payload.kaiSignature,l=Oe(e.url),u=e.payload.chakraDay;return(0,Z.jsxs)(`section`,{className:`origin`,"aria-label":`Sigil origin stream`,style:Pt(u),"data-chakra":String(u??``),"data-node-id":e.id,children:[(0,Z.jsxs)(`header`,{className:`origin-head`,children:[(0,Z.jsxs)(`div`,{className:`o-meta`,children:[(0,Z.jsx)(`span`,{className:`o-title`,children:`Origin`}),(0,Z.jsx)(`a`,{className:`o-link`,href:l,target:`_blank`,rel:`noopener noreferrer`,title:l,children:Le(c??s??`origin`,14)}),u&&(0,Z.jsx)(`span`,{className:`o-chakra`,title:String(u),children:String(u)})]}),(0,Z.jsxs)(`div`,{className:`o-right`,children:[(0,Z.jsx)(pn,{p:e.payload}),(0,Z.jsxs)(`span`,{className:`o-count`,title:`Total content keys in this lineage`,children:[o,` keys`]}),(0,Z.jsx)(`button`,{className:`o-copy`,onClick:()=>void dn(l),title:`Copy origin URL`,type:`button`,children:`Remember Origin`})]})]}),(0,Z.jsx)(`div`,{className:`origin-body`,children:e.children.length===0?(0,Z.jsx)(`div`,{className:`kx-empty`,children:`No memories yet. The stream begins here.`}):(0,Z.jsx)(`div`,{className:`tree`,children:e.children.map(e=>(0,Z.jsx)(mn,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a},e.id))})})]})}function gn({onAdd:e,onImport:t,onExport:n,total:r,lastAdded:i}){let[a,o]=(0,g.useState)(``);return(0,Z.jsx)(`div`,{className:`kx-toolbar`,role:`region`,"aria-label":`Explorer toolbar`,children:(0,Z.jsxs)(`div`,{className:`kx-toolbar-inner`,children:[(0,Z.jsxs)(`div`,{className:`kx-brand`,children:[(0,Z.jsx)(`div`,{className:`kx-glyph`,"aria-hidden":!0,children:(0,Z.jsx)(`img`,{className:`kx-glyph__mark`,src:an,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`eager`,draggable:!1})}),(0,Z.jsxs)(`div`,{className:`kx-title`,children:[(0,Z.jsxs)(`h1`,{children:[`KAIROS `,(0,Z.jsx)(`span`,{children:`Keystream`})]}),(0,Z.jsx)(`div`,{className:`kx-tagline`,children:`Sovereign Lineage • No DB • Pure Φ`})]})]}),(0,Z.jsxs)(`div`,{className:`kx-controls`,children:[(0,Z.jsxs)(`form`,{className:`kx-add-form`,onSubmit:t=>{t.preventDefault(),a.trim()&&(e(a.trim()),o(``))},children:[(0,Z.jsx)(`input`,{className:`kx-input`,placeholder:`Inhale a sigil (or memory)…`,spellCheck:!1,value:a,onChange:e=>o(e.target.value),"aria-label":`Sigil Key`}),(0,Z.jsx)(`button`,{className:`kx-button`,type:`submit`,children:`Inhale`})]}),(0,Z.jsxs)(`div`,{className:`kx-io`,role:`group`,"aria-label":`Import and export`,children:[(0,Z.jsxs)(`label`,{className:`kx-import`,title:`Import a JSON list of Keys (or krystals)`,children:[(0,Z.jsx)(`input`,{type:`file`,accept:`application/json`,onChange:e=>{let n=e.target.files?.[0];n&&t(n)},"aria-label":`Import JSON`}),`Inhale`]}),(0,Z.jsx)(`button`,{className:`kx-export`,onClick:n,"aria-label":`Export registry to JSON`,type:`button`,children:`Exhale`})]}),(0,Z.jsxs)(`div`,{className:`kx-stats`,"aria-live":`polite`,children:[(0,Z.jsxs)(`span`,{className:`kx-pill`,title:`Total KEYS in registry (includes variants)`,children:[r,` KEYS`]}),i&&(0,Z.jsxs)(`span`,{className:`kx-pill subtle`,title:i,children:[`Last: `,Le(i,8)]})]})]})]})})}var _n=()=>{let[t,n]=(0,g.useState)(0),[r,i]=(0,g.useState)(0),[a,c]=(0,g.useState)(void 0),[l,u]=(0,g.useState)(()=>te()),f=(0,g.useRef)(!1),p=(0,g.useRef)(new Set),m=(0,g.useRef)(null),h=(0,g.useRef)(!1),_=(0,g.useRef)(null),v=(0,g.useRef)(0),y=(0,g.useRef)(null),b=(0,g.useRef)(!1),x=(0,g.useRef)(void 0),S=(0,g.useRef)([]),C=(0,g.useRef)(null),w=(0,g.useCallback)(e=>{let t=$()+e;t>v.current&&(v.current=t)},[]),T=(0,g.useCallback)(()=>{if(!Q||f.current)return;let e=$(),t=v.current-e;if(t>0){y.current!=null&&window.clearTimeout(y.current),y.current=window.setTimeout(()=>{y.current=null,T()},t+en);return}let r=S.current.splice(0);if(r.length>0&&(0,g.startTransition)(()=>{u(e=>{let t=e;for(let e of r){let n=t[e.normalized];n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===(e.originHash??n.originHash)&&n.ownerHint===(e.ownerHint??n.ownerHint)||(t={...t,[e.normalized]:{...n,normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash??n?.originHash,ownerHint:e.ownerHint??n?.ownerHint??null,updatedAt:n?.updatedAt??0}})}return t})}),x.current!==void 0){let e=x.current;x.current=void 0,(0,g.startTransition)(()=>c(e))}b.current&&(b.current=!1,(0,g.startTransition)(()=>n(e=>e+1)))},[w]),E=(0,g.useCallback)(()=>{if(!Q||y.current!=null)return;let e=$(),t=v.current-e,n=Math.max(0,t)+en;y.current=window.setTimeout(()=>{y.current=null,T()},n)},[T]),D=(0,g.useCallback)(()=>{if(!f.current){if($()<v.current||h.current){b.current=!0,E();return}(0,g.startTransition)(()=>n(e=>e+1))}},[E]),O=(0,g.useCallback)(e=>{if(!f.current){if($()<v.current||h.current){x.current=e,E();return}(0,g.startTransition)(()=>c(e))}},[E]),k=(0,g.useRef)(null),[A,re]=(0,g.useState)(()=>new Set),ie=(0,g.useCallback)(e=>{w($t);let t=m.current;if(t){let n=`[data-node-id="${on(e)}"]`,r=t.querySelector(n);k.current={id:e,scrollTop:t.scrollTop,rectTop:r?r.getBoundingClientRect().top:0}}re(t=>{let n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n}),E()},[w,E]);(0,g.useEffect)(()=>{if(!Q)return;let e=document.documentElement,t=document.body,n=document.scrollingElement||document.documentElement,r={htmlOverscroll:e?.style.overscrollBehavior??``,htmlOverscrollY:e?.style.overscrollBehaviorY??``,bodyOverscroll:t?.style.overscrollBehavior??``,bodyOverscrollY:t?.style.overscrollBehaviorY??``,rootOverscroll:n?.style.overscrollBehavior??``,rootOverscrollY:n?.style.overscrollBehaviorY??``};return e&&(e.style.overscrollBehavior=`none`,e.style.overscrollBehaviorY=`none`),t&&(t.style.overscrollBehavior=`none`,t.style.overscrollBehaviorY=`none`),n&&(n.style.overscrollBehavior=`none`,n.style.overscrollBehaviorY=`none`),()=>{e&&(e.style.overscrollBehavior=r.htmlOverscroll,e.style.overscrollBehaviorY=r.htmlOverscrollY),t&&(t.style.overscrollBehavior=r.bodyOverscroll,t.style.overscrollBehaviorY=r.bodyOverscrollY),n&&(n.style.overscrollBehavior=r.rootOverscroll,n.style.overscrollBehaviorY=r.rootOverscrollY)}},[]),(0,g.useEffect)(()=>{if(!Q)return;let e=m.current;if(!e)return;let t=0,n=0,r=e=>{e.touches.length===1&&(t=e.touches[0]?.clientY??0,n=e.touches[0]?.clientX??0)},i=r=>{if(!r.cancelable||r.touches.length!==1)return;let i=r.touches[0]?.clientY??0,a=r.touches[0]?.clientX??0,o=i-t,s=a-n;if(t=i,n=a,Math.abs(o)<=Math.abs(s))return;let c=e.scrollHeight-e.clientHeight;if(c<=0)return;let l=e.scrollTop<=0,u=e.scrollTop>=c-1,d=o>0,f=o<0;(l&&d&&window.scrollY<=0||u&&f)&&r.preventDefault()};return e.addEventListener(`touchstart`,r,{passive:!0}),e.addEventListener(`touchmove`,i,{passive:!1}),()=>{e.removeEventListener(`touchstart`,r),e.removeEventListener(`touchmove`,i)}},[]),(0,g.useEffect)(()=>{if(!Q)return;let e=m.current;if(!e)return;let t=()=>{h.current=!0,w(Qt),_.current!=null&&window.clearTimeout(_.current),_.current=window.setTimeout(()=>{h.current=!1,_.current=null,E()},180)};return e.addEventListener(`scroll`,t,{passive:!0}),()=>{e.removeEventListener(`scroll`,t),_.current!=null&&window.clearTimeout(_.current),_.current=null,h.current=!1}},[w,E]),(0,g.useLayoutEffect)(()=>{let e=k.current;if(!e)return;k.current=null;let t=m.current;if(!t)return;let n=`[data-node-id="${on(e.id)}"]`,r=t.querySelector(n);if(!r)return;let i=r.getBoundingClientRect().top-e.rectTop;Number.isFinite(i)&&Math.abs(i)>1&&(t.scrollTop=Math.max(0,e.scrollTop+i))},[A]);let j=(0,g.useRef)(null),oe=(0,g.useRef)(!1),se=(0,g.useRef)(null);(0,g.useEffect)(()=>{if(f.current=!1,ne(),ae(),me(),nt(),At()&&D(),Q){let e=I(window.location.href);if(R(e)){let t=K(e,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0});O(L(e)),t&&D()}}let t=window.__SIGIL__?.registerSigilUrl,n=window.__SIGIL__?.registerSend;window.__SIGIL__||(window.__SIGIL__={}),window.__SIGIL__.registerSigilUrl=e,window.__SIGIL__.registerSend=e=>{if(!e||typeof e!=`object`)return;let t=e.url;typeof t!=`string`||!t.trim()||K(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(O(L(t)),D())};let r=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&K(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(O(L(t)),D())};window.addEventListener(`sigil:url-registered`,r);let a=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&K(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(O(L(t)),D())};window.addEventListener(`sigil:minted`,a);let o=Q&&`BroadcastChannel`in window?new BroadcastChannel(Zt):null,c=e=>{let t=e.data;t?.type===`sigil:add`&&typeof t.url==`string`&&K(t.url,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0})&&(O(L(t.url)),D())};o?.addEventListener(`message`,c);let l=e=>{if(!e.key)return;let t=e.key===dt,n=e.key===ft;if(e.key===`kai:sigil-transfer:v1`){i(e=>e+1);return}if(!(!t&&!n)&&e.newValue)try{let t=JSON.parse(e.newValue);if(!Array.isArray(t))return;let n=!1;for(let e of t)typeof e==`string`&&K(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:!0})&&(n=!0);O(void 0),n&&(kt(),D())}catch{}};window.addEventListener(`storage`,l);let p=()=>i(e=>e+1);window.addEventListener(s,p);let m=Q&&`BroadcastChannel`in window?new BroadcastChannel(d):null,te=e=>{e.data?.type===`transfer:update`&&i(e=>e+1)};m?.addEventListener(`message`,te);let _=()=>{tt(),U()};window.addEventListener(`pagehide`,_);let b=ee(e=>{if($()<v.current||h.current){S.current.push({normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash,ownerHint:e.ownerHint}),E();return}(0,g.startTransition)(()=>{u(t=>{let n=t[e.normalized];return n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===e.originHash&&n.ownerHint===e.ownerHint?t:{...t,[e.normalized]:e}})})}),x=new AbortController,w=async e=>{f.current||G()&&(h.current||$()<v.current&&(e===`pulse`||e===`import`)||await U())},T=async e=>{if(!f.current&&G()&&!oe.current&&!h.current&&!($()<v.current&&(e===`pulse`||e===`import`))){oe.current=!0;try{let t=j.current,n=await ce(e=>new URL(`/sigils/seal`,e).toString(),{method:`GET`,cache:`no-store`,signal:x.signal,headers:void 0});if(!n||n.status===304||!n.ok)return;let r=``;try{let e=await n.json();r=typeof e?.seal==`string`?e.seal:``}catch{return}if(t&&r&&t===r){j.current=r;return}let i=await Lt(x.signal);j.current=i.remoteSeal??r??t??null,i.imported>0&&(O(void 0),D());let a=j.current;(e===`open`||(e===`visible`||e===`focus`||e===`online`||e===`import`)&&a!==se.current)&&(at(),se.current=a,await U())}finally{oe.current=!1}}};C.current=T,at(),w(`open`),T(`open`);let k=null,A=null,re=()=>{Q&&(f.current||(k!=null&&window.clearInterval(k),k=window.setInterval(()=>{document.visibilityState===`visible`&&G()&&w(`pulse`)},nn)))},ie=()=>{Q&&(f.current||(A!=null&&window.clearInterval(A),A=window.setInterval(()=>{document.visibilityState===`visible`&&G()&&T(`pulse`)},rn)))},M=()=>{re(),ie()};M();let N=()=>{document.visibilityState===`visible`&&(M(),w(`visible`),T(`visible`))};document.addEventListener(`visibilitychange`,N);let le=()=>{M(),w(`focus`),T(`focus`)},ue=()=>{M(),w(`online`),T(`online`)};return window.addEventListener(`focus`,le),window.addEventListener(`online`,ue),()=>{window.__SIGIL__&&(window.__SIGIL__.registerSigilUrl=t,window.__SIGIL__.registerSend=n),window.removeEventListener(`sigil:url-registered`,r),window.removeEventListener(`sigil:minted`,a),window.removeEventListener(`storage`,l),window.removeEventListener(s,p),m?.removeEventListener(`message`,te),m?.close(),window.removeEventListener(`pagehide`,_),window.removeEventListener(`focus`,le),window.removeEventListener(`online`,ue),document.removeEventListener(`visibilitychange`,N),o?.removeEventListener(`message`,c),o?.close(),typeof b==`function`&&b(),y.current!=null&&window.clearTimeout(y.current),y.current=null,k!=null&&window.clearInterval(k),k=null,A!=null&&window.clearInterval(A),A=null,x.abort(),C.current=null,f.current=!0}},[D,w,E,O]);let M=(0,g.useCallback)(e=>{let t=C.current;t&&t(e)},[]);(0,g.useEffect)(()=>{if(!Q)return;let e=()=>M(`visible`);return window.addEventListener(Xt,e),()=>window.removeEventListener(Xt,e)},[M]);let N=(0,g.useMemo)(()=>Jt(W),[t]),le=(0,g.useMemo)(()=>o(),[r]),ue=(0,g.useMemo)(()=>{let e=0;for(let[,]of W)e+=1;return e},[t]),de=(0,g.useMemo)(()=>{let e=new Map,t=new Map;for(let[n,r]of W){let i=typeof r.pulse==`number`?r.pulse:void 0;if(i==null)continue;let a=Ne(I(n),r),o=t.get(i);if(o||(o=new Set,t.set(i,o)),o.has(a))continue;o.add(a);let s=He(r);s!==void 0&&e.set(i,(e.get(i)??0)+s)}return e},[t]),fe=(0,g.useMemo)(()=>{let e=[];for(let[t]of W){let n=I(Oe(t));e.includes(n)||e.push(n)}return e},[t]);(0,g.useEffect)(()=>{if(!Q||fe.length===0)return;let e=fe.filter(e=>!p.current.has(e));if(e.length===0)return;let t=!1,n=async()=>{for(let n of e){if(t)break;p.current.add(n),await fn(n)}},r=window,i=null;if(typeof r.requestIdleCallback==`function`){let e=r.requestIdleCallback(()=>void n(),{timeout:1e3});i=()=>r.cancelIdleCallback?.(e)}else{let e=window.setTimeout(()=>void n(),120);i=()=>window.clearTimeout(e)}return()=>{t=!0,i?.()}},[fe]);let pe=(0,g.useCallback)(async()=>{if(!Q||h.current||!G()||$()<v.current)return;let e=[],t=n=>{if(n.urls.length>1){let t=je(n.url),r=[...n.urls].map(e=>I(L(e))).filter((e,t,n)=>n.indexOf(e)===t).sort((e,n)=>z(n,t)-z(e,t));for(let t of r.slice(0,2)){let n=I(t);!P.has(n)&&!e.includes(n)&&e.push(n)}}n.children.forEach(t)};for(let e of N)t(e);if(e.length!==0)for(let t of e.slice(0,tn)){let e=await ve(t);e===`ok`&&ge(t,1),e===`bad`&&ge(t,-1)}},[N]);(0,g.useEffect)(()=>{if(!Q)return;let e=!1,t=()=>{e||pe()},n=window,r=null;if(typeof n.requestIdleCallback==`function`){let e=n.requestIdleCallback(t,{timeout:900});r=()=>n.cancelIdleCallback?.(e)}else{let e=window.setTimeout(t,250);r=()=>window.clearTimeout(e)}return()=>{e=!0,r?.()}},[t,pe]);let he=(0,g.useCallback)(e=>{w($t),K(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(O(L(e)),D())},[D,w,O]),_e=(0,g.useCallback)(async e=>{w($t);let t=await e.text(),{urls:n,rawKrystals:r}=jt(JSON.parse(t));if(n.length===0&&r.length===0)return;let i=!1;for(let e of r)rt(e);for(let e of n)K(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`import`,enqueueToApi:!0})&&(i=!0);n.length>0&&ut(n),i&&(O(void 0),D()),M(`import`)},[D,w,M,O]),ye=(0,g.useCallback)(()=>{w($t);let e=[];for(let[t]of W)e.push(t);let t=new Blob([JSON.stringify({urls:e},null,2)],{type:`application/json`}),n=document.createElement(`a`);n.href=URL.createObjectURL(t),n.download=`sigil-registry-${Date.now()}.json`,n.click(),URL.revokeObjectURL(n.href)},[w]);return(0,Z.jsxs)(`div`,{className:`sigil-explorer`,"aria-label":`Kairos Keystream Explorer`,children:[(0,Z.jsx)(gn,{onAdd:he,onImport:_e,onExport:ye,total:ue,lastAdded:a}),(0,Z.jsx)(`div`,{className:`explorer-scroll`,ref:m,role:`region`,"aria-label":`Explorer scroll viewport`,children:(0,Z.jsxs)(`div`,{className:`explorer-inner`,children:[N.length===0?(0,Z.jsxs)(`div`,{className:`kx-empty`,children:[(0,Z.jsx)(`p`,{children:`No sigil-glyphs in your keystream yet.`}),(0,Z.jsxs)(`ol`,{children:[(0,Z.jsx)(`li`,{children:`Import your keystream memories.`}),(0,Z.jsx)(`li`,{children:`Seal a moment — auto-registered here.`}),(0,Z.jsx)(`li`,{children:`Inhale any sigil-glyph or memory key above — lineage aligns instantly.`})]})]}):(0,Z.jsx)(`div`,{className:`forest`,"aria-label":`Sigil forest`,children:N.map(e=>(0,Z.jsx)(hn,{root:e,expanded:A,toggle:ie,phiTotalsByPulse:de,usernameClaims:l,transferRegistry:le},e.id))}),(0,Z.jsx)(`footer`,{className:`kx-footer`,"aria-label":`Explorer footer`,children:(0,Z.jsxs)(`span`,{className:`row`,children:[(0,Z.jsx)(`span`,{children:`Determinate • Stateless • Kairos-Memory`}),(0,Z.jsx)(`span`,{className:`dot`,children:`•`}),(0,Z.jsx)(`span`,{children:G()?`online`:`offline`}),(0,Z.jsx)(`span`,{className:`dot`,children:`•`}),(0,Z.jsxs)(`span`,{children:[ue,` keys`]})]})})]})})]})};export{_n as default};