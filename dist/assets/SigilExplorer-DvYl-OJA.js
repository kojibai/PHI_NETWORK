import{At as e,Bt as t,Ct as n,Dt as r,Er as i,Et as a,Ft as o,Gt as s,Ht as c,It as l,Jt as u,Kt as d,Lt as f,Mr as p,Mt as m,Nt as h,Ot as g,Pt as _,Rt as v,St as y,Tt as b,Ut as ee,Vt as x,Wt as S,Xt as te,Yt as ne,Zt as re,_t as C,bt as w,dt as ie,ft as ae,gt as T,hn as oe,ht as se,i as ce,jt as E,kt as le,mt as D,n as ue,pn as O,pt as de,qt as fe,r as k,t as pe,ut as A,vn as j,vt as me,wt as he,xt as ge,yt as _e,zt as ve}from"./index-BUOThiBr.js";import{n as M}from"./kaiMath-C4GPq5jA.js";var N=p(i(),1);const P={root:`#ff3b3b`,sacral:`#ff8a3d`,solar:`#ffd54a`,heart:`#3dff9a`,throat:`#46d3ff`,thirdEye:`#6b6cff`,crown:`#c18bff`};function F(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`root`)?`root`:t.includes(`sacral`)?`sacral`:t.includes(`solar`)||t.includes(`plexus`)||t.includes(`sun`)?`solar`:t.includes(`heart`)?`heart`:t.includes(`throat`)?`throat`:t.includes(`third`)||t.includes(`eye`)||t.includes(`indigo`)?`thirdEye`:t.includes(`crown`)||t.includes(`krown`)||t.includes(`violet`)?`crown`:t===`1`?`root`:t===`2`?`sacral`:t===`3`?`solar`:t===`4`?`heart`:t===`5`?`throat`:t===`6`?`thirdEye`:t===`7`?`crown`:null:null}function I(e){let t=F(e),n=t?P[t]:`var(--sx-accent)`;return{"--sx-chakra":n}}function L(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function R(e){if(typeof e==`number`)return!Number.isFinite(e)||Math.abs(e)<1e-12?void 0:Math.abs(e);if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&Math.abs(t)>=1e-12)return Math.abs(t)}}function z(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`receive`)||t.includes(`received`)||t.includes(`inhale`)?`receive`:t.includes(`send`)||t.includes(`sent`)||t.includes(`exhale`)?`send`:null:null}function B(e){if(typeof e==`number`)return!Number.isFinite(e)||e<=0?void 0:e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function V(e){if(typeof e==`number`&&Number.isFinite(e)&&e>0)return e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function H(e){let t=e,n=L(t.feed)?t.feed:null,r=e=>e?z(e.phiDirection)||z(e.transferDirection)||z(e.transferMode)||z(e.transferKind):null,i=e=>{if(e)return e.phiDelta??e.phiSigned??e.phiChange},a=e=>e?R(e.transferAmountPhi)??R(e.transferPhi)??R(e.amountPhi)??R(e.phiAmount)??R(e.childAllocationPhi)??R(e.branchBasePhi):void 0,o=e=>e?B(e.amountUsd)??B(e.usdAmount)??B(e.usdValue)??B(e.valueUsd)??B(e.usd):void 0,s=e=>e?B(e.usdPerPhi)??B(e.fxUsdPerPhi)??B(e.usd_per_phi):void 0,c=e=>e?V(e.atPulse)??V(e.sentPulse)??V(e.senderKaiPulse)??V(e.transferPulse):void 0,l=r(t)??r(n),u=i(t)??i(n),d=typeof u==`number`?u:void 0;d===void 0&&typeof u==`string`&&(d=Number(u));let f=l??(typeof d==`number`&&Number.isFinite(d)?d>=0?`receive`:`send`:null);if(!f)return;let p=a(t)??a(n)??(L(t.preview)?R(t.preview.amountPhi):void 0)??(L(n?.preview)?R(n.preview.amountPhi):void 0)??(typeof d==`number`&&Number.isFinite(d)?Math.abs(d):void 0);if(p===void 0)return;let m=o(t)??o(n)??(L(t.preview)?B(t.preview.amountUsd):void 0)??(L(n?.preview)?B(n.preview.amountUsd):void 0),h=s(t)??s(n)??(L(t.preview)?B(t.preview.usdPerPhi):void 0)??(L(n?.preview)?B(n.preview.usdPerPhi):void 0),g=c(t)??c(n)??(L(t.preview)?V(t.preview.atPulse):void 0)??(L(n?.preview)?V(n.preview.atPulse):void 0);return{direction:f,amount:p,amountUsd:m??(h===void 0?void 0:p*h),sentPulse:g,source:`payload`}}function U(e){for(let t of[`transferUrl`,`transferURL`,`transferLink`,`transfer_link`,`sealUrl`,`sealURL`,`sigilTransferUrl`]){let n=e[t];if(typeof n!=`string`||!n.trim())continue;let r=l(n.trim());if(!r)continue;let i=H(r);if(i)return i}}function ye(e,t){if(!e)return;let n=t.get(e.toLowerCase());if(!n)return;let r=R(n.amountPhi);if(r!==void 0)return{direction:n.direction,amount:r,amountUsd:B(n.amountUsd),sentPulse:V(n.sentPulse),source:`registry`}}function W(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function be(e,t){if(!W(e))return;let n=e[t];return typeof n==`string`&&n.trim().length>0?n.trim():void 0}function G(e){let t=new Map,n=new Map;for(let[r,i]of e){let e=m(r),o=_(e),s=h(e,i),c=ve(e,i);t.set(e,s);let l=n.get(s);if(!l){n.set(s,{payload:i,urls:new Set([e]),kind:o,momentKey:c});continue}a(i,l.payload)>0&&(l.payload=i),l.urls.add(e);let u=l.momentKey,d=c;u.startsWith(`u:`)&&!d.startsWith(`u:`)&&(l.momentKey=d),u.startsWith(`h:`)&&(d.startsWith(`k:`)||d.startsWith(`sig:`)||d.startsWith(`tok:`))&&(l.momentKey=d)}let r=new Map;for(let[e,t]of n){let n=x(Array.from(t.urls),t.kind);r.set(e,{id:e,payload:t.payload,urls:t.urls,primaryUrl:n,kind:t.kind,momentKey:t.momentKey})}let i=new Map;for(let e of r.values()){let t=e.momentKey;i.has(t)||i.set(t,[]),i.get(t).push(e.id)}let o=new Map,s=new Map,l=new Map;for(let[e,t]of i){let n=t.map(e=>r.get(e)).filter(Boolean),i=n.filter(e=>e.kind===`post`),a;a=i.length>0?i.slice().sort((e,t)=>c(t.primaryUrl,`post`)-c(e.primaryUrl,`post`))[0]:n.slice().sort((e,t)=>c(t.primaryUrl,t.kind)-c(e.primaryUrl,e.kind))[0];let u=a?.id??t[0];o.set(e,u);for(let e of t)s.set(e,u);for(let e of t){let t=r.get(e);if(t)for(let e of t.urls)l.set(e,u)}}let u=new Map;for(let e of r.values()){let n=s.get(e.id)??e.id;if(e.id!==n)continue;let r=be(e.payload,`originUrl`),i=r?m(r):f(e.primaryUrl)??e.primaryUrl,a=t.get(i),o=l.get(i)??(a?s.get(a):void 0);u.set(n,o??n)}let d=new Map;for(let e of r.values()){let n=s.get(e.id)??e.id,r=u.get(n)??n,i;if(e.id!==n)i=n;else{let n=be(e.payload,`parentUrl`);if(n){let r=m(n),a=t.get(r),o=l.get(r)??(a?s.get(a):void 0);o&&o!==e.id&&(i=o)}}d.set(e.id,{id:e.id,payload:e.payload,urls:e.urls,primaryUrl:e.primaryUrl,kind:e.kind,momentKey:e.momentKey,parentId:i,originId:r,momentParentId:n})}return d}function K(e,t){let n=[];for(let[r,i]of t)i.parentId===e&&n.push(r);return n.sort((e,n)=>a(t.get(n).payload,t.get(e).payload)),n}function xe(e,t,n=new Set){let r=t.get(e);if(!r)return null;if(n.has(e))return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:[]};n.add(e);let i=K(e,t).map(e=>xe(e,t,n)).filter(Boolean);return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:i}}function q(e){let t=0,n=e.payload,r=e=>{t+=1,a(e.payload,n)>0&&(n=e.payload),e.children.forEach(r)};return r(e),{nodeCount:t,latest:n}}function Se(e){let t=G(e),n=new Map;for(let[e,r]of t){let t=r.originId;n.has(t)||n.set(t,[]),n.get(t).push(e)}let r=[];for(let e of n.keys()){let n=xe(e,t);if(!n)continue;let i=q(n);r.push({root:n,nodeCount:i.nodeCount,latest:i.latest})}return r.sort((e,t)=>{let n=a(t.latest,e.latest);return n===0?t.nodeCount===e.nodeCount?a(t.root.payload,e.root.payload):t.nodeCount-e.nodeCount:n}),r.map(e=>e.root)}function J(e){let n=e.payload;if(W(n)&&typeof n.canonicalHash==`string`)return n.canonicalHash;let r=t(e.url);if(r)return r;for(let n of e.urls){let e=t(n);if(e)return e;let r=l(n);if(!r)continue;let i=r;if(W(i)&&typeof i.canonicalHash==`string`)return i.canonicalHash}}var Y=p(A(),1),X=typeof window<`u`,Ce=`sigil:explorer:open`,we=`sigil:explorer:bc:v1`,Te=520,Ee=900,De=80,Z=80,Oe=18,ke=3236,Ae=2e3;function je(){let e;for(let[,t]of C){let n=t.pulse;typeof n!=`number`||!Number.isFinite(n)||(e==null||n>e)&&(e=n)}return e}function Me(e){let t=e?.pulse??e?.latestPulse??e?.latest_pulse;if(!(typeof t!=`number`||!Number.isFinite(t)))return t}var Ne=`/phi.svg`;function Q(){return Date.now()}function Pe(){return X?new Promise(e=>{if(typeof window.requestAnimationFrame==`function`){window.requestAnimationFrame(()=>e());return}window.setTimeout(e,0)}):Promise.resolve()}function Fe(e){let t=(X?window:null)?.CSS?.escape;return typeof t==`function`?t(e):e.replace(/["\\]/g,`\\$&`)}function Ie(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function Le(e,t){return Ie(e)&&typeof e[t]==`string`}function $(e,t){let n=ye(J(e),t);if(n)return n;let r=H(e.payload);if(r)return r;let i=e.payload,a=U(i);if(a)return a;if(Ie(i.feed)){let e=U(i.feed);if(e)return e}for(let t of e.urls){let e=l(t);if(!e)continue;let n=H(e);if(n)return n;let r=U(e);if(r)return r}}function Re(t,n,i){let a=t.payload,o=[],s=new Set,c=le(t.payload);c!==void 0&&o.push({label:`This glyph Φ`,value:`${r(c)} Φ`});let l=$(t,i);if(l){o.push({label:`Φ ${l.direction===`receive`?`Received`:`Sent`}`,value:`${l.direction===`receive`?`+`:`-`}${r(l.amount)} Φ`}),l.amountUsd!==void 0&&o.push({label:`USD value`,value:`$${g(l.amountUsd)}`}),l.sentPulse!==void 0&&o.push({label:`Sent pulse`,value:String(l.sentPulse)});let e=l;Le(e,`txHash`)&&o.push({label:`Tx hash`,value:e.txHash})}let u=a.feed,d=typeof u?.author==`string`?u.author:typeof a.author==`string`?a.author:void 0,f=u?u.usernameClaim:void 0,p=f?j(f.payload?.normalized||f.payload?.username||``):``,m=j(d??``),h=p||m;if(h){let t=n[h],r=typeof d==`string`&&d.trim().length>0?d.trim():`@${h}`;t?(o.push({label:`Username (claimed)`,value:`${r} → glyph ${e(t.claimHash,10)}`}),o.push({label:`Claim glyph`,value:E(t.claimUrl)})):o.push({label:`Username`,value:r})}let _=(e,t)=>{let n=a[e];typeof n==`string`&&n.trim().length>0&&!s.has(e)&&(o.push({label:t,value:n.trim()}),s.add(e))};_(`userPhiKey`,`PhiKey`),_(`phiKey`,`PhiKey`),_(`phikey`,`PhiKey`),_(`kaiSignature`,`Kai Signature`),typeof a.parentUrl==`string`&&a.parentUrl.length>0&&o.push({label:`Parent URL`,value:E(a.parentUrl)}),typeof a.originUrl==`string`&&a.originUrl.length>0&&o.push({label:`Origin URL`,value:E(a.originUrl)});let y=a.label??a.title??a.type??a.note??a.description;typeof y==`string`&&y.trim().length>0&&o.push({label:`Label / Type`,value:y.trim()}),o.push({label:`Primary URL`,value:E(t.url)});let b=t.urls.filter(e=>!v(e)).map(e=>E(e));return t.urls.length>1&&o.push({label:`URL variants`,value:b.length===0?`${t.urls.length} urls (kept in data; hidden from browser view)`:b.length<=3?b.join(` | `):`${t.urls.length} urls (kept in data; rendered once)`}),o.slice(0,12)}async function ze(e){if(X){try{if(navigator.clipboard&&typeof navigator.clipboard.writeText==`function`){await navigator.clipboard.writeText(e);return}}catch{}try{let t=document.createElement(`textarea`);t.value=e,t.setAttribute(`readonly`,`true`),t.style.position=`fixed`,t.style.left=`-9999px`,t.style.top=`-9999px`,document.body.appendChild(t),t.select(),document.execCommand(`copy`),document.body.removeChild(t)}catch{}}}async function Be(e){if(X)try{await fetch(e,{method:`GET`,cache:`force-cache`,mode:`cors`,credentials:`omit`,redirect:`follow`})}catch{}}function Ve({p:e}){let t=typeof e.pulse==`number`?e.pulse:0,n=typeof e.stepsPerBeat==`number`&&e.stepsPerBeat>0?e.stepsPerBeat:44,r=typeof e.pulse==`number`?M(e.pulse,n):typeof e.stepIndex==`number`?e.stepIndex:0,i=typeof e.beat==`number`?e.beat:0;return(0,Y.jsxs)(`span`,{className:`k-stamp`,title:`pulse ${t} • beat ${i} • step ${r}`,children:[(0,Y.jsxs)(`span`,{className:`k-pill`,children:[`☤KAI `,t]}),(0,Y.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,Y.jsxs)(`span`,{className:`k-pill`,children:[`beat `,i]}),(0,Y.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,Y.jsxs)(`span`,{className:`k-pill`,children:[`step `,r]})]})}function He({node:t,expanded:n,toggle:i,phiTotalsByPulse:a,usernameClaims:s,transferRegistry:c}){let l=n.has(t.id),u=J(t),d=t.payload.kaiSignature,f=t.payload.chakraDay,p=typeof t.payload.pulse==`number`?t.payload.pulse:void 0,m=p==null?void 0:a.get(p),h=o(t.url),_=l?Re(t,s,c):[],v=$(t,c);return(0,Y.jsxs)(`div`,{className:`node`,style:I(f),"data-chakra":String(f??``),"data-node-id":t.id,children:[(0,Y.jsxs)(`div`,{className:`node-row`,children:[(0,Y.jsxs)(`div`,{className:`node-main`,children:[(0,Y.jsx)(`button`,{className:`twirl`,"aria-label":l?`Collapse memories`:`Expand memories`,"aria-expanded":l,onClick:()=>i(t.id),title:l?`Collapse`:`Expand`,type:`button`,children:(0,Y.jsx)(`span`,{className:`tw ${l?`open`:``}`})}),(0,Y.jsx)(`a`,{className:`node-link`,href:h,target:`_blank`,rel:`noopener noreferrer`,title:h,children:(0,Y.jsx)(`span`,{children:e(d??u??`glyph`,12)})})]}),(0,Y.jsxs)(`div`,{className:`node-meta`,children:[(0,Y.jsx)(Ve,{p:t.payload}),f&&(0,Y.jsx)(`span`,{className:`chakra`,title:String(f),children:String(f)}),v&&(0,Y.jsxs)(`span`,{className:`phi-move phi-move--${v.direction}`,title:`Φ ${v.direction===`receive`?`received`:`sent`}: ${r(v.amount)} Φ${v.amountUsd===void 0?``:` • $${g(v.amountUsd)}`}${v.sentPulse===void 0?``:` • sent pulse ${v.sentPulse}`}`,children:[(0,Y.jsx)(`img`,{className:`phi-move__mark`,src:Ne,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`lazy`,draggable:!1}),(0,Y.jsx)(`span`,{className:`phi-move__sign`,"aria-hidden":`true`,children:v.direction===`receive`?`+`:`-`}),(0,Y.jsxs)(`span`,{className:`phi-move__amount`,children:[r(v.amount),` Φ`]}),v.amountUsd!==void 0&&(0,Y.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,g(v.amountUsd)]})]}),m!==void 0&&(0,Y.jsxs)(`span`,{className:`phi-pill`,title:`Total Φ on pulse ${t.payload.pulse??``}`,children:[`Φ pulse: `,r(m),`Φ`]}),(0,Y.jsx)(`button`,{className:`node-copy`,"aria-label":`Copy URL`,onClick:()=>void ze(h),title:`Copy URL`,type:`button`,children:`⧉`})]})]}),l&&(0,Y.jsxs)(`div`,{className:`node-open`,children:[(0,Y.jsx)(`div`,{className:`node-detail`,children:_.length===0?(0,Y.jsx)(`div`,{className:`node-detail-empty`,children:`No additional memory fields recorded on this glyph.`}):(0,Y.jsx)(`div`,{className:`node-detail-grid`,children:_.map(e=>(0,Y.jsxs)(N.Fragment,{children:[(0,Y.jsx)(`div`,{className:`detail-label`,children:e.label}),(0,Y.jsx)(`div`,{className:`detail-value`,title:e.value,children:e.value})]},e.label))})}),t.children.length>0&&(0,Y.jsx)(`div`,{className:`node-children`,"aria-label":`Memory Imprints`,children:t.children.map(e=>(0,Y.jsx)(He,{node:e,expanded:n,toggle:i,phiTotalsByPulse:a,usernameClaims:s,transferRegistry:c},e.id))})]})]})}function Ue({root:n,expanded:r,toggle:i,phiTotalsByPulse:a,usernameClaims:s,transferRegistry:c}){let l=(0,N.useMemo)(()=>{let e=0,t=n=>{e+=1,n.children.forEach(t)};return t(n),e},[n]),u=t(n.url),d=n.payload.kaiSignature,f=o(n.url),p=n.payload.chakraDay;return(0,Y.jsxs)(`section`,{className:`origin`,"aria-label":`Sigil origin stream`,style:I(p),"data-chakra":String(p??``),"data-node-id":n.id,children:[(0,Y.jsxs)(`header`,{className:`origin-head`,children:[(0,Y.jsxs)(`div`,{className:`o-meta`,children:[(0,Y.jsx)(`span`,{className:`o-title`,children:`Origin`}),(0,Y.jsx)(`a`,{className:`o-link`,href:f,target:`_blank`,rel:`noopener noreferrer`,title:f,children:e(d??u??`origin`,14)}),p&&(0,Y.jsx)(`span`,{className:`o-chakra`,title:String(p),children:String(p)})]}),(0,Y.jsxs)(`div`,{className:`o-right`,children:[(0,Y.jsx)(Ve,{p:n.payload}),(0,Y.jsxs)(`span`,{className:`o-count`,title:`Total content keys in this lineage`,children:[l,` keys`]}),(0,Y.jsx)(`button`,{className:`o-copy`,onClick:()=>void ze(f),title:`Copy origin URL`,type:`button`,children:`Remember Origin`})]})]}),(0,Y.jsx)(`div`,{className:`origin-body`,children:n.children.length===0?(0,Y.jsx)(`div`,{className:`kx-empty`,children:`No memories yet. The stream begins here.`}):(0,Y.jsx)(`div`,{className:`tree`,children:n.children.map(e=>(0,Y.jsx)(He,{node:e,expanded:r,toggle:i,phiTotalsByPulse:a,usernameClaims:s,transferRegistry:c},e.id))})})]})}function We({onAdd:t,onImport:n,onExport:r,total:i,lastAdded:a}){let[o,s]=(0,N.useState)(``);return(0,Y.jsx)(`div`,{className:`kx-toolbar`,role:`region`,"aria-label":`Explorer toolbar`,children:(0,Y.jsxs)(`div`,{className:`kx-toolbar-inner`,children:[(0,Y.jsxs)(`div`,{className:`kx-brand`,children:[(0,Y.jsx)(`div`,{className:`kx-glyph`,"aria-hidden":!0,children:(0,Y.jsx)(`img`,{className:`kx-glyph__mark`,src:Ne,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`eager`,draggable:!1})}),(0,Y.jsxs)(`div`,{className:`kx-title`,children:[(0,Y.jsxs)(`h1`,{children:[`KAIROS `,(0,Y.jsx)(`span`,{children:`Keystream`})]}),(0,Y.jsx)(`div`,{className:`kx-tagline`,children:`Sovereign Lineage • No DB • Pure Φ`})]})]}),(0,Y.jsxs)(`div`,{className:`kx-controls`,children:[(0,Y.jsxs)(`form`,{className:`kx-add-form`,onSubmit:e=>{e.preventDefault(),o.trim()&&(t(o.trim()),s(``))},children:[(0,Y.jsx)(`input`,{className:`kx-input`,placeholder:`Inhale a sigil (or memory)…`,spellCheck:!1,value:o,onChange:e=>s(e.target.value),"aria-label":`Sigil Key`}),(0,Y.jsx)(`button`,{className:`kx-button`,type:`submit`,children:`Inhale`})]}),(0,Y.jsxs)(`div`,{className:`kx-io`,role:`group`,"aria-label":`Import and export`,children:[(0,Y.jsxs)(`label`,{className:`kx-import`,title:`Import a JSON list of Keys (or krystals)`,children:[(0,Y.jsx)(`input`,{type:`file`,accept:`application/json`,onChange:e=>{let t=e.target.files?.[0];t&&n(t)},"aria-label":`Import JSON`}),`Inhale`]}),(0,Y.jsx)(`button`,{className:`kx-export`,onClick:r,"aria-label":`Export registry to JSON`,type:`button`,children:`Exhale`})]}),(0,Y.jsxs)(`div`,{className:`kx-stats`,"aria-live":`polite`,children:[(0,Y.jsxs)(`span`,{className:`kx-pill`,title:`Total KEYS in registry (includes variants)`,children:[i,` KEYS`]}),a&&(0,Y.jsxs)(`span`,{className:`kx-pill subtle`,title:a,children:[`Last: `,e(a,8)]})]})]})]})})}var Ge=()=>{let[e,t]=(0,N.useState)(()=>se()?1:0),[r,i]=(0,N.useState)(0),[a,f]=(0,N.useState)(void 0),[p,h]=(0,N.useState)(()=>O()),g=(0,N.useRef)(!1),v=(0,N.useRef)(new Set),x=(0,N.useRef)(null),k=(0,N.useRef)(!1),A=(0,N.useRef)(null),j=(0,N.useRef)(0),M=(0,N.useRef)(null),P=(0,N.useRef)(!1),F=(0,N.useRef)(void 0),I=(0,N.useRef)([]),L=(0,N.useRef)(null),R=(0,N.useCallback)(e=>{let t=Q()+e;t>j.current&&(j.current=t)},[]),z=(0,N.useCallback)(()=>{if(!X||g.current)return;let e=Q(),n=j.current-e;if(n>0){M.current!=null&&window.clearTimeout(M.current),M.current=window.setTimeout(()=>{M.current=null,z()},n+De);return}let r=I.current.splice(0);if(r.length>0&&(0,N.startTransition)(()=>{h(e=>{let t=e;for(let e of r){let n=t[e.normalized];n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===(e.originHash??n.originHash)&&n.ownerHint===(e.ownerHint??n.ownerHint)||(t={...t,[e.normalized]:{...n,normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash??n?.originHash,ownerHint:e.ownerHint??n?.ownerHint??null,updatedAt:n?.updatedAt??0}})}return t})}),F.current!==void 0){let e=F.current;F.current=void 0,(0,N.startTransition)(()=>f(e))}P.current&&(P.current=!1,(0,N.startTransition)(()=>t(e=>e+1)))},[R]),B=(0,N.useCallback)(()=>{if(!X||M.current!=null)return;let e=Q(),t=j.current-e,n=Math.max(0,t)+De;M.current=window.setTimeout(()=>{M.current=null,z()},n)},[z]),V=(0,N.useCallback)(()=>{if(!g.current){if(Q()<j.current||k.current){P.current=!0,B();return}(0,N.startTransition)(()=>t(e=>e+1))}},[B]),H=(0,N.useCallback)(e=>{if(!g.current){if(Q()<j.current||k.current){F.current=e,B();return}(0,N.startTransition)(()=>f(e))}},[B]),U=(0,N.useRef)(null),[ye,W]=(0,N.useState)(()=>new Set),be=(0,N.useCallback)(e=>{R(Ee);let t=x.current;if(t){let n=`[data-node-id="${Fe(e)}"]`,r=t.querySelector(n);U.current={id:e,scrollTop:t.scrollTop,rectTop:r?r.getBoundingClientRect().top:0}}W(t=>{let n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n}),B()},[R,B]);(0,N.useEffect)(()=>{if(!X)return;let e=document.documentElement,t=document.body,n=document.scrollingElement||document.documentElement,r={htmlOverscroll:e?.style.overscrollBehavior??``,htmlOverscrollY:e?.style.overscrollBehaviorY??``,bodyOverscroll:t?.style.overscrollBehavior??``,bodyOverscrollY:t?.style.overscrollBehaviorY??``,rootOverscroll:n?.style.overscrollBehavior??``,rootOverscrollY:n?.style.overscrollBehaviorY??``};return e&&(e.style.overscrollBehavior=`none`,e.style.overscrollBehaviorY=`none`),t&&(t.style.overscrollBehavior=`none`,t.style.overscrollBehaviorY=`none`),n&&(n.style.overscrollBehavior=`none`,n.style.overscrollBehaviorY=`none`),()=>{e&&(e.style.overscrollBehavior=r.htmlOverscroll,e.style.overscrollBehaviorY=r.htmlOverscrollY),t&&(t.style.overscrollBehavior=r.bodyOverscroll,t.style.overscrollBehaviorY=r.bodyOverscrollY),n&&(n.style.overscrollBehavior=r.rootOverscroll,n.style.overscrollBehaviorY=r.rootOverscrollY)}},[]),(0,N.useEffect)(()=>{if(!X)return;let e=x.current;if(!e)return;let t=0,n=0,r=e=>{e.touches.length===1&&(t=e.touches[0]?.clientY??0,n=e.touches[0]?.clientX??0)},i=r=>{if(!r.cancelable||r.touches.length!==1)return;let i=r.touches[0]?.clientY??0,a=r.touches[0]?.clientX??0,o=i-t,s=a-n;if(t=i,n=a,Math.abs(o)<=Math.abs(s))return;let c=e.scrollHeight-e.clientHeight;if(c<=0)return;let l=e.scrollTop<=0,u=e.scrollTop>=c-1,d=o>0,f=o<0;(l&&d&&window.scrollY<=0||u&&f)&&r.preventDefault()};return e.addEventListener(`touchstart`,r,{passive:!0}),e.addEventListener(`touchmove`,i,{passive:!1}),()=>{e.removeEventListener(`touchstart`,r),e.removeEventListener(`touchmove`,i)}},[]),(0,N.useEffect)(()=>{if(!X)return;let e=x.current;if(!e)return;let t=()=>{k.current=!0,R(Te),A.current!=null&&window.clearTimeout(A.current),A.current=window.setTimeout(()=>{k.current=!1,A.current=null,B()},180)};return e.addEventListener(`scroll`,t,{passive:!0}),()=>{e.removeEventListener(`scroll`,t),A.current!=null&&window.clearTimeout(A.current),A.current=null,k.current=!1}},[R,B]),(0,N.useLayoutEffect)(()=>{let e=U.current;if(!e)return;U.current=null;let t=x.current;if(!t)return;let n=`[data-node-id="${Fe(e.id)}"]`,r=t.querySelector(n);if(!r)return;let i=r.getBoundingClientRect().top-e.rectTop;Number.isFinite(i)&&Math.abs(i)>1&&(t.scrollTop=Math.max(0,e.scrollTop+i))},[ye]);let G=(0,N.useRef)(null),K=(0,N.useRef)(!1),xe=(0,N.useRef)(null);(0,N.useEffect)(()=>{if(g.current=!1,ne(),te(),ee(),n(),se()&&V(),X){let e=m(window.location.href);if(l(e)){let t=D(e,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0});H(E(e)),t&&V()}}let e=window.__SIGIL__?.registerSigilUrl,t=window.__SIGIL__?.registerSend;window.__SIGIL__||(window.__SIGIL__={}),window.__SIGIL__.registerSigilUrl=re,window.__SIGIL__.registerSend=e=>{if(!e||typeof e!=`object`)return;let t=e.url;typeof t!=`string`||!t.trim()||D(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(H(E(t)),V())};let r=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&D(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(H(E(t)),V())};window.addEventListener(`sigil:url-registered`,r);let a=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&D(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(H(E(t)),V())};window.addEventListener(`sigil:minted`,a);let o=X&&`BroadcastChannel`in window?new BroadcastChannel(we):null,s=e=>{let t=e.data;t?.type===`sigil:add`&&typeof t.url==`string`&&D(t.url,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0})&&(H(E(t.url)),V())};o?.addEventListener(`message`,s);let c=e=>{if(!e.key)return;let t=e.key===de,n=e.key===ae;if(e.key===`kai:sigil-transfer:v1`){i(e=>e+1);return}if(!(!t&&!n)&&e.newValue)try{let t=JSON.parse(e.newValue);if(!Array.isArray(t))return;let n=!1;for(let e of t)typeof e==`string`&&D(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:!0})&&(n=!0);H(void 0),n&&(_e(),V())}catch{}};window.addEventListener(`storage`,c);let d=()=>i(e=>e+1);window.addEventListener(ue,d);let f=X&&`BroadcastChannel`in window?new BroadcastChannel(pe):null,p=e=>{e.data?.type===`transfer:update`&&i(e=>e+1)};f?.addEventListener(`message`,p);let _=()=>{he(),ge()};window.addEventListener(`pagehide`,_);let v=oe(e=>{if(Q()<j.current||k.current){I.current.push({normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash,ownerHint:e.ownerHint}),B();return}(0,N.startTransition)(()=>{h(t=>{let n=t[e.normalized];return n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===e.originHash&&n.ownerHint===e.ownerHint?t:{...t,[e.normalized]:e}})})}),y=new AbortController,x=async e=>{g.current||T()&&(k.current||Q()<j.current&&(e===`pulse`||e===`import`)||await ge())},S=async e=>{if(!g.current&&T()&&!K.current&&!k.current&&!(Q()<j.current&&(e===`pulse`||e===`import`))){K.current=!0;try{let t=G.current,n=await u(e=>new URL(fe,e).toString(),{method:`GET`,cache:`no-store`,signal:y.signal,headers:void 0});if(!n||n.status===304||!n.ok)return;let r=``,i;try{let e=await n.json();r=typeof e?.seal==`string`?e.seal:``,i=Me(e)}catch{return}let a=i==null?void 0:je();if(t&&r&&t===r&&!(i!=null&&(a==null||i>a))){G.current=r;return}let o=await ie(y.signal);o.pulled&&(G.current=o.remoteSeal??r??t??null),o.imported>0&&(H(void 0),V());let s=G.current;(e===`open`||(e===`visible`||e===`focus`||e===`online`||e===`import`)&&s!==xe.current)&&(b(),xe.current=s,await ge())}finally{K.current=!1}}};L.current=S,b(),x(`open`),S(`open`);let C=null,w=null,ce=()=>{X&&(g.current||(C!=null&&window.clearInterval(C),C=window.setInterval(()=>{document.visibilityState===`visible`&&T()&&x(`pulse`)},ke)))},le=()=>{X&&(g.current||(w!=null&&window.clearInterval(w),w=window.setInterval(()=>{document.visibilityState===`visible`&&T()&&S(`pulse`)},Ae)))},O=()=>{ce(),le()};O();let A=()=>{document.visibilityState===`visible`&&(O(),x(`visible`),S(`visible`))};document.addEventListener(`visibilitychange`,A);let me=()=>{O(),x(`focus`),S(`focus`)},ve=()=>{O(),x(`online`),S(`online`)};return window.addEventListener(`focus`,me),window.addEventListener(`online`,ve),()=>{window.__SIGIL__&&(window.__SIGIL__.registerSigilUrl=e,window.__SIGIL__.registerSend=t),window.removeEventListener(`sigil:url-registered`,r),window.removeEventListener(`sigil:minted`,a),window.removeEventListener(`storage`,c),window.removeEventListener(ue,d),f?.removeEventListener(`message`,p),f?.close(),window.removeEventListener(`pagehide`,_),window.removeEventListener(`focus`,me),window.removeEventListener(`online`,ve),document.removeEventListener(`visibilitychange`,A),o?.removeEventListener(`message`,s),o?.close(),typeof v==`function`&&v(),M.current!=null&&window.clearTimeout(M.current),M.current=null,C!=null&&window.clearInterval(C),C=null,w!=null&&window.clearInterval(w),w=null,y.abort(),L.current=null,g.current=!0}},[V,R,B,H]);let q=(0,N.useCallback)(e=>{let t=L.current;t&&t(e)},[]);(0,N.useEffect)(()=>{if(!X)return;let e=()=>q(`visible`);return window.addEventListener(Ce,e),()=>window.removeEventListener(Ce,e)},[q]);let J=(0,N.useMemo)(()=>Se(C),[e]),Ne=(0,N.useMemo)(()=>ce(),[r]),Ie=(0,N.useMemo)(()=>{let e=0;for(let[,]of C)e+=1;return e},[e]),Le=(0,N.useMemo)(()=>{let e=new Map,t=new Map;for(let[n,r]of C){let i=typeof r.pulse==`number`?r.pulse:void 0;if(i==null)continue;let a=ve(m(n),r),o=t.get(i);if(o||(o=new Set,t.set(i,o)),o.has(a))continue;o.add(a);let s=le(r);s!==void 0&&e.set(i,(e.get(i)??0)+s)}return e},[e]),$=(0,N.useMemo)(()=>{let e=[];for(let[t]of C){let n=m(o(t));e.includes(n)||e.push(n)}return e},[e]);(0,N.useEffect)(()=>{if(!X||$.length===0)return;let e=$.filter(e=>!v.current.has(e));if(e.length===0)return;let t=!1,n=async()=>{for(let n of e){if(t)break;v.current.add(n),await Be(n)}},r=window,i=null;if(typeof r.requestIdleCallback==`function`){let e=r.requestIdleCallback(()=>void n(),{timeout:1e3});i=()=>r.cancelIdleCallback?.(e)}else{let e=window.setTimeout(()=>void n(),120);i=()=>window.clearTimeout(e)}return()=>{t=!0,i?.()}},[$]);let Re=(0,N.useCallback)(async()=>{if(!X||k.current||!T()||Q()<j.current)return;let e=[],t=n=>{if(n.urls.length>1){let t=_(n.url),r=[...n.urls].map(e=>m(E(e))).filter((e,t,n)=>n.indexOf(e)===t).sort((e,n)=>c(n,t)-c(e,t));for(let t of r.slice(0,2)){let n=m(t);!d.has(n)&&!e.includes(n)&&e.push(n)}}n.children.forEach(t)};for(let e of J)t(e);if(e.length!==0)for(let t of e.slice(0,Oe)){let e=await S(t);e===`ok`&&s(t,1),e===`bad`&&s(t,-1)}},[J]);(0,N.useEffect)(()=>{if(!X)return;let e=!1,t=()=>{e||Re()},n=window,r=null;if(typeof n.requestIdleCallback==`function`){let e=n.requestIdleCallback(t,{timeout:900});r=()=>n.cancelIdleCallback?.(e)}else{let e=window.setTimeout(t,250);r=()=>window.clearTimeout(e)}return()=>{e=!0,r?.()}},[e,Re]);let ze=(0,N.useCallback)(e=>{R(Ee),D(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(H(E(e)),V())},[V,R,H]),Ve=(0,N.useCallback)(async e=>{R(0);let t=await e.text(),n;try{n=JSON.parse(t)}catch{return}let{urls:r,rawKrystals:i}=me(n);if(r.length===0&&i.length===0)return;let a=!1;for(let e=0;e<i.length;e+=Z){for(let t of i.slice(e,e+Z))w(t);e+Z<i.length&&await Pe()}for(let e=0;e<r.length;e+=Z){for(let t of r.slice(e,e+Z))D(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`import`,enqueueToApi:!0})&&(a=!0);a&&(H(void 0),V()),e+Z<r.length&&await Pe()}r.length>0&&y(r),a&&(H(void 0),V()),q(`import`)},[V,R,q,H]),He=(0,N.useCallback)(()=>{R(Ee);let e=[];for(let[t]of C)e.push(t);let t=new Blob([JSON.stringify({urls:e},null,2)],{type:`application/json`}),n=document.createElement(`a`);n.href=URL.createObjectURL(t),n.download=`sigil-registry-${Date.now()}.json`,n.click(),URL.revokeObjectURL(n.href)},[R]);return(0,Y.jsxs)(`div`,{className:`sigil-explorer`,"aria-label":`Kairos Keystream Explorer`,children:[(0,Y.jsx)(We,{onAdd:ze,onImport:Ve,onExport:He,total:Ie,lastAdded:a}),(0,Y.jsx)(`div`,{className:`explorer-scroll`,ref:x,role:`region`,"aria-label":`Explorer scroll viewport`,children:(0,Y.jsxs)(`div`,{className:`explorer-inner`,children:[J.length===0?(0,Y.jsxs)(`div`,{className:`kx-empty`,children:[(0,Y.jsx)(`p`,{children:`No sigil-glyphs in your keystream yet.`}),(0,Y.jsxs)(`ol`,{children:[(0,Y.jsx)(`li`,{children:`Import your keystream memories.`}),(0,Y.jsx)(`li`,{children:`Seal a moment — auto-registered here.`}),(0,Y.jsx)(`li`,{children:`Inhale any sigil-glyph or memory key above — lineage aligns instantly.`})]})]}):(0,Y.jsx)(`div`,{className:`forest`,"aria-label":`Sigil forest`,children:J.map(e=>(0,Y.jsx)(Ue,{root:e,expanded:ye,toggle:be,phiTotalsByPulse:Le,usernameClaims:p,transferRegistry:Ne},e.id))}),(0,Y.jsx)(`footer`,{className:`kx-footer`,"aria-label":`Explorer footer`,children:(0,Y.jsxs)(`span`,{className:`row`,children:[(0,Y.jsx)(`span`,{children:`Determinate • Stateless • Kairos-Memory`}),(0,Y.jsx)(`span`,{className:`dot`,children:`•`}),(0,Y.jsx)(`span`,{children:T()?`online`:`offline`}),(0,Y.jsx)(`span`,{className:`dot`,children:`•`}),(0,Y.jsxs)(`span`,{children:[Ie,` keys`]})]})})]})})]})};export{Ge as default};