import{$n as e,$t as t,A as n,An as r,Br as i,C as a,Cn as o,Dn as s,En as c,G as l,Gt as u,Ht as d,Jn as f,Jt as p,Kt as ee,Mn as m,N as h,On as g,Qt as _,S as v,Sn as y,Tn as b,Ut as x,Wt as S,Xn as C,Xr as w,Xt as T,Yt as E,Zt as D,_i as O,_n as k,an as A,b as te,bn as j,br as ne,cn as M,di as N,dn as P,ei as F,en as I,fn as L,gn as R,hn as z,in as re,j as ie,jn as ae,kn as oe,li as B,ln as se,mn as ce,nn as le,on as V,pn as H,qt as ue,rn as de,sn as U,ti as fe,tn as pe,tt as me,un as W,vn as he,wn as ge,x as _e,xn as ve,yn as ye}from"./index-CNvYq8f9.js";var G=O(N(),1);const be={root:`#ff3b3b`,sacral:`#ff8a3d`,solar:`#ffd54a`,heart:`#3dff9a`,throat:`#46d3ff`,thirdEye:`#6b6cff`,crown:`#c18bff`};function K(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`root`)?`root`:t.includes(`sacral`)?`sacral`:t.includes(`solar`)||t.includes(`plexus`)||t.includes(`sun`)?`solar`:t.includes(`heart`)?`heart`:t.includes(`throat`)?`throat`:t.includes(`third`)||t.includes(`eye`)||t.includes(`indigo`)?`thirdEye`:t.includes(`crown`)||t.includes(`krown`)||t.includes(`violet`)?`crown`:t===`1`?`root`:t===`2`?`sacral`:t===`3`?`solar`:t===`4`?`heart`:t===`5`?`throat`:t===`6`?`thirdEye`:t===`7`?`crown`:null:null}function xe(e){let t=K(e),n=t?be[t]:`var(--sx-accent)`;return{"--sx-chakra":n}}function q(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function J(e){if(typeof e==`number`)return!Number.isFinite(e)||Math.abs(e)<1e-12?void 0:Math.abs(e);if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&Math.abs(t)>=1e-12)return Math.abs(t)}}function Y(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`receive`)||t.includes(`received`)||t.includes(`inhale`)?`receive`:t.includes(`send`)||t.includes(`sent`)||t.includes(`exhale`)?`send`:null:null}function X(e){if(typeof e==`number`)return!Number.isFinite(e)||e<=0?void 0:e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function Se(e){if(typeof e==`number`&&Number.isFinite(e)&&e>0)return e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function Ce(e){let t=e,n=q(t.feed)?t.feed:null,r=e=>e?Y(e.phiDirection)||Y(e.transferDirection)||Y(e.transferMode)||Y(e.transferKind):null,i=e=>{if(e)return e.phiDelta??e.phiSigned??e.phiChange},a=e=>e?J(e.transferAmountPhi)??J(e.transferPhi)??J(e.amountPhi)??J(e.phiAmount)??J(e.childAllocationPhi)??J(e.branchBasePhi):void 0,o=e=>e?X(e.amountUsd)??X(e.usdAmount)??X(e.usdValue)??X(e.valueUsd)??X(e.usd):void 0,s=e=>e?X(e.usdPerPhi)??X(e.fxUsdPerPhi)??X(e.usd_per_phi):void 0,c=e=>e?Se(e.atPulse)??Se(e.sentPulse)??Se(e.senderKaiPulse)??Se(e.transferPulse):void 0,l=r(t)??r(n),u=i(t)??i(n),d=typeof u==`number`?u:void 0;d===void 0&&typeof u==`string`&&(d=Number(u));let f=l??(typeof d==`number`&&Number.isFinite(d)?d>=0?`receive`:`send`:null);if(!f)return;let p=a(t)??a(n)??(q(t.preview)?J(t.preview.amountPhi):void 0)??(q(n?.preview)?J(n.preview.amountPhi):void 0)??(typeof d==`number`&&Number.isFinite(d)?Math.abs(d):void 0);if(p===void 0)return;let ee=o(t)??o(n)??(q(t.preview)?X(t.preview.amountUsd):void 0)??(q(n?.preview)?X(n.preview.amountUsd):void 0),m=s(t)??s(n)??(q(t.preview)?X(t.preview.usdPerPhi):void 0)??(q(n?.preview)?X(n.preview.usdPerPhi):void 0),h=c(t)??c(n)??(q(t.preview)?Se(t.preview.atPulse):void 0)??(q(n?.preview)?Se(n.preview.atPulse):void 0);return{direction:f,amount:p,amountUsd:ee??(m===void 0?void 0:p*m),sentPulse:h,source:`payload`}}function we(e){for(let t of[`transferUrl`,`transferURL`,`transferLink`,`transfer_link`,`sealUrl`,`sealURL`,`sigilTransferUrl`]){let n=e[t];if(typeof n!=`string`||!n.trim())continue;let r=R(n.trim());if(!r)continue;let i=Ce(r);if(i)return i}}function Te(e,t){if(!e)return;let n=t.get(e.toLowerCase());if(!n)return;let r=J(n.amountPhi);if(r!==void 0)return{direction:n.direction,amount:r,amountUsd:X(n.amountUsd),sentPulse:Se(n.sentPulse),source:`registry`}}function Ee(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function De(e,t){if(!Ee(e))return;let n=e[t];return typeof n==`string`&&n.trim().length>0?n.trim():void 0}function Oe(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`receive`)||t.includes(`received`)||t.includes(`inhale`)?`receive`:t.includes(`send`)||t.includes(`sent`)||t.includes(`exhale`)?`send`:null:null}function ke(e){let t=e,n=Ee(t.feed)?t.feed:null,r=e=>e?Oe(e.transferDirection)||Oe(e.transferMode)||Oe(e.transferKind)||Oe(e.phiDirection):null,i=!!(r(t)??r(n)),a=!!(typeof t.transferNonce==`string`||typeof t.nonce==`string`||typeof t.transferToken==`string`||typeof t.token==`string`||n&&(typeof n.transferNonce==`string`||typeof n.nonce==`string`||typeof n.transferToken==`string`||typeof n.token==`string`)),o=!!(typeof t.parentUrl==`string`||typeof t.parentHash==`string`||typeof t.parentCanonical==`string`||n&&(typeof n.parentUrl==`string`||typeof n.parentHash==`string`||typeof n.parentCanonical==`string`));return i||a||o}function Ae(e){return e.kind!==`post`||!j(e.primaryUrl)||Ce(e.payload)?!1:!ke(e.payload)}function je(e){let t=new Map,n=new Map;for(let[r,i]of e){let e=L(r),a=ce(e),o=H(e,i),s=ye(e,i);t.set(e,o);let c=n.get(o);if(!c){n.set(o,{payload:i,urls:new Set([e]),kind:a,momentKey:s});continue}V(i,c.payload)>0&&(c.payload=i),c.urls.add(e);let l=c.momentKey,u=s;l.startsWith(`u:`)&&!u.startsWith(`u:`)&&(c.momentKey=u),l.startsWith(`h:`)&&(u.startsWith(`k:`)||u.startsWith(`sig:`)||u.startsWith(`tok:`))&&(c.momentKey=u)}let r=new Map;for(let[e,t]of n){let n=ve(Array.from(t.urls),t.kind);r.set(e,{id:e,payload:t.payload,urls:t.urls,primaryUrl:n,kind:t.kind,momentKey:t.momentKey})}let i=new Map;for(let e of r.values()){let t=e.momentKey;i.has(t)||i.set(t,[]),i.get(t).push(e.id)}let a=new Map,o=new Map,s=new Map,c=new Map;for(let e of r.values()){let t=j(e.primaryUrl);t&&!c.has(t)&&c.set(t,e.id)}for(let[e,t]of i){let n=t.map(e=>r.get(e)).filter(Boolean),i=n.filter(e=>e.kind===`post`),c;c=i.length>0?i.slice().sort((e,t)=>y(t.primaryUrl,`post`)-y(e.primaryUrl,`post`))[0]:n.slice().sort((e,t)=>y(t.primaryUrl,t.kind)-y(e.primaryUrl,e.kind))[0];let l=c?.id??t[0];a.set(e,l);for(let e of t)o.set(e,l);for(let e of t){let t=r.get(e);if(t)for(let e of t.urls)s.set(e,l)}}let l=new Map,u=new Map;for(let e of r.values()){if(!Ae(e))continue;let t=j(e.primaryUrl);t&&(u.has(t)||u.set(t,e.id))}for(let e of r.values()){let n=o.get(e.id)??e.id;if(e.id!==n)continue;let r=De(e.payload,`originUrl`),i=r?L(r):k(e.primaryUrl)??e.primaryUrl,a=j(i),d=t.get(i)??(a?c.get(a):void 0),f=(a?u.get(a):void 0)??d??s.get(i);l.set(n,f??n)}let d=new Map;for(let e of r.values()){let n=o.get(e.id)??e.id,r=l.get(n)??n,i,a=De(e.payload,`parentUrl`);if(a){let n=L(a),r=j(n),o=t.get(n)??(r?c.get(r):void 0)??s.get(n);o&&o!==e.id&&(i=o)}!i&&e.id!==n&&(i=n),d.set(e.id,{id:e.id,payload:e.payload,urls:e.urls,primaryUrl:e.primaryUrl,kind:e.kind,momentKey:e.momentKey,parentId:i,originId:r,momentParentId:n})}return d}function Me(e,t){let n=[];for(let[r,i]of t)i.parentId===e&&n.push(r);return n.sort((e,n)=>V(t.get(n).payload,t.get(e).payload)),n}function Ne(e,t,n=new Set){let r=t.get(e);if(!r)return null;if(n.has(e))return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:[]};n.add(e);let i=Me(e,t).map(e=>Ne(e,t,n)).filter(Boolean);return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:i}}function Pe(e){let t=0,n=e.payload,r=e=>{t+=1,V(e.payload,n)>0&&(n=e.payload),e.children.forEach(r)};return r(e),{nodeCount:t,latest:n}}function Fe(e){let t=je(e),n=new Map;for(let[e,r]of t){let t=r.originId;n.has(t)||n.set(t,[]),n.get(t).push(e)}let r=[];for(let e of n.keys()){let n=Ne(e,t);if(!n)continue;let i=Pe(n);r.push({root:n,nodeCount:i.nodeCount,latest:i.latest})}return r.sort((e,t)=>{let n=V(t.latest,e.latest);return n===0?t.nodeCount===e.nodeCount?V(t.root.payload,e.root.payload):t.nodeCount-e.nodeCount:n}),r.map(e=>e.root)}function Ie(e){let t=e.payload;if(Ee(t)&&typeof t.canonicalHash==`string`)return t.canonicalHash;let n=j(e.url);if(n)return n;for(let t of e.urls){let e=j(t);if(e)return e;let n=R(t);if(!n)continue;let r=n;if(Ee(r)&&typeof r.canonicalHash==`string`)return r.canonicalHash}}var Z=O(S(),1),Le=typeof window<`u`,Re=`sigil:explorer:open`,ze=`sigil:explorer:bc:v1`,Be=`sigil:explorer:select:bc:v1`,Ve=`sigil:explorer:selectedHash:v1`,He=1000000n,Ue=(e,t)=>{if(t===0n)return 0n;let n=e%t;return n>=0n?n:n+t},We=(e,t)=>{let n=e<0n?-e:e,r=t<0n?-t:t;for(;r!==0n;){let e=n%r;n=r,r=e}return n},Ge=(()=>{let e=We(i,He);return e===0n?0n:i/e})(),Ke=(1+Math.sqrt(5))/2,qe=e=>{if(!Number.isFinite(e))return 0;let t=BigInt(Math.trunc(e));if(Ge<=0n)return 0;let n=Ue(t,Ge);return Number(n)},Je=e=>{let t=Number.isFinite(e)?Math.trunc(e):0,{beat:n,stepIndex:r,percentIntoStep:i}=w(BigInt(t)*He);return{beat:n,stepIndex:r,stepPct:F(i)}},Ye=e=>{let t=0;for(let n=0;n<e.length;n+=1)t=(t*31+e.charCodeAt(n))%1e6;return t/1e6},Xe=e=>{let t=Ye(e),n=Ye(e.split(``).reverse().join(``)),r=Ye(`${e}phi`);return`${Math.floor(80+t*175)} ${Math.floor(80+n*175)} ${Math.floor(80+r*175)}`},Ze=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function Qe(e,t,n){return Math.max(t,Math.min(n,e))}function $e(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function et(e){return typeof e==`string`&&e.trim().length>0?e.trim():void 0}function tt(e){let t=et(e);return t?t.toLowerCase():void 0}function nt(e){return typeof e==`number`&&Number.isFinite(e)?e:void 0}function rt(e){return JSON.parse(e)}function it(e){try{return window.localStorage.getItem(e)}catch{return null}}function at(e,t){try{window.localStorage.setItem(e,t)}catch{}}function ot(e){let t=et(e);if(t===`send`||t===`receive`)return t}function st(e){let t=(e??``).toLowerCase();return t.includes(`root`)?`chakra-root`:t.includes(`sacral`)?`chakra-sacral`:t.includes(`solar`)?`chakra-solar`:t.includes(`heart`)?`chakra-heart`:t.includes(`throat`)?`chakra-throat`:t.includes(`third`)||t.includes(`brow`)?`chakra-third`:t.includes(`crown`)?`chakra-crown`:`chakra-unknown`}function ct(e){let t=(e??``).toLowerCase();return t.includes(`root`)?`shape-root`:t.includes(`sacral`)?`shape-sacral`:t.includes(`solar`)?`shape-solar`:t.includes(`heart`)?`shape-heart`:t.includes(`throat`)?`shape-throat`:t.includes(`third`)||t.includes(`brow`)?`shape-third`:t.includes(`crown`)?`shape-crown`:null}function lt(e,t=10){return e.length<=t?e:e.slice(0,t)}function ut(e){return e?e.startsWith(`-`)?e:`+${e}`:`—`}function dt(e){let t=j(e);if(typeof t==`string`&&t.length)return t.toLowerCase();let n=e.match(/\/s\/([0-9a-f]{32,128})(?:\?|$)/i);return n?.[1]?n[1].toLowerCase():null}function ft(e){let t=tt(e.parentHash);if(t)return t;let n=et(e.parentUrl);if(n){let e=dt(n);if(e)return e}}function pt(e){let t=et(e.originUrl);if(t){let e=dt(t);if(e)return e}}function mt(e){let t=0,n=e=>{e!=null&&(typeof e==`string`&&e.length===0||(t+=1))};return n(e.pulse),n(e.beat),n(e.stepIndex),n(e.chakraDay),n(e.userPhiKey),n(e.kaiSignature),n(e.parentHash),n(e.originHash),n(e.transferDirection),n(e.transferAmountPhi),n(e.phiDelta),n(e.receiverKaiPulse),t}function ht(e){let t=e[0]??``,n=-1/0;for(let r of e){let e=L(r),i=y(e,ce(e));i>n&&(n=i,t=r)}return z(t)}function gt(e,t){let n=new Map;for(let[e,t]of D){let r=L(e),i=dt(r);if(!i)continue;let a=$e(t)?t:{},o={hash:i,bestUrl:z(r),pulse:nt(a.pulse),beat:nt(a.beat),stepIndex:nt(a.stepIndex),chakraDay:et(a.chakraDay),userPhiKey:et(a.userPhiKey),kaiSignature:tt(a.kaiSignature),parentHash:ft(a),originHash:pt(a),transferDirection:ot(a.transferDirection),transferAmountPhi:et(a.transferAmountPhi),phiDelta:et(a.phiDelta),receiverKaiPulse:nt(a.receiverKaiPulse)},s=n.get(i);if(!s){n.set(i,{hash:i,bestUrl:o.bestUrl??z(r),sources:[r],pulse:o.pulse,beat:o.beat,stepIndex:o.stepIndex,chakraDay:o.chakraDay,userPhiKey:o.userPhiKey,kaiSignature:o.kaiSignature,parentHash:o.parentHash,originHash:o.originHash,transferDirection:o.transferDirection,transferAmountPhi:o.transferAmountPhi,phiDelta:o.phiDelta,receiverKaiPulse:o.receiverKaiPulse,degree:0});continue}let c=new Set(s.sources);c.add(r);let l=mt(s),u=mt(o)>l,d={...s,sources:Array.from(c),bestUrl:s.bestUrl,pulse:u&&o.pulse!==void 0?o.pulse:s.pulse??o.pulse,beat:u&&o.beat!==void 0?o.beat:s.beat??o.beat,stepIndex:u&&o.stepIndex!==void 0?o.stepIndex:s.stepIndex??o.stepIndex,chakraDay:u&&o.chakraDay?o.chakraDay:s.chakraDay??o.chakraDay,userPhiKey:u&&o.userPhiKey?o.userPhiKey:s.userPhiKey??o.userPhiKey,kaiSignature:u&&o.kaiSignature?o.kaiSignature:s.kaiSignature??o.kaiSignature,parentHash:u&&o.parentHash?o.parentHash:s.parentHash??o.parentHash,originHash:u&&o.originHash?o.originHash:s.originHash??o.originHash,transferDirection:u&&o.transferDirection?o.transferDirection:s.transferDirection??o.transferDirection,transferAmountPhi:u&&o.transferAmountPhi?o.transferAmountPhi:s.transferAmountPhi??o.transferAmountPhi,phiDelta:u&&o.phiDelta?o.phiDelta:s.phiDelta??o.phiDelta,receiverKaiPulse:u&&o.receiverKaiPulse!==void 0?o.receiverKaiPulse:s.receiverKaiPulse??o.receiverKaiPulse,degree:0};n.set(i,d)}let r=new Map;for(let e of n.values())e.parentHash&&r.set(e.parentHash,(r.get(e.parentHash)??0)+1);for(let e of n.values()){let t=0;e.parentHash&&(t+=1),e.originHash&&(t+=1),t+=r.get(e.hash)??0,e.degree=t,e.bestUrl=ht(e.sources)}let i=e=>typeof e.pulse==`number`?e.pulse:-1;return Array.from(n.values()).sort((e,n)=>t===`degreeDesc`?n.degree===e.degree?i(n)-i(e):n.degree-e.degree:t===`pulseAsc`?i(e)-i(n):i(n)-i(e)).slice(0,e)}function _t(e){if(e<=0)return[];let t=[{q:0,r:0}],n=1;for(;t.length<e;){let r=Ze[4].q*n,i=Ze[4].r*n;for(let a=0;a<6&&t.length<e;a++){let o=Ze[a].q,s=Ze[a].r;for(let a=0;a<n&&t.length<e;a++)t.push({q:r,r:i}),r+=o,i+=s}n+=1}return t}function vt(e,t){return{x:t*Math.sqrt(3)*(e.q+e.r/2),y:t*(3/2)*e.r}}function yt(e){let t=e;return nt(t.pulse??t.latestPulse??t.latest_pulse)}function bt(e){return $e(e)?typeof e.pulled==`boolean`&&typeof e.imported==`number`:!1}var xt=G.memo(function(e){let{node:t,x:n,y:r,selected:i,onClick:a}=e,o=Je(qe(typeof t.pulse==`number`&&Number.isFinite(t.pulse)?t.pulse:0)),s=(Ye(t.hash)-.5)*220*Ke,c=Math.floor(Ye(t.hash)*6),l=ct(t.chakraDay)??`shape-${c}`,u=t.chakraDay?void 0:Xe(t.hash),d=[];typeof t.pulse==`number`&&d.push(`pulse ${t.pulse}`),Number.isFinite(o.beat)&&Number.isFinite(o.stepIndex)&&d.push(`beat ${o.beat} step ${o.stepIndex}`),t.chakraDay&&d.push(t.chakraDay),d.push(lt(t.hash,12));let f=d.join(` — `);return(0,Z.jsx)(`button`,{type:`button`,className:[`sigilHex`,st(t.chakraDay),t.transferDirection?`xfer-${t.transferDirection}`:``,i?`isSelected`:``].join(` `),style:{transform:`translate3d(${n}px, ${r}px, ${s.toFixed(2)}px)`},onClick:a,"aria-label":f,title:f,children:(0,Z.jsxs)(`div`,{className:`sigilHexInner`,children:[(0,Z.jsx)(`div`,{className:`sigilHexGlyphFrame`,"aria-hidden":`true`,children:(0,Z.jsx)(`div`,{className:`sigilHexGlyphSimple ${l}`,style:u?{"--hex-tint":u}:void 0})}),(0,Z.jsxs)(`div`,{className:`sigilHexTop`,children:[(0,Z.jsx)(`span`,{className:`sigilHexPulse`,children:typeof t.pulse==`number`?t.pulse:`—`}),(0,Z.jsx)(`span`,{className:`sigilHexHash`,children:lt(t.hash)})]}),(0,Z.jsxs)(`div`,{className:`sigilHexMid`,children:[(0,Z.jsxs)(`span`,{className:`sigilHexBeat`,children:[o.beat,`:`,o.stepIndex]}),(0,Z.jsx)(`span`,{className:`sigilHexDelta`,children:ut(t.phiDelta)})]}),(0,Z.jsx)(`div`,{className:`sigilHexBot`,children:(0,Z.jsx)(`span`,{className:`sigilHexChakra`,children:t.chakraDay||`—`})})]})})});function St({className:e,sort:n=`pulseDesc`,maxNodes:i=1400,edgeMode:a=`all`,syncMode:c=`standalone`,onOpenPulseView:l}){let d=c===`standalone`,[f,m]=(0,G.useState)(a),[h,_]=(0,G.useState)(``),[v,y]=(0,G.useState)(()=>E()?1:0),[b,x]=(0,G.useState)(null),S=(0,G.useRef)(null),[C,w]=(0,G.useState)({w:0,h:0}),[D,O]=(0,G.useState)(.6),[k,te]=(0,G.useState)({x:-18,y:0,z:0}),[j,ne]=(0,G.useState)(!1),[M,N]=(0,G.useState)({x:0,y:0}),F=(0,G.useRef)({active:!1,mode:`pan`,x0:0,y0:0,panX0:0,panY0:0,rotX0:0,rotY0:0,rotZ0:0}),I=(0,G.useRef)(null),L=(0,G.useRef)(!1),R=(0,G.useRef)(null),z=(0,G.useCallback)(()=>{(0,G.startTransition)(()=>y(e=>e+1))},[]);(0,G.useEffect)(()=>{if(!Le)return;d&&(oe(),r(),de()),o(),E()&&z(),window.dispatchEvent(new Event(Re)),R.current=`BroadcastChannel`in window?new BroadcastChannel(Be):null;let e=e=>{let t=e.data;if(!$e(t)||et(t.type)!==`sigil:select`)return;let n=tt(t.hash);n&&x(n)};R.current?.addEventListener(`message`,e);let n=e=>{if(!e.key||!e.newValue)return;if(e.key===Ve){let t=tt(e.newValue);t&&x(t);return}let n=e.key===ue,r=e.key===ee;if(!(!n&&!r))try{let n=rt(e.newValue);if(!Array.isArray(n))return;let r=!1;for(let e of n)typeof e==`string`&&p(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:d})&&(r=!0);r&&(t(),z())}catch{}};window.addEventListener(`storage`,n);let i=`BroadcastChannel`in window?new BroadcastChannel(ze):null,a=e=>{let t=e.data;if(!$e(t)||et(t.type)!==`sigil:add`)return;let n=et(t.url);n&&p(n,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:d})&&z()};i?.addEventListener(`message`,a);let s=e=>{let t=e,n=typeof t.detail?.url==`string`?t.detail.url:``;n&&p(n,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:d})&&z()},c=e=>{let t=e,n=typeof t.detail?.url==`string`?t.detail.url:``;n&&p(n,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:d})&&z()};window.addEventListener(`sigil:url-registered`,s),window.addEventListener(`sigil:minted`,c);let l=()=>{d&&(re(),pe())};return window.addEventListener(`pagehide`,l),()=>{window.removeEventListener(`storage`,n),window.removeEventListener(`sigil:url-registered`,s),window.removeEventListener(`sigil:minted`,c),window.removeEventListener(`pagehide`,l),i?.removeEventListener(`message`,a),i?.close(),R.current?.removeEventListener(`message`,e),R.current?.close(),R.current=null}},[d,z]),(0,G.useEffect)(()=>{let e=S.current;if(!e||typeof ResizeObserver>`u`)return;let t=new ResizeObserver(e=>{let t=e[0]?.contentRect;t&&w({w:Math.round(t.width),h:Math.round(t.height)})});return t.observe(e),()=>t.disconnect()},[]);let ie=(0,G.useCallback)(async e=>{if(T()&&c===`standalone`){if(A(),e===`pulse`){await pe();return}await pe()}},[c]),ae=(0,G.useCallback)(async(e,t)=>{if(T()&&c===`standalone`&&!L.current){L.current=!0;try{let n=await g(e=>new URL(s,e).toString(),{method:`GET`,cache:`no-store`,signal:t,headers:void 0});if(!n||!n.ok)return;let r=``,i;try{let e=await n.json(),t=e;r=typeof t.seal==`string`?t.seal:``,i=yt(e)}catch{return}let a=I.current,o=i==null?void 0:Ct();if(a&&r&&a===r&&!(i!=null&&(o==null||i>o))&&e===`pulse`){I.current=r;return}let c=await u(t);bt(c)?(c.pulled&&(I.current=c.remoteSeal??r??a??null),c.imported>0&&z()):I.current=r||a,A(),await pe()}finally{L.current=!1}}},[z,c]);(0,G.useEffect)(()=>{if(!Le||c!==`standalone`)return;let e=new AbortController;ie(`open`),ae(`open`,e.signal);let t=()=>{document.visibilityState===`visible`&&(ie(`visible`),ae(`visible`,e.signal))},n=()=>{ie(`focus`),ae(`focus`,e.signal)},r=()=>{ie(`online`),ae(`online`,e.signal)};return document.addEventListener(`visibilitychange`,t),window.addEventListener(`focus`,n),window.addEventListener(`online`,r),()=>{document.removeEventListener(`visibilitychange`,t),window.removeEventListener(`focus`,n),window.removeEventListener(`online`,r),e.abort()}},[ae,ie,c]);let B=(0,G.useMemo)(()=>gt(i,n),[v,i,n]),se=(0,G.useMemo)(()=>{let e=new Map;for(let t of B)e.set(t.hash,t);return e},[B]),ce=(0,G.useMemo)(()=>{let e=new Map;for(let t of B){if(!t.parentHash)continue;let n=e.get(t.parentHash)??[];n.push(t.hash),e.set(t.parentHash,n)}return e},[B]),le=(0,G.useMemo)(()=>{if(B.length===0)return null;if(Le){let e=it(Ve),t=e?e.toLowerCase():``;if(t&&se.has(t))return t}let e=null;for(let t of B)e?t.degree>e.degree&&(e=t):e=t;return e?.hash??B[0].hash},[B,se]),V=(0,G.useMemo)(()=>{let e=b?b.toLowerCase():null;return e&&se.has(e)?e:le},[b,se,le]),H=(0,G.useMemo)(()=>V?se.get(V)??null:null,[V,se]),U=H&&typeof H.pulse==`number`&&Number.isFinite(H.pulse)?qe(H.pulse):null,fe=U==null?null:Je(U),me=(0,G.useMemo)(()=>{let e=h.trim().toLowerCase();return e?B.filter(t=>!!(t.hash.includes(e)||typeof t.pulse==`number`&&String(t.pulse).includes(e)||t.userPhiKey&&t.userPhiKey.toLowerCase().includes(e)||t.kaiSignature&&t.kaiSignature.toLowerCase().includes(e)||t.chakraDay&&t.chakraDay.toLowerCase().includes(e))):B},[B,h]),W=(0,G.useMemo)(()=>{let e=me.length,t=_t(e).map(e=>vt(e,45)),n=1/0,r=1/0,i=-1/0,a=-1/0;for(let e of t)n=Math.min(n,e.x),r=Math.min(r,e.y),i=Math.max(i,e.x),a=Math.max(a,e.y);let o=Math.sqrt(3)*45,s=(Number.isFinite(n)?-n:0)+96,c=(Number.isFinite(r)?-r:0)+96,l=me.map((e,n)=>{let r=t[n]??{x:0,y:0};return{node:e,x:r.x+s-o/2,y:r.y+c-90/2,cx:r.x+s,cy:r.y+c}}),u=(Number.isFinite(i-n)?i-n:0)+192+o,d=(Number.isFinite(a-r)?a-r:0)+192+90,f=new Map;for(let e of l)f.set(e.node.hash,e);return{width:u,height:d,items:l,itemByHash:f,centerOf:e=>{if(!e)return null;let t=f.get(e);return t?{x:t.cx,y:t.cy}:null}}},[me]),he=(0,G.useMemo)(()=>{if(!V||!C.w||!C.h)return{x:0,y:0};let e=W.centerOf(V);return e?{x:C.w/2-e.x*D,y:C.h/2-e.y*D}:{x:0,y:0}},[V,C.w,C.h,W,D]),ge=j?M:he,_e=(0,G.useMemo)(()=>{if(!V||f===`none`)return[];let e=W.itemByHash.get(V),t=se.get(V);if(!e||!t)return[];let n=[],r=(t,r)=>{if(!t)return;let i=W.itemByHash.get(t);i&&n.push({x1:e.cx,y1:e.cy,x2:i.cx,y2:i.cy,kind:r})};if((f===`parent`||f===`parent+children`||f===`all`)&&r(t.parentHash,`parent`),f===`parent+children`||f===`all`){let e=ce.get(t.hash)??[];for(let t of e)r(t,`child`)}return f===`all`&&r(t.originHash,`origin`),n},[V,f,W,se,ce]),ve=()=>{ne(!1),N({x:0,y:0})},ye=e=>{if(Le){at(Ve,e);try{R.current?.postMessage({type:`sigil:select`,hash:e})}catch{}}},be=e=>{let t=e.toLowerCase();if(x(t),ye(t),ve(),l){let e=se.get(t),n=e?.pulse;typeof n==`number`&&Number.isFinite(n)&&l({pulse:n,originHash:e?.originHash})}},K=e=>{let t=S.current;if(!t)return;let n=e.deltaY,r=Qe(D*(n>0?.9:1.12),.12,4.25),i=t.getBoundingClientRect(),a=e.clientX-i.left,o=e.clientY-i.top,s=ge,c=(a-s.x)/D,l=(o-s.y)/D,u=a-c*r,d=o-l*r;O(r),ne(!0),N({x:u,y:d})},xe=e=>{e.button!==0&&e.button!==2||e.target instanceof HTMLElement&&e.target.closest(`.sigilHex`)||(ne(!0),F.current={active:!0,mode:e.button===2||e.shiftKey?`rotate`:`pan`,x0:e.clientX,y0:e.clientY,panX0:ge.x,panY0:ge.y,rotX0:k.x,rotY0:k.y,rotZ0:k.z},e.currentTarget.setPointerCapture(e.pointerId))},q=e=>{if(!F.current.active)return;let t=e.clientX-F.current.x0,n=e.clientY-F.current.y0;F.current.mode===`rotate`?te({x:Qe(F.current.rotX0+n*.35,-85,85),y:F.current.rotY0+t*.35,z:e.altKey?F.current.rotZ0+t*.2:F.current.rotZ0}):N({x:F.current.panX0+t,y:F.current.panY0+n})},J=e=>{F.current.active=!1;try{e.currentTarget.releasePointerCapture(e.pointerId)}catch{}},Y=()=>{H&&window.open(H.bestUrl,`_blank`,`noopener,noreferrer`)},X=async()=>{if(H&&navigator.clipboard)try{await navigator.clipboard.writeText(H.bestUrl)}catch{}},Se=H?ce.get(H.hash)?.length??0:0;return(0,Z.jsxs)(`div`,{className:[`sigilHoneycomb`,e??``].join(` `),children:[(0,Z.jsxs)(`div`,{className:`sigilHoneycombHeader`,children:[(0,Z.jsx)(`div`,{className:`sigilHoneycombTitle`,"aria-hidden":`true`}),(0,Z.jsxs)(`div`,{className:`sigilHoneycombControls`,children:[(0,Z.jsxs)(`div`,{className:`searchBox`,children:[(0,Z.jsx)(`input`,{value:h,onChange:e=>_(e.target.value),placeholder:`Search hash / pulse / phiKey / signature / chakra…`,spellCheck:!1}),h?(0,Z.jsx)(`button`,{className:`miniBtn`,onClick:()=>_(``),type:`button`,children:`Clear`}):null]}),(0,Z.jsxs)(`div`,{className:`toggleRow`,children:[(0,Z.jsxs)(`div`,{className:`seg`,children:[(0,Z.jsxs)(`button`,{type:`button`,className:f===`none`?`on`:``,onClick:()=>m(`none`),"aria-label":`Edges off`,children:[(0,Z.jsx)(`span`,{className:`btn-icon`,children:`◌`}),(0,Z.jsx)(`span`,{className:`btn-text`,children:`Edges: Off`})]}),(0,Z.jsxs)(`button`,{type:`button`,className:f===`parent`?`on`:``,onClick:()=>m(`parent`),"aria-label":`Parent edges`,children:[(0,Z.jsx)(`span`,{className:`btn-icon`,children:`↑`}),(0,Z.jsx)(`span`,{className:`btn-text`,children:`Parent`})]}),(0,Z.jsxs)(`button`,{type:`button`,className:f===`parent+children`?`on`:``,onClick:()=>m(`parent+children`),"aria-label":`Parent and children edges`,children:[(0,Z.jsx)(`span`,{className:`btn-icon`,children:`⇄`}),(0,Z.jsx)(`span`,{className:`btn-text`,children:`Parent+Kids`})]}),(0,Z.jsxs)(`button`,{type:`button`,className:f===`all`?`on`:``,onClick:()=>m(`all`),"aria-label":`All edges`,children:[(0,Z.jsx)(`span`,{className:`btn-icon`,children:`◎`}),(0,Z.jsx)(`span`,{className:`btn-text`,children:`All`})]})]}),(0,Z.jsx)(`div`,{className:`seg`})]})]})]}),(0,Z.jsxs)(`div`,{className:`sigilHoneycombBody`,children:[(0,Z.jsx)(`div`,{className:`combViewport`,ref:S,onWheel:K,onPointerDown:xe,onPointerMove:q,onPointerUp:J,onPointerCancel:J,onContextMenu:e=>e.preventDefault(),children:(0,Z.jsxs)(`div`,{className:`combInner`,style:{width:`${W.width}px`,height:`${W.height}px`,transform:`translate(${ge.x}px, ${ge.y}px) scale(${D}) rotateX(${k.x}deg) rotateY(${k.y}deg) rotateZ(${k.z}deg)`},children:[(0,Z.jsx)(`svg`,{className:`combEdges`,width:W.width,height:W.height,"aria-hidden":`true`,children:_e.map((e,t)=>(0,Z.jsx)(`line`,{x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2,className:`edgeLine edge-${e.kind}`,vectorEffect:`non-scaling-stroke`},`${e.kind}-${t}`))}),W.items.map(e=>(0,Z.jsx)(xt,{node:e.node,x:e.x,y:e.y,selected:e.node.hash===V,onClick:()=>be(e.node.hash)},e.node.hash))]})}),(0,Z.jsx)(`aside`,{className:`combInspector`,"aria-label":`Honeycomb inspector`,children:(0,Z.jsxs)(`div`,{className:`inspectorCard`,children:[(0,Z.jsxs)(`div`,{className:`inspectorHead`,children:[(0,Z.jsx)(`div`,{className:`inspectorTitle`,children:`Selection`}),(0,Z.jsx)(`div`,{className:`inspectorSub`,children:H?lt(H.hash,16):`—`})]}),(0,Z.jsxs)(`div`,{className:`inspectorGrid`,children:[(0,Z.jsx)(`div`,{className:`k`,children:`Pulse`}),(0,Z.jsx)(`div`,{className:`v mono`,children:H?.pulse??`—`}),(0,Z.jsx)(`div`,{className:`k`,children:`Beat:Step`}),(0,Z.jsx)(`div`,{className:`v mono`,children:fe?`${fe.beat}:${fe.stepIndex}`:`—`}),(0,Z.jsx)(`div`,{className:`k`,children:`Chakra`}),(0,Z.jsx)(`div`,{className:`v`,children:H?.chakraDay??`—`}),(0,Z.jsx)(`div`,{className:`k`,children:`ΔΦ`}),(0,Z.jsx)(`div`,{className:`v mono`,children:ut(H?.phiDelta)}),(0,Z.jsx)(`div`,{className:`k`,children:`Transfer`}),(0,Z.jsx)(`div`,{className:`v`,children:H?.transferDirection??`—`}),(0,Z.jsx)(`div`,{className:`k`,children:`Parent`}),(0,Z.jsx)(`div`,{className:`v mono`,children:H?.parentHash?(0,Z.jsx)(`button`,{className:`linkBtn`,type:`button`,onClick:()=>be(H.parentHash),children:lt(H.parentHash,14)}):`—`}),(0,Z.jsx)(`div`,{className:`k`,children:`Children`}),(0,Z.jsx)(`div`,{className:`v mono`,children:H?Se:`—`}),(0,Z.jsx)(`div`,{className:`k`,children:`Origin`}),(0,Z.jsx)(`div`,{className:`v mono`,children:H?.originHash?(0,Z.jsx)(`button`,{className:`linkBtn`,type:`button`,onClick:()=>be(H.originHash),children:lt(H.originHash,14)}):`—`}),(0,Z.jsx)(`div`,{className:`k`,children:`PhiKey`}),(0,Z.jsx)(`div`,{className:`v mono`,children:H?.userPhiKey?lt(H.userPhiKey,20):`—`}),(0,Z.jsx)(`div`,{className:`k`,children:`KaiSig`}),(0,Z.jsx)(`div`,{className:`v mono`,children:H?.kaiSignature?lt(H.kaiSignature,20):`—`}),(0,Z.jsx)(`div`,{className:`k`,children:`Degree`}),(0,Z.jsx)(`div`,{className:`v mono`,children:H?.degree??`—`})]}),(0,Z.jsxs)(`div`,{className:`inspectorActions`,children:[(0,Z.jsx)(`button`,{type:`button`,className:`primaryBtn`,onClick:Y,disabled:!H,children:`Open`}),(0,Z.jsx)(`button`,{type:`button`,className:`miniBtn`,onClick:X,disabled:!H,children:`Copy URL`})]}),H?.sources?.length?(0,Z.jsxs)(`details`,{className:`sources`,children:[(0,Z.jsxs)(`summary`,{children:[`Sources (`,H.sources.length,`)`]}),(0,Z.jsxs)(`div`,{className:`sourcesList`,children:[H.sources.slice(0,40).map((e,t)=>(0,Z.jsx)(`div`,{className:`sourceItem mono`,children:P(e)},`${t}-${e}`)),H.sources.length>40?(0,Z.jsxs)(`div`,{className:`sourceMore`,children:[`… `,H.sources.length-40,` more`]}):null]})]}):null]})})]})]})}function Ct(){let e;for(let[,t]of D){if(!$e(t))continue;let n=nt(t.pulse);n!=null&&(e==null||n>e)&&(e=n)}return e}var wt=O(B(),1),Tt=typeof window<`u`,Et=`sigil:explorer:select:bc:v1`,Dt=`sigil:explorer:selectedHash:v1`,Ot=1000000n,kt=(e,t)=>{if(t===0n)return 0n;let n=e%t;return n>=0n?n:n+t},At=(e,t)=>{let n=e<0n?-e:e,r=t<0n?-t:t;for(;r!==0n;){let e=n%r;n=r,r=e}return n},jt=(()=>{let e=At(i,Ot);return e===0n?0n:i/e})(),Mt=new Set,Nt=(1+Math.sqrt(5))/2,Pt=e=>{if(!Number.isFinite(e))return 0;let t=BigInt(Math.trunc(e));if(jt<=0n)return 0;let n=kt(t,jt);return Number(n)},Ft=e=>{let t=Number.isFinite(e)?Math.trunc(e):0,{beat:n,stepIndex:r,percentIntoStep:i}=w(BigInt(t)*Ot);return{beat:n,stepIndex:r,stepPct:F(i)}},It=e=>{let t=0;for(let n=0;n<e.length;n+=1)t=(t*31+e.charCodeAt(n))%1e6;return t/1e6};function Lt(e){let[,t]=(0,G.useState)(0),n=Mt.has(e);return(0,G.useEffect)(()=>{if(n)return;let r=!1,i=(typeof window<`u`&&`requestIdleCallback`in window?e=>window.requestIdleCallback(e,{timeout:200}):e=>window.setTimeout(e,32))(()=>{r||(Mt.add(e),t(e=>e+1))});return()=>{r=!0,typeof window<`u`&&`cancelIdleCallback`in window?window.cancelIdleCallback(i):clearTimeout(i)}},[n,e]),n}var Rt=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function zt(e,t,n){return Math.max(t,Math.min(n,e))}function Bt(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function Vt(e){return typeof e==`string`&&e.trim().length>0?e.trim():void 0}function Ht(e){let t=Vt(e);return t?t.toLowerCase():void 0}function Ut(e){if(typeof e==`number`&&Number.isFinite(e))return e;if(typeof e==`string`){let t=Number(e);if(Number.isFinite(t))return t}}function Wt(e){let t=Vt(e);if(t===`send`||t===`receive`)return t}function Gt(e){let t=(e??``).toLowerCase();return t.includes(`root`)?`Root`:t.includes(`sacral`)?`Sacral`:t.includes(`solar`)?`Solar Plexus`:t.includes(`heart`)?`Heart`:t.includes(`throat`)?`Throat`:t.includes(`third`)||t.includes(`brow`)?`Third Eye`:t.includes(`crown`)?`Crown`:`Root`}function Kt(e,t){try{window.localStorage.setItem(e,t)}catch{}}function qt(e){if(Tt){Kt(Dt,e);try{let t=`BroadcastChannel`in window?new BroadcastChannel(Et):null;t?.postMessage({type:`sigil:select`,hash:e}),t?.close()}catch{}}}function Jt(e){let t=(e??``).toLowerCase();return t.includes(`root`)?`chakra-root`:t.includes(`sacral`)?`chakra-sacral`:t.includes(`solar`)?`chakra-solar`:t.includes(`heart`)?`chakra-heart`:t.includes(`throat`)?`chakra-throat`:t.includes(`third`)||t.includes(`brow`)?`chakra-third`:t.includes(`crown`)?`chakra-crown`:`chakra-unknown`}function Yt(e){return e?e.startsWith(`-`)?e:`+${e}`:`—`}function Xt(e){return e==null||!Number.isFinite(e)?`—`:new Intl.NumberFormat(`en-US`,{minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}function Zt(e){return e==null||!Number.isFinite(e)?`—`:e.toFixed(6).replace(/0+$/u,``).replace(/\.$/u,``)}function Qt(e){return{pulse:Ut(e.pulse),beat:Ut(e.beat),stepIndex:Ut(e.stepIndex),chakraDay:Vt(e.chakraDay),userPhiKey:Vt(e.userPhiKey),kaiSignature:Ht(e.kaiSignature),transfers:Array.isArray(e.transfers)?e.transfers:void 0,segments:Array.isArray(e.segments)?e.segments:void 0,ip:Bt(e.ip)?e.ip:void 0}}function $t(e,t){if(t==null||!Number.isFinite(t))return null;try{let{unsigned:n}=ne(Qt(e),t);return Number.isFinite(n.valuePhi)?n.valuePhi:null}catch{return null}}function en(e,t){if(t==null||!Number.isFinite(t))return null;try{let n=x({meta:Qt(e),nowPulse:t,usd:100,currentStreakDays:0,lifetimeUsdSoFar:0},d);return Number.isFinite(n.usdPerPhi)?n.usdPerPhi:null}catch{return null}}function tn(e,t=10){return e.length<=t?e:e.slice(0,t)}function nn(e){let t=j(e);if(typeof t==`string`&&t.length)return t.toLowerCase();let n=e.match(/\/s\/([0-9a-f]{32,128})(?:\?|$)/i);return n?.[1]?n[1].toLowerCase():null}function rn(e){let t=Ht(e.parentHash);if(t)return t;let n=Vt(e.parentUrl);if(n){let e=nn(n);if(e)return e}}function an(e){let t=Vt(e.originUrl);if(t){let e=nn(t);if(e)return e}}function on(e){let t=0,n=e=>{e!=null&&(typeof e==`string`&&e.length===0||(t+=1))};return n(e.pulse),n(e.beat),n(e.stepIndex),n(e.chakraDay),n(e.userPhiKey),n(e.kaiSignature),n(e.parentHash),n(e.originHash),n(e.transferDirection),n(e.transferAmountPhi),n(e.phiDelta),t}function sn(e){let t=e[0]??``,n=-1/0;for(let r of e){let e=L(r),i=y(e,ce(e));i>n&&(n=i,t=r)}return z(t)}function cn(e){if(e<=0)return[];let t=[{q:0,r:0}],n=1;for(;t.length<e;){let r=Rt[4].q*n,i=Rt[4].r*n;for(let a=0;a<6&&t.length<e;a++){let o=Rt[a].q,s=Rt[a].r;for(let a=0;a<n&&t.length<e;a++)t.push({q:r,r:i}),r+=o,i+=s}n+=1}return t}function ln(e,t){return{x:t*Math.sqrt(3)*(e.q+e.r/2),y:t*(3/2)*e.r}}function un(e){let t=new Map;for(let[n,r]of D){if(!Bt(r))continue;let i=Ut(r.pulse);if(i!==e)continue;let a=L(n),o=nn(a);if(!o)continue;let s={hash:o,bestUrl:z(a),sources:[a],pulse:i,beat:Ut(r.beat),stepIndex:Ut(r.stepIndex),chakraDay:Vt(r.chakraDay),userPhiKey:Vt(r.userPhiKey),kaiSignature:Ht(r.kaiSignature),parentHash:rn(r),originHash:an(r),transferDirection:Wt(r.transferDirection),transferAmountPhi:Vt(r.transferAmountPhi),phiDelta:Vt(r.phiDelta)},c=t.get(o);if(!c){t.set(o,{hash:o,bestUrl:s.bestUrl??z(a),sources:[a],pulse:s.pulse,beat:s.beat,stepIndex:s.stepIndex,chakraDay:s.chakraDay,userPhiKey:s.userPhiKey,kaiSignature:s.kaiSignature,parentHash:s.parentHash,originHash:s.originHash,transferDirection:s.transferDirection,transferAmountPhi:s.transferAmountPhi,phiDelta:s.phiDelta,degree:0});continue}let l=new Set(c.sources);l.add(a);let u=on(c),d=on(s)>u;t.set(o,{...c,sources:Array.from(l),pulse:c.pulse??s.pulse,beat:d&&s.beat!==void 0?s.beat:c.beat??s.beat,stepIndex:d&&s.stepIndex!==void 0?s.stepIndex:c.stepIndex??s.stepIndex,chakraDay:d&&s.chakraDay?s.chakraDay:c.chakraDay??s.chakraDay,userPhiKey:d&&s.userPhiKey?s.userPhiKey:c.userPhiKey??s.userPhiKey,kaiSignature:d&&s.kaiSignature?s.kaiSignature:c.kaiSignature??s.kaiSignature,parentHash:d&&s.parentHash?s.parentHash:c.parentHash??s.parentHash,originHash:d&&s.originHash?s.originHash:c.originHash??s.originHash,transferDirection:d&&s.transferDirection?s.transferDirection:c.transferDirection??s.transferDirection,transferAmountPhi:d&&s.transferAmountPhi?s.transferAmountPhi:c.transferAmountPhi??s.transferAmountPhi,phiDelta:d&&s.phiDelta?s.phiDelta:c.phiDelta??s.phiDelta,bestUrl:c.bestUrl,degree:0})}let n=new Map;for(let e of t.values())e.parentHash&&n.set(e.parentHash,(n.get(e.parentHash)??0)+1);for(let e of t.values()){let t=0;e.parentHash&&(t+=1),e.originHash&&(t+=1),t+=n.get(e.hash)??0,e.degree=t,e.bestUrl=sn(e.sources)}return Array.from(t.values()).sort((e,t)=>{if(t.degree!==e.degree)return t.degree-e.degree;let n=typeof e.beat==`number`?e.beat:-1,r=typeof t.beat==`number`?t.beat:-1;if(r!==n)return r-n;let i=typeof e.stepIndex==`number`?e.stepIndex:-1,a=typeof t.stepIndex==`number`?t.stepIndex:-1;return a===i?e.hash<t.hash?-1:e.hash>t.hash?1:0:a-i})}var dn=G.memo(function(e){let{node:t,x:n,y:r,selected:i,isOrigin:a,onClick:o}=e,s=Pt(typeof t.pulse==`number`&&Number.isFinite(t.pulse)?t.pulse:0),c=Ft(s),l=Gt(t.chakraDay),u=Lt(`${s}:${l}`),d=(It(t.hash)-.5)*220*Nt,f=[];typeof t.pulse==`number`&&f.push(`pulse ${t.pulse}`),Number.isFinite(c.beat)&&Number.isFinite(c.stepIndex)&&f.push(`beat ${c.beat} step ${c.stepIndex}`),t.chakraDay&&f.push(t.chakraDay),f.push(tn(t.hash,12));let p=f.join(` — `);return(0,Z.jsx)(`button`,{type:`button`,className:[`sigilHex`,Jt(t.chakraDay),t.transferDirection?`xfer-${t.transferDirection}`:``,a?`isOrigin`:``,i?`isSelected`:``].join(` `),style:{transform:`translate3d(${n}px, ${r}px, ${d.toFixed(2)}px)`},onClick:o,"aria-label":p,title:p,children:(0,Z.jsxs)(`div`,{className:`sigilHexInner`,children:[(0,Z.jsx)(`div`,{className:`sigilHexGlyphFrame`,"aria-hidden":`true`,children:u?(0,Z.jsx)(me,{pulse:s,beat:c.beat,stepIndex:c.stepIndex,stepPct:c.stepPct,chakraDay:l,size:48,hashMode:`deterministic`,animate:!1}):(0,Z.jsx)(`div`,{className:`sigilHexGlyphPlaceholder`})}),(0,Z.jsxs)(`div`,{className:`sigilHexTop`,children:[(0,Z.jsx)(`span`,{className:`sigilHexPulse`,children:typeof t.pulse==`number`?t.pulse:`—`}),(0,Z.jsx)(`span`,{className:`sigilHexHash`,children:tn(t.hash)})]}),(0,Z.jsxs)(`div`,{className:`sigilHexMid`,children:[(0,Z.jsxs)(`span`,{className:`sigilHexBeat`,children:[c.beat,`:`,c.stepIndex]}),(0,Z.jsx)(`span`,{className:`sigilHexDelta`,children:Yt(t.phiDelta)})]}),(0,Z.jsx)(`div`,{className:`sigilHexBot`,children:(0,Z.jsx)(`span`,{className:`sigilHexChakra`,children:t.chakraDay||`—`})})]})})});function fn(e){let{open:t,pulse:n,originUrl:r,originHash:i,onClose:a}=e,o=(0,G.useRef)(null);(0,G.useEffect)(()=>{if(!Tt||!t)return;let e=e=>{e.key===`Escape`&&a()};return window.addEventListener(`keydown`,e),window.setTimeout(()=>{(o.current?.querySelector(`.phmBtnClose`))?.focus()},0),()=>{window.removeEventListener(`keydown`,e)}},[t,a]),(0,G.useEffect)(()=>{if(!Tt||!t)return;let e=document.documentElement,n=document.body,r=e.style.overflow,i=n.style.overflow;return e.style.overflow=`hidden`,n.style.overflow=`hidden`,()=>{e.style.overflow=r,n.style.overflow=i}},[t]);let s=Tt?document.body:null;if(!t||s==null)return null;let c=`${n??`none`}:${i??``}:${r??``}`;return(0,wt.createPortal)((0,Z.jsx)(`div`,{className:`phmBackdrop`,role:`presentation`,onMouseDown:e=>{e.target===e.currentTarget&&a()},children:(0,Z.jsx)(`div`,{ref:o,className:`phmShell`,role:`dialog`,"aria-modal":`true`,children:(0,Z.jsx)(pn,{...e},c)})}),s)}function pn({open:e,pulse:t,originUrl:r,originHash:i,registryRev:a,onClose:o}){let[s]=(0,G.useState)(`parent+children`),[c,l]=(0,G.useState)(null),u=(0,G.useRef)(null),[d,f]=(0,G.useState)({w:0,h:0}),[p,ee]=(0,G.useState)(1),[m,g]=(0,G.useState)(!1),[_,v]=(0,G.useState)({x:0,y:0}),y=(0,G.useRef)({active:!1,x0:0,y0:0,panX0:0,panY0:0});(0,G.useEffect)(()=>{let e=u.current;if(!e||typeof ResizeObserver>`u`)return;let t=new ResizeObserver(e=>{let t=e[0]?.contentRect;t&&f({w:Math.round(t.width),h:Math.round(t.height)})});return t.observe(e),()=>t.disconnect()},[]);let b=typeof t==`number`?t:null,x=(0,G.useMemo)(()=>b==null?[]:un(b),[b,a]),S=(0,G.useMemo)(()=>i??(r?nn(r):null)??null,[i,r]),C=(0,G.useMemo)(()=>{let e=new Map;for(let t of x)e.set(t.hash,t);return e},[x]),w=(0,G.useMemo)(()=>{let e=new Map;for(let t of x){if(!t.parentHash)continue;let n=e.get(t.parentHash)??[];n.push(t.hash),e.set(t.parentHash,n)}return e},[x]),T=x,E=T.length>0?T:x,O=(0,G.useMemo)(()=>{if(E.length===0)return null;if(S&&C.has(S))return S;let e=null;for(let t of E)e?t.degree>e.degree&&(e=t):e=t;return e?.hash??E[0].hash},[E,S,C]),k=(0,G.useMemo)(()=>{let e=c?c.toLowerCase():null;return e&&C.has(e)?e:O},[c,C,O]),A=(0,G.useMemo)(()=>k?C.get(k)??null:null,[k,C]),te=A&&typeof A.pulse==`number`&&Number.isFinite(A.pulse)?Pt(A.pulse):null,j=te==null?null:Ft(te),M=j?Math.floor(j.beat):null,N=(0,G.useMemo)(()=>{if(b==null)return{phi:null,usd:null,usdPerPhi:null};let e=0,t=null;for(let[,n]of D){if(!Bt(n)||Ut(n.pulse)!==b)continue;let r=$t(n,b);if(r!=null&&(e+=r),t==null){let e=en(n,b);e!=null&&(t=e)}}let n=Number.isFinite(e)?e:null;return{phi:n,usd:n!=null&&t!=null?n*t:null,usdPerPhi:t}},[b,a]),F=(0,G.useMemo)(()=>{if(b==null)return null;let e=null;for(let[,t]of D)if(Bt(t)&&Ut(t.pulse)===b){e=t;break}if(!e)return null;let t=Qt(e),{unsigned:r}=ne(t,b);return n({version:1,unit:`Φ`,algorithm:`phi/kosmos-vφ-5`,policyChecksum:r.policyChecksum,valuePhi:r.valuePhi,premium:r.premium,inputs:r.inputs,computedAtPulse:r.computedAtPulse,headRef:r.headRef,stamp:`0`},t,b,64)},[b,a]),I=(0,G.useMemo)(()=>{let e=T.length,t=cn(e).map(e=>ln(e,49)),n=1/0,r=1/0,i=-1/0,a=-1/0;for(let e of t)n=Math.min(n,e.x),r=Math.min(r,e.y),i=Math.max(i,e.x),a=Math.max(a,e.y);let o=Math.sqrt(3)*49,s=(Number.isFinite(n)?-n:0)+120,c=(Number.isFinite(r)?-r:0)+120,l=T.map((e,n)=>{let r=t[n]??{x:0,y:0};return{node:e,x:r.x+s-o/2,y:r.y+c-98/2,cx:r.x+s,cy:r.y+c}}),u=(Number.isFinite(i-n)?i-n:0)+240+o,d=(Number.isFinite(a-r)?a-r:0)+240+98,f=new Map;for(let e of l)f.set(e.node.hash,e);return{width:u,height:d,items:l,itemByHash:f,centerOf:e=>{if(!e)return null;let t=f.get(e);return t?{x:t.cx,y:t.cy}:null}}},[T]),L=(0,G.useMemo)(()=>{if(!k||!d.w||!d.h)return{x:0,y:0};let e=I.centerOf(k);return e?{x:d.w/2-e.x*p,y:d.h/2-e.y*p}:{x:0,y:0}},[k,d.w,d.h,I,p]),R=m?_:L,z=(0,G.useMemo)(()=>{if(!k||s===`none`)return[];let e=I.itemByHash.get(k),t=C.get(k);if(!e||!t)return[];let n=[],r=(t,r)=>{if(!t)return;let i=I.itemByHash.get(t);i&&n.push({x1:e.cx,y1:e.cy,x2:i.cx,y2:i.cy,kind:r})};if((s===`parent`||s===`parent+children`||s===`all`)&&r(t.parentHash,`parent`),s===`parent+children`||s===`all`){let e=w.get(t.hash)??[];for(let t of e)r(t,`child`)}return s===`all`&&r(t.originHash,`origin`),n},[k,s,I,C,w]),re=()=>{g(!1),v({x:0,y:0})},ae=e=>{let t=e.toLowerCase();l(t),qt(t),re()},oe=e=>{let t=u.current;if(!t)return;let n=e.deltaY,r=zt(p*(n>0?.92:1.08),.35,3),i=t.getBoundingClientRect(),a=e.clientX-i.left,o=e.clientY-i.top,s=R,c=(a-s.x)/p,l=(o-s.y)/p,d=a-c*r,f=o-l*r;ee(r),g(!0),v({x:d,y:f})},B=e=>{e.button===0&&(e.target instanceof HTMLElement&&e.target.closest(`.sigilHex`)||(g(!0),y.current={active:!0,x0:e.clientX,y0:e.clientY,panX0:R.x,panY0:R.y},e.currentTarget.setPointerCapture(e.pointerId)))},se=e=>{if(!y.current.active)return;let t=e.clientX-y.current.x0,n=e.clientY-y.current.y0;v({x:y.current.panX0+t,y:y.current.panY0+n})},ce=e=>{y.current.active=!1;try{e.currentTarget.releasePointerCapture(e.pointerId)}catch{}},le=()=>{A&&window.open(A.bestUrl,`_blank`,`noopener,noreferrer`)},V=async()=>{if(A&&navigator.clipboard)try{await navigator.clipboard.writeText(A.bestUrl)}catch{}},H=b==null?`Pulse`:`Pulse ${b}`,ue=S??``;return(0,Z.jsxs)(`div`,{className:`phmRoot`,"aria-label":`Pulse Atlas`,children:[(0,Z.jsxs)(`header`,{className:`phmHeader`,children:[(0,Z.jsxs)(`div`,{className:`phmHeaderLeft`,children:[(0,Z.jsxs)(`div`,{className:`phmTitleBlock`,children:[(0,Z.jsx)(`div`,{id:`phmTitle`,className:`phmTitle`,children:H}),(0,Z.jsxs)(`div`,{className:`phmSub`,children:[ue?(0,Z.jsxs)(`span`,{className:`phmOrigin`,children:[`origin `,tn(ue,14)]}):null,M==null?null:(0,Z.jsx)(`span`,{className:`phmDot`,children:`•`}),M==null?null:(0,Z.jsxs)(`span`,{className:`phmBeatFilter`,children:[`beat `,M]})]})]}),(0,Z.jsx)(`div`,{className:`phmChart`,children:F?(0,Z.jsx)(ie,{data:F.lineData,live:N.phi??F.lineData[F.lineData.length-1]?.value??0,pv:F.lineData[F.lineData.length-1]?.value??0,premiumX:1,momentX:1,colors:Array.from(h),height:96,usdPerPhi:N.usdPerPhi??0,mode:`usd`}):(0,Z.jsx)(`div`,{className:`phmChartEmpty`,children:`No pulse data`})})]}),(0,Z.jsxs)(`div`,{className:`phmHeaderRight`,children:[(0,Z.jsxs)(`div`,{className:`phmValueCard`,"aria-live":`polite`,children:[(0,Z.jsx)(`div`,{className:`phmValueLabel`,children:`Pulse Value`}),(0,Z.jsx)(`div`,{className:`phmValuePhi`,children:N.phi==null?`—`:`${Zt(N.phi)} Φ`}),(0,Z.jsx)(`div`,{className:`phmValueUsd`,children:N.usd==null?`—`:`$${Xt(N.usd)}`}),(0,Z.jsx)(`div`,{className:`phmValueMeta`,children:N.usdPerPhi==null?`Live rate`:`$${Xt(N.usdPerPhi)} / Φ`})]}),(0,Z.jsx)(`button`,{type:`button`,className:`phmBtn phmBtnClose`,onClick:o,"aria-label":`Close`,children:`✕`})]})]}),(0,Z.jsxs)(`div`,{className:`phmBody`,children:[(0,Z.jsx)(`div`,{className:`phmCombPanel`,children:(0,Z.jsxs)(`div`,{className:`phmViewport combViewport`,ref:u,onWheel:oe,onPointerDown:B,onPointerMove:se,onPointerUp:ce,onPointerCancel:ce,children:[(0,Z.jsxs)(`div`,{className:`combInner`,style:{width:`${I.width}px`,height:`${I.height}px`,transform:`translate(${R.x}px, ${R.y}px) scale(${p})`},children:[(0,Z.jsx)(`svg`,{className:`combEdges`,width:I.width,height:I.height,"aria-hidden":`true`,children:z.map((e,t)=>(0,Z.jsx)(`line`,{x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2,className:`edgeLine edge-${e.kind}`,vectorEffect:`non-scaling-stroke`},`${e.kind}-${t}`))}),I.items.map(e=>(0,Z.jsx)(dn,{node:e.node,x:e.x,y:e.y,isOrigin:S!=null&&e.node.hash===S,selected:e.node.hash===k,onClick:()=>ae(e.node.hash)},e.node.hash))]}),(0,Z.jsx)(`div`,{className:`combHint phmHint`,children:`Pulse lattice • drag to pan • scroll to zoom`})]})}),(0,Z.jsx)(`aside`,{className:`phmInspector`,children:(0,Z.jsxs)(`div`,{className:`inspectorCard phmInspectorCard`,children:[(0,Z.jsxs)(`div`,{className:`inspectorHead`,children:[(0,Z.jsx)(`div`,{className:`inspectorTitle`,children:`Selection`}),(0,Z.jsx)(`div`,{className:`inspectorSub`,children:A?tn(A.hash,16):`—`})]}),(0,Z.jsxs)(`div`,{className:`inspectorGrid`,children:[A?.pulse!=null&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`Pulse`}),(0,Z.jsx)(`div`,{className:`v mono`,children:A.pulse})]}),te!=null&&j&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`Beat:Step`}),(0,Z.jsxs)(`div`,{className:`v mono`,children:[j.beat,`:`,j.stepIndex]})]}),A?.chakraDay&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`Chakra`}),(0,Z.jsx)(`div`,{className:`v`,children:A.chakraDay})]}),A?.phiDelta&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`ΔΦ`}),(0,Z.jsx)(`div`,{className:`v mono`,children:Yt(A.phiDelta)})]}),A?.transferDirection&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`Transfer`}),(0,Z.jsx)(`div`,{className:`v`,children:A.transferDirection})]}),A?.parentHash&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`Parent`}),(0,Z.jsx)(`div`,{className:`v mono`,children:C.has(A.parentHash)?(0,Z.jsx)(`button`,{className:`linkBtn`,type:`button`,onClick:()=>ae(A.parentHash),children:tn(A.parentHash,14)}):tn(A.parentHash,14)})]}),A?.originHash&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`Origin`}),(0,Z.jsx)(`div`,{className:`v mono`,children:C.has(A.originHash)?(0,Z.jsx)(`button`,{className:`linkBtn`,type:`button`,onClick:()=>ae(A.originHash),children:tn(A.originHash,14)}):tn(A.originHash,14)})]}),A?.userPhiKey&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`PhiKey`}),(0,Z.jsx)(`div`,{className:`v mono`,children:tn(A.userPhiKey,20)})]}),A?.kaiSignature&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`KaiSig`}),(0,Z.jsx)(`div`,{className:`v mono`,children:tn(A.kaiSignature,20)})]}),A?.degree!=null&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`div`,{className:`k`,children:`Degree`}),(0,Z.jsx)(`div`,{className:`v mono`,children:A.degree})]})]}),(0,Z.jsxs)(`div`,{className:`inspectorActions`,children:[(0,Z.jsx)(`button`,{type:`button`,className:`primaryBtn`,onClick:le,disabled:!A,children:`Open`}),(0,Z.jsx)(`button`,{type:`button`,className:`miniBtn`,onClick:V,disabled:!A,children:`Copy URL`})]}),A?.sources?.length?(0,Z.jsxs)(`details`,{className:`sources`,children:[(0,Z.jsxs)(`summary`,{children:[`Sources (`,A.sources.length,`)`]}),(0,Z.jsxs)(`div`,{className:`sourcesList`,children:[A.sources.slice(0,40).map((e,t)=>(0,Z.jsx)(`div`,{className:`sourceItem mono`,children:P(e)},`${t}-${e}`)),A.sources.length>40?(0,Z.jsxs)(`div`,{className:`sourceMore`,children:[`… `,A.sources.length-40,` more`]}):null]})]}):null]})})]})]})}var Q=typeof window<`u`,mn=`sigil:explorer:open`,hn=`sigil:explorer:bc:v1`,gn=520,_n=900,vn=80,yn=80,bn=25e4,xn=18;function Sn(){let e;for(let[,t]of D){let n=t.pulse;typeof n!=`number`||!Number.isFinite(n)||(e==null||n>e)&&(e=n)}return e}function Cn(e){let t=e?.pulse??e?.latestPulse??e?.latest_pulse;if(!(typeof t!=`number`||!Number.isFinite(t)))return t}var wn=`/phi.svg`,$=`phi`;function Tn({className:e}){return(0,Z.jsx)(`img`,{className:[`phi-mark`,e].filter(Boolean).join(` `),src:wn,alt:$,decoding:`async`,loading:`lazy`,draggable:!1})}function En(e,t){return(0,Z.jsxs)(`span`,{className:[`phi-amount`,t?.className].filter(Boolean).join(` `),children:[t?.sign?(0,Z.jsx)(`span`,{className:`phi-amount__sign`,children:t.sign}):null,(0,Z.jsx)(`span`,{className:`phi-amount__value`,children:U(e)}),(0,Z.jsx)(Tn,{className:[`phi-amount__mark`,t?.markClassName].filter(Boolean).join(` `)})]})}function Dn(){return Date.now()}function On(){return Q?new Promise(e=>{if(typeof window.requestAnimationFrame==`function`){window.requestAnimationFrame(()=>e());return}window.setTimeout(e,0)}):Promise.resolve()}function kn(e){let t=(Q?window:null)?.CSS?.escape;return typeof t==`function`?t(e):e.replace(/["\\]/g,`\\$&`)}function An(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function jn(e,t){return An(e)&&typeof e[t]==`string`}function Mn(e){if(typeof e==`number`&&Number.isFinite(e))return e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&Number.isFinite(t))return t}}function Nn(e){if(typeof e==`boolean`)return e}function Pn(e){if(e===`low`||e===`med`||e===`high`)return e}function Fn(e){let t=e,n=Mn(e.stepsPerBeat),r=Array.isArray(t.transfers)?t.transfers:void 0,i=Array.isArray(t.segments)?t.segments:void 0,a=An(t.ip)?t.ip:void 0;return{pulse:e.pulse,kaiPulse:e.pulse,beat:e.beat,stepIndex:e.stepIndex,stepsPerBeat:Mn(t.stepsPerBeat)??n,kaiSignature:e.kaiSignature,userPhiKey:e.userPhiKey,chakraDay:e.chakraDay,chakraGate:typeof t.chakraGate==`string`?t.chakraGate:void 0,seriesSize:Mn(t.seriesSize),quality:Pn(t.quality),creatorVerified:Nn(t.creatorVerified),creatorRep:Mn(t.creatorRep),frequencyHz:Mn(t.frequencyHz),transfers:r,cumulativeTransfers:Mn(t.cumulativeTransfers),segments:i,segmentsMerkleRoot:typeof t.segmentsMerkleRoot==`string`?t.segmentsMerkleRoot:void 0,transfersWindowRoot:typeof t.transfersWindowRoot==`string`?t.transfersWindowRoot:void 0,ip:a}}function In(e,t){if(t==null||!Number.isFinite(t))return null;try{let{unsigned:n}=ne(Fn(e),t);return Number.isFinite(n.valuePhi)?n.valuePhi:null}catch{return null}}function Ln(e,t){if(t==null||!Number.isFinite(t))return null;try{let n=x({meta:Fn(e),nowPulse:t,usd:100,currentStreakDays:0,lifetimeUsdSoFar:0},d);return Number.isFinite(n.usdPerPhi)?n.usdPerPhi:null}catch{return null}}function Rn(e){if(!Q||typeof Worker>`u`||e.length<bn)return Promise.resolve(JSON.parse(e));let t=null,n=``;try{let e=new Blob([`
    self.onmessage = (event) => {
      try {
        const parsed = JSON.parse(event.data);
        self.postMessage({ ok: true, value: parsed });
      } catch (err) {
        self.postMessage({ ok: false, error: err && err.message ? err.message : "parse-failed" });
      }
    };
  `],{type:`text/javascript`});n=URL.createObjectURL(e),t=new Worker(n)}catch{return n&&URL.revokeObjectURL(n),Promise.resolve(JSON.parse(e))}return new Promise((r,i)=>{let a=()=>{t?.terminate(),n&&URL.revokeObjectURL(n)};t.onmessage=e=>{let t=e.data;a(),t?.ok?r(t.value):i(Error(t?.error??`parse-failed`))},t.onerror=()=>{a(),i(Error(`parse-failed`))},t.postMessage(e)})}function zn(e){let t=ce(e.url);return t===`stream`?`inhale`:t===`post`?`exhale`:null}function Bn(e,t){let n=Te(Ie(e),t);if(n)return n;let r=Ce(e.payload);if(r)return r;let i=e.payload,a=we(i);if(a)return a;if(An(i.feed)){let e=we(i.feed);if(e)return e}for(let t of e.urls){let e=R(t);if(!e)continue;let n=Ce(e);if(n)return n;let r=we(e);if(r)return r}}function Vn(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`receive`)||t.includes(`received`)||t.includes(`inhale`)?`receive`:t.includes(`send`)||t.includes(`sent`)||t.includes(`exhale`)?`send`:null:null}function Hn(e){let t=e;return Vn(t.transferDirection)||Vn(t.transferMode)||Vn(t.transferKind)||Vn(t.phiDirection)}function Un(e){let t=e,n=t.transferNonce??t.nonce;return typeof n==`string`&&n.trim()?n.trim():null}function Wn(e){let t=e,n=t.canonicalHash??t.childHash??t.hash;return typeof n==`string`&&n.trim()?n.trim().toLowerCase():null}function Gn(e){let t=new Set,n=new Set;for(let r of e.values()){if(Hn(r)!==`receive`)continue;let e=Un(r);e&&t.add(e);let i=Wn(r);i&&n.add(i)}return{nonces:t,canonicals:n}}function Kn(e,t,n){let r=Bn(e,t);if(!r)return null;if(r.direction===`receive`)return`received`;let i=Un(e.payload);if(i&&n.nonces.has(i))return`received`;let a=Ie(e);return a&&n.canonicals.has(a)?`received`:`pending`}function qn(t,n,r,i,a){let o=t.payload,s=[],c=new Set,l=Bn(t,r),u=l?Kn(t,r,i):null,d=u===`pending`&&l?l.amount:a?.netPhi??null,f=u===`pending`&&l?l.amountUsd??(a?.usdPerPhi==null?null:l.amount*a.usdPerPhi):a?.usdValue??null;d!=null&&s.push({label:(0,Z.jsxs)(`span`,{className:`phi-detail__label`,children:[`Live `,(0,Z.jsx)(Tn,{className:`phi-detail__mark`}),` value`]}),value:En(d),valueText:`${U(d)} ${$}`}),f!=null&&s.push({label:`Live USD`,value:`$${M(f)}`});let p=a?.pendingFromChildren??0,ee=a?.pendingFromParent??0,m=t.children.length>0?p:p+ee;m>0&&s.push({label:`Exhale (pending)`,value:En(m,{sign:`-`}),valueText:`-${U(m)} ${$}`});let h=a?.receivedFromChildren??0;h>0&&s.push({label:(0,Z.jsxs)(`span`,{className:`phi-detail__label`,children:[(0,Z.jsx)(Tn,{className:`phi-detail__mark`}),` Exhaled`]}),value:En(h,{sign:`-`}),valueText:`-${U(h)} ${$}`});let g=se(t.payload);if(g!==void 0&&s.push({label:(0,Z.jsxs)(`span`,{className:`phi-detail__label`,children:[`This glyph `,(0,Z.jsx)(Tn,{className:`phi-detail__mark`})]}),value:En(g),valueText:`${U(g)} ${$}`}),l){let e=l.direction===`receive`?`Inhaled`:`Exhaled`,t=l.direction===`receive`?`Inhale (pending)`:`Exhale (pending)`,n=l.sentPulse===void 0?``:` • pulse ${l.sentPulse}`,r=l.sentPulse===void 0?``:` (pulse ${l.sentPulse})`;u&&s.push({label:`Transfer status`,value:`${u===`pending`?t:e}${n}`}),u===`received`&&s.push({label:(0,Z.jsxs)(`span`,{className:`phi-detail__label`,children:[(0,Z.jsx)(Tn,{className:`phi-detail__mark`}),` `,e,r]}),value:En(l.amount,{sign:`+`}),valueText:`+${U(l.amount)} ${$}`}),l.amountUsd!==void 0&&s.push({label:`USD value`,value:`$${M(l.amountUsd)}`}),l.sentPulse!==void 0&&s.push({label:`Sent pulse`,value:String(l.sentPulse)});let i=l;jn(i,`txHash`)&&s.push({label:`Tx hash`,value:i.txHash})}let _=o.feed,v=typeof _?.author==`string`?_.author:typeof o.author==`string`?o.author:void 0,y=_?_.usernameClaim:void 0,b=y?e(y.payload?.normalized||y.payload?.username||``):``,x=e(v??``),S=b||x;if(S){let e=n[S],t=typeof v==`string`&&v.trim().length>0?v.trim():`@${S}`;e?(s.push({label:`Username (claimed)`,value:`${t} → glyph ${W(e.claimHash,10)}`}),s.push({label:`Claim glyph`,value:P(e.claimUrl)})):s.push({label:`Username`,value:t})}let C=(e,t)=>{let n=o[e];typeof n==`string`&&n.trim().length>0&&!c.has(e)&&(s.push({label:t,value:n.trim()}),c.add(e))};C(`userPhiKey`,`PhiKey`),C(`phiKey`,`PhiKey`),C(`phikey`,`PhiKey`),C(`kaiSignature`,`Kai Signature`),typeof o.parentUrl==`string`&&o.parentUrl.length>0&&s.push({label:`Parent URL`,value:P(o.parentUrl)}),typeof o.originUrl==`string`&&o.originUrl.length>0&&s.push({label:`Origin URL`,value:P(o.originUrl)});let w=o.label??o.title??o.type??o.note??o.description;typeof w==`string`&&w.trim().length>0&&s.push({label:`Label / Type`,value:w.trim()}),s.push({label:`Primary URL`,value:P(t.url)});let T=t.urls.filter(e=>!he(e)).map(e=>P(e));return t.urls.length>1&&s.push({label:`URL variants`,value:T.length===0?`${t.urls.length} urls (kept in data; hidden from browser view)`:T.length<=3?T.join(` | `):`${t.urls.length} urls (kept in data; rendered once)`}),s.slice(0,12)}async function Jn(e){if(Q){try{if(navigator.clipboard&&typeof navigator.clipboard.writeText==`function`){await navigator.clipboard.writeText(e);return}}catch{}try{let t=document.createElement(`textarea`);t.value=e,t.setAttribute(`readonly`,`true`),t.style.position=`fixed`,t.style.left=`-9999px`,t.style.top=`-9999px`,document.body.appendChild(t),t.select(),document.execCommand(`copy`),document.body.removeChild(t)}catch{}}}async function Yn(e){if(Q)try{await fetch(e,{method:`GET`,cache:`force-cache`,mode:`cors`,credentials:`omit`,redirect:`follow`})}catch{}}function Xn({p:e}){let t=typeof e.pulse==`number`?e.pulse:0,n=typeof e.stepsPerBeat==`number`&&e.stepsPerBeat>0?e.stepsPerBeat:44,r=typeof e.stepIndex==`number`?e.stepIndex:typeof e.pulse==`number`?fe(e.pulse,n):0,i=typeof e.beat==`number`?e.beat:0;return(0,Z.jsxs)(`span`,{className:`k-stamp`,title:`pulse ${t} • beat ${i} • step ${r}`,children:[(0,Z.jsxs)(`span`,{className:`k-pill`,children:[`☤KAI `,t]}),(0,Z.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,Z.jsxs)(`span`,{className:`k-pill`,children:[`beat `,i]}),(0,Z.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,Z.jsxs)(`span`,{className:`k-pill`,children:[`step `,r]})]})}function Zn({node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a,receiveLocks:o,valueSnapshots:s}){let c=t.has(e.id),l=Ie(e),u=e.payload.kaiSignature,d=e.payload.chakraDay,f=typeof e.payload.pulse==`number`?e.payload.pulse:void 0,p=f==null?void 0:r.get(f),ee=z(e.url),m=s.get(e.id)??null,h=c?qn(e,i,a,o,m):[],g=Bn(e,a),_=Kn(e,a,o),v=zn(e),y=!(e.children.length>0),b=m?.netPhi??null,x=m?.usdValue??null,S=_===`pending`&&g?g.amount:b,C=_===`pending`&&g?g.amountUsd??(m?.usdPerPhi==null?null:g.amount*m.usdPerPhi):x,w=m?.pendingFromChildren??0,T=m?.pendingFromParent??0,E=m?.receivedFromChildren??0,D=w+E,O=D>0?E/D:0,k=w>0&&E>0?{"--exhale-rgb":`${Math.round(255*(.85+.15*O))},${Math.round(140*(1-O)+75*O)},${Math.round(80*(1-O)+110*O)}`}:void 0,A=w>0?`Exhale (pending) children: -${U(w)} ${$}${S===null?``:` • Live ${U(Math.max(0,S))} ${$}`}`:void 0,te=T>0?`Exhale (pending) send: -${U(T)} ${$}${S===null?``:` • Live ${U(Math.max(0,S))} ${$}`}`:void 0,j=y&&T>0&&_!==`pending`,ne=E>0?`Exhaled: -${U(E)} ${$}${S===null?``:` • Live ${U(Math.max(0,S))} ${$}`}`:void 0,N=S===null?void 0:`Live value: ${U(S)} ${$}${C===null?``:` • $${M(C)}`}`,P=g&&_===`received`?{direction:`send`,sign:`-`,titleVerb:g.direction===`receive`?`inhaled`:`exhaled`}:g?{direction:`pending`,sign:`-`,titleVerb:g.direction===`receive`?`inhaled`:`exhaled`}:null;return(0,Z.jsxs)(`div`,{className:`node`,style:xe(d),"data-chakra":String(d??``),"data-node-id":e.id,children:[(0,Z.jsxs)(`div`,{className:`node-row`,children:[(0,Z.jsxs)(`div`,{className:`node-main`,children:[(0,Z.jsx)(`button`,{className:`twirl`,"aria-label":c?`Collapse memories`:`Expand memories`,"aria-expanded":c,onClick:()=>n(e.id),title:c?`Collapse`:`Expand`,type:`button`,children:(0,Z.jsx)(`span`,{className:`tw ${c?`open`:``}`})}),(0,Z.jsx)(`a`,{className:`node-link`,href:ee,target:`_blank`,rel:`noopener noreferrer`,title:ee,children:(0,Z.jsx)(`span`,{children:W(u??l??`glyph`,12)})})]}),(0,Z.jsxs)(`div`,{className:`node-meta`,children:[(0,Z.jsx)(Xn,{p:e.payload}),d&&(0,Z.jsx)(`span`,{className:`chakra`,title:String(d),children:String(d)}),y&&g&&P&&(0,Z.jsxs)(`span`,{className:`phi-move phi-move--${P.direction}`,title:`Phi ${P.titleVerb}${_===`pending`?` (pending)`:``}: ${U(g.amount)} ${$}${g.amountUsd===void 0?``:` • $${M(g.amountUsd)}`}${g.sentPulse===void 0?``:` • sent pulse ${g.sentPulse}`}`,children:[(0,Z.jsx)(`span`,{className:`phi-move__sign`,"aria-hidden":`true`,children:P.sign}),En(g.amount,{className:`phi-move__amount`,markClassName:`phi-move__mark`}),_===`received`&&g.amountUsd!==void 0&&(0,Z.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,M(g.amountUsd)]}),_===`received`&&g.amountUsd===void 0&&m?.usdPerPhi!=null&&(0,Z.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,M(g.amount*m.usdPerPhi)]}),_===`pending`&&m?.usdPerPhi!=null&&(0,Z.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,M(g.amount*m.usdPerPhi)]})]}),y&&g&&_===`pending`&&(0,Z.jsx)(`span`,{className:`phi-status phi-status--pending`,title:`Exhale pending`,children:`Exhale`}),y&&g&&v===`exhale`&&_===`received`&&(0,Z.jsx)(`span`,{className:`phi-status phi-status--received`,title:`Exhale received`,children:`Exhaled`}),!g&&v!==`inhale`&&D>0&&(0,Z.jsx)(`span`,{className:`phi-status phi-status--${w>0&&E>0?`exhale-mix`:`received`}`,title:w>0&&E>0?`Exhale mix: ${U(E)} exhaled • ${U(w)} pending`:w>0?`Exhale pending: ${U(w)} ${$}`:`Exhaled: ${U(E)} ${$}`,style:k,children:`Exhale`}),v===`inhale`&&(0,Z.jsx)(`span`,{className:`phi-status phi-status--inhale`,title:`Inhale`,children:`Inhale`}),S!==null&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--live`,title:N,children:[(0,Z.jsxs)(`span`,{className:`phi-pill__label`,children:[(0,Z.jsx)(Tn,{className:`phi-pill__mark`}),v===`inhale`?`+`:`live:`]}),En(S)]}),C!==null&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--usd`,title:N,children:[`$`,M(C)]}),E>0&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--drain`,title:ne,children:[`Exhaled `,En(E,{sign:`-`})]}),w>0&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--pending`,title:A,children:[`Exhale (pending) `,En(w,{sign:`-`})]}),j&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--pending`,title:te,children:[`Exhale (pending) `,En(T,{sign:`-`})]}),y&&_===`received`&&g&&v===`exhale`&&(0,Z.jsx)(`span`,{className:`phi-pill phi-pill--drain`,title:`Exhaled: ${U(g.amount)} ${$}${g.amountUsd===void 0?``:` • $${M(g.amountUsd)}`}`,children:`Exhaled`}),p!==void 0&&(0,Z.jsxs)(`span`,{className:`phi-pill`,title:`Total ${$} on pulse ${e.payload.pulse??``}`,children:[(0,Z.jsxs)(`span`,{className:`phi-pill__label`,children:[(0,Z.jsx)(Tn,{className:`phi-pill__mark`}),`pulse:`]}),En(p)]}),(0,Z.jsx)(`button`,{className:`node-copy`,"aria-label":`Copy URL`,onClick:()=>void Jn(ee),title:`Copy URL`,type:`button`,children:`⧉`})]})]}),c&&(0,Z.jsxs)(`div`,{className:`node-open`,children:[(0,Z.jsx)(`div`,{className:`node-detail`,children:h.length===0?(0,Z.jsx)(`div`,{className:`node-detail-empty`,children:`No additional memory fields recorded on this glyph.`}):(0,Z.jsx)(`div`,{className:`node-detail-grid`,children:h.map((e,t)=>(0,Z.jsxs)(G.Fragment,{children:[(0,Z.jsx)(`div`,{className:`detail-label`,children:e.label}),(0,Z.jsx)(`div`,{className:`detail-value`,title:e.valueText??(typeof e.value==`string`?e.value:void 0),children:e.value})]},t))})}),e.children.length>0&&(0,Z.jsx)(`div`,{className:`node-children`,"aria-label":`Memory Imprints`,children:e.children.map(e=>(0,Z.jsx)(Zn,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a,receiveLocks:o,valueSnapshots:s},e.id))})]})]})}function Qn({root:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a,receiveLocks:o,valueSnapshots:s,onOpenPulseView:c}){let l=(0,G.useMemo)(()=>{let t=0,n=e=>{t+=1,e.children.forEach(n)};return n(e),t},[e]),u=j(e.url),d=e.payload.kaiSignature,f=Mn(e.payload.pulse),p=z(e.url),ee=e.payload.chakraDay,m=s.get(e.id)??null,h=(0,G.useMemo)(()=>{let t=0,n=m?.pendingFromParent??0;for(let r of e.children){let e=s.get(r.id);e?.receivedAmount&&(t+=e.receivedAmount),e?.pendingFromParent&&(n+=e.pendingFromParent)}let r=m?.basePhi??null,i=m?.netPhi??null,a=m?.usdPerPhi??null;return{basePhi:r,netPhi:i,usdValue:i!=null&&a!=null?i*a:null,derivedPhi:t,pendingPhi:n}},[e,m,s]),g=(0,G.useMemo)(()=>{let t=0,n=0,r=0,i=e=>{let r=ce(e.url),c=s.get(e.id)??null;if(r===`stream`&&c?.netPhi!=null&&(t+=c.netPhi),r===`post`){let t=Bn(e,a);(t?Kn(e,a,o):null)===`received`&&t&&(n+=t.amount)}e.children.forEach(i)};i(e);for(let t of e.children){if(ce(t.url)!==`post`)continue;let e=Bn(t,a);(e?Kn(t,a,o):null)===`pending`&&e&&(r+=e.amount)}return{inhaleTotal:t,exhaleTotal:n,pendingTotal:r}},[o,e,a,s]),_=h.netPhi==null?void 0:`Live origin value: ${U(h.netPhi)} ${$}${h.usdValue==null?``:` • $${M(h.usdValue)}`}`,v=t=>{if(t.metaKey||t.ctrlKey||t.shiftKey){typeof window<`u`&&window.open(p,`_blank`,`noopener,noreferrer`);return}f!=null&&c?.({pulse:f,originUrl:e.url,originHash:u??void 0})};return(0,Z.jsxs)(`section`,{className:`origin`,"aria-label":`Sigil origin stream`,style:xe(ee),"data-chakra":String(ee??``),"data-node-id":e.id,children:[(0,Z.jsxs)(`header`,{className:`origin-head`,children:[(0,Z.jsxs)(`div`,{className:`o-meta`,children:[(0,Z.jsx)(`span`,{className:`o-title`,children:`Origin`}),(0,Z.jsx)(`button`,{className:`o-link`,onClick:v,type:`button`,title:f==null?p:`Open pulse view for ${p}`,"aria-label":`Open origin pulse view`,children:W(d??u??`origin`,14)}),ee&&(0,Z.jsx)(`span`,{className:`o-chakra`,title:String(ee),children:String(ee)})]}),(0,Z.jsxs)(`div`,{className:`o-right`,children:[(0,Z.jsx)(Xn,{p:e.payload}),h.netPhi!=null&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--live`,title:_,children:[(0,Z.jsxs)(`span`,{className:`phi-pill__label`,children:[(0,Z.jsx)(Tn,{className:`phi-pill__mark`}),`live:`]}),En(h.netPhi)]}),h.usdValue!=null&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--usd`,title:_,children:[`$`,M(h.usdValue)]}),g.inhaleTotal>0&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--lift`,title:`Inhales from memory: +${U(g.inhaleTotal)} ${$}`,children:[`Inhale `,En(g.inhaleTotal,{sign:`+`})]}),g.exhaleTotal>0&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--drain`,title:`Exhaled: -${U(g.exhaleTotal)} ${$}`,children:[`Exhaled `,En(g.exhaleTotal,{sign:`-`})]}),g.pendingTotal>0&&(0,Z.jsxs)(`span`,{className:`phi-pill phi-pill--pending`,title:`Exhale (pending): -${U(g.pendingTotal)} ${$}`,children:[`Exhale (pending) `,En(g.pendingTotal,{sign:`-`})]}),(0,Z.jsxs)(`span`,{className:`o-count`,title:`Total content keys in this lineage`,children:[l,` keys`]}),(0,Z.jsx)(`button`,{className:`o-copy`,onClick:()=>void Jn(p),title:`Copy origin URL`,type:`button`,children:`Remember Origin`})]})]}),(0,Z.jsx)(`div`,{className:`origin-body`,children:e.children.length===0?(0,Z.jsx)(`div`,{className:`kx-empty`,children:`No memories yet. The stream begins here.`}):(0,Z.jsx)(`div`,{className:`tree`,children:e.children.map(e=>(0,Z.jsx)(Zn,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a,receiveLocks:o,valueSnapshots:s},e.id))})})]})}function $n({onAdd:e,onImport:t,onExport:n,total:r,lastAdded:i,viewMode:a,onViewModeChange:o}){let[s,c]=(0,G.useState)(``);return(0,Z.jsx)(`div`,{className:`kx-toolbar`,role:`region`,"aria-label":`Explorer toolbar`,children:(0,Z.jsxs)(`div`,{className:`kx-toolbar-inner`,children:[(0,Z.jsxs)(`div`,{className:`kx-brand`,children:[(0,Z.jsx)(`div`,{className:`kx-glyph`,"aria-hidden":!0,children:(0,Z.jsx)(`img`,{className:`kx-glyph__mark`,src:wn,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`eager`,draggable:!1})}),(0,Z.jsxs)(`div`,{className:`kx-title`,children:[(0,Z.jsxs)(`h1`,{children:[`KAIROS `,(0,Z.jsx)(`span`,{children:`Keystream`})]}),(0,Z.jsxs)(`div`,{className:`kx-tagline`,children:[`Sovereign Lineage • No DB • Pure `,(0,Z.jsx)(Tn,{className:`phi-tagline__mark`})]})]})]}),(0,Z.jsxs)(`div`,{className:`kx-controls`,children:[(0,Z.jsxs)(`form`,{className:`kx-add-form`,onSubmit:t=>{t.preventDefault(),s.trim()&&(e(s.trim()),c(``))},children:[(0,Z.jsx)(`input`,{className:`kx-input`,placeholder:`Inhale a sigil (or memory)…`,spellCheck:!1,value:s,onChange:e=>c(e.target.value),"aria-label":`Sigil Key`}),(0,Z.jsx)(`button`,{className:`kx-button`,type:`submit`,children:`Inhale`})]}),(0,Z.jsxs)(`div`,{className:`kx-io`,role:`group`,"aria-label":`Import and export`,children:[(0,Z.jsxs)(`label`,{className:`kx-import`,title:`Import a JSON list of Keys (or krystals)`,children:[(0,Z.jsx)(`input`,{type:`file`,accept:`application/json`,onChange:e=>{let n=e.target.files?.[0];n&&t(n)},"aria-label":`Import JSON`}),`Inhale`]}),(0,Z.jsx)(`button`,{className:`kx-export`,onClick:n,"aria-label":`Export registry to JSON`,type:`button`,children:`Exhale`})]}),(0,Z.jsx)(`div`,{className:`kx-view-toggle`,role:`group`,"aria-label":`Explorer view mode`,children:(0,Z.jsx)(`button`,{className:`kx-view-btn`,type:`button`,onClick:()=>o(a===`keystream`?`lattice`:`keystream`),"aria-pressed":a===`lattice`,children:a===`keystream`?`Memory Lattice`:`Keystream`})}),(0,Z.jsxs)(`div`,{className:`kx-stats`,"aria-live":`polite`,children:[(0,Z.jsxs)(`span`,{className:`kx-pill`,title:`Total KEYS in registry (includes variants)`,children:[r,` KEYS`]}),i&&(0,Z.jsxs)(`span`,{className:`kx-pill subtle`,title:i,children:[`Last: `,W(i,8)]})]})]})]})})}var er=()=>{let[e,n]=(0,G.useState)(()=>E()?1:0),[i,d]=(0,G.useState)(0),[h,v]=(0,G.useState)(void 0),[x,S]=(0,G.useState)(()=>f()),[w,O]=(0,G.useState)(()=>l(new Date)),[k,j]=(0,G.useState)(`keystream`),[ne,M]=(0,G.useState)({open:!1,pulse:null}),N=(0,G.useRef)(!1),F=(0,G.useRef)(new Set),ie=(0,G.useRef)(null),B=(0,G.useRef)(!1),V=(0,G.useRef)(null),H=(0,G.useRef)(0),U=(0,G.useRef)(null),fe=(0,G.useRef)(!1),me=(0,G.useRef)(void 0),W=(0,G.useRef)(0),he=(0,G.useRef)(null),ve=(0,G.useRef)([]),be=(0,G.useRef)(null),K=(0,G.useCallback)(e=>{let t=Dn()+e;t>H.current&&(H.current=t)},[]),xe=(0,G.useCallback)(()=>{if(!Q||N.current)return;let e=Dn(),t=H.current-e;if(t>0){U.current!=null&&window.clearTimeout(U.current),U.current=window.setTimeout(()=>{U.current=null,xe()},t+vn);return}let r=ve.current.splice(0);if(r.length>0&&(0,G.startTransition)(()=>{S(e=>{let t=e;for(let e of r){let n=t[e.normalized];n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===(e.originHash??n.originHash)&&n.ownerHint===(e.ownerHint??n.ownerHint)||(t={...t,[e.normalized]:{...n,normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash??n?.originHash,ownerHint:e.ownerHint??n?.ownerHint??null,updatedAt:n?.updatedAt??0}})}return t})}),me.current!==void 0){let e=me.current;me.current=void 0,(0,G.startTransition)(()=>v(e))}if(he.current!==null){let e=he.current;he.current=null,(0,G.startTransition)(()=>O(e))}if(W.current>0){let e=W.current;W.current=0,(0,G.startTransition)(()=>d(t=>t+e))}fe.current&&(fe.current=!1,(0,G.startTransition)(()=>n(e=>e+1)))},[K]),q=(0,G.useCallback)(()=>{if(!Q||U.current!=null)return;let e=Dn(),t=H.current-e,n=Math.max(0,t)+vn;U.current=window.setTimeout(()=>{U.current=null,xe()},n)},[xe]),J=(0,G.useCallback)(()=>{if(!N.current){if(Dn()<H.current||B.current){fe.current=!0,q();return}(0,G.startTransition)(()=>n(e=>e+1))}},[q]),Y=(0,G.useCallback)(e=>{if(!N.current){if(Dn()<H.current||B.current){me.current=e,q();return}(0,G.startTransition)(()=>v(e))}},[q]),X=(0,G.useCallback)((e=1)=>{if(!N.current){if(Dn()<H.current||B.current){W.current+=e,q();return}(0,G.startTransition)(()=>d(t=>t+e))}},[q]),Se=(0,G.useCallback)(e=>{if(!N.current){if(Dn()<H.current||B.current){he.current=e,q();return}(0,G.startTransition)(()=>O(e))}},[q]),Ce=(0,G.useRef)(null),[we,Te]=(0,G.useState)(()=>new Set),Ee=(0,G.useCallback)(e=>{K(_n);let t=ie.current;if(t){let n=`[data-node-id="${kn(e)}"]`,r=t.querySelector(n);Ce.current={id:e,scrollTop:t.scrollTop,rectTop:r?r.getBoundingClientRect().top:0}}Te(t=>{let n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n}),q()},[K,q]);(0,G.useEffect)(()=>{if(!Q)return;let e=window.setInterval(()=>Se(l(new Date)),6e3);return()=>window.clearInterval(e)},[Se]),(0,G.useEffect)(()=>{if(!Q)return;let e=document.documentElement,t=document.body,n=document.scrollingElement||document.documentElement,r={htmlOverscroll:e?.style.overscrollBehavior??``,htmlOverscrollY:e?.style.overscrollBehaviorY??``,bodyOverscroll:t?.style.overscrollBehavior??``,bodyOverscrollY:t?.style.overscrollBehaviorY??``,rootOverscroll:n?.style.overscrollBehavior??``,rootOverscrollY:n?.style.overscrollBehaviorY??``};return e&&(e.style.overscrollBehavior=`none`,e.style.overscrollBehaviorY=`none`),t&&(t.style.overscrollBehavior=`none`,t.style.overscrollBehaviorY=`none`),n&&(n.style.overscrollBehavior=`none`,n.style.overscrollBehaviorY=`none`),()=>{e&&(e.style.overscrollBehavior=r.htmlOverscroll,e.style.overscrollBehaviorY=r.htmlOverscrollY),t&&(t.style.overscrollBehavior=r.bodyOverscroll,t.style.overscrollBehaviorY=r.bodyOverscrollY),n&&(n.style.overscrollBehavior=r.rootOverscroll,n.style.overscrollBehaviorY=r.rootOverscrollY)}},[]),(0,G.useEffect)(()=>{if(!Q)return;let e=ie.current;if(!e)return;let t=0,n=0,r=e=>{e.touches.length===1&&(t=e.touches[0]?.clientY??0,n=e.touches[0]?.clientX??0)},i=r=>{if(!r.cancelable||r.touches.length!==1)return;let i=r.touches[0]?.clientY??0,a=r.touches[0]?.clientX??0,o=i-t,s=a-n;if(t=i,n=a,Math.abs(o)<=Math.abs(s))return;let c=e.scrollHeight-e.clientHeight;if(c<=0)return;let l=e.scrollTop<=0,u=e.scrollTop>=c-1,d=o>0,f=o<0;(l&&d&&window.scrollY<=0||u&&f)&&r.preventDefault()};return e.addEventListener(`touchstart`,r,{passive:!0}),e.addEventListener(`touchmove`,i,{passive:!1}),()=>{e.removeEventListener(`touchstart`,r),e.removeEventListener(`touchmove`,i)}},[]),(0,G.useEffect)(()=>{if(!Q)return;let e=ie.current;if(!e)return;let t=()=>{B.current=!0,K(gn),V.current!=null&&window.clearTimeout(V.current),V.current=window.setTimeout(()=>{B.current=!1,V.current=null,q()},180)};return e.addEventListener(`scroll`,t,{passive:!0}),()=>{e.removeEventListener(`scroll`,t),V.current!=null&&window.clearTimeout(V.current),V.current=null,B.current=!1}},[K,q]);let De=(0,G.useCallback)(e=>{Number.isFinite(e.pulse)&&M({open:!0,pulse:e.pulse,originUrl:e.originUrl,originHash:e.originHash})},[]);(0,G.useLayoutEffect)(()=>{let e=Ce.current;if(!e)return;Ce.current=null;let t=ie.current;if(!t)return;let n=`[data-node-id="${kn(e.id)}"]`,r=t.querySelector(n);if(!r)return;let i=r.getBoundingClientRect().top-e.rectTop;Number.isFinite(i)&&Math.abs(i)>1&&(t.scrollTop=Math.max(0,e.scrollTop+i))},[we]);let Oe=(0,G.useRef)(null),ke=(0,G.useRef)(!1),Ae=(0,G.useRef)(null);(0,G.useEffect)(()=>{if(N.current=!1,oe(),r(),o(),de(),E()&&J(),Q){let e=L(window.location.href);if(R(e)){let t=p(e,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0});Y(P(e)),t&&J()}}let e=window.__SIGIL__?.registerSigilUrl,n=window.__SIGIL__?.registerSend;window.__SIGIL__||(window.__SIGIL__={}),window.__SIGIL__.registerSigilUrl=m,window.__SIGIL__.registerSend=e=>{if(!e||typeof e!=`object`)return;let t=e.url;typeof t!=`string`||!t.trim()||p(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(Y(P(t)),J())};let i=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&p(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(Y(P(t)),J())};window.addEventListener(`sigil:url-registered`,i);let a=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&p(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(Y(P(t)),J())};window.addEventListener(`sigil:minted`,a);let c=Q&&`BroadcastChannel`in window?new BroadcastChannel(hn):null,l=e=>{let t=e.data;t?.type===`sigil:add`&&typeof t.url==`string`&&p(t.url,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0})&&(Y(P(t.url)),J())};c?.addEventListener(`message`,l);let d=e=>{if(!e.key)return;let n=e.key===ue,r=e.key===ee;if(e.key===`kai:sigil-transfer:v1`){X();return}if(!(!n&&!r)&&e.newValue)try{let n=JSON.parse(e.newValue);if(!Array.isArray(n))return;let r=!1;for(let e of n)typeof e==`string`&&p(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:!0})&&(r=!0);Y(void 0),r&&(t(),J())}catch{}};window.addEventListener(`storage`,d);let f=()=>X();window.addEventListener(_e,f);let h=Q&&`BroadcastChannel`in window?new BroadcastChannel(te):null,_=e=>{e.data?.type===`transfer:update`&&X()};h?.addEventListener(`message`,_);let v=()=>{re(),pe()};window.addEventListener(`pagehide`,v);let y=C(e=>{if(Dn()<H.current||B.current){ve.current.push({normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash,ownerHint:e.ownerHint}),q();return}(0,G.startTransition)(()=>{S(t=>{let n=t[e.normalized];return n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===e.originHash&&n.ownerHint===e.ownerHint?t:{...t,[e.normalized]:e}})})}),b=new AbortController,x=async e=>{N.current||T()&&(B.current||Dn()<H.current&&(e===`pulse`||e===`import`)||await pe())},w=async e=>{if(!N.current&&T()&&!ke.current&&!B.current&&!(Dn()<H.current&&(e===`pulse`||e===`import`))){ke.current=!0;try{let t=Oe.current,n=await g(e=>new URL(s,e).toString(),{method:`GET`,cache:`no-store`,signal:b.signal,headers:void 0});if(!n||n.status===304||!n.ok)return;let r=``,i;try{let e=await n.json();r=typeof e?.seal==`string`?e.seal:``,i=Cn(e)}catch{return}let a=i==null?void 0:Sn();if(t&&r&&t===r&&!(i!=null&&(a==null||i>a))){Oe.current=r;return}let o=await u(b.signal);o.pulled&&(Oe.current=o.remoteSeal??r??t??null),o.imported>0&&(Y(void 0),J());let c=Oe.current;(e===`open`||(e===`visible`||e===`focus`||e===`online`||e===`import`)&&c!==Ae.current)&&(A(),Ae.current=c,await pe())}finally{ke.current=!1}}};be.current=async e=>{await x(e),await w(e)},A(),x(`open`),w(`open`);let D=null,O=()=>{if(!Q||N.current)return;D!=null&&window.clearTimeout(D);let e=ae();D=window.setTimeout(()=>{if(D=null,document.visibilityState!==`visible`){O();return}if(!T()){O();return}x(`pulse`),w(`pulse`),O()},e)},k=()=>{O()};O();let j=()=>{document.visibilityState===`visible`&&(k(),x(`visible`),w(`visible`))};document.addEventListener(`visibilitychange`,j);let ne=()=>{k(),x(`focus`),w(`focus`)},M=()=>{k(),x(`online`),w(`online`)};return window.addEventListener(`focus`,ne),window.addEventListener(`online`,M),()=>{window.__SIGIL__&&(window.__SIGIL__.registerSigilUrl=e,window.__SIGIL__.registerSend=n),window.removeEventListener(`sigil:url-registered`,i),window.removeEventListener(`sigil:minted`,a),window.removeEventListener(`storage`,d),window.removeEventListener(_e,f),h?.removeEventListener(`message`,_),h?.close(),window.removeEventListener(`pagehide`,v),window.removeEventListener(`focus`,ne),window.removeEventListener(`online`,M),document.removeEventListener(`visibilitychange`,j),c?.removeEventListener(`message`,l),c?.close(),typeof y==`function`&&y(),U.current!=null&&window.clearTimeout(U.current),U.current=null,D!=null&&window.clearTimeout(D),D=null,b.abort(),be.current=null,N.current=!0}},[J,K,q,Y]);let je=(0,G.useCallback)(e=>{let t=be.current;t&&t(e)},[]);(0,G.useEffect)(()=>{if(!Q)return;let e=()=>je(`visible`);return window.addEventListener(mn,e),()=>window.removeEventListener(mn,e)},[je]);let Me=(0,G.useMemo)(()=>Fe(D),[e]),Ne=(0,G.useMemo)(()=>a(),[i]),Pe=(0,G.useMemo)(()=>Gn(D),[e,i]),Ie=(0,G.useMemo)(()=>{let e=0;for(let[,]of D)e+=1;return e},[e]),Le=(0,G.useMemo)(()=>{let e=new Map,t=n=>{let r=In(n.payload,w),i=Ln(n.payload,w),a=Bn(n,Ne)??null,o=Kn(n,Ne,Pe),s=o===`received`&&a?a.amount:0,c=s>0?s:r??0,l=0,u=0,d=0;for(let e of n.children){let n=t(e);l+=n.receivedFromParent,u+=n.pendingFromParent,d+=n.liftToParent}let f=o===`pending`&&a?.direction===`send`?a.amount:0,p=Math.max(0,c+d-l),ee=o===`received`&&a?.amountUsd?a.amountUsd:i==null?null:p*i,m=f,h=ce(n.url)===`stream`?p:0;return e.set(n.id,{basePhi:r,netPhi:Number.isFinite(p)?p:null,usdValue:ee,usdPerPhi:i,transferMove:a,receivedAmount:s,receivedFromChildren:l,pendingFromChildren:u,pendingFromParent:m}),{receivedFromParent:s,pendingFromParent:m,liftToParent:h}};for(let e of Me)t(e);return e},[Me,w,Pe,Ne]),Re=(0,G.useMemo)(()=>{let e=new Map,t=new Map;for(let[n,r]of D){let i=typeof r.pulse==`number`?r.pulse:void 0;if(i==null)continue;let a=ye(L(n),r),o=t.get(i);if(o||(o=new Set,t.set(i,o)),o.has(a))continue;o.add(a);let s=se(r);s!==void 0&&e.set(i,(e.get(i)??0)+s)}return e},[e]),ze=(0,G.useMemo)(()=>{let e=[];for(let[t]of D){let n=L(z(t));e.includes(n)||e.push(n)}return e},[e]);(0,G.useEffect)(()=>{if(!Q||ze.length===0)return;let e=ze.filter(e=>!F.current.has(e));if(e.length===0)return;let t=!1,n=async()=>{for(let n of e){if(t)break;F.current.add(n),await Yn(n)}},r=window,i=null;if(typeof r.requestIdleCallback==`function`){let e=r.requestIdleCallback(()=>void n(),{timeout:1e3});i=()=>r.cancelIdleCallback?.(e)}else{let e=window.setTimeout(()=>void n(),120);i=()=>window.clearTimeout(e)}return()=>{t=!0,i?.()}},[ze]);let Be=(0,G.useCallback)(async()=>{if(!Q||B.current||!T()||Dn()<H.current)return;let e=[],t=n=>{if(n.urls.length>1){let t=ce(n.url),r=[...n.urls].map(e=>L(P(e))).filter((e,t,n)=>n.indexOf(e)===t).sort((e,n)=>y(n,t)-y(e,t));for(let t of r.slice(0,2)){let n=L(t);!c.has(n)&&!e.includes(n)&&e.push(n)}}n.children.forEach(t)};for(let e of Me)t(e);if(e.length!==0)for(let t of e.slice(0,xn)){let e=await ge(t);e===`ok`&&b(t,1),e===`bad`&&b(t,-1)}},[Me]);(0,G.useEffect)(()=>{if(!Q)return;let e=!1,t=()=>{e||Be()},n=window,r=null;if(typeof n.requestIdleCallback==`function`){let e=n.requestIdleCallback(t,{timeout:900});r=()=>n.cancelIdleCallback?.(e)}else{let e=window.setTimeout(t,250);r=()=>window.clearTimeout(e)}return()=>{e=!0,r?.()}},[e,Be]);let Ve=(0,G.useCallback)(e=>{K(_n),p(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(Y(P(e)),J())},[J,K,Y]),He=(0,G.useCallback)(async e=>{K(0);let t=await e.text(),n;try{n=await Rn(t)}catch{return}let{urls:r,rawKrystals:i}=_(n);if(r.length===0&&i.length===0)return;let a=!1;for(let e=0;e<i.length;e+=yn){for(let t of i.slice(e,e+yn))I(t);e+yn<i.length&&await On()}for(let e=0;e<r.length;e+=yn){for(let t of r.slice(e,e+yn))p(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`import`,enqueueToApi:!0})&&(a=!0);a&&(Y(void 0),J()),e+yn<r.length&&await On()}r.length>0&&le(r),a&&(Y(void 0),J()),je(`import`)},[J,K,je,Y]),Ue=(0,G.useCallback)(()=>{K(_n);let e=[];for(let[t]of D)e.push(t);let t=new Blob([JSON.stringify({urls:e},null,2)],{type:`application/json`}),n=document.createElement(`a`);n.href=URL.createObjectURL(t),n.download=`sigil-registry-${Date.now()}.json`,n.click(),URL.revokeObjectURL(n.href)},[K]);return(0,Z.jsxs)(`div`,{className:`sigil-explorer`,"aria-label":`Kairos Keystream Explorer`,children:[(0,Z.jsx)($n,{onAdd:Ve,onImport:He,onExport:Ue,total:Ie,lastAdded:h,viewMode:k,onViewModeChange:e=>{K(_n),j(e)}}),(0,Z.jsx)(`div`,{className:[`explorer-scroll`,k===`lattice`?`explorer-scroll--lattice`:``].filter(Boolean).join(` `),ref:ie,role:`region`,"aria-label":`Explorer scroll viewport`,children:(0,Z.jsxs)(`div`,{className:`explorer-inner`,children:[k===`keystream`?(0,Z.jsx)(Z.Fragment,{children:Me.length===0?(0,Z.jsxs)(`div`,{className:`kx-empty`,children:[(0,Z.jsx)(`p`,{children:`No sigil-glyphs in your keystream yet.`}),(0,Z.jsxs)(`ol`,{children:[(0,Z.jsx)(`li`,{children:`Import your keystream memories.`}),(0,Z.jsx)(`li`,{children:`Seal a moment — auto-registered here.`}),(0,Z.jsx)(`li`,{children:`Inhale any sigil-glyph or memory key above — lineage aligns instantly.`})]})]}):(0,Z.jsx)(`div`,{className:`forest`,"aria-label":`Sigil forest`,children:Me.map(e=>(0,Z.jsx)(Qn,{root:e,expanded:we,toggle:Ee,phiTotalsByPulse:Re,usernameClaims:x,transferRegistry:Ne,receiveLocks:Pe,valueSnapshots:Le,onOpenPulseView:De},e.id))})}):(0,Z.jsx)(`div`,{className:`kx-view kx-view--lattice`,"aria-label":`Memory lattice`,children:(0,Z.jsx)(St,{className:`kx-lattice`,syncMode:`embedded`,onOpenPulseView:De})}),(0,Z.jsx)(`footer`,{className:`kx-footer`,"aria-label":`Explorer footer`,children:(0,Z.jsxs)(`span`,{className:`row`,children:[(0,Z.jsx)(`span`,{children:`Determinate • Stateless • Kairos-Memory`}),(0,Z.jsx)(`span`,{className:`dot`,children:`•`}),(0,Z.jsx)(`span`,{children:T()?`online`:`offline`}),(0,Z.jsx)(`span`,{className:`dot`,children:`•`}),(0,Z.jsxs)(`span`,{children:[Ie,` keys`]})]})})]})}),(0,Z.jsx)(fn,{open:ne.open,pulse:ne.pulse,originUrl:ne.originUrl,originHash:ne.originHash,registryRev:e,onClose:()=>M({open:!1,pulse:null})})]})};export{er as default};