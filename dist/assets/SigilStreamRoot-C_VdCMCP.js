const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/postSeal-D8Xvalbm.js","assets/postSeal-ClhKso-i.js"])))=>i.map(i=>d[i]);
import{m as e,n as t,o as n,s as r,t as i}from"./index-_3SastuA.js";import{n as a}from"./EternalKlock-DufDOa3w.js";import{C as o,D as s,F as c,M as l,S as u,T as d,_ as f,b as p,k as m,w as h,y as g}from"./sigilUrl-vUGjkVe6.js";import{A as _,C as v,F as y,L as ee,_ as b,a as x,c as S,l as C,m as w,r as te,s as T}from"./kai_pulse-DWvpfws5.js";import{t as E}from"./SealMomentModal-CddVtHDk.js";import{n as D}from"./SigilAuthContext-DsrJ8dhq.js";import{n as ne,t as O}from"./sigilRegistry-Du5J99mi.js";import{t as k}from"./SigilAuthProvider-zTaS-S93.js";import{a as A,i as re,n as ie,o as j,r as ae,t as oe}from"./usernameClaimRegistry-CdGv1qnf.js";import{c as se,l as ce,n as le}from"./chunk-JMJ3UQ3L-DPsIw9OM.js";import{t as ue}from"./useFastPress-BwxNc_92.js";var M=e(r(),1);const de=(0,M.createContext)(null);function N(){let e=(0,M.useContext)(de);if(!e)throw Error(`useToasts() must be used within <ToastsProvider/>`);return e}var P=e(t(),1);function fe({children:e}){let[t,n]=(0,M.useState)([]),r=(0,M.useRef)(new Map),i=(0,M.useRef)(1),a=(0,M.useCallback)(e=>{let t=r.current.get(e);typeof t==`number`&&(window.clearTimeout(t),r.current.delete(e))},[]),o=(0,M.useCallback)(e=>{a(e),n(t=>t.filter(t=>t.id!==e))},[a]),s=(0,M.useCallback)((e,t)=>{let s=i.current++;n(n=>{let r=[{id:s,kind:e,text:t},...n],i=r.slice(0,3),o=r.slice(3);for(let e of o)a(e.id);return i});let c=window.setTimeout(()=>o(s),2600);r.current.set(s,c)},[a,o]),c=(0,M.useMemo)(()=>({push:s}),[s]);(0,M.useEffect)(()=>()=>{for(let e of r.current.values())window.clearTimeout(e);r.current.clear()},[]);let l=e=>{switch(e){case`success`:return`rgba(16,28,22,.88)`;case`warn`:return`rgba(28,24,12,.88)`;case`error`:return`rgba(36,16,16,.88)`;case`info`:default:return`rgba(12,18,28,.88)`}};return(0,P.jsxs)(de.Provider,{value:c,children:[e,(0,P.jsx)(`div`,{"aria-live":`polite`,"aria-atomic":`false`,style:{position:`fixed`,left:0,right:0,bottom:0,padding:`8px 12px`,display:`grid`,gap:8,zIndex:1e3,pointerEvents:`none`},children:t.map(e=>(0,P.jsx)(`div`,{role:`status`,style:{pointerEvents:`auto`,marginInline:`auto`,maxWidth:`min(720px, 100%)`,width:`100%`,background:l(e.kind),border:`1px solid rgba(255,255,255,.12)`,borderRadius:12,padding:`10px 12px`,color:`rgb(236,241,251)`,boxShadow:`0 8px 28px rgba(0,0,0,.35)`,backdropFilter:`blur(6px)`,fontVariantNumeric:`tabular-nums`},children:e.text},e.id))})]})}var F=fe;function I(e){return String(e).padStart(2,`0`)}function pe(e,t){let n=e%t;return n<0n?n+(t<0n?-t:t):n}function me(e,t){let n=e/t,r=e%t;return r!==0n&&r>0n!=t>0n?n-1n:n}function he(e){if(!Number.isFinite(e))return 0n;let t=e<0?-1:1,n=Math.abs(e),r=Math.trunc(n),i=n-r;return i<.5?BigInt(t*r):i>.5?BigInt(t*(r+1)):BigInt(t*(r%2==0?r:r+1))}function L(e,t){try{let n=t instanceof Error?t.message:String(t);console.warn(`[SigilStream:${e}] ${n}`)}catch{}}function R(e){return typeof e==`object`&&!!e}function ge(e){try{let t=new URL(e);return t.protocol===`https:`||t.protocol===`http:`}catch{return!1}}function _e(e,t){if(!R(e))return;let n=e[t];if(typeof n==`string`)return n;let r=e.meta;if(R(r)){let e=r[t];if(typeof e==`string`)return e}}function ve(e){let t=e;if(R(t)&&`auth`in t&&(t=t.auth),R(t)){let e=t.meta,n=t.svgText;return{meta:R(e)?e:null,svgText:typeof n==`string`?n:null}}return{meta:null,svgText:null}}async function z(){try{let e=await fetch(`/links.json`,{cache:`no-store`});if(!e.ok||!(e.headers.get(`content-type`)??``).toLowerCase().includes(`application/json`))return[];let t=await e.text(),n=JSON.parse(t);if(!Array.isArray(n))return[];let r=[];for(let e of n)R(e)&&typeof e.url==`string`&&e.url.trim().length&&r.push({url:e.url});return r}catch(e){return L(`loadLinksJson`,e),[]}}const B=`sf-links`;function V(e){if(!e)return[];try{let t=JSON.parse(e);return Array.isArray(t)&&t.every(e=>typeof e==`string`)?t:[]}catch(e){return L(`parseStringArray`,e),[]}}function H(e){try{if(typeof window>`u`)return;let t=V(localStorage.getItem(B)),n=e.filter(e=>typeof e==`string`&&e.trim().length);if(n.length===0)return;let r=new Set(t),i=n.filter(e=>!r.has(e));if(i.length===0)return;let a=[...i,...t];localStorage.setItem(B,JSON.stringify(a))}catch(e){L(`prependUniqueToStorage`,e)}}const U=(()=>{try{return((typeof window<`u`?window.__PSHORT__:void 0)?.trim()||(void 0)?.trim()||``).replace(/\s+/g,``)}catch(e){return L(`Resolve PSHORT`,e),``}})();function ye(){try{if(U)return new URL(`/`,U)}catch(e){L(`Invalid PSHORT`,e)}let e=typeof window<`u`?window.location.href:`https://example.com`;return new URL(`/`,e)}function W(){let e=typeof window<`u`?window.location.href:`https://example.com`;return new URL(`/`,e)}function be(e){try{let t=new URL(e);if(!(t.protocol===`https:`||t.protocol===`http:`))return!1;let n=t.pathname;if(n.startsWith(`/stream/p/`)||n.startsWith(`/p~`)&&n.length>3)return!0;if(n===`/p`){let e=t.hash.includes(`t=`),n=t.searchParams.has(`t`);return e||n}return t.search.includes(`p=`)}catch{return!1}}function xe(e){try{let t=ye(),n=new URL(e,t),r=W();if(n.pathname.startsWith(`/p~`)&&n.pathname.length>3){r.pathname=`/stream/p/${n.pathname.slice(3)}`;let e=n.searchParams.get(`add`)||(n.hash.startsWith(`#add=`)?new URLSearchParams(n.hash.slice(1)).get(`add`):null);return e&&r.searchParams.set(`add`,Se(e)),r.toString()}if(n.pathname===`/p`){let t=n.hash.startsWith(`#`)?n.hash.slice(1):n.hash,i=new URLSearchParams(t),a=i.get(`t`),o=n.searchParams.get(`t`),s=a||o;if(!s)return e;r.pathname=`/stream/p/${s}`;let c=i.get(`add`),l=n.searchParams.get(`add`),u=c||l;return u&&r.searchParams.set(`add`,Se(u)),r.toString()}return e}catch(t){return L(`expandShortAliasToCanonical`,t),e}}function Se(e){let t=e.trim();if(!t)return t;try{if(t.startsWith(`/p~`))return xe(`${ye().origin}${t}`);if(t.startsWith(`/p#t=`)||t.startsWith(`#t=`)||t.includes(`/p?t=`))return xe(t.startsWith(`#t=`)?`${ye().origin}/p${t}`:t.startsWith(`/p`)?`${ye().origin}${t}`:t);if(ge(t)){let e=new URL(t);return e.pathname===`/p`||e.pathname.startsWith(`/p~`)?xe(t):t}return t}catch(e){return L(`normalizeAddParam`,e),t}}function Ce(e){let t=W();return t.pathname=`/stream/p/${e}`.replace(/\/{2,}/g,`/`),t.search=``,t.hash=``,t.toString()}function we(e){let t=e.trim();if(t.startsWith(`#`)&&(t=t.slice(1)),t.length===3&&(t=t.split(``).map(e=>e+e).join(``)),t.length!==6)return null;let n=parseInt(t,16);return[n>>16&255,n>>8&255,n&255]}var Te=(e,t=0,n=255)=>Math.max(t,Math.min(n,e));function Ee(e,t,n){return[Te(e[0]+(t[0]-e[0])*n),Te(e[1]+(t[1]-e[1])*n),Te(e[2]+(t[2]-e[2])*n)]}var De=e=>`${e[0]}, ${e[1]}, ${e[2]}`,Oe={root:`#FF3B3B`,sacral:`#FF8A33`,solar:`#FFD60A`,heart:`#22C55E`,throat:`#0EA5E9`,thirdEye:`#6366F1`,crown:`#C084FC`},ke=`crown`;function Ae(e){if(e==null)return null;let t;return t=typeof e==`number`?[`root`,`sacral`,`solar`,`heart`,`throat`,`thirdEye`,`crown`][Math.min(7,Math.max(1,e))-1]:e===`krown`?ke:e,we(Oe[t]??Oe.crown)}function je(e){let t=Ae(e);if(!t)return null;let n=[255,255,255],r=[255,215,128],i=Ee(t,n,.28),a=Ee(t,r,.42);return{s1:De(t),s2:De(i),s3:De(a)}}var Me={s1:`154, 230, 255`,s2:`196, 181, 253`,s3:`255, 215, 128`};function Ne(e,t){let n=je(e);if(n)return n;if(t?.primary){let e=we(t.primary)??we(`#9AE6FF`),n=t.secondary?we(t.secondary)??e:Ee(e,[255,255,255],.28),r=[255,215,128],i=t.accent?we(t.accent)??r:Ee(e,r,.45);return{s1:De(e),s2:De(n),s3:De(i)}}return Me}function Pe(e){if(!e)return;let t=e.trim();if(t)return t.startsWith(`@`),t}function Fe({username:e,phiKey:t,kaiSignature:n,sigilColors:r,chakra:i}){let a=Ne(i,r),o=Pe(e),s={"--sigil-1":a.s1,"--sigil-2":a.s2,"--sigil-3":a.s3},c=!o&&!t&&!n;return(0,P.jsx)(`div`,{className:`sf-identity`,style:s,...c?{"data-empty":``}:{},children:(0,P.jsxs)(`div`,{className:`sf-reply-id`,style:{rowGap:`.4rem`,columnGap:`.4rem`,display:`flex`,flexWrap:`wrap`},"aria-label":c?`No identity loaded`:`Identity chips`,children:[c&&(0,P.jsx)(`span`,{className:`sf-muted`,children:`No identity loaded this session.`}),o&&(0,P.jsxs)(`span`,{className:`sf-pill sf-pill--user`,title:`Username (session)`,children:[(0,P.jsx)(`strong`,{className:`sf-pill__label`,children:`User`}),`\xA0`,(0,P.jsx)(`span`,{className:`sf-key`,children:o})]}),t&&(0,P.jsxs)(`span`,{className:`sf-pill sf-pill--phikey`,title:`Your ΦKey (session)`,children:[(0,P.jsx)(`strong`,{className:`sf-pill__label`,children:`ΦKey`}),`\xA0`,(0,P.jsx)(`span`,{className:`sf-key`,children:t})]}),n&&(0,P.jsxs)(`span`,{className:`sf-pill sf-pill--ksig`,title:`Kai Signature (session)`,children:[(0,P.jsx)(`strong`,{className:`sf-pill__label`,children:`ΣSig`}),`\xA0`,(0,P.jsx)(`span`,{className:`sf-key`,children:n})]})]})})}var Ie=[`sigilActionUrl`,`sigilUrl`,`actionUrl`,`claimedUrl`,`loginUrl`,`sourceUrl`,`originUrl`,`url`,`link`,`href`];function Le(e){if(!e||!R(e))return[];let t=[],n=new Set;for(let r of Ie){let i=_e(e,r);if(typeof i!=`string`)continue;let a=i.trim();a&&(n.has(a)||(n.add(a),t.push(a)))}return t}function Re(e){if(!e)return[];try{let t=e.match(/https?:\/\/[^\s"'<>)#]+/gi)??[],n=[],r=new Set;for(let e of t){let t=(e??``).trim();t&&(r.has(t)||(r.add(t),n.push(t)))}return n}catch{return[]}}function ze(e){return/^https?:\/\//i.test((e??``).trim())}function Be(e){try{return new URL(e)}catch{return null}}function Ve(e){let t=(e??``).trim();if(!t)return``;let n=t;n=n.replace(/\/stream\/v=/gi,`/stream/t=`),n=n.replace(/\/stream\/v\//gi,`/stream/t/`),n=n.replace(/\/stream\/v(\?|&|#)/gi,`/stream/t$1`),n=n.replace(/([?&#])v=/gi,`$1t=`);let r=Be(n);if(!r)return n.replace(/([?&#])v=/gi,`$1t=`);let i=r.searchParams,a=(i.get(`t`)??``).trim().length>0,o=(i.get(`v`)??``).trim();if(!a&&o&&i.set(`t`,o),i.delete(`v`),(i.get(`t`)??``).trim().length>0&&i.delete(`p`),r.hash&&r.hash.length>1){let e=r.hash.startsWith(`#`)?r.hash.slice(1):r.hash;if(e.includes(`=`)&&!e.startsWith(`/`)){let t=e.split(`&`).filter(Boolean),n=[],i=!1;for(let e of t){let t=e.indexOf(`=`);if(t<=0){n.push(e);continue}let r=e.slice(0,t),a=e.slice(t+1),o=r.toLowerCase();if(o===`v`){!i&&a.trim().length&&(n.push(`t=${a}`),i=!0);continue}o===`t`&&(i=!0),n.push(e)}if(i){let e=[];for(let t of n){let n=t.indexOf(`=`);(n>0?t.slice(0,n).toLowerCase():``)!==`p`&&e.push(t)}r.hash=e.length?`#${e.join(`&`)}`:``}else r.hash=n.length?`#${n.join(`&`)}`:``}else r.hash=r.hash.replace(/([?&#])v=/gi,`$1t=`)}return r.toString()}function He(e){let t=(e??``).trim();if(!t)return-1;let n=t.toLowerCase(),r=0;return(/[?&#]v=/.test(n)||n.includes(`/stream/v`))&&(r-=1e4),(/[?&#]t=/.test(n)||n.includes(`/stream/t`)||n.includes(`stream/t=`))&&(r+=500),(/[?&#]p=/.test(n)||n.includes(`/stream/p`)||n.includes(`stream/p=`))&&(r+=280),be(t)&&(r+=160),n.startsWith(`https://`)?r+=20:n.startsWith(`http://`)&&(r+=10),r+=Math.max(0,120-Math.min(120,Math.floor(t.length/6))),r}function Ue(e){let t=``,n=-1;for(let r of e){let e=Ve(r),i=He(e);i>n&&(n=i,t=e)}return t}async function We(e){let t=e??``;if(!t)return!1;try{if(typeof navigator<`u`&&navigator.clipboard?.writeText)return await navigator.clipboard.writeText(t),!0}catch{}try{let e=document.createElement(`textarea`);e.value=t,e.setAttribute(`readonly`,`true`),e.style.position=`fixed`,e.style.left=`-9999px`,e.style.top=`-9999px`,document.body.appendChild(e),e.select(),e.setSelectionRange(0,e.value.length);let n=document.execCommand(`copy`);return document.body.removeChild(e),n}catch{return!1}}function Ge({value:e,isCanonical:t}){let n=(0,M.useMemo)(()=>Be(e),[e]),r=(0,M.useMemo)(()=>ze(e)?e:``,[e]),[i,a]=(0,M.useState)(!1),[o,s]=(0,M.useState)(!1),c=(0,M.useRef)(null);(0,M.useEffect)(()=>()=>{c.current&&window.clearTimeout(c.current)},[]);let l=(0,M.useCallback)(e=>{c.current&&window.clearTimeout(c.current),a(e),s(!e),c.current=window.setTimeout(()=>{a(!1),s(!1),c.current=null},1400)},[]),u=(0,M.useCallback)(async()=>{l(await We(e))},[l,e]),d=(0,M.useCallback)(e=>{let t=e.currentTarget;try{t.focus(),t.select(),t.setSelectionRange(0,t.value.length)}catch{}},[]),f=n?.host??``,p=n?`${n.hostname}${n.pathname}${n.search}${n.hash}`.replace(/\/{2,}/g,`/`):e;return(0,P.jsxs)(`div`,{className:`sf-reply-row sf-actionurl`,children:[(0,P.jsxs)(`div`,{className:`sf-actionurl__head`,children:[(0,P.jsxs)(`label`,{className:`sf-label sf-actionurl__label`,children:[`Proof of Breath™ `,(0,P.jsx)(`span`,{className:`sf-muted`,children:`(Sigil-Glyph)`})]}),(0,P.jsx)(`span`,{className:`sf-actionurl__pill ${t?`is-ok`:`is-warn`}`,children:t?`SIGNED`:`EXTERNAL`})]}),(0,P.jsxs)(`div`,{className:`sf-actionurl__field`,children:[(0,P.jsxs)(`div`,{className:`sf-actionurl__inputWrap`,children:[(0,P.jsx)(`input`,{className:`sf-input sf-input--locked sf-actionurl__input`,type:`url`,value:e,readOnly:!0,onClick:d,onFocus:d,"aria-label":`Proof of Breath™ Sigil-Glyph`}),(0,P.jsxs)(`div`,{className:`sf-actionurl__meta`,"aria-hidden":`true`,children:[f?(0,P.jsx)(`span`,{className:`sf-actionurl__host`,children:f}):(0,P.jsx)(`span`,{className:`sf-actionurl__host`,children:`URL`}),(0,P.jsx)(`span`,{className:`sf-actionurl__dot`,children:`•`}),(0,P.jsx)(`span`,{className:`sf-actionurl__pretty`,children:p})]})]}),(0,P.jsxs)(`div`,{className:`sf-actionurl__btns`,children:[(0,P.jsx)(`button`,{type:`button`,className:`sf-actionurl__btn ${i?`is-copied`:``} ${o?`is-fail`:``}`,onClick:u,"aria-live":`polite`,children:i?`✓ Remembered`:o?`Remember failed`:`Remember`}),r?(0,P.jsx)(`a`,{className:`sf-actionurl__btn sf-actionurl__btn--link`,href:r,target:`_blank`,rel:`noreferrer noopener`,"aria-label":`Open Proof of Breath URL in a new tab`,children:`↗`}):(0,P.jsx)(`button`,{type:`button`,className:`sf-actionurl__btn sf-actionurl__btn--disabled`,disabled:!0,children:`↗`})]})]}),!t&&(0,P.jsx)(`div`,{className:`sf-warn sf-actionurl__warn`,role:`status`,children:`Not recognized as a sealed Proof of Breath™ link; fallback rules may apply.`})]})}function Ke(){return(0,P.jsxs)(`div`,{className:`sf-reply-row sf-actionurl sf-actionurl--empty`,children:[(0,P.jsxs)(`div`,{className:`sf-actionurl__head`,children:[(0,P.jsxs)(`label`,{className:`sf-label sf-actionurl__label`,children:[`Proof of Breath™ `,(0,P.jsx)(`span`,{className:`sf-muted`,children:`(Sigil-Glyph)`})]}),(0,P.jsx)(`span`,{className:`sf-actionurl__pill is-warn`,children:`MISSING`})]}),(0,P.jsx)(`div`,{className:`sf-warn sf-actionurl__warn`,role:`status`,children:`No Proof of Breath™ sigil-glyph detected; a fallback will be used.`})]})}function qe({meta:e,svgText:t}){let n=Le(e),r=Re(t),i=[...n,...r],a=i.length?Ue(i):``,o=a.length>0&&be(a);return{value:a,isCanonical:o,node:a?(0,P.jsx)(Ge,{value:a,isCanonical:o}):(0,P.jsx)(Ke,{})}}function Je(e){let t=e.trim();if(!t)return null;let n=t.replace(/^(kai|sigil):\/\//i,`https://`);try{if(ge(n))return n;if(/^[a-z0-9.-]+\.[a-z]{2,}(?:\/.*)?$/i.test(n))return`https://${n}`}catch{}return null}function Ye({onAdd:e,placeholder:t=`Paste any message (https://… or domain.tld)`,title:n=`Inhale a memory`}){let r=N(),[i,a]=(0,M.useState)(``),[o,s]=(0,M.useState)(null),c=(0,M.useCallback)(t=>{s(null);let n=Je(t);if(!n){s(`Enter a valid URL (https://… or domain.tld).`);return}e(n),a(``),r.push(`success`,`Link inhaled.`)},[e,r]),l=(0,M.useCallback)(async()=>{s(null);try{let e=(await navigator.clipboard.readText()).trim();if(!e){s(`Memory is empty.`);return}let t=Je(e);if(!t){s(`Memory does not contain a valid link.`);return}a(t),c(t)}catch{s(`Memory read is not permitted.`)}},[c]);return(0,P.jsxs)(`section`,{className:`sf-inhaler`,"aria-labelledby":`inhaler-title`,style:{marginTop:`1rem`},children:[(0,P.jsx)(`h2`,{id:`inhaler-title`,className:`sf-reply-title`,children:n}),(0,P.jsxs)(`div`,{className:`sf-reply-row`,style:{display:`grid`,gap:`.5rem`},children:[(0,P.jsx)(`input`,{className:`sf-input`,type:`url`,placeholder:t,value:i,onChange:e=>a(e.target.value),autoCorrect:`off`,autoCapitalize:`none`,spellCheck:!1,inputMode:`url`,enterKeyHint:`go`,onKeyDown:e=>{e.key===`Enter`&&(e.preventDefault(),c(i))}}),(0,P.jsxs)(`div`,{className:`sf-reply-actions`,style:{gap:`.5rem`,display:`flex`,flexWrap:`wrap`},children:[(0,P.jsx)(`button`,{className:`sf-btn`,onClick:()=>c(i),children:`Inhale`}),(0,P.jsx)(`button`,{className:`sf-btn sf-btn--ghost`,onClick:l,children:`Inhale from memory`})]}),o&&(0,P.jsx)(`div`,{className:`sf-error`,role:`alert`,children:o})]})]})}const Xe=[`Solhara`,`Aquaris`,`Flamora`,`Verdari`,`Sonari`,`Kaelith`],Ze={Solhara:`Root`,Aquaris:`Sacral`,Flamora:`Solar Plexus`,Verdari:`Heart`,Sonari:`Throat`,Kaelith:`Krown`},Qe=[`Aethon`,`Virelai`,`Solari`,`Amarin`,`Kaelus`,`Umbriel`,`Noktura`,`Liora`],$e=[`Awakening Flame`,`Flowing Heart`,`Radiant Will`,`Harmonic Voh`,`Inner Mirror`,`Dreamfire Memory`,`Krowned Light`],et=Date.UTC(2024,4,10,6,45,41,888),tt=3+Math.sqrt(5);tt*1e3;const nt=1000000n,rt=17491270421n,it=11000000n,at=(rt+18n)/36n;function ot(e){return he((e.getTime()-et)/1e3/tt*1e6)}function st(e){let t=ot(e),n=pe(t,rt),r=me(t,rt),i=Number(me(n,at)),a=n-BigInt(i)*at,o=Number(a/it),s=Math.min(Math.max(o,0),43),c=a-BigInt(s)*it,l=Number(c)/Number(it),u=Number(me(t,nt)),d=Number(a/nt),f=Number(n/nt),p=Xe[Number(pe(r,BigInt(6)))],m=Ze[p],h=Number(r),g=(h%42+42)%42+1,_=(Math.floor(h/42)%8+8)%8,v=_+1,y=Qe[_],ee=Math.floor(h/336),b=Math.floor((g-1)/6),x=$e[b];return{pulse:u,beat:i,step:s,stepPct:l,pulsesIntoBeat:d,pulsesIntoDay:f,harmonicDay:p,chakraDay:m,chakraStepString:`${i}:${I(s)}`,dayOfMonth:g,monthIndex0:_,monthIndex1:v,monthName:y,yearIndex:ee,weekIndex:b,weekName:x,_pμ_in_day:n,_pμ_in_beat:a}}function ct(e){try{let t=new URL(e).pathname.split(`/`).pop()||``,n=t.lastIndexOf(`.`);return n>=0?t.slice(n+1).toLowerCase():``}catch{return``}}function lt(e){return[`png`,`jpg`,`jpeg`,`gif`,`webp`,`avif`,`bmp`].includes(e)}function ut(e){return[`mp4`,`webm`,`ogg`,`ogv`,`mov`,`m4v`].includes(e)}function dt(e){return e===`pdf`}function ft(e){try{return new URL(e).host}catch{return``}}function pt(e){try{let t=new URL(e),n=t.host,r=t.pathname||``;r===`/`&&(r=``),r.endsWith(`/`)&&r.length>1&&(r=r.slice(0,-1));let i=t.search||``;return`${n}${r}${i}`}catch{return e.replace(/^https?:\/\//i,``).replace(/\/+$/g,``)}}function mt(e){try{let t=new URL(e);if(t.hostname.includes(`youtu.be`))return t.pathname.slice(1)||null;if(t.hostname.includes(`youtube.com`)){let e=t.searchParams.get(`v`);if(e)return e;let n=t.pathname.split(`/`).filter(Boolean),r=n.indexOf(`embed`);if(r>=0&&n[r+1])return n[r+1]}return null}catch{return null}}function ht(e){try{let t=new URL(e);return t.hostname.includes(`vimeo.com`)&&t.pathname.split(`/`).filter(Boolean).find(e=>/^\d+$/.test(e))||null}catch{return null}}function gt(e){try{let t=new URL(e);return t.hostname.includes(`spotify.com`)&&(t.pathname.startsWith(`/track/`)||t.pathname.startsWith(`/album/`)||t.pathname.startsWith(`/playlist/`))?`https://open.spotify.com/embed${t.pathname}${t.search}`:null}catch{return null}}function _t({host:e}){return(0,P.jsx)(`img`,{className:`sf-favicon`,src:`https://${e}/favicon.ico`,alt:``,width:16,height:16,loading:`eager`,decoding:`async`,onError:e=>{e.currentTarget.style.visibility=`hidden`}})}function vt(e){let{url:t,title:n,children:r}=e,i=ft(t),a=(n&&n.trim().length?n.trim():``)||pt(t);return(0,P.jsxs)(`div`,{className:`sf-att-card`,children:[(0,P.jsx)(`div`,{className:`sf-att-head`,children:(0,P.jsxs)(`a`,{className:`sf-att-head__hit`,href:t,target:`_blank`,rel:`noopener noreferrer`,title:t,children:[i?(0,P.jsx)(_t,{host:i}):(0,P.jsx)(`span`,{className:`sf-favicon sf-favicon--blank`,"aria-hidden":`true`}),(0,P.jsx)(`div`,{className:`sf-att-head__text`,children:(0,P.jsx)(`div`,{className:`sf-att-head__title`,children:a})}),(0,P.jsx)(`span`,{className:`sf-att-open`,"aria-hidden":`true`,children:`↗`})]})}),r?(0,P.jsx)(`div`,{className:`sf-att-body`,children:r}):null]})}function yt({src:e,title:t}){return(0,P.jsx)(`div`,{className:`sf-embed`,children:(0,P.jsx)(`iframe`,{className:`sf-embed__frame`,src:e,title:t,loading:`eager`,allow:`accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share`,allowFullScreen:!0,sandbox:`allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox`})})}function bt({url:e,title:t}){return(0,P.jsx)(vt,{url:e,title:t})}function xt({url:e,title:t}){let n=mt(e);if(n)return(0,P.jsx)(vt,{url:e,title:t,children:(0,P.jsx)(yt,{src:`https://www.youtube.com/embed/${n}`,title:t||`YouTube`})});let r=ht(e);if(r)return(0,P.jsx)(vt,{url:e,title:t,children:(0,P.jsx)(yt,{src:`https://player.vimeo.com/video/${r}`,title:t||`Vimeo`})});let i=gt(e);if(i)return(0,P.jsx)(vt,{url:e,title:t,children:(0,P.jsx)(yt,{src:i,title:t||`Spotify`})});let a=ct(e);return lt(a)?(0,P.jsx)(vt,{url:e,title:t,children:(0,P.jsx)(`div`,{className:`sf-media sf-media--image`,children:(0,P.jsx)(`img`,{className:`sf-media__img`,src:e,alt:t||`image`,loading:`eager`,decoding:`async`})})}):ut(a)?(0,P.jsx)(vt,{url:e,title:t,children:(0,P.jsx)(`div`,{className:`sf-media sf-media--video`,children:(0,P.jsx)(`video`,{className:`sf-media__video`,src:e,controls:!0,playsInline:!0,preload:`metadata`})})}):dt(a)?(0,P.jsx)(vt,{url:e,title:t,children:(0,P.jsx)(`div`,{className:`sf-embed sf-embed--doc`,children:(0,P.jsx)(`iframe`,{className:`sf-embed__frame`,src:e,title:t||`Document`,loading:`eager`})})}):(0,P.jsx)(bt,{url:e,title:t})}function St(e){let t=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,`0`)),n=``;for(let r=0;r<e.length;r++)n+=t[e[r]];return n}function Ct(e){let t=``;for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return btoa(t).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``)}function wt(e){let t=e.replace(/-/g,`+`).replace(/_/g,`/`),n=t.length%4?4-t.length%4:0;return t+`=`.repeat(n)}const Tt=(e,t=`application/octet-stream`)=>`data:${t};base64,${wt(e)}`;async function Et(e){let t=typeof crypto<`u`&&crypto.subtle||typeof window<`u`&&window.crypto&&window.crypto.webkitSubtle;if(!t)throw Error(`WebCrypto.subtle is not available in this context.`);let n=await t.digest(`SHA-256`,e);return St(new Uint8Array(n))}async function Dt(e,t=524288){let n=[],r=0,i=0;for(let a of Array.from(e)){r+=a.size;try{let e=await a.arrayBuffer(),r=await Et(e),o=a.type||`application/octet-stream`;if(a.size<=t){let t=Ct(new Uint8Array(e)),s={kind:`file-inline`,name:a.name,type:o,size:a.size,sha256:r,data_b64url:t};i+=a.size,n.push(s)}else{let e={kind:`file-ref`,name:a.name,type:o,size:a.size,sha256:r};n.push(e)}}catch(e){L(`filesToManifest: read/hash failed`,e)}}return{version:1,totalBytes:r,inlinedBytes:i,items:n}}function Ot({n:e}){if(typeof e!=`number`||!Number.isFinite(e)||e<0)return(0,P.jsx)(P.Fragment,{children:`—`});let t=1024,n=t*1024,r=n*1024;return(0,P.jsx)(P.Fragment,{children:e>=r?`${(e/r).toFixed(2)} GB`:e>=n?`${(e/n).toFixed(2)} MB`:e>=t?`${(e/t).toFixed(2)} KB`:`${Math.round(e)} B`})}function kt({it:e}){let t=e.type||`application/octet-stream`,n=Tt(e.data_b64url,t),r=e.name||`file`;if(t.startsWith(`image/`))return(0,P.jsxs)(`div`,{className:`sf-media sf-media--image`,children:[(0,P.jsx)(`img`,{src:n,alt:r,loading:`eager`,decoding:`async`}),(0,P.jsxs)(`div`,{className:`sf-file-meta`,children:[(0,P.jsx)(`span`,{children:r}),(0,P.jsx)(`span`,{children:(0,P.jsx)(Ot,{n:e.size})})]}),(0,P.jsx)(`a`,{className:`sf-file-dl`,href:n,download:r,children:`Download`})]});if(t.startsWith(`video/`))return(0,P.jsxs)(`div`,{className:`sf-media sf-media--video`,children:[(0,P.jsx)(`video`,{src:n,controls:!0,playsInline:!0,preload:`metadata`}),(0,P.jsxs)(`div`,{className:`sf-file-meta`,children:[(0,P.jsx)(`span`,{children:r}),(0,P.jsx)(`span`,{children:(0,P.jsx)(Ot,{n:e.size})})]}),(0,P.jsx)(`a`,{className:`sf-file-dl`,href:n,download:r,children:`Download`})]});if(t.startsWith(`audio/`))return(0,P.jsxs)(`div`,{className:`sf-media sf-media--audio`,children:[(0,P.jsx)(`audio`,{src:n,controls:!0,preload:`metadata`}),(0,P.jsxs)(`div`,{className:`sf-file-meta`,children:[(0,P.jsx)(`span`,{children:r}),(0,P.jsx)(`span`,{children:(0,P.jsx)(Ot,{n:e.size})})]}),(0,P.jsx)(`a`,{className:`sf-file-dl`,href:n,download:r,children:`Download`})]});let i=t.startsWith(`text/`)||[`application/json`,`application/xml`,`application/svg+xml`].includes(t),a=null;if(i)try{a=atob(e.data_b64url.replace(/-/g,`+`).replace(/_/g,`/`)).slice(0,1200)}catch{a=null}return(0,P.jsxs)(`div`,{className:`sf-file`,children:[(0,P.jsxs)(`div`,{className:`sf-file-head`,children:[(0,P.jsx)(`div`,{className:`sf-file-name`,children:e.relPath||r}),(0,P.jsx)(`div`,{className:`sf-file-size`,children:(0,P.jsx)(Ot,{n:e.size})})]}),a&&(0,P.jsxs)(`pre`,{className:`sf-file-pre`,"aria-label":`${r} preview`,children:[a,a.length>=1200?`
… (truncated preview)`:``]}),(0,P.jsxs)(`div`,{className:`sf-file-foot`,children:[(0,P.jsxs)(`code`,{className:`sf-hash mono`,children:[`sha256:`,e.sha256]}),(0,P.jsx)(`a`,{className:`sf-file-dl`,href:n,download:r,children:`Download`})]})]})}function At({it:e}){let t=e.name||`file`;return(0,P.jsxs)(`div`,{className:`sf-fileref`,children:[(0,P.jsxs)(`div`,{className:`sf-file-head`,children:[(0,P.jsx)(`div`,{className:`sf-file-name`,children:e.relPath||t}),(0,P.jsx)(`div`,{className:`sf-file-size`,children:(0,P.jsx)(Ot,{n:e.size})})]}),(0,P.jsxs)(`div`,{className:`sf-file-foot`,children:[(0,P.jsx)(`div`,{className:`sf-file-type`,children:e.type||`application/octet-stream`}),(0,P.jsxs)(`code`,{className:`sf-hash mono`,children:[`sha256:`,e.sha256]})]}),(0,P.jsx)(`div`,{className:`sf-note`,children:`Large file not inlined. Host by hash anywhere and add the public URL as an attachment link.`})]})}function jt({item:e}){return e.kind===`url`?(0,P.jsx)(xt,{url:e.url,title:e.title}):e.kind===`file-inline`?(0,P.jsx)(kt,{it:e}):(0,P.jsx)(At,{it:e})}function Mt({manifest:e}){return e.items.length?(0,P.jsxs)(`section`,{className:`sf-attachments`,"aria-labelledby":`sf-att-title`,children:[(0,P.jsx)(`h3`,{id:`sf-att-title`,className:`sf-att-title`,children:`Attachments`}),(0,P.jsx)(`div`,{className:`sf-att-grid`,children:e.items.map((e,t)=>(0,P.jsx)(`div`,{className:`sf-att-item`,children:(0,P.jsx)(jt,{item:e})},t))}),(0,P.jsxs)(`div`,{className:`sf-att-foot`,children:[(0,P.jsxs)(`span`,{children:[`Total:`,` `,(0,P.jsx)(`strong`,{children:(0,P.jsx)(Ot,{n:e.totalBytes})})]}),typeof e.inlinedBytes==`number`&&e.inlinedBytes>0&&(0,P.jsxs)(`span`,{children:[` `,`• Inlined:`,` `,(0,P.jsx)(`strong`,{children:(0,P.jsx)(Ot,{n:e.inlinedBytes})})]})]})]}):null}function Nt(e){let t=e.trim();if(!t)return null;if(/^(kai|sigil):\/\//i.test(t))return t.replace(/^(kai|sigil):\/\//i,`https://`);try{if(ge(t))return t;if(/^[a-z0-9.-]+\.[a-z]{2,}(\/.*)?$/i.test(t))return`https://${t}`}catch{}return null}function Pt(e,t){if(!t)return{next:e,error:`Missing URL.`};if(e.some(e=>e.url===t))return{next:e,error:`Link already added.`};let n={kind:`url`,url:t};return{next:[...e,n],added:n}}function Ft(e,t){return t<0||t>=e.length?e:[...e.slice(0,t),...e.slice(t+1)]}var It=512,Lt=`sigil:urls`,Rt=`sigil:feed`,zt=`kai-sigil-registry`,Bt=`kai-feed-registry`;function Vt(e){try{return decodeURIComponent(e)}catch{return e}}function Ht(e){let t=e.trim();return t.length<16?!1:/^[A-Za-z0-9_-]+$/u.test(t)}function Ut(e){let t=e.trim();if(!t)return``;try{return new URL(t,W().origin).toString()}catch{return t}}function Wt(e){let t=o(e);return t?`t:${t}`:null}function Gt(e){try{let t=new URL(e,W().origin),n=t.hash.startsWith(`#`)?t.hash.slice(1):``;return new URLSearchParams(n).getAll(`add`).length+t.searchParams.getAll(`add`).length}catch{return 0}}function Kt(e){return Gt(e)*1e5+e.length}function qt(e,t){if(typeof window>`u`||window.localStorage===void 0)return{changed:!1,value:t};let n=Ut(t);if(!n)return{changed:!1,value:t};try{let t=window.localStorage.getItem(e),r=[];if(t){let e=JSON.parse(t);if(Array.isArray(e))for(let t of e)typeof t==`string`&&r.push(t)}let i=[],a=new Map,o=e=>Wt(e)??`u:${Ut(e)}`;for(let e of r){let t=Ut(e);if(!t)continue;let n=o(t),r=Kt(t);a.has(n)?r>a.get(n).score&&a.set(n,{url:t,score:r}):(a.set(n,{url:t,score:r}),i.push(n))}let s=o(n),c=Kt(n);a.has(s)?c>a.get(s).score&&a.set(s,{url:n,score:c}):(a.set(s,{url:n,score:c}),i.push(s));let l=[];for(let e of i){let t=a.get(e);t&&l.push(t.url)}let u=JSON.stringify(r),d=JSON.stringify(l);return u===d?{changed:!1,value:n}:(window.localStorage.setItem(e,d),{changed:!0,value:n})}catch{return{changed:!1,value:n}}}function Jt(e){if(!(typeof window>`u`)){try{window.__SIGIL__?.registerSigilUrl?.(e)}catch{}try{window.dispatchEvent(new CustomEvent(`sigil:url-registered`,{detail:{url:e}}))}catch{}try{if(`BroadcastChannel`in window){let t=new BroadcastChannel(zt);t.postMessage({type:`sigil:add`,url:e}),t.close()}}catch{}}}function Yt(e){if(!(typeof window>`u`)){try{window.__FEED__?.registerFeedUrl?.(e)}catch{}try{window.dispatchEvent(new CustomEvent(`feed:url-registered`,{detail:{url:e}}))}catch{}try{if(`BroadcastChannel`in window){let t=new BroadcastChannel(Bt);t.postMessage({type:`feed:add`,url:e}),t.close()}}catch{}}}function Xt(e){try{let t=new URL(e,W().origin),n=t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n),i=[...t.searchParams.getAll(`add`),...r.getAll(`add`)],a=[];for(let e of i){let t=Vt(String(e)).trim();if(t){if(t.startsWith(`j:`)&&t.length>10){a.includes(t)||a.push(t);continue}if(Ht(t))try{let e=xe(Ce(t));e&&!a.includes(e)&&a.push(e);continue}catch{}try{let e=xe(t);e&&!a.includes(e)&&a.push(e)}catch{}}}return a.slice(-It)}catch{return[]}}function Zt(e,t){let n=new URL(e,W().origin),r=n.hash.startsWith(`#`)?n.hash.slice(1):``,i=new URLSearchParams(r);i.delete(`add`);for(let e of t)i.append(`add`,e);n.search=``;let a=i.toString();return n.hash=a?`#${a}`:``,n.toString()}function Qt(e){return`${W().origin.replace(/\/+$/g,``)}/stream/p/${encodeURIComponent(e)}`}function $t(e){try{let t=new URL(e,W().origin),n=t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n).get(`root`)??t.searchParams.get(`root`);if(!r)return null;let i=Vt(String(r)).trim();return i?i.startsWith(`j:`)&&i.length>10?i:/^[A-Za-z0-9_-]{16,}$/u.test(i)?`j:${i}`:null:null}catch{return null}}function en(){if(typeof window>`u`)return{replyToUrl:null,originUrl:null,addChain:[]};let e=window.location.href,t=Xt(e),n=o(e)??u(window.location),r=n?(()=>{try{return xe(Qt(n))}catch{return Qt(n)}})():null,i=$t(e),a=!r&&!i&&t.length?t[t.length-1]:null,s=r??i??a;return{replyToUrl:s,originUrl:t.length?t[0]:s,addChain:(a&&t.length?t.slice(0,-1):t.slice(0)).slice(-It)}}function tn({meta:e,svgText:t,onUseDifferentKey:n,inlineLimitBytes:r=512*1024}){let i=N(),{meta:a,svgText:f}=(0,M.useMemo)(()=>ve({meta:e,svgText:t}),[e,t]),_=(0,M.useMemo)(()=>a?_e(a,`userPhiKey`):void 0,[a]),v=(0,M.useMemo)(()=>a?_e(a,`kaiSignature`):void 0,[a]),{value:y}=qe({meta:a,svgText:f}),[ee,b]=(0,M.useState)(``),[x,S]=(0,M.useState)(``),[C,w]=(0,M.useState)(``),[te,T]=(0,M.useState)({version:1,totalBytes:0,inlinedBytes:0,items:[]}),[E,D]=(0,M.useState)(``),[ne,O]=(0,M.useState)([]),k=(0,M.useId)(),se=(0,M.useId)(),ce=(0,M.useRef)(null),le=(0,M.useRef)(null),[ue,de]=(0,M.useState)(!1),[fe,F]=(0,M.useState)(``),[I,pe]=(0,M.useState)(!1),[me,he]=(0,M.useState)(()=>oe()),[L,R]=(0,M.useState)(null);(0,M.useEffect)(()=>{if(!(typeof window>`u`))try{let e=en();if(!e.replyToUrl)return;let t=o(e.replyToUrl)??u(window.location);if(!t)return;let n=g(t);n&&R(n)}catch{}},[]);let ge=(0,M.useMemo)(()=>{if(!L)return null;let e=L.body,t=L.caption??``;e&&(e.kind===`text`?t=e.text:e.kind===`md`?t=e.md:e.kind===`code`?t=e.code:e.kind===`html`&&(t=e.html));let n=t.trim();if(!n)return{author:L.author,url:L.url,snippet:`(Previous memory has no visible text content.)`};let r=n.length>280?`${n.slice(0,279)}…`:n;return{author:L.author,url:L.url,snippet:r}},[L]);(0,M.useEffect)(()=>{he(oe());let e=ae((e,t)=>{he(t=>({...t,[e.normalized]:e}))});return()=>e()},[]);let z=(0,M.useMemo)(()=>j(x),[x]),B=z?me[z]:void 0,V=(0,M.useMemo)(()=>A(C),[C]),H=(0,M.useMemo)(()=>z?B?B.claimHash===V||B.ownerHint&&_&&B.ownerHint===_?`Username claimed by you`:`Username claimed by another`:`Username available`:``,[B,V,z,_]),U=(0,M.useCallback)(async e=>{let t=e.currentTarget.files;if(!(!t||t.length===0))try{let n=await Dt(t,r);T(e=>({version:1,totalBytes:e.totalBytes+n.totalBytes,inlinedBytes:e.inlinedBytes+n.inlinedBytes,items:[...n.items,...e.items]})),e.currentTarget.value=``,i.push(`success`,`Attached.`)}catch(e){console.error(`[Composer] onPickFiles:`,e),i.push(`error`,`Attach failed.`)}},[r,i]),ye=(0,M.useCallback)(e=>{T(t=>{let n=[...t.items],r=n.splice(e,1)[0],i=r&&(r.kind===`file-inline`||r.kind===`file-ref`)?r.size??0:0,a=r&&r.kind===`file-inline`?r.size??0:0;return{version:1,totalBytes:Math.max(0,t.totalBytes-i),inlinedBytes:Math.max(0,t.inlinedBytes-a),items:n}})},[]),xe=e=>{let t=Nt(e);if(!t){i.push(`warn`,`Invalid URL. Use https://example.com`);return}let{next:n,added:r,error:a}=Pt(ne,t);if(a){i.push(`warn`,a);return}O(n),D(``),r&&i.push(`success`,`Link added.`)},Se=e=>{O(t=>Ft(t,e))},Ce=async()=>{if(!ue){de(!0);try{let e=(y||``).trim();(!e||!be(e))&&i.push(`info`,`No sigil URL detected; using fallback.`);let t=ee.trim(),n=x.trim(),r=j(n),u=ne.map(e=>l({url:e.url,title:e.title})),f=te.items.map(e=>e.kind===`file-ref`?s({sha256:e.sha256,name:e.name,type:e.type,size:e.size,url:void 0}):e.kind===`file-inline`?m({name:e.name,type:e.type,size:e.size,data_b64url:e.data_b64url,thumbnail_b64:void 0}):e),g=[...u,...f],b=g.length>0?h(g):void 0,S=st(new Date).pulse,C=t.length>0?{kind:`text`,text:t}:void 0,w;if(r)if(B){if(!V){i.push(`warn`,`Username is claimed. Provide your claim glyph token to seal.`);return}if(V!==B.claimHash){i.push(`warn`,`Claim glyph mismatch. Memory not sealed.`);return}w={hash:B.claimHash,url:B.claimUrl,payload:{kind:c,username:B.username,normalized:B.normalized,originHash:B.originHash,ownerHint:B.ownerHint??null},ownerHint:B.ownerHint??null}}else{if(!a||!v){i.push(`warn`,`Inhale your sigil to mint a username claim.`);return}let e=re({origin:{hash:v,pulseCreated:a?.pulse??S,pulseGenesis:a?.pulse??S,value:1,sentTo:[],receivedFrom:[],metadata:{kaiSignature:v,creator:_??void 0}},username:n,pulse:S,ownerHint:_??null}),t=e.metadata?.usernameClaim;if(t)w={hash:e.hash,payload:t,ownerHint:t.ownerHint??null};else{i.push(`warn`,`Could not mint username-claim glyph.`);return}}let T=Qt(p({...d({url:e||W().origin,pulse:S,caption:t||void 0,body:C,author:n||void 0,sigilId:void 0,phiKey:_??void 0,kaiSignature:v??void 0,parent:void 0,parentUrl:void 0,originUrl:void 0,ts:void 0,attachments:b,usernameClaim:w}),kind:`post`})),E=en(),D=[];for(let e of E.addChain){let t=o(e);t&&!D.includes(t)&&D.push(t)}let O=E.replyToUrl?o(E.replyToUrl):null,k=[...D];O&&!k.includes(O)&&k.push(O);let A=k.length?Zt(T,k.slice(-It)):T;if(w){let e=ie({...w,url:w.url??A});if(!e.accepted){i.push(`warn`,e.reason||`Unable to register username claim.`);return}he(e.registry)}await navigator.clipboard.writeText(A),i.push(`success`,`Link kopied. Kai-sealed.`),F(A);try{for(let e of k){let t=qt(Lt,Qt(e));t.changed&&Jt(t.value)}let e=qt(Lt,A);e.changed&&Jt(e.value);let t=qt(Rt,A);t.changed&&Yt(t.value)}catch{}}catch(e){console.error(`[Composer] onGenerateReply:`,e),i.push(`error`,`Could not seal reply.`)}finally{de(!1)}}};return(0,P.jsxs)(`section`,{className:`sf-reply`,"aria-labelledby":`reply-title`,children:[ge&&(0,P.jsxs)(`aside`,{className:`sf-reply-context`,"aria-label":`Replying to previous memory`,children:[(0,P.jsxs)(`div`,{className:`sf-reply-context-header`,children:[(0,P.jsx)(`span`,{className:`sf-pill`,children:`Replying to`}),ge.author&&(0,P.jsx)(`span`,{className:`sf-reply-context-author`,children:ge.author})]}),(0,P.jsx)(`p`,{className:`sf-reply-context-body`,children:ge.snippet})]}),(0,P.jsxs)(`div`,{className:`sf-reply-row`,children:[(0,P.jsx)(`label`,{className:`sf-label`,children:`Attach`}),(0,P.jsxs)(`div`,{className:`sf-reply-row-inline`,children:[(0,P.jsx)(`label`,{className:`sf-btn`,htmlFor:se,children:`Record Memory`}),(0,P.jsx)(`label`,{className:`sf-btn sf-btn--ghost`,htmlFor:k,children:`Inhale files`})]}),(0,P.jsx)(`input`,{id:se,ref:le,type:`file`,accept:`image/*,video/*`,capture:`environment`,multiple:!0,onChange:U,style:{position:`absolute`,opacity:0,pointerEvents:`none`}}),(0,P.jsx)(`input`,{id:k,ref:ce,type:`file`,accept:`image/*,video/*,audio/*,application/pdf,text/plain,application/json,application/xml,application/svg+xml`,multiple:!0,onChange:U,style:{position:`absolute`,opacity:0,pointerEvents:`none`}}),te.items.length>0&&(0,P.jsx)(`div`,{className:`sf-att-grid`,children:te.items.map((e,t)=>(0,P.jsxs)(`div`,{className:`sf-att-item`,style:{position:`relative`},children:[(0,P.jsx)(jt,{item:e}),(0,P.jsx)(`button`,{className:`sf-btn sf-btn--icon`,onClick:()=>ye(t),style:{position:`absolute`,top:8,right:8},type:`button`,"aria-label":`Remove attachment`,children:`✕`})]},`${e.kind}:${t}`))})]}),(0,P.jsxs)(`div`,{className:`sf-reply-row`,children:[(0,P.jsx)(`label`,{className:`sf-label`,children:`Add links`}),(0,P.jsxs)(`div`,{className:`sf-reply-row-inline`,children:[(0,P.jsx)(`input`,{className:`sf-input`,type:`url`,placeholder:`https://example.com`,value:E,onChange:e=>D(e.target.value)}),(0,P.jsx)(`button`,{className:`sf-btn`,onClick:()=>xe(E),type:`button`,children:`Add`})]}),ne.length>0&&(0,P.jsx)(`div`,{className:`sf-att-grid`,children:ne.map((e,t)=>(0,P.jsxs)(`div`,{className:`sf-att-item`,style:{position:`relative`},children:[(0,P.jsx)(jt,{item:e}),(0,P.jsx)(`button`,{className:`sf-btn sf-btn--icon`,onClick:()=>Se(t),style:{position:`absolute`,top:8,right:8},type:`button`,"aria-label":`Remove link`,children:`✕`})]},`${e.kind}:${e.url}:${t}`))})]}),(0,P.jsxs)(`div`,{className:`sf-reply-row`,children:[(0,P.jsx)(`label`,{className:`sf-label`,children:`Author`}),(0,P.jsx)(`input`,{className:`sf-input`,type:`text`,value:x,onChange:e=>S(e.target.value),placeholder:`@you`,"aria-describedby":H?`username-claim-status`:void 0}),H?(0,P.jsx)(`div`,{id:`username-claim-status`,className:`sf-sub`,role:`status`,"aria-live":`polite`,children:H}):null]}),z?(0,P.jsxs)(`div`,{className:`sf-reply-row`,children:[(0,P.jsx)(`label`,{className:`sf-label`,children:`Claim glyph`}),(0,P.jsx)(`input`,{className:`sf-input`,type:`text`,value:C,onChange:e=>w(e.target.value),placeholder:`Paste claim glyph hash or Memory Stream link`})]}):null,(0,P.jsxs)(`div`,{className:`sf-reply-row`,children:[(0,P.jsx)(`label`,{className:`sf-label`,children:`Memory`}),(0,P.jsx)(`textarea`,{className:`sf-textarea`,rows:3,value:ee,onChange:e=>b(e.target.value),placeholder:`What do you want this moment to remember?`})]}),(0,P.jsxs)(`div`,{className:`sf-reply-actions`,children:[(0,P.jsx)(`button`,{className:`sf-btn`,onClick:()=>void Ce(),disabled:ue,type:`button`,children:ue?`Sealing…`:`Exhale Reply`}),n&&(0,P.jsx)(`button`,{className:`sf-btn sf-btn--ghost`,onClick:n,type:`button`,children:`Use a different ΦKey`})]}),fe&&(0,P.jsxs)(`div`,{className:`sf-reply-result`,children:[(0,P.jsx)(`label`,{className:`sf-label`,children:`Share this link`}),(0,P.jsx)(`input`,{className:`sf-input`,readOnly:!0,value:fe,onFocus:e=>e.currentTarget.select()}),(0,P.jsxs)(`div`,{className:`sf-reply-actions`,children:[(0,P.jsx)(`a`,{className:`sf-link`,href:fe,target:`_blank`,rel:`noreferrer`,children:`Open →`}),(0,P.jsx)(`button`,{className:`sf-btn`,type:`button`,onClick:async()=>{try{await navigator.clipboard.writeText(fe),i.push(`success`,`Link remembered.`),pe(!0),window.setTimeout(()=>pe(!1),1200)}catch{i.push(`warn`,`Copy failed.`)}},children:I?`Remembered`:`Remember`})]})]})]})}var nn=e(n(),1),rn=w/1e3,an=1000000n,on=11000000n,sn=(C+18n)/36n;function cn(e){return e<0?0:e>1?1:e}function ln(e){if(!e)return rn;let t=window.getComputedStyle(e).getPropertyValue(`--pulse-dur`).trim();if(!t)return rn;let n=Number.parseFloat(t);if(!Number.isFinite(n)||n<=0)return rn;let r=t.toLowerCase();return r.endsWith(`ms`)?n/1e3:r.endsWith(`s`)?n:n>1e3?n/1e3:n}function un(e){return e>0&&e<360?`nano`:e>0&&e<520?`tiny`:e>0&&e<760?`tight`:`wide`}function dn(e){switch(e){case`nano`:return .84;case`tiny`:return .9;case`tight`:return .95;default:return 1}}function fn(e){return e===`nano`?`stack`:`row`}function pn(e){let[t,n]=M.useState(0);return M.useLayoutEffect(()=>{let t=e.current;if(!t)return;let r=()=>{n(Math.round(t.getBoundingClientRect().width))};if(r(),typeof ResizeObserver<`u`){let e=new ResizeObserver(()=>r());return e.observe(t),()=>e.disconnect()}let i=()=>r();return window.addEventListener(`resize`,i,{passive:!0}),()=>window.removeEventListener(`resize`,i)},[e]),t}var mn=[`Ignite`,`Integrate`,`Harmonize`,`Reflekt`,`Purifikation`,`Dream`];function hn(e){let t=Number.isFinite(e)?Math.floor(e):0;return mn[Math.max(0,Math.min(5,Math.floor(t/6)))]}var gn=(e,t)=>{let n=e%t;return n>=0n?n:n+t},_n=(e,t)=>{if(t===0n)throw Error(`Division by zero`);let n=e/t;return e%t===0n||e>=0n?n:n-1n},vn=e=>{let t=BigInt(2**53-1),n=BigInt(-(2**53-1));return e>t?2**53-1:e<n?-(2**53-1):Number(e)},yn=e=>e<0n?-e:e,bn=BigInt(T),xn=500000000000n;function Sn(e){return e>=100000000000000n?y(e/1000n):yn(e-bn)<=xn?y(e):e}function Cn(e){return vn(_n(e,an))}function wn(e){let t=gn(e,C),n=_n(t,sn),r=Math.max(0,Math.min(35,vn(n))),i=t-BigInt(r)*sn;return{beat:r,step:Math.max(0,Math.min(43,vn(i/on)))}}function Tn(e){let t=vn(gn(_n(e,C),6n));return[`Solhara`,`Aquaris`,`Flamora`,`Verdari`,`Sonari`,`Kaelith`][Math.max(0,Math.min(5,t))]??`Solhara`}function En(e){let t=_n(e,C),n=_n(t,BigInt(42)),r=_n(t,BigInt(336));return{day:vn(gn(t,BigInt(42)))+1,month:vn(gn(n,BigInt(8)))+1,year:vn(r)}}function Dn(e){let t=BigInt(2**53-1),n=BigInt(-(2**53-1));if(e>t||e<n)return T;let r=Number(e);if(!Number.isFinite(r))return T;let i=T+r/1e6*w;return Number.isFinite(i)?i:T}function On(e){let t=_n(e,an)+1n;return t>BigInt(2**53-1)?T:T+Number(t)*w}var kn=`000000`;function An(e){if(e<=0)return kn;if(e>=999999)return`999999`;let t=String(e);return t.length>=6?t:kn.slice(0,6-t.length)+t}function jn(e){let t=Number.isFinite(e)?Math.max(0,e):0,n=Math.floor(t*1e3),r=Math.floor(n/1e6);return{text:`${r}.${An(n-r*1e6)}`,secs:n/1e6}}function Mn(e){let[t,n]=M.useState(()=>typeof window>`u`?0n:Sn(_())),r=M.useRef(_n(t,an));return M.useEffect(()=>{if(!e)return;let t=()=>{let e=Sn(_()),t=_n(e,an);t!==r.current&&(r.current=t,n(e))};t();let i=window.setInterval(t,125),a=()=>t();return document.addEventListener(`visibilitychange`,a),window.addEventListener(`pageshow`,a),window.addEventListener(`focus`,a),()=>{window.clearInterval(i),document.removeEventListener(`visibilitychange`,a),window.removeEventListener(`pageshow`,a),window.removeEventListener(`focus`,a)}},[e]),t}function Nn(e){let{active:t,rootRef:n,numRef:r,pulseDurSec:i,dialOpen:a,onWrap:o}=e,[s,c]=M.useState(()=>({secsLeft:t?rn:null,progress:0})),l=M.useRef(null),u=M.useRef(null),d=M.useRef(null),f=M.useRef(T),p=M.useRef(0),m=M.useRef(T),h=M.useRef(-1),g=M.useRef(0),v=M.useRef(`—`),y=M.useRef(-1),ee=()=>typeof performance<`u`?performance.now():0,b=M.useCallback(()=>{let e=Sn(_());f.current=Dn(e),p.current=ee(),m.current=On(e)},[]);return M.useEffect(()=>{if(l.current!==null&&cancelAnimationFrame(l.current),u.current!==null&&window.clearInterval(u.current),d.current!==null&&window.clearInterval(d.current),l.current=null,u.current=null,d.current=null,!t){c({secsLeft:null,progress:0});return}b();let e=a?100:250,s=t=>{let a=ee();if(h.current>=0&&a-h.current<8)return;h.current=a;let s=f.current+(a-p.current),l=!1;if(s>=m.current){let e=Math.floor((s-m.current)/w)+1;m.current+=e*w,l=!0}let{text:u,secs:d}=jn(Math.max(0,m.current-s)),_=cn(1-d/Math.max(1e-6,i)),x=n.current;x&&_!==y.current&&(y.current=_,x.style.setProperty(`--kai-progress`,String(_)));let S=r.current;S&&u!==v.current&&(v.current=u,S.textContent=u),(t||a-g.current>=e)&&(g.current=a,c({secsLeft:d,progress:_})),l&&(b(),o&&o())};s(!0);let _=()=>{s(!1),l.current=requestAnimationFrame(_)};l.current=requestAnimationFrame(_),u.current=window.setInterval(()=>s(!1),33),d.current=window.setInterval(()=>{b(),s(!0)},250);let x=()=>{b(),s(!0)};return document.addEventListener(`visibilitychange`,x),window.addEventListener(`focus`,x),window.addEventListener(`pageshow`,x),()=>{document.removeEventListener(`visibilitychange`,x),window.removeEventListener(`focus`,x),window.removeEventListener(`pageshow`,x),l.current!==null&&cancelAnimationFrame(l.current),u.current!==null&&window.clearInterval(u.current),d.current!==null&&window.clearInterval(d.current),l.current=null,u.current=null,d.current=null}},[t,a,i,o,b,n,r]),s}var Pn=[`Root`,`Sacral`,`Solar Plexus`,`Heart`,`Throat`,`Third Eye`,`Crown`];function Fn(e){return e===`Crown`?`Krown`:e}function In(e){let t=Number.isFinite(e)?Math.floor(e):1;return Pn[Math.max(0,Math.min(6,Math.floor((Math.max(1,t)-1)/6)))]??`Root`}function Ln(e,t){let n=e%t;return n<0?n+t:n}function Rn(e){let t=Number.isFinite(e)?Math.floor(e):1;return Pn[Ln(Math.max(1,t)-1,7)]??`Root`}var zn={solhara:`Root`,aquaris:`Sacral`,flamora:`Solar Plexus`,verdari:`Heart`,sonari:`Throat`,kaelith:`Crown`,caelith:`Crown`};function Bn(e,t){if(typeof e==`string`){let t=zn[e.trim().toLowerCase().replace(/[^a-z]/g,``)];if(t)return t}if(typeof e==`number`&&Number.isFinite(e)){let t=zn[[`solhara`,`aquaris`,`flamora`,`verdari`,`sonari`,`kaelith`][Ln(Math.floor(e),6)]];if(t)return t}return In(t)}var Vn=[`Aethon`,`Virelai`,`Solari`,`Amarin`,`Kaelus`,`Umbriel`,`Noktura`,`Liora`];function Hn(e){let t=Number.isFinite(e)?Math.floor(e):1;return Vn[Math.max(1,Math.min(8,t))-1]??`Month ${Math.max(1,t)}`}var Un={Ignite:`Root`,Integrate:`Sacral`,Harmonize:`Solar Plexus`,Reflekt:`Heart`,Purifikation:`Throat`,Dream:`Third Eye`},Wn=a;function Gn(){let e=M.useRef(null),t=M.useRef(null),n=Mn(!0),r=M.useMemo(()=>Cn(n),[n]),{beat:i,step:a}=M.useMemo(()=>wn(n),[n]),o=M.useMemo(()=>En(n),[n]),s=M.useMemo(()=>Tn(n),[n]),c=`${i}:${I(a)}`,l=hn(i),u=Un[l]??`Heart`,d=un(pn(e)),f=fn(d),p=d===`wide`||d===`tight`,[m,h]=M.useState(rn);M.useEffect(()=>{h(ln(e.current))},[r]);let[g,_]=M.useState(!1),v=M.useCallback(()=>_(!0),[]),y=M.useCallback(()=>_(!1),[]),[ee,b]=M.useState(!1),x=M.useRef(null),S=M.useCallback(()=>{b(!0),x.current!==null&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{b(!1),x.current=null},180)},[]);M.useEffect(()=>()=>{x.current!==null&&window.clearTimeout(x.current),x.current=null},[]);let{secsLeft:C,progress:w}=Nn({active:!0,rootRef:e,numRef:t,pulseDurSec:m,dialOpen:g,onWrap:S}),te=M.useCallback(e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),_(!0))},[]);M.useEffect(()=>{if(!g||typeof document>`u`)return;let e=document.documentElement.style.overflow;document.documentElement.style.overflow=`hidden`;let t=e=>{e.key===`Escape`&&y()};return window.addEventListener(`keydown`,t),()=>{document.documentElement.style.overflow=e,window.removeEventListener(`keydown`,t)}},[g,y]);let T=M.useMemo(()=>Bn(s,o.day),[s,o.day]),E=M.useMemo(()=>Rn(o.month),[o.month]),D=M.useMemo(()=>Hn(o.month),[o.month]),ne=`D${o.day}/M${o.month}/Y${o.year}`,O=Fn(T),k=Fn(E),A=M.useMemo(()=>({"--kai-ui-scale":dn(d)}),[d]),re=1584,ie=Math.max(0,Math.min(re-1,i*44+a))/re*100,j=w*100,ae=String(Math.round(i/36*360)),oe=C===null?`—`:C.toFixed(6),se=(0,P.jsxs)(`div`,{className:`kai-status__countdown`,"aria-label":`Next pulse`,children:[(0,P.jsx)(`span`,{className:`kai-status__nLabel`,children:`NEXT`}),(0,P.jsxs)(`span`,{className:`kai-status__nVal`,title:oe,"aria-label":C===null?`Next pulse in — seconds`:`Next pulse in ${oe} seconds`,children:[(0,P.jsx)(`span`,{ref:t,className:`kai-status__nNum`,children:C===null?`—`:C.toFixed(6)}),` `,(0,P.jsx)(`span`,{className:`kai-status__nUnit`,children:`s`})]})]}),ce=(0,P.jsxs)(`span`,{className:`kai-pill kai-pill--pulse`,title:`Pulse ${r}`,"aria-label":`Pulse ${r}`,"data-chakra":`Pulse`,children:[`☤KAI: `,(0,P.jsx)(`strong`,{className:`kai-pill__num`,children:r})]}),le=(0,P.jsxs)(`span`,{className:`kai-pill kai-pill--dmy`,title:ne,"aria-label":`Date ${ne}`,children:[(0,P.jsxs)(`span`,{className:`kai-dmy__seg kai-dmy__seg--day`,"data-chakra":T,children:[`D`,(0,P.jsx)(`span`,{className:`kai-dmy__num`,children:o.day})]}),(0,P.jsx)(`span`,{className:`kai-dmy__sep`,children:`/`}),(0,P.jsxs)(`span`,{className:`kai-dmy__seg kai-dmy__seg--month`,"data-chakra":E,children:[`M`,(0,P.jsx)(`span`,{className:`kai-dmy__num`,children:o.month})]}),(0,P.jsx)(`span`,{className:`kai-dmy__sep`,children:`/`}),(0,P.jsxs)(`span`,{className:`kai-dmy__seg kai-dmy__seg--year`,"data-chakra":`Year`,children:[`Y`,(0,P.jsx)(`span`,{className:`kai-dmy__num`,children:o.year})]})]}),ue=(0,P.jsx)(`span`,{className:`kai-pill kai-pill--day`,title:s,"aria-label":`Day ${s}`,"data-chakra":T,children:s}),de=(0,P.jsx)(`span`,{className:`kai-pill kai-pill--dayChakra`,title:`Day chakra ${O}`,"aria-label":`Day chakra ${O}`,"data-chakra":T,children:O}),N=(0,P.jsx)(`span`,{className:`kai-pill kai-pill--monthName`,title:D,"aria-label":`Month ${D}`,"data-chakra":E,children:D}),fe=(0,P.jsx)(`span`,{className:`kai-pill kai-pill--monthChakra`,title:`Month chakra ${k}`,"aria-label":`Month chakra ${k}`,"data-chakra":E,children:k}),F=(0,P.jsx)(`span`,{className:`kai-pill kai-pill--ark`,title:l,"aria-label":`Ark ${l}`,"data-chakra":u,children:l}),pe=g&&typeof document<`u`?(0,nn.createPortal)((0,P.jsxs)(`div`,{className:`kk-pop`,role:`dialog`,"aria-modal":`true`,"aria-label":`Kai-Klok`,children:[(0,P.jsx)(`button`,{type:`button`,className:`kk-pop__backdrop`,"aria-label":`Close Kai-Klok`,onClick:y}),(0,P.jsxs)(`div`,{className:`kk-pop__panel`,role:`document`,children:[(0,P.jsxs)(`div`,{className:`kk-pop__head`,children:[(0,P.jsx)(`div`,{className:`kk-pop__title`,children:`Kai-Klok`}),(0,P.jsx)(`button`,{type:`button`,className:`kk-pop__close`,onClick:y,"aria-label":`Close`,children:`✕`})]}),(0,P.jsxs)(`div`,{className:`kk-pop__meta`,"aria-label":`Kai summary`,children:[(0,P.jsx)(`span`,{className:`kk-pop__pill`,children:c}),(0,P.jsx)(`span`,{className:`kk-pop__pill`,children:ne}),(0,P.jsx)(`span`,{className:`kk-pop__pill`,children:D}),(0,P.jsx)(`span`,{className:`kk-pop__pill`,children:l})]}),(0,P.jsx)(`div`,{className:`kk-pop__dial`,"aria-label":`Kai-Klok dial`,children:(0,P.jsx)(`div`,{className:`klock-stage`,"data-klock-stage":`1`,children:(0,P.jsx)(`div`,{className:`klock-stage__inner`,children:(0,P.jsx)(Wn,{hue:ae,pulse:r,harmonicDayPercent:ie,microCyclePercent:j,dayLabel:s,monthLabel:D,monthDay:o.day,kaiPulseEternal:r,glowPulse:!0,pulseIntervalSec:m,rimFlash:ee,solarSpiralStepString:`${I(i)}:${I(a)}`,eternalBeatIndex:i,eternalStepIndex:a})})})}),(0,P.jsx)(`div`,{className:`kk-pop__foot`,children:(0,P.jsx)(`span`,{className:`kk-pop__hint`,children:`Tap the Klok for more details or press x to return.`})})]})]}),document.body):null;return(0,P.jsxs)(P.Fragment,{children:[(0,P.jsxs)(`div`,{ref:e,className:`kai-feed-status kai-feed-status--slim${ee?` kai-feed-status--flash`:``}`,onClick:v,onKeyDown:te,tabIndex:0,role:`button`,"aria-haspopup":`dialog`,"aria-expanded":g,"aria-label":`Kai status (open Kai-Klok)`,"data-layout":d,"data-bottom":f,"data-kai-bsi":c,"data-kai-ark":l,"data-kai-dmy":ne,"data-day-chakra":T,"data-month-chakra":E,"data-ark-chakra":u,"data-day-num":o.day,"data-month-num":o.month,"data-year-num":o.year,style:A,children:[(0,P.jsxs)(`div`,{className:`kai-status__top`,"aria-label":`Kai timeline (day row)`,children:[(0,P.jsxs)(`span`,{className:`kai-status__bsiWrap`,"aria-label":`Beat step ${c}`,children:[(0,P.jsx)(`span`,{className:`kai-status__kLabel`,"aria-hidden":`true`,children:`KAIROS`}),(0,P.jsx)(`span`,{className:`kai-status__bsi`,title:c,children:c})]}),le,ue,de,p?ce:null]}),(0,P.jsxs)(`div`,{className:`kai-status__mid`,"aria-label":`Kai timeline (month/ark row)`,children:[N,fe,F]}),(0,P.jsxs)(`div`,{className:`kai-status__bottom`,"aria-label":`Next pulse row`,children:[p?null:ce,se]}),(0,P.jsxs)(`div`,{className:`kai-feed-status__bar`,"aria-hidden":`true`,children:[(0,P.jsx)(`div`,{className:`kai-feed-status__barFill`}),(0,P.jsx)(`div`,{className:`kai-feed-status__barSpark`})]})]}),pe]})}function Kn(e){return typeof e==`object`&&!!e}function G(e){return typeof e==`number`&&Number.isFinite(e)}function K(e){return typeof e==`string`}function qn(e){if(!Array.isArray(e))return!1;for(let t of e)if(!K(t))return!1;return!0}function q(e){let t=e.trim();return t=t.replace(/[)\].,;:!?]+$/g,``),t=t.replace(/^[([{"'`]+/g,``),t.trim()}function Jn(){let e=globalThis.location?.origin;return typeof e==`string`&&e.length>0?e:`https://phi.network`}function Yn(e){let t=q(e);try{return new URL(t)}catch{}try{return new URL(t,Jn())}catch{return null}}function Xn(e){let t=q(e);if(/%[0-9A-Fa-f]{2}/.test(t))try{t=decodeURIComponent(t)}catch(e){let t=e instanceof Error?e.message:`decodeURIComponent failed`;throw Error(t)}return t.includes(` `)&&(t=t.replaceAll(` `,`+`)),/[+/=]/.test(t)&&(t=t.replaceAll(`+`,`-`).replaceAll(`/`,`_`).replace(/=+$/g,``)),q(t)}function Zn(e){let t=e.startsWith(`j:`)||e.startsWith(`c:`)?e.slice(2):e;return/^[A-Za-z0-9_-]{16,}$/.test(t)}function Qn(e){let t=e.replace(/-/g,`+`).replace(/_/g,`/`),n=t.length%4;return n===2?t+=`==`:n===3&&(t+=`=`),t}function $n(e){let t=q(e),n=Qn(t.startsWith(`j:`)||t.startsWith(`c:`)?t.slice(2):t),r=globalThis;if(typeof r.atob!=`function`)throw Error(`Base64 decode failure: atob() unavailable`);if(r.TextDecoder===void 0)throw Error(`Base64 decode failure: TextDecoder unavailable`);try{let e=r.atob(n),t=new Uint8Array(e.length);for(let n=0;n<e.length;n+=1)t[n]=e.charCodeAt(n);return new TextDecoder().decode(t)}catch(e){let t=e instanceof Error?e.message:`Base64 decode failure`;throw Error(t)}}function er(e){try{return JSON.parse(e)}catch(e){let t=e instanceof Error?e.message:`Invalid JSON`;throw Error(t)}}function tr(e){{let t=e.match(/\/s\/([^/?#]+)/);if(t?.[1])return t[1]}{let t=e.match(/\/p(?:~|%7[Ee])\/?([^/?#]+)/);if(t?.[1])return t[1]}{let t=e.match(/\/(?:stream|feed)\/p\/([^/?#]+)/);if(t?.[1])return t[1]}{let t=e.match(/\/p\/([^/?#]+)/);if(t?.[1])return t[1]}return null}function nr(e){let t=q(e),n=t.startsWith(`#`)?t.slice(1):t;{let e=n.match(/\/?s\/([^/?#]+)/);if(e?.[1])return e[1]}return n.match(/\/?p(?:~|%7[Ee])\/?([^/?#]+)/)?.[1]??null}function rr(e,t,n){for(let r of n){let n=t.get(r);if(n&&n.trim().length)return n;let i=e.get(r);if(i&&i.trim().length)return i}return null}function ir(e,t=0){let n=[],r=e=>{if(!e)return;let t=Xn(e);Zn(t)&&(n.includes(t)||n.push(t))},i=q(e);Zn(i)&&r(i);let a=Yn(i);if(!a)return n;r(nr(a.hash));let o=a.hash&&a.hash.startsWith(`#`)?a.hash.slice(1):a.hash,s=new URLSearchParams(o),c=a.searchParams,l=[`p`,`t`,`token`,`capsule`];r(rr(c,s,l));for(let e of l)r(s.get(e)),r(c.get(e));if(r(tr(a.pathname)),t<1){let e=[...c.getAll(`add`),...s.getAll(`add`)];for(let n of e){let e=q(n);if(!e)continue;let i=e;if(/%[0-9A-Fa-f]{2}/.test(i))try{i=decodeURIComponent(i)}catch(e){let t=e instanceof Error?e.message:`decodeURIComponent(add) failed`;throw Error(t)}for(let e of ir(i,t+1))r(e)}}return n}function ar(e){let t=q(e);if(t.startsWith(`j:`)||t.startsWith(`c:`))return{rootRef:t,addRefs:[]};let n=Yn(t);if(!n)return{rootRef:null,addRefs:[]};let r=n.hash&&n.hash.startsWith(`#`)?n.hash.slice(1):n.hash,i=new URLSearchParams(r),a=n.searchParams,o=i.get(`root`)??a.get(`root`),s=i.get(`v`)??a.get(`v`),c=[...i.getAll(`add`),...a.getAll(`add`)].map(e=>q(e)).filter(e=>e.length>0),l=o?q(o):null;return{v:s?q(s):void 0,rootRef:l,addRefs:c}}function or(e){if(Kn(e)&&Kn(e.capsule))return e.capsule;if(Kn(e)&&Kn(e.data)){let t=e.data;if(Kn(t)&&Kn(t.capsule))return t.capsule;if(Kn(t)&&(`post`in t||`message`in t||`share`in t||`reaction`in t))return t}return Kn(e)&&(`post`in e||`message`in e||`share`in e||`reaction`in e)||Kn(e)&&(`pulse`in e||`u`in e||`kind`in e||`userId`in e||`userPhiKey`in e)?e:null}function sr(e){let t=G(e.pulse)?e.pulse:G(e.u)?e.u:void 0,n=G(e.beat)?e.beat:G(e.b)?e.b:void 0,r=G(e.stepIndex)?e.stepIndex:G(e.s)?e.s:void 0,i=K(e.chakraDay)||G(e.chakraDay)?e.chakraDay:K(e.c)||G(e.c)?e.c:void 0;return{...e,pulse:t,beat:n,stepIndex:r,chakraDay:i}}function cr(e){return er($n(q(e)))}function lr(e,t){let n=or(e);if(!n)throw Error(`Invalid payload (missing capsule)`);let r=sr(n),i=Kn(e)?e:null,a=i&&Kn(i.data)?i.data:null,o=Yn(t),s=(()=>{let e=i?.path;if(qn(e))return e;let t=a?.path;return qn(t)?t:o?o.pathname.split(`/`).filter(Boolean):[]})();return{url:t,appId:(i&&K(i.appId)?i.appId:void 0)??(a&&K(a.appId)?a.appId:void 0)??(s[0]===`s`&&s.length>=2?s[1]:void 0),userId:(i&&K(i.userId)?i.userId:void 0)??(a&&K(a.userId)?a.userId:void 0)??(K(r.userId)?r.userId:K(r.userPhiKey)?r.userPhiKey:void 0),kind:(i&&K(i.kind)?i.kind:void 0)??(a&&K(a.kind)?a.kind:void 0)??(K(r.kind)?r.kind:r.post?`post`:r.message?`message`:r.share?`share`:r.reaction?`reaction`:void 0),pulse:(i&&G(i.pulse)?i.pulse:void 0)??(a&&G(a.pulse)?a.pulse:void 0)??(G(r.pulse)?r.pulse:void 0),beat:(i&&G(i.beat)?i.beat:void 0)??(a&&G(a.beat)?a.beat:void 0)??(G(r.beat)?r.beat:void 0),stepIndex:(i&&G(i.stepIndex)?i.stepIndex:void 0)??(a&&G(a.stepIndex)?a.stepIndex:void 0)??(G(r.stepIndex)?r.stepIndex:void 0),chakraDay:(i&&(K(i.chakraDay)||G(i.chakraDay))?i.chakraDay:void 0)??(a&&(K(a.chakraDay)||G(a.chakraDay))?a.chakraDay:void 0)??(K(r.chakraDay)||G(r.chakraDay)?r.chakraDay:void 0),capsule:r,path:s}}function ur(e){try{let t=q(e),n=ar(t);if(n.rootRef){let t=lr(cr(n.rootRef),e),r=[];for(let e of n.addRefs)if(!(!e.startsWith(`j:`)&&!e.startsWith(`c:`)))try{let t=cr(e);r.push(lr(t,e))}catch{}return{ok:!0,data:{...t,url:e,stream:{v:n.v,rootRef:n.rootRef,addRefs:n.addRefs,addData:r}}}}let r=ir(t)[0]??null;if(!r)return{ok:!1,error:`No capsule token found (expected /s/<sigil>, /p~<token>, /stream/p/<token>, ?p=, #t=, #/p~<token>, a raw token, or a Memory Stream with #root=j:<payload>).`};let i=er($n(r));if(!Kn(i))return{ok:!1,error:`Payload is not an object`};let a=sr(i),o=Yn(t),s=o?o.pathname.split(`/`).filter(Boolean):[],c=s[0]===`s`&&s.length>=2?s[1]:void 0,l=K(a.userId)?a.userId:K(a.userPhiKey)?a.userPhiKey:void 0,u=K(a.kind)?a.kind:a.post?`post`:a.message?`message`:a.share?`share`:a.reaction?`reaction`:void 0,d=s.length>=8?s[6]:void 0;return{ok:!0,data:{url:e,appId:c,userId:l,kind:u??d,pulse:a.pulse,beat:a.beat,stepIndex:a.stepIndex,chakraDay:a.chakraDay,capsule:a,path:s}}}catch(e){return{ok:!1,error:e instanceof Error?e.message:`Decode error`}}}const dr=`/stream`,fr=(()=>{if(typeof window>`u`)return dr;let e=window.location?.origin;return!e||e===`null`?dr:`${e.replace(/\/+$/g,``)}${dr}`})();(()=>{if(typeof window>`u`)return`/s`;let e=window.location?.origin;return!e||e===`null`?`/s`:`${e.replace(/\/+$/g,``)}/s`})();function pr(e){let t=String(e??``).trim();return t=t.replace(/[)\].,;:!?]+$/g,``),t=t.replace(/^[([{"'`]+/g,``),t.trim()}function mr(e){let t=pr(e);if(/%[0-9A-Fa-f]{2}/.test(t))try{t=decodeURIComponent(t)}catch{}return t.includes(` `)&&(t=t.replaceAll(` `,`+`)),/[+/=]/.test(t)&&(t=t.replaceAll(`+`,`-`).replaceAll(`/`,`_`).replace(/=+$/g,``)),pr(t)}function hr(e){let t=mr(e);return`${fr||`/stream`}#t=${encodeURIComponent(t)}`}function gr(e){return hr(e)}var _r=(e,t=8,n=4)=>e.length<=t+n?e:`${e.slice(0,t)}…${e.slice(-n)}`,vr=e=>{if(e)try{return new URL(e).host}catch{return}},yr=e=>typeof e==`string`&&e.trim().length>0,br=e=>String(e??``).toUpperCase(),J=e=>!!e&&typeof e==`object`&&!Array.isArray(e);function xr(e){let t=String(e??``),n=t.length;return{lines:t.length?t.split(/\r\n|\r|\n/).length:0,chars:n}}function Sr(e,t){let{lines:n,chars:r}=xr(e);return{shouldCollapse:n>(t===`code`?18:10)||r>(t===`code`?1400:700),lines:n,chars:r,maxHeightPx:t===`code`?320:240}}function Cr(e){return e instanceof HTMLElement?!!e.closest(`a,button,input,textarea,select,summary,[role="button"],[role="link"],[data-no-open="true"]`):!1}var wr=`/stream`,Tr=`/s`,Er=`2`,Dr=12e4,Y=`j:`,Or=`s:`;function X(e){let t=e.trim();return t=t.replace(/[)\].,;:!?]+$/g,``),t=t.replace(/^[([{"'`]+/g,``),t.trim()}function kr(e){let t=X(e);if(/%[0-9A-Fa-f]{2}/.test(t))try{t=decodeURIComponent(t)}catch{}return t.includes(` `)&&(t=t.replaceAll(` `,`+`)),/[+/=]/.test(t)&&(t=t.replaceAll(`+`,`-`).replaceAll(`/`,`_`).replace(/=+$/g,``)),X(t)}function Ar(e){return/^[A-Za-z0-9_-]{16,}$/.test(e)}function jr(){let e=typeof fr==`string`?fr.trim():``;if(e)return e.replace(/\/+$/g,``).replace(/\/stream\/?$/g,``);if(typeof window>`u`)return``;let t=window.location?.origin;return t&&t!==`null`?t.replace(/\/+$/g,``):``}function Mr(){return jr()||`https://x.invalid`}function Nr(){let e=jr();return e?`${e}${wr}`:wr}function Pr(){let e=jr();return e?`${e}${Tr}`:Tr}function Fr(e){let t=e.trim();try{return new URL(t)}catch{try{return new URL(t,Mr())}catch{return null}}}function Ir(e){let t=X(e),n=Fr(t),r=n?n.pathname:t;return/^\/s(?:\/|$)/.test(r)}function Lr(e){{let t=e.match(/\/s\/([^/?#]+)/);if(t?.[1])return t[1]}{let t=e.match(/\/p(?:\u007e|%7[Ee])\/?([^/?#]+)/);if(t?.[1])return t[1]}{let t=e.match(/\/(?:stream|feed)\/p\/([^/?#]+)/);if(t?.[1])return t[1]}{let t=e.match(/\/p\/([^/?#]+)/);if(t?.[1])return t[1]}return null}function Rr(e,t=0){let n=[],r=e=>{if(!e)return;let t=kr(e);t&&Ar(t)&&(n.includes(t)||n.push(t))},i=X(e);Ar(i)&&r(i);let a=Fr(i);if(!a)return n;let o=a.hash&&a.hash.startsWith(`#`)?a.hash.slice(1):``,s=new URLSearchParams(o),c=a.searchParams;for(let e of[`t`,`p`,`token`,`capsule`])r(s.get(e)),r(c.get(e));let l=s.get(`v`),u=c.get(`v`);for(let e of[l,u]){if(!e)continue;let t=kr(e);/^\d{1,4}$/.test(t)||t!==Er&&r(t)}if(r(Lr(a.pathname)),t<1){let e=[...c.getAll(`add`),...s.getAll(`add`)];for(let n of e){let e=X(n);if(e){if(/%[0-9A-Fa-f]{2}/.test(e))try{e=decodeURIComponent(e)}catch{}for(let n of Rr(e,t+1))r(n)}}}return n}function zr(e){let t=Nr(),n=kr(e);return`${t}#t=${encodeURIComponent(n)}`}function Br(e){let t=Rr(X(e))[0];return t?zr(t):null}function Z(e){let t=X(e),n=Fr(t);if(n){let e=n.hash&&n.hash.startsWith(`#`)?n.hash.slice(1):``,t=new URLSearchParams(e),r=n.searchParams;if(t.get(`root`)||r.get(`root`)){let e=Nr(),n=new URL(e||wr,Mr()),i=new URLSearchParams;for(let[e,n]of t.entries())i.append(e,n);for(let[e,t]of r.entries())i.append(e,t);return n.hash=i.toString()?`#${i.toString()}`:``,n.search=``,n.toString()}}if(Ir(t))return t;let r=Rr(t)[0];return r?zr(r):t}function Vr(e){let t=Nr().replace(/\/stream\/?$/g,``),n=kr(e);return[n,`${t}/stream#t=${n}`,`${t}/stream?t=${n}`,`${t}/stream/t=${n}`,`${t}/p#t=${n}`,`${t}/p?t=${n}`,`${t}/stream/p/${n}`,`${t}/p#p=${n}`,`${t}/p?p=${n}`,`${t}/p#token=${n}`,`${t}/p?token=${n}`,`${t}/stream#v=${n}`,`${t}/stream?v=${n}`]}function Hr(e){let t=new Set,n=e=>{let n=e.trim();if(!n||t.has(n))return null;t.add(n);let r=ur(n);return r.ok?r:null},r=X(e),i=n(r);if(i)return{decoded:i,resolvedUrl:Z(r)};let a=Rr(r);for(let e of a)for(let t of Vr(e)){let r=n(t);if(r)return{decoded:r,resolvedUrl:zr(e)}}return{decoded:ur(r),resolvedUrl:Z(r)}}function Ur(e){if(!J(e))return null;let t=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==void 0,n=e=>t(e,`post`)||t(e,`message`)||t(e,`share`)||t(e,`reaction`),r=(e,n)=>{for(let r of[`post`,`message`,`share`,`reaction`])t(n,r)&&e[r]===void 0&&(e[r]=n[r])},i=e,a=J(i.data)?i.data:null,o=n(i),s=!!a&&n(a),c=J(i.capsule)?i.capsule:null,l=a&&J(a.capsule)?a.capsule:null,u=c??l;if(u&&(o||s)){let e={...u};return s&&a&&r(e,a),o&&r(e,i),e}return u||(o?i:s&&a?a:i)}function Wr(e){if(e===null)return null;if(typeof e==`number`)return Number.isFinite(e)?e:null;if(typeof e==`string`||typeof e==`boolean`)return e;if(typeof e==`bigint`)return e.toString();if(Array.isArray(e))return e.map(Wr);if(e&&typeof e==`object`){let t=e,n=Object.keys(t).sort((e,t)=>e.localeCompare(t)),r={};for(let e of n)r[e]=Wr(t[e]);return r}return null}function Gr(e){let t=``,n=32768;for(let r=0;r<e.length;r+=n){let i=e.subarray(r,r+n);t+=String.fromCharCode(...i)}return btoa(t)}function Kr(e){let t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}function qr(e){return Gr(new TextEncoder().encode(e)).replaceAll(`+`,`-`).replaceAll(`/`,`_`).replace(/=+$/g,``)}function Jr(e){let t=Kr(e.replaceAll(`-`,`+`).replaceAll(`_`,`/`)+`===`.slice((e.length+3)%4));return new TextDecoder().decode(t)}function Yr(e){return`${Y}${qr(JSON.stringify(Wr(e)))}`}function Xr(e){let t=X(e),n=t.startsWith(Y)?t.slice(2):t;if(!/^[A-Za-z0-9_-]{16,}$/.test(n))return null;try{let e=Jr(n);return JSON.parse(e)}catch{return null}}function Zr(e){let t=14695981039346656037n;for(let n=0;n<e.length;n++)t^=BigInt(e.charCodeAt(n)),t=t*1099511628211n&18446744073709551615n;return t.toString(16).padStart(16,`0`)}function Qr(e){if(!e.length)return Zr(`merkle:empty`);let t=e.map(e=>Zr(`leaf:${e}`));for(;t.length>1;){let e=[];for(let n=0;n<t.length;n+=2){let r=t[n],i=t[n+1]??r;e.push(Zr(`node:${r}${i}`))}t=e}return t[0]}function $r(e){if(e&&typeof e==`object`){let t=e,n=t.id;if(typeof n==`string`&&/^[0-9a-fA-F]{64}$/.test(n.trim()))return`cid:${n.trim().toLowerCase()}`;let r=t.contentId;if(typeof r==`string`&&/^[0-9a-fA-F]{64}$/.test(r.trim()))return`cid:${r.trim().toLowerCase()}`;let i=t.cid;if(typeof i==`string`&&/^[0-9a-fA-F]{64}$/.test(i.trim()))return`cid:${i.trim().toLowerCase()}`;let a=t.pulse;if(typeof a==`number`&&Number.isFinite(a)&&a>0)return`p:${Math.floor(a)}`;let o=t.kaiSignature;if(typeof o==`string`&&o.trim())return`ks:${o.trim()}`}return`h:${Zr(JSON.stringify(Wr(e)))}`}function ei(e){return`${Or}${qr(JSON.stringify(Wr(e)))}`}function ti(e){let t=X(e),n=t.startsWith(Or)?t.slice(2):t;if(!/^[A-Za-z0-9_-]{16,}$/.test(n))return null;try{let e=Jr(n),t=JSON.parse(e);if(!t||typeof t!=`object`)return null;let r=t,i=r.v,a=r.id,o=r.m,s=r.n,c=r.a,l=r.r;return typeof i!=`string`||typeof a!=`string`||typeof o!=`string`||typeof s!=`number`||typeof c!=`number`||typeof l!=`string`?null:{v:i,id:a,m:o,n:s,a:c,r:l}}catch{return null}}var ni=(e,t)=>{let n=e%t;return n>=0n?n:n+t},ri=(e,t)=>{if(t===0n)throw Error(`Division by zero`);let n=e/t;return e%t===0n||e>=0n?n:n-1n},ii=e=>{let t=BigInt(2**53-1),n=BigInt(-(2**53-1));return e>t?2**53-1:e<n?-(2**53-1):Number(e)};function ai(e){let t=ri(y(v(e)),C),n=ri(t,BigInt(42)),r=ri(t,BigInt(336));return{day:ii(ni(t,BigInt(42)))+1,month:ii(ni(n,BigInt(8)))+1,year:ii(r)}}function oi(e,t){if(typeof e==`string`){let t=e.trim();if(t===`Krown`)return`Crown`;if(t===`Root`||t===`Sacral`||t===`Solar Plexus`||t===`Heart`||t===`Throat`||t===`Third Eye`||t===`Crown`)return t}return t}function si(e){return[`Ignite`,`Integrate`,`Harmonize`,`Reflekt`,`Purify`,`Dream`][Math.max(0,Math.min(5,Math.floor(e/6)))]}var ci=e=>String(Math.max(0,Math.floor(e))).padStart(2,`0`);function li(e,t,n,r,i,a){let o=si(t),s=`${ci(t)}:${ci(n)}`;return{arc:o,label:s,line:`☤KAI:${e} • ${s} D${Math.max(1,Math.floor(r))}/M${Math.max(1,Math.floor(i))}/Y${Math.floor(a)}`}}function ui(e){let t=Math.max(0,Math.min(43,Math.floor(e)))/44;return t>=1?.999999999999:t}var di={Root:[255,88,88],Sacral:[255,146,88],"Solar Plexus":[255,215,128],Heart:[88,255,174],Throat:[42,197,255],"Third Eye":[164,126,255],Crown:[238,241,251],Krown:[238,241,251]};function fi(e){if(e&&typeof e==`object`&&`source`in e){let t=e.source;return typeof t==`string`?t:void 0}}function pi(e,t){if(e&&typeof e==`object`&&`kind`in e){let t=e.kind;if(typeof t==`string`&&t.trim().length>0)return t}return t}var mi=256;function hi(e){let t=Fr(X(e));if(!t)return[];let n=t.hash&&t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n),i=t.searchParams,a=[...r.getAll(`add`),...i.getAll(`add`)],o=[];for(let e of a){let t=X(e);if(!t)continue;if(/%[0-9A-Fa-f]{2}/.test(t))try{t=decodeURIComponent(t)}catch{}if(t.startsWith(Y)&&t.length>10){o.push(t);continue}let n=Xr(t);if(n&&Ur(n)){let e=X(t.startsWith(Y)?t.slice(2):t);o.push(`${Y}${e}`);continue}let r=Rr(t)[0];if(r){o.push(zr(r));continue}if(Ir(t)){o.push(t);continue}o.push(Z(t))}return o.slice(-mi)}function gi(e){let t=Fr(X(e));if(!t)return null;let n=t.hash&&t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n),i=t.searchParams,a=r.get(`root`)??i.get(`root`);if(!a)return null;if(a=X(a),/%[0-9A-Fa-f]{2}/.test(a))try{a=decodeURIComponent(a)}catch{}if(a.startsWith(Y))return a;let o=Xr(a);return o&&Ur(o)?`${Y}${X(a)}`:null}function _i(e){let t=Fr(X(e));if(!t)return null;let n=t.hash&&t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n),i=t.searchParams,a=r.get(`seg`)??i.get(`seg`);if(!a)return null;let o=X(a);if(/%[0-9A-Fa-f]{2}/.test(o))try{o=decodeURIComponent(o)}catch{}return ti(o)}function vi(e){let t=X(e);if(!t)return null;if(t.startsWith(Y)||Ir(t))return t;{let e=Fr(t);if(e){let n=e.hash&&e.hash.startsWith(`#`)?e.hash.slice(1):``,r=new URLSearchParams(n),i=e.searchParams;if(r.get(`root`)||i.get(`root`))return Z(t)}}let n=Rr(t)[0];return n?zr(n):null}function yi(e){if(typeof e==`string`)return vi(e);if(e&&typeof e==`object`){let t=e;if(typeof t.url==`string`)return vi(t.url);if(typeof t.href==`string`)return vi(t.href)}return null}function bi(e,t=0){if(!e||typeof e!=`object`||Array.isArray(e)||t>4)return null;let n=e,r=n.skip;if(Array.isArray(r)&&typeof r[1]==`string`){let e=vi(r[1]);if(e)return e}for(let e of`prevUrl.prevURL.prev.prevId.prev_id.previousUrl.previousURL.previous.previousId.previous_id.parentUrl.parentURL.parent.parentId.parent_id.replyToUrl.replyToURL.replyTo.replyToId.replyTo_id.inReplyToUrl.inReplyToURL.inReplyTo.inReplyToId.inReplyTo_id.refUrl.ref_url.ref`.split(`.`)){let t=yi(n[e]);if(t)return t}for(let e of[`capsule`,`data`,`payload`]){let r=bi(n[e],t+1);if(r)return r}return null}function xi(e){let t=Math.max(0,Math.floor(e));if(t<=2)return t;let n=1,r=2;for(;;){let e=n+r;if(e>t)return r;n=r,r=e}}function Si(e,t){let n=Nr(),r=new URL(n||wr,Mr()),i=[e,...t],a=Qr(i),o={v:Er,id:`seg:${a}:${i.length}`,m:a,n:i.length,a:t.length,r:_r(e,8,6)},s=new URLSearchParams;s.set(`v`,Er),s.set(`root`,e),s.set(`seg`,ei(o));for(let e of t)s.append(`add`,e);return r.hash=s.toString()?`#${s.toString()}`:``,r.search=``,{url:r.toString(),rootRef:e,adds:[...t],meta:o}}function Ci(e,t){let n=0,r=t.length;for(;n<r;){let i=Math.floor((n+r)/2);Si(e,t.slice(i)).url.length<=Dr?r=i:n=i+1}let i=t.length-n,a=xi(i),o=Math.max(0,Math.min(i,a>0?a:i)),s=t.length-o;return{keepFrom:s,kept:t.slice(s)}}function wi(e,t,n=0){if(n>64)return{primary:Si(e,[]),archives:[]};let r=Si(e,t);if(r.url.length<=Dr)return{primary:r,archives:[]};let{keepFrom:i,kept:a}=Ci(e,t),o=Si(e,a);if(o.url.length>Dr)return{primary:Si(e,[]),archives:[]};if(i<=0)return{primary:o,archives:[]};let s=t.slice(0,i),c=a[0];if(!c)return{primary:o,archives:[]};let l=wi(c,s,n+1);return{primary:o,archives:[l.primary,...l.archives]}}function Q(e){let t=[],n=new Set;for(let r of e){let e=String(r??``).trim();e&&(n.has(e)||(n.add(e),t.push(e)))}return t}function Ti(e){let t=0;for(let n of e)X(n).startsWith(Y)&&t++;return t}function Ei(e,t){let n=X(e);if(t)return`k:${$r(t)}`;if(n.startsWith(Y)){let e=Xr(n);return e?`k:${$r(e)}`:`k:${Zr(n)}`}let r=Rr(n)[0];return r?`t:${kr(r)}`:`u:${Z(n)}`}var Di=4096,Oi=new Map,ki=0,Ai=0,ji=!1,Mi=new Set;function Ni(){if(ji)return;ji=!0;let e=()=>{ji=!1,Ai++;for(let e of Mi)e()};typeof queueMicrotask==`function`?queueMicrotask(e):Promise.resolve().then(e)}function Pi(e){return Mi.add(e),()=>Mi.delete(e)}function Fi(){return Ai}function Ii(){return 0}function Li(e){let t=Oi.get(e.key);if(!(t&&t.prevKey===e.prevKey&&t.payloadRef===e.payloadRef&&t.fallbackRef===e.fallbackRef))for(Oi.has(e.key)&&Oi.delete(e.key),Oi.set(e.key,{...e,tick:++ki}),Ni();Oi.size>Di;){let e=Oi.keys().next().value;if(!e)break;Oi.delete(e),Ni()}}function Ri(e,t){let n=[],r=new Set,i=Oi.get(e)?.prevKey??null,a=0;for(;i&&a<t;){let e=i;if(r.has(e))break;r.add(e);let t=Oi.get(e);if(!t)break;n.push(t.payloadRef??t.fallbackRef),i=t.prevKey,a++}return n.reverse(),n}var zi=`™`,Bi=`Proof of Memory${zi}`,Vi=`Proof of Breath${zi}`,Hi=e=>typeof e==`string`&&e.trim().toLowerCase()===`manual`,Ui=e=>{if(yr(e))return Hi(e)?Bi:e};function Wi(e,t=0){if(t>5)return!1;if(Hi(e))return!0;if(Array.isArray(e)){for(let n of e)if(Wi(n,t+1))return!0;return!1}if(e&&typeof e==`object`){let n=e;for(let e of Object.keys(n))if(Wi(n[e],t+1))return!0}return!1}function Gi(e,t){if(!J(e))return;let n=e[t];return typeof n==`string`&&n.trim()?n.trim():void 0}function Ki(e,t){if(!J(e))return[];let n=e[t];if(!Array.isArray(n))return[];let r=[];for(let e of n)typeof e==`string`&&e.trim()&&r.push(e.trim());return r}function qi(e){if(!J(e))return{};let t=Gi(e,`caption`),n=e.body;if(J(n)){let e=Gi(n,`kind`),r=e===`text`||e===`md`||e===`code`||e===`html`?e:void 0;if(r===`text`)return{text:Gi(n,`text`)??t,kind:r};if(r===`md`)return{text:Gi(n,`md`)??t,kind:r};if(r===`code`)return{text:Gi(n,`code`)??t,kind:r};if(r===`html`)return{text:Gi(n,`html`)??t,kind:r}}return{text:t,kind:void 0}}function Ji(e){if(!J(e))return[];let t=e.attachments;if(!J(t))return[];let n=t.items;if(!Array.isArray(n))return[];let r=[];for(let e of n){if(!J(e))continue;let t=Gi(e,`url`);if(t){r.push({url:t});continue}let n=Gi(e,`href`);n&&r.push({url:n})}return r}function Yi(e,t){let n=e??t;if(!n)return{};let{text:r,kind:i}=qi(n),a=Ki(n,`tags`),o=Ji(n),s=typeof r==`string`&&r.trim().length>0,c=o.length>0,l=a.length>0;return!s&&!c&&!l?{}:{post:{title:void 0,text:s?r:void 0,tags:l?a:void 0,media:c?o.map(e=>({kind:`url`,url:e.url})):void 0},bodyKind:i}}function Xi(e){if(typeof document>`u`)return!1;try{let t=document.createElement(`textarea`);t.value=e,t.setAttribute(`readonly`,`true`),t.style.position=`fixed`,t.style.left=`-9999px`,t.style.top=`0`,document.body.appendChild(t);let n=document.activeElement instanceof HTMLElement?document.activeElement:null;t.focus(),t.select();let r=document.execCommand(`copy`);return document.body.removeChild(t),n&&n.focus(),r}catch{return!1}}function Zi(e){if(typeof window>`u`)return null;let t=window.navigator;return t!==void 0&&t.clipboard!==void 0&&typeof t.clipboard.writeText==`function`&&window.isSecureContext?t.clipboard.writeText(e):null}function Qi(e,t,n){if(Xi(e)){t();return}let r=Zi(e);if(r){t(),r.catch(e=>n(e));return}n()}var $i=`sigil:urls`,ea=`sigil:feed`,ta=`kai-sigil-registry`,na=`kai:sigils:v1`,ra=`kai-feed-registry`,ia=0,aa=!1,oa=new Set,sa=!1,ca=null,la=null;function ua(){if(aa)return;aa=!0;let e=()=>{aa=!1,ia++;for(let e of oa)e()};typeof queueMicrotask==`function`?queueMicrotask(e):Promise.resolve().then(e)}function da(e){return oa.add(e),()=>oa.delete(e)}function fa(){return ia}function pa(){return 0}function ma(e){let t=[];if(Array.isArray(e)){for(let n of e)typeof n==`string`&&n.trim()&&t.push(n.trim());return t}if(J(e)){let n=e.urls;if(Array.isArray(n)){for(let e of n)typeof e==`string`&&e.trim()&&t.push(e.trim());return t}let r=Object.keys(e).filter(e=>e.startsWith(`http`)||e.startsWith(`/`)||e.includes(`/stream`)||e.includes(`/s/`));if(r.length)return r;for(let n of Object.values(e))J(n)&&typeof n.url==`string`&&n.url.trim()&&t.push(n.url.trim());return t}return t}function ha(e){if(typeof window>`u`||window.localStorage===void 0)return[];let t=window.localStorage.getItem(e);if(!t)return[];try{return ma(JSON.parse(t))}catch{return[]}}function ga(e){let t=e.trim();if(!t)return``;try{return new URL(t,Mr()).toString()}catch{return t}}function _a(){let e=Q([...ha(ea),...ha($i),...ha(na)]),t=[];for(let n of e){let e=ga(n);e&&t.push(e)}return Q(t)}function va(e){let t=X(e);return t?t.startsWith(Y)?Si(t,[]).url:Br(t)??Z(t):``}function ya(e){let t=Q(hi(e))[0]??e;return Ei(t,(t.startsWith(Y)?Xr(t):null)??void 0)}function ba(e){let t=X(e);if(!t)return null;if(t.startsWith(Y))return Xr(t);let n=Hr(t);return n.decoded.ok?n.decoded.data:null}function xa(e,t){let n=X(e);if(!n)return e;let r=Q(hi(n));if(r.length>0)return r[0];let i=n,a=t===void 0?null:t;a||=ba(i);let o=new Set;for(let e=0;e<48;e++){let e=Ei(i,a??void 0);if(o.has(e))break;o.add(e);let t=a?bi(a):null;if(!t)return i;i=t,a=ba(i)}return i}function Sa(e,t){let n=xa(e,t);return Ei(n,(n.startsWith(Y)?Xr(n):ba(n))??void 0)}function Ca(e){let t=X(e);if(/^[0-9a-fA-F]{64}$/.test(t))try{return gr(t.toLowerCase())}catch{}return`${Pr()}/${encodeURIComponent(t)}`}function wa(e,t){if(!J(e))return null;for(let n of t){let t=e[n];if(typeof t==`string`&&t.trim())return t.trim()}return null}function Ta(e,t){let n=X(e);if(Ir(n))return n;let r=wa(t,[`sigilUrl`,`sigilURL`,`sigil_url`,`sigilHref`,`sigil_href`,`sUrl`,`s_url`,`s`])??null;if(r&&Ir(r))return Z(r);let i=wa(t,[`id`,`contentId`,`cid`,`hash`,`contentHash`])??null;if(i&&/^[0-9a-fA-F]{64}$/.test(i))return Ca(i);let a=J(t)?t.sigilId:void 0;if(typeof a==`string`&&a.trim())return Ca(a);let o=Rr(n)[0];return o?Ca(o):null}function Ea(e,t){let n=xa(e,t),r=ba(n),i=Ta(n,r?Ur(r):null);return i?Z(i):va(n)}function Da(e){let t=Fr(e);if(!t)return 0;let n=t.hash&&t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n),i=t.searchParams;return r.getAll(`add`).length+i.getAll(`add`).length}function Oa(e){let t=Da(e),n=e.length;return t*1e5+n}function ka(e){let t=Rr(e)[0];if(t)return`t:${kr(t)}`;let n=gi(e);if(n){let e=Xr(n);return e?`r:${$r(e)}`:`r:${Zr(n)}`}return`u:${Z(e)}`}function Aa(e,t){if(typeof window>`u`||window.localStorage===void 0)return{changed:!1,added:!1,updated:!1,value:t};let n=ga(t);if(!n)return{changed:!1,added:!1,updated:!1,value:t};try{let t=window.localStorage.getItem(e),r=[];if(t){let e=JSON.parse(t);if(Array.isArray(e))for(let t of e)typeof t==`string`&&r.push(t)}let i=new Map,a=[];for(let e of r){let t=ga(e);if(!t)continue;let n=ka(t),r=Oa(t),o=i.get(n);o?r>o.score&&i.set(n,{url:t,score:r,index:o.index}):(i.set(n,{url:t,score:r,index:a.length}),a.push(n))}let o=ka(n),s=Oa(n),c=i.get(o),l=!1,u=!1;c?s>c.score&&(i.set(o,{url:n,score:s,index:c.index}),u=!0):(i.set(o,{url:n,score:s,index:a.length}),a.push(o),l=!0);let d=[];for(let e of a){let t=i.get(e);t&&d.push(t.url)}let f=JSON.stringify(r),p=JSON.stringify(d);return f===p?{changed:!1,added:l,updated:u,value:n}:(window.localStorage.setItem(e,p),{changed:!0,added:l,updated:u,value:n})}catch{return{changed:!1,added:!1,updated:!1,value:n}}}function ja(e){if(!(typeof window>`u`)){try{window.__SIGIL__?.registerSigilUrl?.(e)}catch{}try{window.dispatchEvent(new CustomEvent(`sigil:url-registered`,{detail:{url:e}}))}catch{}try{if(`BroadcastChannel`in window){let t=new BroadcastChannel(ta);t.postMessage({type:`sigil:add`,url:e}),t.close()}}catch{}}}function Ma(e){if(!(typeof window>`u`)){try{window.dispatchEvent(new CustomEvent(`sigil:feed-registered`,{detail:{url:e}}))}catch{}try{if(`BroadcastChannel`in window){let t=new BroadcastChannel(ra);t.postMessage({type:`feed:add`,url:e}),t.close()}}catch{}}}function Na(e){let t=0,n=e.toLowerCase();return Ir(e)&&(t+=5e6),(/[?&#]t=/.test(n)||n.includes(`/stream/t`))&&(t+=2e6),n.includes(`/stream/p/`)&&(t-=5e5),/[?&#]v=/.test(n)&&(t-=25e4),t+=Oa(e),t}function Pa(e,t){if(typeof window>`u`||window.localStorage===void 0)return;let n=ha(ea);if(!n.length)return;let r=[],i=null,a=-1/0;for(let t of n){let n=ga(t);if(!n)continue;if(Sa(n)!==e){r.push(n);continue}let o=Na(n);o>a&&(a=o,i=n)}if(t){let e=ga(t);if(e){let t=Na(e);t>a&&(a=t,i=e)}}i&&r.push(i);let o=Q(r);try{let e=window.localStorage.getItem(ea)??`[]`,t=JSON.stringify(ma(JSON.parse(e))),n=JSON.stringify(o);t!==n&&window.localStorage.setItem(ea,n)}catch{}}function Fa(){if(typeof window>`u`||sa)return;sa=!0;let e=e=>{let t=e.key??``;(t===$i||t===ea||t===na)&&ua()};try{window.addEventListener(`storage`,e)}catch{}try{`BroadcastChannel`in window&&(ca=new BroadcastChannel(ta),ca.onmessage=e=>{let t=e.data,n=J(t)&&typeof t.url==`string`?t.url:null;n&&(Aa($i,n),ua())},la=new BroadcastChannel(ra),la.onmessage=e=>{let t=e.data,n=J(t)&&typeof t.url==`string`?t.url:null;n&&(Aa(ea,n),ua())})}catch{}ua()}function Ia(e){return J(e)&&typeof e.pulse==`number`&&Number.isFinite(e.pulse)?e.pulse:J(e)&&J(e.data)&&typeof e.data.pulse==`number`&&Number.isFinite(e.data.pulse)?e.data.pulse:0}function La(e){let t=J(e)?e.appId:void 0;if(typeof t==`string`&&t.trim())return t;let n=J(e)&&J(e.data)?e.data.appId:void 0;if(typeof n==`string`&&n.trim())return n}function Ra(e){let t=J(e)?e.userId:void 0;return t===void 0?J(e)&&J(e.data)?e.data.userId:void 0:t}function za(e){let t=X(e);if(t.startsWith(Y)){let e=Xr(t);if(e){let n=t.startsWith(Y)?t:`${Y}${t}`;return{kind:`embedded`,rootRef:n,payload:e,openUrl:Si(n,[]).url}}}let n=gi(t);if(n){let e=Xr(n);if(e)return{kind:`embedded`,rootRef:n,payload:e,openUrl:Si(n,[]).url}}return{kind:`sigilUrl`,openUrl:Z(t)}}var Ba=({url:e,depth:t=0,seen:n=[],addChain:r,addIndex:i,threadMode:a=`thread`})=>{let[o,s]=(0,M.useState)(!1),[c,l]=(0,M.useState)(!1),[u,d]=(0,M.useState)(!1),f=(0,M.useSyncExternalStore)(Pi,Fi,Ii),p=(0,M.useMemo)(()=>za(e),[e]),m=(0,M.useMemo)(()=>Hr(e),[e]),h=(0,M.useMemo)(()=>{if(p.kind===`embedded`){let e=p.payload,t=Ur(e);if(!t)return{ok:!1,openUrl:p.openUrl,error:`Invalid embedded payload (missing capsule).`};let n=Ia(e),r=La(e),i=Ra(e);return{ok:!0,openUrl:p.openUrl,dataRaw:e,storePayload:e,pulse:n,appId:r,userId:i,capsule:t}}let t=m.decoded,n=Z(m.resolvedUrl||e);if(!t.ok)return{ok:!1,openUrl:n,error:(`error`in t?t.error:void 0)??`Decode failed.`};let r=t.data,i=Ur(r);if(!i)return{ok:!1,openUrl:n,error:`Decode ok, but capsule missing.`};let a=typeof t.data.pulse==`number`&&Number.isFinite(t.data.pulse)?t.data.pulse:Ia(t.data),o=typeof t.data.appId==`string`&&t.data.appId?t.data.appId:La(t.data),s=t.data.userId??Ra(t.data);return{ok:!0,openUrl:n,dataRaw:r,storePayload:t.data,pulse:a,appId:o,userId:s,capsule:i}},[p,m.decoded,m.resolvedUrl,e]),g=h.ok,_=g?h:null,v=g?_.storePayload:null,y=g?_.capsule:null,b=(0,M.useMemo)(()=>Ta(e,y),[e,y]),x=(0,M.useMemo)(()=>Q(r?[...r]:hi(e)).slice(-mi),[r,e]),S=(0,M.useMemo)(()=>typeof i==`number`&&Number.isFinite(i)?i:x.length-1,[i,x.length]),C=(0,M.useMemo)(()=>!x.length||S<0||S>=x.length?null:x[S]??null,[x,S]),w=(0,M.useMemo)(()=>g&&v?Ei(e,v):Ei(e),[g,v,e]),te=(0,M.useMemo)(()=>[...n,w],[n,w]),T=(0,M.useMemo)(()=>{if(t>=mi)return null;let e=g?_.dataRaw??v:null,n=C??(e?bi(e):null);if(!n)return null;let r=Ei(n,(n.startsWith(Y)?Xr(n):null)??void 0);return te.includes(r)?null:n},[C,t,te,g,_,v]),D=(0,M.useMemo)(()=>{if(!g||!v)return null;try{return Yr(v)}catch{return null}},[g,v]),ne=(0,M.useMemo)(()=>x.length?Q(x.slice(0,Math.max(0,S+1))).slice(-mi):[],[x,S]);(0,M.useLayoutEffect)(()=>{if(!g)return;let e=D,t=Z(h.openUrl),n=null;if(T){let e=null;if(T.startsWith(Y))e=Xr(T);else{let t=Hr(T);t.decoded.ok&&(e=t.decoded.data)}n=Ei(T,e??void 0)}Li({key:w,prevKey:n,payloadRef:e??null,fallbackRef:t})},[g,h.openUrl,w,T,D]);let O=(0,M.useSyncExternalStore)(da,fa,pa);(0,M.useEffect)(()=>{Fa()},[]);let k=(0,M.useMemo)(()=>ya(va(b??h.openUrl??e)),[b,h.openUrl,e]),A=(0,M.useMemo)(()=>{if(!g)return{origin:null,replies:[]};let t=va(x.length>0?x[0]:b??e),n=ya(t),r=Q([va(e),va(h.openUrl),...x.map(e=>va(e)),..._a()]).filter(Boolean),i=new Map,a=(e,t)=>{let n=0,r=e.toLowerCase();return t?Ir(e)?n+=260:n+=40:((/[?&#]t=/.test(r)||r.includes(`/stream/t`))&&(n+=240),r.includes(`/stream/p/`)&&(n-=25),/[?&#]v=/.test(r)&&(n-=20),Ir(e)&&(n-=40)),n+=Math.max(0,20-Math.floor(e.length/40)),n+=Math.min(2e5,Oa(e)),n};for(let e of r){let t=ga(e);if(!t)continue;let r=ya(t);if(!r)continue;let o=Q(hi(t)),s=r===n;if(!s&&o.length>0){for(let e of o)if(ya(va(e))===n){s=!0;break}}if(!s)continue;let c=Hr(t),l=c.decoded.ok?Ia(c.decoded.data):0,u=a(t,r===n),d=i.get(r);if(!d||u>d.score){let e=Br(t)??t;i.set(r,{url:e,score:u,pulse:l})}}let o=i.get(n)?.url??t,s={key:n,url:o,pulse:(()=>{let e=Hr(o);return e.decoded.ok?Ia(e.decoded.data):0})()},c=[];for(let[e,t]of i.entries())e!==n&&e!==k&&(Ir(t.url)||c.push({key:e,url:t.url,pulse:t.pulse}));return c.sort((e,t)=>(t.pulse??0)-(e.pulse??0)),{origin:s,replies:c}},[g,x,b,e,h.openUrl,k,O]),re=(0,M.useCallback)(()=>{if(!g||!v)return{primary:{url:Z(h.openUrl),rootRef:``,adds:[],meta:{v:Er,id:`seg:none`,m:``,n:0,a:0,r:``}},archives:[]};let e=D??Yr(v),t=Q(Ri(w,mi)),n=Q(ne),r=Ti(n),i=Ti(t),a=r>i?n:r<i?t:n.length>t.length?n:t.length>n.length?t:n,o=[];for(let e of a){let t=X(e);if(!t)continue;if(t.startsWith(Y)){o.push(t);continue}let n=Hr(t),r=n.decoded.ok?n.decoded.data:null;if(r){let e=Ei(t,r),n=Oi.get(e);if(n?.payloadRef){o.push(n.payloadRef);continue}try{o.push(Yr(r));continue}catch{}}o.push(Z(t))}return wi(e,Q(o).slice(-mi))},[g,v,h.openUrl,D,w,ne]),ie=(0,M.useMemo)(()=>re(),[re,f]),j=ie.primary.url,ae=ie.archives.length>0,oe=(0,M.useMemo)(()=>Br(e)??Br(h.openUrl),[e,h.openUrl]),se=(0,M.useMemo)(()=>Yi(y,g?_.dataRaw:null),[y,g,_]),ce=!!T,le=(0,M.useMemo)(()=>{if(!g||!y)return!1;let e=y;return!!(e.post||e.message||e.share||e.reaction)},[g,y]),ue=(0,M.useMemo)(()=>{if(!g||!y)return!1;let e=y,t=pi(_.dataRaw,``),n=(yr(e.source)?e.source:void 0)??fi(_.dataRaw);return Hi(t)||Hi(n)||Wi(e)},[g,y,_]),de=(0,M.useMemo)(()=>le||!!se.post,[le,se.post]),N=(0,M.useMemo)(()=>ue||de||ce,[ue,de,ce]),fe=N;(0,M.useEffect)(()=>{if(typeof window>`u`||t!==0)return;Fa();let n=Br(window.location.href)??oe??Br(h.openUrl)??j??Z(e),r=Q([n,...x.map(e=>va(e)).filter(Boolean)]);for(let e of r){let t=Aa($i,e);t.changed&&ja(t.value)}if(fe){let e=g?_.dataRaw??v:void 0,t=Ea(n,e),r=Aa(ea,t);r.changed&&Ma(r.value),Pa(Sa(n,e),t)}ua()},[t,e,h.openUrl,oe,j,fe,x,g,_,v]);let F=(0,M.useMemo)(()=>oe??j,[oe,j]),I=(0,M.useMemo)(()=>g?N?F:b??F:h.openUrl,[g,h.openUrl,N,F,b]),pe=(0,M.useMemo)(()=>I,[I]),me=(0,M.useCallback)(()=>{let e=re();return[e.primary.url,...e.archives.map(e=>e.url)].join(`
`)},[re]),he=(0,M.useCallback)(()=>{Qi(pe,()=>{s(!0),typeof window<`u`&&window.setTimeout(()=>s(!1),1100)},e=>{s(!1)})},[pe]),L=(0,M.useCallback)(()=>{Qi(me(),()=>{l(!0),typeof window<`u`&&window.setTimeout(()=>l(!1),1100)},e=>{l(!1)})},[me]);if(!h.ok)return(0,P.jsxs)(`article`,{className:`fc fc--error`,role:`group`,"aria-label":`Invalid Sigil-Glyph`,children:[(0,P.jsx)(`div`,{className:`fc-crystal`,"aria-hidden":`true`}),(0,P.jsxs)(`div`,{className:`fc-shell`,children:[(0,P.jsx)(`header`,{className:`fc-head`,children:(0,P.jsxs)(`div`,{className:`fc-titleRow`,children:[(0,P.jsx)(`span`,{className:`fc-chip fc-chip--danger`,children:`INVALID`}),(0,P.jsx)(`span`,{className:`fc-muted`,children:`Sigil-Glyph capsule could not be resolved`})]})}),(0,P.jsx)(`div`,{className:`fc-error`,role:`alert`,children:h.error}),(0,P.jsxs)(`footer`,{className:`fc-actions`,role:`group`,"aria-label":`Actions`,children:[(0,P.jsx)(`a`,{className:`fc-btn`,href:I,target:`_blank`,rel:`noreferrer`,onClick:e=>e.stopPropagation(),title:`Open the best available href for this capsule`,children:`↗ Open`}),(0,P.jsx)(`button`,{className:`fc-btn`,type:`button`,onClick:he,"aria-pressed":o,"data-state":o?`remembered`:`idle`,title:`Copies the same href as Open for this block.`,children:o?`Remembered`:`Remember`})]})]})]});let R=_.capsule,ge=R.post,_e=R.message,ve=R.share,z=R.reaction,B=ge??se.post,V=typeof _.pulse==`number`&&Number.isFinite(_.pulse)?_.pulse:0,H=ee(V),U=Math.max(0,Math.floor(H.beat)),ye=Math.max(0,Math.floor(H.stepIndex)),W=oi(H.chakraDay,H.chakraDay),be=W===`Crown`?`Krown`:String(W),{day:xe,month:Se,year:Ce}=ai(V),we=B?`post`:_e?`message`:ve?`share`:z?`reaction`:`sigil`,Te=pi(_.dataRaw,we),Ee=String(Te),De=typeof _.appId==`string`&&_.appId?`app ${_r(_.appId,10,4)}`:void 0,Oe=_.userId!==void 0&&_.userId!==null?`user ${_r(String(_.userId),10,4)}`:void 0,ke=yr(R.sigilId)?R.sigilId:void 0,Ae=yr(R.phiKey)?R.phiKey:void 0,je=yr(R.kaiSignature),Me=je?`Signature present (Kai Signature)`:`Unsigned capsule`,Ne=yr(R.author)?R.author:void 0,Pe=(yr(R.source)?R.source:void 0)??fi(_.dataRaw),Fe=br(N?Bi:Vi),Ie=N?Bi:Vi,Le=Pe?Hi(Pe)?br(Bi):br(Pe):void 0,Re=!!Le&&Le!==Fe,ze=Ui(B?.title),Be=Ui(B?.text),Ve=Ui(_e?.text),He=Ui(ve?.note),Ue=li(V,U,ye,xe,Se,Ce),We=ui(ye),[Ge,Ke,qe]=di[be]??di.Crown??[238,241,251],Je=(V%13+13)%13,Ye={"--fc-accent-r":String(Ge),"--fc-accent-g":String(Ke),"--fc-accent-b":String(qe),"--fc-pulse-dur":`5236ms`,"--fc-pulse-offset":`${-(Je*120)}ms`,"--fc-thread-depth":String(t)},Xe=N?`memory`:Ee,Ze=N?`↗ Proof of Memory™`:`↗ Proof of Breath™`,Qe=N?`Open ${Bi}`:`Open ${Vi}`,$e=t===0&&a!==`self`,et=(Be??Ve??He??``)||``,tt=se.bodyKind===`code`||se.bodyKind===`html`?`code`:`text`,nt=et?Sr(et,tt):null,rt=!!nt?.shouldCollapse,it=rt&&!u,at=`fc-body-${Zr(w).slice(0,10)}`,ot=e=>{e.preventDefault(),e.stopPropagation(),d(e=>!e)},st=e=>{if(!$e&&!Cr(e.target??null)){if(`key`in e){let t=e.key;if(t!==`Enter`&&t!==` `)return;e.preventDefault()}try{window.open(I,`_blank`,`noopener,noreferrer`)}catch{}}},ct=S-1;return(0,P.jsxs)(P.Fragment,{children:[a!==`self`&&T?(0,P.jsx)(Ba,{url:T,depth:t+1,seen:te,addChain:x,addIndex:ct,threadMode:a}):null,(0,P.jsxs)(`article`,{className:`fc fc--crystal ${je?`fc--signed`:`fc--unsigned`} ${$e?`fc--primary`:`fc--preview`}`,role:$e?`article`:`link`,tabIndex:$e?-1:0,onClick:st,onKeyDown:st,"aria-label":`${Ie} glyph`,"data-kind":Xe,"data-chakra":be,"data-signed":je?`true`:`false`,"data-beat":ci(U),"data-step":ci(ye),"data-collapsed":it?`true`:`false`,style:Ye,children:[(0,P.jsx)(`div`,{className:`fc-crystal`,"aria-hidden":`true`}),(0,P.jsx)(`div`,{className:`fc-rim`,"aria-hidden":`true`}),(0,P.jsx)(`div`,{className:`fc-veil`,"aria-hidden":`true`}),(0,P.jsxs)(`div`,{className:`fc-shell`,children:[(0,P.jsx)(`aside`,{className:`fc-left`,"aria-label":N?Bi:Vi,children:(0,P.jsxs)(`div`,{className:`fc-sigilStage`,children:[(0,P.jsx)(`div`,{className:`fc-sigilGlass`,"aria-hidden":`true`}),(0,P.jsx)(`div`,{className:`fc-sigil`,"aria-label":N?Bi:Vi,children:(0,P.jsx)(E,{pulse:V,beat:U,stepPct:We,chakraDay:W})}),(0,P.jsxs)(`div`,{className:`fc-stamp mono`,"aria-label":`Kai stamp`,children:[(0,P.jsx)(`span`,{className:`fc-stamp__pulse`,title:`Pulse`,children:V}),(0,P.jsx)(`span`,{className:`fc-stamp__sep`,children:`•`}),(0,P.jsx)(`span`,{className:`fc-stamp__bbss`,title:`Beat:Step (zero-based)`,children:Ue.label})]})]})}),(0,P.jsxs)(`section`,{className:`fc-right`,children:[(0,P.jsxs)(`header`,{className:`fc-head`,"aria-label":`Glyph metadata`,children:[(0,P.jsxs)(`div`,{className:`fc-metaRow`,children:[(0,P.jsx)(`span`,{className:`fc-chip fc-chip--kind`,title:N?`${Bi} • type: ${Ee}`:`${Vi} • type: ${Ee}`,children:Fe}),De&&(0,P.jsx)(`span`,{className:`fc-chip`,children:De}),Oe&&(0,P.jsx)(`span`,{className:`fc-chip`,children:Oe}),!N&&ke?(0,P.jsxs)(`span`,{className:`fc-chip fc-chip--sigil`,title:`Sigil-Glyph: ${ke}`,children:[`SIGIL-GLYPH `,_r(ke,6,4)]}):null,Ae&&(0,P.jsxs)(`span`,{className:`fc-chip fc-chip--phikey`,title:`ΦKey: ${Ae}`,children:[`ΦKEY `,_r(Ae,6,4)]}),Ne&&(0,P.jsx)(`span`,{className:`fc-chip fc-chip--author`,title:`Author handle / origin`,children:Ne}),Re&&Le&&(0,P.jsx)(`span`,{className:`fc-chip fc-chip--source`,title:`Source`,children:Le}),(0,P.jsx)(`span`,{className:`fc-chip fc-chip--chakra`,title:`Chakra day`,children:be}),(0,P.jsx)(`span`,{className:`fc-sig ${je?`fc-sig--ok`:`fc-sig--warn`}`,title:Me,"aria-label":Me,children:je?`SIGNED`:`UNSIGNED`}),(()=>{let e=_i(j);return e?(0,P.jsxs)(`span`,{className:`fc-chip`,title:`Merkle: ${e.m}`,children:[`SEG `,_r(e.id,10,6)]}):null})()]}),(0,P.jsxs)(`div`,{className:`fc-kaiRow`,"aria-label":`Kai meta`,children:[(0,P.jsx)(`span`,{className:`fc-kai mono`,title:`Kai meta line`,children:Ue.line}),(0,P.jsx)(`span`,{className:`fc-arc`,title:`Arc`,children:Ue.arc})]})]}),B&&(0,P.jsxs)(`section`,{className:`fc-bodywrap`,"aria-label":`Post body`,children:[yr(ze)&&(0,P.jsx)(`h3`,{className:`fc-title`,children:ze}),yr(Be)?(0,P.jsxs)(`div`,{className:`fc-collapse`,"data-open":u?`true`:`false`,children:[(0,P.jsx)(`div`,{id:at,className:`fc-collapse__content`,style:{maxHeight:it?`${nt?.maxHeightPx??240}px`:`none`,overflow:it?`hidden`:`visible`},children:se.bodyKind===`code`||se.bodyKind===`html`?(0,P.jsx)(`pre`,{className:`fc-body`,style:{whiteSpace:`pre-wrap`},children:Be}):(0,P.jsx)(`p`,{className:`fc-body`,children:Be})}),rt?(0,P.jsx)(`button`,{className:`fc-btn fc-btn--ghost fc-collapse__toggle`,type:`button`,onClick:ot,"aria-expanded":u,"aria-controls":at,"data-no-open":`true`,title:`Expand/collapse long content`,children:u?`Collapse`:`Expand${nt?.lines?` • ${nt.lines} lines`:``}`}):null]}):null,Array.isArray(B.tags)&&B.tags.length>0&&(0,P.jsx)(`div`,{className:`fc-tags`,"aria-label":`Tags`,children:B.tags.map(e=>(0,P.jsxs)(`span`,{className:`fc-tag`,children:[`#`,e]},e))}),Array.isArray(B.media)&&B.media.length>0&&(0,P.jsx)(`div`,{className:`fc-media`,"aria-label":`Attached media`,children:B.media.map(e=>{let t=`${e.kind}:${e.url}`,n=vr(e.url)??e.kind;return(0,P.jsx)(`a`,{className:`fc-btn fc-btn--ghost`,href:e.url,target:`_blank`,rel:`noreferrer`,title:e.url,onClick:e=>e.stopPropagation(),children:n},t)})})]}),_e&&(0,P.jsxs)(`section`,{className:`fc-bodywrap`,"aria-label":`Message body`,children:[(0,P.jsxs)(`h3`,{className:`fc-title`,children:[`Message → `,_r(String(_e.toUserId??`recipient`),10,4)]}),yr(Ve)?(0,P.jsxs)(`div`,{className:`fc-collapse`,"data-open":u?`true`:`false`,children:[(0,P.jsx)(`div`,{id:`${at}-m`,className:`fc-collapse__content`,style:{maxHeight:it?`${nt?.maxHeightPx??240}px`:`none`,overflow:it?`hidden`:`visible`},children:(0,P.jsx)(`p`,{className:`fc-body`,children:Ve})}),rt?(0,P.jsx)(`button`,{className:`fc-btn fc-btn--ghost fc-collapse__toggle`,type:`button`,onClick:ot,"aria-expanded":u,"aria-controls":`${at}-m`,"data-no-open":`true`,children:u?`Collapse`:`Expand`}):null]}):null]}),ve&&(0,P.jsxs)(`section`,{className:`fc-bodywrap`,"aria-label":`Share body`,children:[(0,P.jsx)(`h3`,{className:`fc-title`,children:`Share`}),(0,P.jsx)(`a`,{className:`fc-link`,href:ve.refUrl,target:`_blank`,rel:`noreferrer`,title:ve.refUrl,onClick:e=>e.stopPropagation(),children:vr(ve.refUrl)??ve.refUrl}),yr(He)?(0,P.jsxs)(`div`,{className:`fc-collapse`,"data-open":u?`true`:`false`,children:[(0,P.jsx)(`div`,{id:`${at}-s`,className:`fc-collapse__content`,style:{maxHeight:it?`${nt?.maxHeightPx??240}px`:`none`,overflow:it?`hidden`:`visible`},children:(0,P.jsx)(`p`,{className:`fc-body`,children:He})}),rt?(0,P.jsx)(`button`,{className:`fc-btn fc-btn--ghost fc-collapse__toggle`,type:`button`,onClick:ot,"aria-expanded":u,"aria-controls":`${at}-s`,"data-no-open":`true`,children:u?`Collapse`:`Expand`}):null]}):null]}),z&&(0,P.jsxs)(`section`,{className:`fc-bodywrap`,"aria-label":`Reaction body`,children:[(0,P.jsx)(`h3`,{className:`fc-title`,children:`Reaction`}),(0,P.jsxs)(`div`,{className:`fc-body`,children:[yr(z.emoji)?z.emoji:`❤️`,typeof z.value==`number`?` × ${z.value}`:null]}),(0,P.jsx)(`a`,{className:`fc-link`,href:z.refUrl,target:`_blank`,rel:`noreferrer`,title:z.refUrl,onClick:e=>e.stopPropagation(),children:vr(z.refUrl)??z.refUrl})]}),!B&&!_e&&!ve&&!z&&(0,P.jsx)(`section`,{className:`fc-bodywrap`,"aria-label":`Sigil body`,children:N&&ae?(0,P.jsxs)(`div`,{className:`fc-muted`,style:{marginTop:8},children:[`Archive segments: `,ie.archives.length,` (use `,(0,P.jsx)(`b`,{children:`Pack`}),` to copy them)`]}):null}),a!==`self`&&t===0?(0,P.jsxs)(`section`,{className:`fc-bodywrap`,"aria-label":`Thread`,children:[(0,P.jsx)(`h3`,{className:`fc-title`,children:`Thread`}),A.origin&&A.origin.key!==k?(0,P.jsxs)(`div`,{style:{marginTop:10},children:[(0,P.jsx)(`div`,{className:`fc-muted`,style:{marginBottom:10},children:`Origin`}),(0,P.jsx)(Ba,{url:A.origin.url,threadMode:`self`,depth:1,seen:[w]})]}):null,(0,P.jsxs)(`div`,{style:{marginTop:14},children:[(0,P.jsxs)(`div`,{className:`fc-muted`,style:{marginBottom:10},children:[`Replies (`,A.replies.length,`)`]}),A.replies.length?A.replies.map(e=>(0,P.jsx)(Ba,{url:e.url,threadMode:`self`,depth:1,seen:[w]},e.key)):(0,P.jsx)(`div`,{className:`fc-muted`,children:`No replies captured locally yet.`})]})]}):null,(0,P.jsxs)(`footer`,{className:`fc-actions`,role:`group`,"aria-label":`Actions`,children:[(0,P.jsx)(`a`,{className:`fc-btn`,href:I,target:`_blank`,rel:`noreferrer`,title:Qe,onClick:e=>e.stopPropagation(),children:Ze}),(0,P.jsx)(`button`,{className:`fc-btn`,type:`button`,onClick:e=>{e.stopPropagation(),he()},"aria-pressed":o,"data-state":o?`remembered`:`idle`,title:`Copies the same href as Open for this block. If overflow exists, use Pack.`,children:o?`Remembered`:`Remember`}),ae?(0,P.jsx)(`button`,{className:`fc-btn`,type:`button`,onClick:e=>{e.stopPropagation(),L()},"aria-pressed":c,"data-state":c?`packed`:`idle`,title:`Copies the full segment pack (primary + archive segments) as newline-separated URLs.`,children:c?`Packed`:`Pack ${1+ie.archives.length}`}):null,(0,P.jsx)(`span`,{className:`fc-live`,"aria-live":`polite`,children:o?`Inhaled to Memory`:c?`Packed to Memory`:``})]})]})]})]})]})},Va=({url:e,threadMode:t=`thread`})=>{let n=(0,M.useMemo)(()=>gi(e),[e]),r=(0,M.useMemo)(()=>Q(hi(e)),[e]);return n?(0,P.jsx)(Ba,{url:n,threadMode:t,addChain:r,addIndex:r.length-1}):(0,P.jsx)(Ba,{url:e,threadMode:t})};function Ha({urls:e}){return!e||e.length===0?(0,P.jsx)(`section`,{className:`sf-list`,children:(0,P.jsxs)(`div`,{className:`sf-empty`,children:[`No items yet. Paste a link above or open a `,(0,P.jsx)(`code`,{children:`/stream/p/<payload>`}),` link and reply to start a thread.`]})}):(0,P.jsx)(`section`,{className:`sf-list`,"aria-label":`Memory Stream`,children:e.map(e=>(0,P.jsx)(Va,{url:e},e))})}function Ua(e){return R(e)&&e.kind===`url`&&typeof e.url==`string`&&(e.title===void 0||typeof e.title==`string`)}function Wa(e){return R(e)&&e.kind===`file-inline`&&typeof e.data_b64url==`string`&&(e.name===void 0||typeof e.name==`string`)&&(e.type===void 0||typeof e.type==`string`)&&(e.size===void 0||typeof e.size==`number`)&&(e.sha256===void 0||typeof e.sha256==`string`)&&(e.thumbnail_b64===void 0||typeof e.thumbnail_b64==`string`)&&(e.relPath===void 0||typeof e.relPath==`string`)}function Ga(e){return R(e)&&e.kind===`file-ref`&&typeof e.sha256==`string`&&(e.name===void 0||typeof e.name==`string`)&&(e.type===void 0||typeof e.type==`string`)&&(e.size===void 0||typeof e.size==`number`)&&(e.url===void 0||typeof e.url==`string`)&&(e.relPath===void 0||typeof e.relPath==`string`)}function Ka(e){return Ua(e)||Wa(e)||Ga(e)}function qa(e){return R(e)&&e.version===1&&typeof e.totalBytes==`number`&&typeof e.inlinedBytes==`number`&&Array.isArray(e.items)&&e.items.every(Ka)}var Ja=`Φ Memory added to PhiStream.`;function Ya(e){let t=(e||``).trim();return t?t.length<=140?t:`${t.slice(0,96)}:${t.slice(-32)}`:`root`}function Xa(e){return`sf.phistream.autoadd.notified:${Ya(e)}`}function Za(){return typeof window<`u`&&typeof document<`u`}function Qa(e){let t=(e||``).trim();if(!t||!Za())return null;try{if(t.startsWith(`/`)){let e=window.location?.origin??`https://kaiklok.com`,n=new URL(t,e);return n.protocol===`http:`||n.protocol===`https:`?n.toString():null}let e=new URL(t);return e.protocol===`http:`||e.protocol===`https:`?e.toString():null}catch{return null}}function $a(){return V(localStorage.getItem(B))}function eo(e){try{return $a().includes(e)}catch{return!1}}function to(e){try{return sessionStorage.getItem(Xa(e))===`1`}catch{return!1}}function no(e){try{sessionStorage.setItem(Xa(e),`1`)}catch{}}function ro(e){let{token:t,payloadUrl:n,fallbackUrl:r,toast:i}=e;if(!Za())return{ok:!1,added:!1,url:null,reason:`no_window`};let a=(n&&n.trim().length?n:r)??``;if(!a.trim())return{ok:!1,added:!1,url:null,reason:`no_url`};let o=Qa(a);if(!o)return{ok:!1,added:!1,url:null,reason:`invalid_url`};try{O(o)}catch{}let s=to(t);try{return eo(o)?{ok:!0,added:!1,url:o,reason:`already_present`}:(H([o]),s?{ok:!0,added:!1,url:o,reason:`already_notified`}:(no(t),i?.(`success`,Ja),{ok:!0,added:!0,url:o,reason:`added`}))}catch{return{ok:!1,added:!1,url:null,reason:`storage_unavailable`}}}var io=17491.270421,ao=36,oo=44,so=ao*oo,co=6,lo=7,uo=8,fo=co*lo,po=fo*uo;function mo(e,t){let n=e%t;return n<0?n+t:n}function ho(e){return Number.isFinite(e)?e<0?0:e>1?1:e:0}function go(e){return Number.isFinite(e)?e:0}function _o(e){let t=go(e);return Math.floor(t/io)}function vo(e){let t=go(e),n=(t-_o(t)*io)%io,r=n<0?n+io:n;return r>=io?0:r}function yo(e){let t=ho(vo(e)/io),n=Math.floor(t*so);return{beat:Math.floor(n/oo),step:n%oo}}function bo(e){let t=_o(e),n=Math.floor(t/po),r=mo(t,po),i=Math.floor(r/fo);return{d:r%fo+1,m:i+1,y:n}}var xo=[`Solhara`,`Aquaris`,`Flamora`,`Verdari`,`Sonari`,`Kaelith`],So=[`Root`,`Sacral`,`Solar`,`Heart`,`Throat`,`Third Eye`,`Crown`];function Co(e){return xo[mo(_o(e),xo.length)]??`Kaelith`}function wo(e){return So[mo(_o(e),So.length)]??`Crown`}var To=[`Aethon`,`Virelai`,`Solari`,`Amarin`,`Kaelus`,`Umbriel`,`Noktura`,`Liora`];function Eo(e){if(typeof window>`u`)return;let t=window.requestIdleCallback;if(typeof t==`function`){t(t=>{if(t.timeRemaining()<=0){e();return}e()});return}window.setTimeout(e,0)}function Do(e){let t=mo(_o(e),po),n=Math.floor(t/fo);return To[n]??`Month ${n+1}`}function Oo(e){let t=e.trim();return t&&(/^caelith$/i.test(t)||/^kaelith$/i.test(t)?`Kaelith`:t.charAt(0).toUpperCase()+t.slice(1))}function ko(e){let t=e.trim();if(!t)return t;let n=t.toLowerCase();return n===`third-eye`||n===`third eye`||n===`ajna`?`Third Eye`:n===`solar plexus`||n===`solar-plexus`||n===`solar`?`Solar`:n===`root`?`Root`:n===`sacral`?`Sacral`:n===`heart`?`Heart`:n===`throat`?`Throat`:n===`crown`?`Krown`:t.charAt(0).toUpperCase()+t.slice(1)}function Ao(e){let t=e.trim();return t&&(/^manual$/i.test(t)?`Proof of Memory™`:t.charAt(0).toUpperCase()+t.slice(1))}var jo=ao/6,Mo=[`Ignite`,`Integrate`,`Harmonize`,`Reflekt`,`Purify`,`Dream`];function No(e){let{beat:t}=yo(e),n=Math.floor(t/jo);return n<0?0:n>=Mo.length?Mo.length-1:n}function Po(e){return Mo[No(e)]??`Dream`}function Fo(e){let t=Number.isFinite(e)?Math.trunc(e):0;return String(t).padStart(2,`0`)}function Io(e){return e.length<=140?e:`${e.slice(0,96)}:${e.slice(-32)}`}function Lo(){let e=globalThis.location?.origin;return e&&typeof e==`string`&&e.length?e:`https://kaiklok.com`}function Ro(e){let t=Lo().replace(/\/+$/,``);return e.length<=3500?`${t}/stream/p/${encodeURIComponent(e)}`:`${t}/stream#t=${e}`}function zo(e){return`${Lo().replace(/\/+$/,``)}/stream?p=${encodeURIComponent(e)}`}function Bo(e){return`${Lo().replace(/\/+$/,``)}/p~${e}`}function Vo(e){return e.length<=3500?Bo(e):zo(e)}function Ho(e){let t=e.trim();try{let e=new URL(t),n=new URLSearchParams(e.hash.startsWith(`#`)?e.hash.slice(1):e.hash),r=new URLSearchParams(e.search),i=n.get(`t`)??n.get(`p`)??n.get(`token`)??r.get(`t`)??r.get(`p`)??r.get(`token`);i?t=i:/\/p~/.test(e.pathname)?t=e.pathname.split(`/p~`)[1]??t:/\/stream\/p\//.test(e.pathname)&&(t=e.pathname.split(`/stream/p/`)[1]??t)}catch{}if(/%[0-9A-Fa-f]{2}/.test(t))try{t=decodeURIComponent(t)}catch{}return t.includes(` `)&&(t=t.replaceAll(` `,`+`)),/[+/=]/.test(t)&&(t=t.replaceAll(`+`,`-`).replaceAll(`/`,`_`).replace(/=+$/g,``)),t}function $(e){return/^[A-Za-z0-9_-]{16,}$/.test(e)}function Uo(e){let t=e.trim();try{return new URL(t)}catch{try{return new URL(t,Lo())}catch{return null}}}function Wo(e){let t=e.trim();if(!t)return null;if($(t))return t;let n=Uo(t);if(!n)return null;let r=n.hash&&n.hash.startsWith(`#`)?n.hash.slice(1):``,i=new URLSearchParams(r),a=n.searchParams,o=i.get(`t`)??i.get(`p`)??i.get(`token`)??i.get(`capsule`)??a.get(`t`)??a.get(`p`)??a.get(`token`)??a.get(`capsule`);if(o&&o.trim().length)return o.trim();if(n.pathname.includes(`/p~`)){let e=n.pathname.indexOf(`/p~`),t=n.pathname.slice(e+3);if(t&&t.length)return t.startsWith(`/`)?t.slice(1):t}{let e=n.pathname.match(/\/stream\/p\/([^/?#]+)/);if(e?.[1])return e[1]}{let e=n.pathname.match(/\/p\/([^/?#]+)/);if(e?.[1])return e[1]}{let e=n.pathname.match(/\/s\/([^/?#]+)/);if(e?.[1])return e[1]}return null}function Go(e){if(typeof window>`u`)return`/stream/p/${encodeURIComponent(e)}`;let t=new URLSearchParams(window.location.search),n=new URLSearchParams(window.location.hash.startsWith(`#`)?window.location.hash.slice(1):window.location.hash),r=[...t.getAll(`add`),...n.getAll(`add`)].map(Se).filter(e=>typeof e==`string`&&e.trim().length>0),i=[];for(let e of r){let t=Ko(e);i.includes(t)||i.push(t)}let a=new URLSearchParams;for(let[e,n]of t.entries())e===`p`||e===`t`||e===`token`||e===`capsule`||e!==`add`&&a.append(e,n);for(let e of i)a.append(`add`,e);let o=new URLSearchParams;for(let[e,t]of n.entries())e===`p`||e===`t`||e===`token`||e===`capsule`||e!==`add`&&o.append(e,t);let s=e.length<=f,c=s?`/stream/p/${encodeURIComponent(e)}`:`/stream`,l=a.toString(),u=l.length?`?${l}`:``;if(s){let e=o.toString();return`${c}${u}${e.length?`#${e}`:``}`}let d=new URLSearchParams;d.set(`t`,e);for(let[e,t]of o.entries())d.append(e,t);return`${c}${u}#${d.toString()}`}function Ko(e){let t=e.trim();if(!t)return t;let n=Wo(t);if(!n){let e=Uo(t);return e?e.toString():t}return Ro(Ho(n))}function qo(e,t){let n=new URL(e,Lo()),r=n.hash.startsWith(`#`)?n.hash.slice(1):n.hash,i=new URLSearchParams(r);i.delete(`add`);for(let e of t)i.append(`add`,e);n.search=``;let a=i.toString();return n.hash=a?`#${a}`:``,n.toString()}var Jo=`sf:memoryStream:v2`,Yo=2e4,Xo=4096,Zo=4096,Qo=2048;function $o(){return{v:2,parentOf:{},childrenOf:{},pulseOf:{}}}function es(){if(typeof window>`u`)return $o();try{let e=window.localStorage.getItem(Jo);if(!e)return $o();let t=JSON.parse(e);if(!R(t)||t.v!==2)return $o();let n=R(t.parentOf)?t.parentOf:{},r=R(t.childrenOf)?t.childrenOf:{},i=R(t.pulseOf)?t.pulseOf:{},a=$o();for(let[e,t]of Object.entries(n))typeof e==`string`&&typeof t==`string`&&$(e)&&$(t)&&(a.parentOf[e]=t);for(let[e,t]of Object.entries(r)){if(!$(e)||!Array.isArray(t))continue;let n=t.filter(e=>typeof e==`string`&&$(e));a.childrenOf[e]=Array.from(new Set(n)).slice(0,Xo)}for(let[e,t]of Object.entries(i))if($(e)){if(typeof t==`number`&&Number.isFinite(t))a.pulseOf[e]=t;else if(typeof t==`string`&&t.trim().length){let n=Number(t.trim());Number.isFinite(n)&&(a.pulseOf[e]=n)}}return a}catch{return $o()}}function ts(e){if(!(typeof window>`u`))try{window.localStorage.setItem(Jo,JSON.stringify(e))}catch(e){L(`ms2Save`,e)}}function ns(e,t,n){let r=e.childrenOf[t]??[];if(r.includes(n))return!1;let i=[...r,n].slice(-Xo);return e.childrenOf[t]=i,!0}function rs(e,t,n){return!$(t)||!$(n)||t===n||e.parentOf[t]===n?!1:(e.parentOf[t]=n,ns(e,n,t),!0)}function is(e,t,n){return!$(t)||!Number.isFinite(n)||e.pulseOf[t]===n?!1:(e.pulseOf[t]=n,!0)}function as(e){let t=Uo(e);if(!t)return[];let n=t.hash&&t.hash.startsWith(`#`)?t.hash.slice(1):``,r=new URLSearchParams(n),i=[...t.searchParams.getAll(`add`),...r.getAll(`add`)];if(i.length===0)return[];let a=[];for(let e of i){let t=Se(e);if(!t||!t.trim().length)continue;let n=Wo(t)??($(t)?t:null);if(!n)continue;let r=Ho(n);$(r)&&(a.includes(r)||a.push(r))}return a}function os(e,t){let n=Wo(t);if(!n)return!1;let r=Ho(n);if(!$(r))return!1;let i=as(t),a=i.length?i[i.length-1]:null,o=!1;if(a&&(o=rs(e,r,a)||o),Object.keys(e.parentOf).length+Object.keys(e.childrenOf).length>Yo){let t=Object.keys(e.childrenOf);for(let n=0;n<Math.min(256,t.length);n++)delete e.childrenOf[t[n]];o=!0}return o}function ss(e,t){if(!$(t))return t;let n=new Set,r=t;for(let t=0;t<Zo&&!n.has(r);t++){n.add(r);let t=e.parentOf[r];if(!t||!$(t))break;r=t}return r}function cs(e,t){if(!$(t))return[];let n=[],r=new Set,i=t;for(let t=0;t<Zo;t++){let t=e.parentOf[i];if(!t||!$(t)||r.has(t))break;r.add(t),n.push(t),i=t}return n.reverse(),n}function ls(e,t){let n=ss(e,t),r=[],i=[],a=new Set;i.push(n),a.add(n);for(let t=0;t<Zo&&i.length;t++){let t=i.shift();r.push(t);let n=e.childrenOf[t]??[];for(let e of n)$(e)&&(a.has(e)||(a.add(e),i.push(e)))}return r.sort((t,n)=>{let r=e.pulseOf[t],i=e.pulseOf[n],a=typeof r==`number`&&Number.isFinite(r),o=typeof i==`number`&&Number.isFinite(i);return a&&o?r-i:a?-1:o?1:t<n?-1:t>n?1:0}),r}function us(e,t){let n=Ro(t),r=cs(e,t);return r.length?qo(n,r):n}function ds(e){if(typeof document>`u`)return!1;try{let t=document.createElement(`textarea`);t.value=e,t.setAttribute(`readonly`,`true`),t.style.position=`fixed`,t.style.left=`-9999px`,t.style.top=`0`,document.body.appendChild(t);let n=document.activeElement instanceof HTMLElement?document.activeElement:null;t.focus(),t.select();let r=document.execCommand(`copy`);return document.body.removeChild(t),n&&n.focus(),r}catch{return!1}}function fs(e){if(typeof window>`u`)return null;let t=window.navigator;return t!==void 0&&t.clipboard!==void 0&&typeof t.clipboard.writeText==`function`&&window.isSecureContext?t.clipboard.writeText(e):null}function ps(e){return e.replaceAll(`&`,`&amp;`).replaceAll(`<`,`&lt;`).replaceAll(`>`,`&gt;`).replaceAll(`"`,`&quot;`).replaceAll(`'`,`&#39;`)}function ms(e){try{let t=new DOMParser().parseFromString(e,`text/html`);return t.querySelectorAll(`script,style,iframe,object,embed`).forEach(e=>e.remove()),t.querySelectorAll(`*`).forEach(e=>{for(let t of Array.from(e.attributes)){let n=t.name.toLowerCase(),r=t.value;if(n.startsWith(`on`)){e.removeAttribute(t.name);continue}if(n===`href`||n===`src`){let n=r.trim().toLowerCase();(n.startsWith(`javascript:`)||n.startsWith(`data:`))&&e.removeAttribute(t.name)}}}),t.body.innerHTML}catch{return ps(e)}}function hs(e){try{let t=new URL(e);return t.protocol===`http:`||t.protocol===`https:`?t.toString():null}catch{return null}}function gs(e){let t=ps(e).replace(/```(\w+)?\n([\s\S]*?)```/g,(e,t,n)=>{let r=(t||``).trim();return`<pre><code${r?` class="language-${ps(r)}"`:``}>${n}</code></pre>`});return t=t.replace(/^####\s(.+)$/gm,`<h4>$1</h4>`),t=t.replace(/^###\s(.+)$/gm,`<h3>$1</h3>`),t=t.replace(/^##\s(.+)$/gm,`<h2>$1</h2>`),t=t.replace(/^#\s(.+)$/gm,`<h1>$1</h1>`),t=t.replace(/\*\*(.+?)\*\*/g,`<strong>$1</strong>`),t=t.replace(/\*(.+?)\*/g,`<em>$1</em>`),t=t.replace(/`([^`]+)`/g,`<code>$1</code>`),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{let r=hs(n);return r?`<a href="${ps(r)}" target="_blank" rel="noreferrer noopener">${t}</a>`:`${t} (${ps(n)})`}),t=t.split(/\n{2,}/g).map(e=>{let t=e.trim();return t?t.startsWith(`<h`)||t.startsWith(`<pre>`)?t:`<p>${t.replace(/\n/g,`<br/>`)}</p>`:``}).filter(Boolean).join(`
`),t}function _s(e){let t=0,n=0;for(let r of e){if(r.kind===`file-inline`){typeof r.size==`number`&&Number.isFinite(r.size)&&r.size>=0&&(t+=r.size,n+=r.size);continue}if(r.kind===`file-ref`){typeof r.size==`number`&&Number.isFinite(r.size)&&r.size>=0&&(t+=r.size);continue}}return{total:t,inlined:n}}function vs(e){if(qa(e))return e;if(!R(e))return null;let t=e.version,n=e.items;if(t!==1||!Array.isArray(n))return null;let r=n.filter(Ka),i=_s(r);return{version:1,totalBytes:typeof e.totalBytes==`number`&&Number.isFinite(e.totalBytes)?e.totalBytes:i.total,inlinedBytes:typeof e.inlinedBytes==`number`&&Number.isFinite(e.inlinedBytes)?e.inlinedBytes:i.inlined,items:r}}function ys({body:e,caption:t,isSealed:n}){let r=e??(!n&&t&&t.trim().length?{kind:`text`,text:t}:null);return r?r.kind===`text`?(0,P.jsxs)(`div`,{className:`sf-text`,children:[`— `,`"${r.text}"`]}):r.kind===`code`?(0,P.jsx)(`pre`,{className:`sf-code`,children:(0,P.jsx)(`code`,{children:r.code})}):r.kind===`md`?(0,P.jsx)(`div`,{className:`sf-md`,dangerouslySetInnerHTML:{__html:gs(r.md)}}):(r.mode??`code`)===`code`?(0,P.jsx)(`pre`,{className:`sf-code sf-code--html`,children:(0,P.jsx)(`code`,{children:r.html})}):(0,P.jsx)(`div`,{className:`sf-html`,dangerouslySetInnerHTML:{__html:ms(r.html)}}):(0,P.jsx)(P.Fragment,{})}function bs(e,t){if(!e||typeof e!=`object`)return null;let n=e;for(let e of t){let t=n[e];if(typeof t==`string`&&t.trim().length)return t.trim()}return null}function xs(e,t){if(!e||typeof e!=`object`)return null;let n=e[t];if(typeof n==`number`&&Number.isFinite(n))return n;if(typeof n==`string`&&n.trim().length){let e=Number(n.trim());return Number.isFinite(e)?e:null}return null}function Ss(e){return Math.max(0,Math.min(255,Math.round(e)))}function Cs(e){if(!R(e))return!1;let t=e.body,n=e.attachments,r=e.caption,i=t===void 0||R(t),a=r===void 0||typeof r==`string`,o=n===void 0||R(n)||Array.isArray(n);return i&&a&&o}function ws(e){return typeof e==`function`}function Ts(e){return R(e)&&e.ok===!0&&`inner`in e}function Es(e){let t=R(e)?e.seal:void 0;return t?bs(t,[`teaser`,`preview`,`hint`,`caption`])??null:null}async function Ds(e){let t=await i(()=>import(`./postSeal-D8Xvalbm.js`),__vite__mapDeps([0,1])),n=R(t)?t:{},r=n.openSealedEnvelope??n.openSealedPayload??n.unsealEnvelope??n.unsealPayload??n.unsealEnvelopeV1??null;if(!ws(r))throw Error(`postSeal module is missing an unseal function.`);if(((R(n)&&Object.entries(n).find(([,e])=>e===r)?.[0])??`unseal`)===`unsealEnvelopeV1`){let t=typeof e.meta==`object`&&e.meta!==null?_e(e.meta,`kaiSignature`):void 0,n=typeof e.meta==`object`&&e.meta!==null?_e(e.meta,`userPhiKey`):void 0;if(!t)throw Error(`Missing kaiSignature in meta (cannot unlock sealed envelope).`);let i=await Promise.resolve(r(e.seal,{kaiSignature:t,phiKey:n}));if(Ts(i)){let e=i.inner;if(!R(e))throw Error(`Unseal returned non-object inner payload.`);let t=e.body,n=e.attachments,r=e.caption,a={};return t!==void 0&&R(t)&&(a.body=t),n!==void 0&&(a.attachments=n),typeof r==`string`&&(a.caption=r),a}if(Cs(i))return i;throw Error(`Unseal returned an unexpected shape.`)}let a=await Promise.resolve(r(e.seal,{meta:e.meta,svgText:e.svgText??void 0}));if(!Cs(a))throw Error(`Unseal returned an unexpected shape.`);return a}function Os(e){let{token:t,payload:n,manifest:r,copied:i,onKopy:a,isSealed:o,unsealState:s,canUnseal:c,verifiedThisSession:l,hasComposerMeta:u,onVerifiedNow:d,onResetVerified:f,onUnseal:p,onForgetUnsealed:m,body:h,caption:g}=e,_=(0,M.useRef)(null),v=(0,M.useCallback)(()=>{let e=_.current;if(!e)return;try{e.scrollIntoView({behavior:`smooth`,block:`center`})}catch{}let t=e.querySelector(`input[type="file"]`);if(t){t.click();return}e.querySelector(`button`)?.click()},[]),y=s.status===`opening`?`UNSEALING…`:c?`UNSEAL`:l?u?`UNSEAL`:`RE-INHALE`:`🔐 Sealed`,ee=(0,M.useCallback)(()=>{if(!c){v();return}p()},[c,p,v]),b=go(n.pulse),{beat:x,step:S}=yo(b),{d:C,m:w,y:te}=bo(b),T=Do(b),E=Oo(Co(b)),D=Po(b),k=bs(n,[`userPhiKey`,`phiKey`,`phikey`,`authorPhiKey`])??bs(n.meta,[`userPhiKey`,`phiKey`,`phikey`])??``,A=Ao(bs(n,[`mode`,`source`,`origin`,`transport`])??bs(n.meta,[`mode`,`source`,`origin`])??`Manual`);(0,M.useEffect)(()=>{try{O(Vo(t))}catch(e){L(`register share url (PayloadCard)`,e)}if(typeof n.url==`string`&&n.url.length)try{O(n.url)}catch(e){L(`register payload.url (PayloadCard)`,e)}},[t,n.url]);let re=o&&s.status!==`open`,ie=(0,M.useMemo)(()=>o?Es(n):null,[o,n]),j=o?(0,P.jsx)(`span`,{className:`sf-pill sf-pill--sealed`,title:`Private (Sealed)`,children:`🔒 SEALED`}):null;return(0,P.jsxs)(`section`,{className:`sf-payload`,role:`region`,"aria-label":`Loaded payload`,children:[(0,P.jsxs)(`div`,{className:`sf-payload-line sf-tags`,children:[(0,P.jsx)(`span`,{className:`sf-pill sf-pill--mode`,children:A||`Proof of Memory™`}),j,k?(0,P.jsxs)(`span`,{className:`sf-pill sf-pill--phikey`,title:k,children:[`ΦKey `,(0,P.jsx)(`span`,{className:`sf-key`,children:k})]}):null]}),(0,P.jsxs)(`div`,{className:`sf-payload-core`,children:[(0,P.jsxs)(`span`,{children:[`☤Kai: `,b]}),(0,P.jsx)(`span`,{className:`sf-muted`,children:` · `}),(0,P.jsxs)(`span`,{className:`sf-kai-label`,children:[Fo(x),`:`,Fo(S),` — D`,C,`/M`,w,`/Y`,te,` · `,D]}),(0,P.jsx)(`span`,{className:`sf-muted`,children:` · `}),(0,P.jsxs)(`span`,{className:`sf-kai-label`,children:[E,` · `,T]})]}),o?(0,P.jsx)(`div`,{className:`sf-seal`,role:`group`,"aria-label":`Private sealed content`,children:s.status===`open`?(0,P.jsxs)(`div`,{className:`sf-seal__row`,children:[(0,P.jsx)(`span`,{className:`sf-seal__label`,children:`Unsealed`}),(0,P.jsx)(`button`,{type:`button`,className:`sf-seal__btn`,onClick:m,"aria-label":`Seal view`,children:`SEAL`})]}):(0,P.jsxs)(P.Fragment,{children:[(0,P.jsxs)(`div`,{className:`sf-seal__row`,children:[(0,P.jsx)(`span`,{className:`sf-seal__label`,children:`Private`}),(0,P.jsx)(`button`,{type:`button`,className:`sf-seal__btn`,onClick:ee,disabled:s.status===`opening`,"aria-label":`Unseal private content`,children:y})]}),ie?(0,P.jsx)(`div`,{className:`sf-seal__hint`,role:`note`,children:ie}):null,(0,P.jsxs)(`div`,{ref:_,className:`sf-seal__gate`,role:`region`,"aria-label":`Unlock gate`,children:[l?u?c?null:(0,P.jsx)(`div`,{className:`sf-seal__hint`,role:`note`,children:`Inhale your ΦKey to unseal.`}):(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(`div`,{className:`sf-seal__hint`,role:`note`,children:`Verified session detected, but no sigil metadata is present. Re-inhale your glyph.`}),(0,P.jsx)(`div`,{className:`sf-seal__login`,"aria-label":`Glyph re-upload`,children:(0,P.jsx)(ne,{onVerified:d})}),(0,P.jsx)(`div`,{className:`sf-seal__row`,children:(0,P.jsx)(`button`,{type:`button`,className:`sf-seal__btn`,onClick:f,"aria-label":`Use a different key`,children:`USE DIFFERENT ΦKEY`})})]}):(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(`div`,{className:`sf-seal__hint`,role:`note`,children:`Inhale your ΦKey, then unseal.`}),(0,P.jsx)(`div`,{className:`sf-seal__login`,"aria-label":`Glyph upload`,children:(0,P.jsx)(ne,{onVerified:d})})]}),s.status===`error`?(0,P.jsx)(`div`,{className:`sf-seal__hint`,role:`note`,children:s.message}):null]})]})}):null,re?null:(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(ys,{body:h,caption:g,isSealed:!1}),r?(0,P.jsx)(Mt,{manifest:r}):null]}),(0,P.jsx)(`div`,{className:`sf-reply-actions`,children:(0,P.jsx)(`button`,{type:`button`,className:`sf-kopyBtn`,onClick:a,disabled:i,"data-state":i?`copied`:`idle`,"aria-label":`Remember share link`,children:i?`REMEMBERED`:`REMEMBER`})})]})}function ks(){return(0,P.jsx)(F,{children:(0,P.jsx)(k,{children:(0,P.jsx)(As,{})})})}function As(){let e=N(),t=se(),n=ce(),r=ue(e=>{e.preventDefault(),n(`/keystream`)}),[i,a]=(0,M.useState)([]),o=(0,M.useRef)(new Set),s=(0,M.useRef)(es()),c=(0,M.useRef)(new Set),[l,d]=(0,M.useState)(0),f=(0,M.useRef)(!1),p=(0,M.useCallback)((e,t)=>{Eo(()=>{let t=s.current,n=!1;for(let r of e)!r||!r.trim().length||(n=os(t,r)||n);n&&(ts(t),d(e=>e+1))})},[]),m=(0,M.useCallback)(e=>{if(!f.current){f.current=!0;try{let t=new Set,n=e=>{if(!e)return;let n=Ho(e);$(n)&&t.add(n)},r=s.current;for(let e of Object.keys(r.parentOf))n(e);for(let e of Object.keys(r.childrenOf)){n(e);for(let t of r.childrenOf[e]??[])n(t)}for(let e of Object.keys(r.pulseOf))n(e);for(let t of e){n(Wo(t));for(let e of as(t))n(e)}let i=0;for(let e of t){if(i>=Qo)break;i+=1;let t=g(e);if(!t)continue;let n=t.usernameClaim;if(!n)continue;let r=A(n.hash??``),a=n.payload;if(!r||!a||a.kind!==`username_claim`)continue;let o=j(a.normalized||a.username||``),s=j(t.author??``),c=o||s;if(!c)continue;let l=n.url?.trim()||Ro(e);if(!l)continue;let u=n.ownerHint??a.ownerHint??null;ie({hash:r,url:l,payload:{...a,normalized:o||c},ownerHint:u})}}catch(e){L(`rehydrate username claims`,e)}}},[]);(0,M.useEffect)(()=>{if(typeof window>`u`)return;let e=e=>{a(t=>{let n=new Set(t.map(({url:e})=>e)),r=[...t],i=[];for(let{url:t}of e){let e=t.trim();!e||n.has(e)||(n.add(e),r.push({url:e}),i.push(e))}if(i.length>0){for(let e of i)O(e);p(i),m(i)}return r})};Eo(()=>{let t=V(localStorage.getItem(B));t.length&&e(t.map(e=>({url:e})))});let t=!1;return Eo(()=>{(async()=>{try{let n=await z();!t&&n.length&&e(n)}catch(e){L(`initial seed load`,e)}})().catch(e=>L(`initial seed load outer`,e))}),()=>{t=!0}},[p,m]),(0,M.useEffect)(()=>{if(!(typeof window>`u`))try{let e=new URLSearchParams(window.location.search),t=new URLSearchParams(window.location.hash.startsWith(`#`)?window.location.hash.slice(1):window.location.hash),n=[...e.getAll(`add`),...t.getAll(`add`)].map(Se).filter(e=>typeof e==`string`&&e.trim().length>0).map(Ko);if(n.length===0)return;p([window.location.href,...n]),a(e=>{let t=new Set(e.map(e=>e.url)),r=n.filter(e=>!t.has(e));if(r.length){H(r);for(let e of r)O(e);return[...r.map(e=>({url:e})),...e]}return e})}catch(e){L(`add ingestion (location)`,e)}},[t.pathname,t.search,t.hash,p]),(0,M.useEffect)(()=>{typeof window>`u`||Eo(()=>{let e=o.current,t=[],n=e=>{e.trim().length&&(t.includes(e)||t.push(e))};for(let t of i){let r=t.url;if(!r||e.has(r))continue;e.add(r);let i=Uo(r);if(!i)continue;let a=i.hash&&i.hash.startsWith(`#`)?i.hash.slice(1):``,o=new URLSearchParams(a),s=[...i.searchParams.getAll(`add`),...o.getAll(`add`)];if(s.length===0)continue;let c=s.map(Se).filter(e=>typeof e==`string`&&e.trim().length>0).map(Ko);for(let e of c)n(e)}t.length!==0&&(p(t),a(e=>{let n=new Set(e.map(e=>e.url)),r=t.filter(e=>!n.has(e));if(!r.length)return e;try{H(r)}catch(e){L(`prependUniqueToStorage (infinite replies)`,e)}for(let e of r)try{O(e)}catch(e){L(`registerSigilUrl (infinite replies)`,e)}return[...r.map(e=>({url:e})),...e]}))})},[i,p]),(0,M.useEffect)(()=>{typeof window>`u`||Eo(()=>{let e=c.current,t=[];for(let n of i){let r=n.url;if(!(!r||e.has(r))&&(e.add(r),t.push(r),t.length>=256))break}t.length&&p(t)})},[i,p]);let[h,_]=(0,M.useState)(null),[v,y]=(0,M.useState)(null),[ee,b]=(0,M.useState)(null),x=(0,M.useRef)(null),[S,C]=(0,M.useState)({status:`none`});(0,M.useEffect)(()=>{if(!v){C({status:`none`});return}C(R(v)&&v.seal!==void 0?{status:`sealed`}:{status:`none`})},[v]);let w=(0,M.useCallback)(async()=>{if(typeof window>`u`)return;let t=u(),n=t?Ho(t):null;if(n)try{let e=Go(n);e!==`${window.location.pathname}${window.location.search}${window.location.hash}`&&window.history.replaceState(null,``,e)}catch(e){L(`canonicalizeLocationRel`,e)}if(_(n),!n){y(null),b(null),x.current=null;return}try{let e=Ro(n),t=Vo(n);O(e),t!==e&&O(t)}catch(e){L(`register current stream url (pre-decode)`,e)}try{let e=Ro(n);a(t=>{if(new Set(t.map(e=>e.url)).has(e))return t;try{H([e])}catch(e){L(`prependUniqueToStorage (visited stream)`,e)}try{O(e)}catch(e){L(`registerSigilUrl (visited stream)`,e)}return[{url:e},...t]}),p([window.location.href,e])}catch(e){L(`ms2 ingest visited stream`,e)}try{let r=await g(n)||(t&&t!==n?await g(t):null);if(!r){y(null),b(`Invalid or unreadable payload token.`);return}let i=r.usernameClaim,o=i?j(i.payload?.normalized||i.payload?.username||``):``,c=j(r.author??``),l=o||c;if(i){let e=A(i.hash??``),t=i.url?.trim()||Ro(n);if(!e||!t){y(null),b(`Username claim missing glyph reference.`);return}if(!l){y(null),b(`Username claim missing normalized username.`);return}let r=oe()[l];if(r&&r.claimHash!==e){y(null),b(`Username claimed by another glyph.`);return}let a=i.payload;if(!a||a.kind!==`username_claim`){y(null),b(`Invalid username-claim payload.`);return}let o=j(a.normalized||a.username||``)||l;if(o!==l){y(null),b(`Username claim does not match author.`);return}let s=ie({hash:e,url:t,payload:{...a,normalized:o},ownerHint:i.ownerHint??a.ownerHint??null});if(!s.accepted){y(null),b(`Username claim rejected: ${s.reason??`unknown`}.`);return}}else if(l&&oe()[l]){y(null),b(`Claim glyph is required for this username.`);return}y(r),b(null);try{let e=s.current;is(e,n,go(r.pulse))&&(ts(e),d(e=>e+1))}catch(e){L(`ms2SetPulse`,e)}if(r.url&&typeof r.url==`string`&&r.url.length){if(x.current!==n){x.current=n;try{H([r.url])}catch(e){L(`prependUniqueToStorage (payload url)`,e)}let t=ro({token:n,payloadUrl:r.url,toast:(t,n)=>e.push(t,n)});a(e=>new Set(e.map(e=>e.url)).has(r.url)?e:[{url:r.url},...e]),t.ok||L(`phistream auto-add`,t.reason)}else a(e=>new Set(e.map(e=>e.url)).has(r.url)?e:[{url:r.url},...e]);try{O(r.url)}catch(e){L(`register payload.url (post-decode)`,e)}}try{O(Bo(n))}catch(e){L(`register short alias url`,e)}}catch(e){L(`payload decode`,e),y(null),b(`Payload decode failed.`)}},[e,p]);(0,M.useEffect)(()=>{w()},[t.pathname,t.search,t.hash,w]);let te=(0,M.useMemo)(()=>{if(!v)return{weekday:void 0,chakra:void 0};let e=go(v.pulse);return{weekday:Oo(Co(e)),chakra:ko(wo(e))}},[v]),T=(0,M.useMemo)(()=>`sf.verifiedSession:${Io(h??(typeof window<`u`?u():null)??`root`)}`,[h]),[E,k]=(0,M.useState)(()=>{try{if(typeof window>`u`)return!1;let e=`sf.verifiedSession:${Io(u()||`root`)}`;return sessionStorage.getItem(e)===`1`}catch(e){return L(`sessionStorage.getItem (init)`,e),!1}});(0,M.useEffect)(()=>{try{if(typeof window>`u`)return;k(sessionStorage.getItem(T)===`1`)}catch(e){L(`sessionStorage.getItem (sync)`,e),k(!1)}},[T]);let re=()=>{k(!0);try{sessionStorage.setItem(T,`1`)}catch(e){L(`sessionStorage.setItem`,e)}e.push(`success`,`ΦKey inhaled.`)},ae=()=>{k(!1);try{sessionStorage.removeItem(T)}catch(e){L(`sessionStorage.removeItem`,e)}},de=D(),fe=(0,M.useMemo)(()=>ve(de),[de]),F=(0,M.useMemo)(()=>E?fe.meta:null,[E,fe.meta]),I=(0,M.useMemo)(()=>E?fe.svgText:null,[E,fe.svgText]),pe=(0,M.useMemo)(()=>F?_e(F,`userPhiKey`):void 0,[F]),me=(0,M.useMemo)(()=>F?_e(F,`kaiSignature`):void 0,[F]),he=(0,M.useMemo)(()=>{let e=xs(F,`sigil_r`)??xs(F,`sigilR`)??xs(F,`tintR`)??null,t=xs(F,`sigil_g`)??xs(F,`sigilG`)??xs(F,`tintG`)??null,n=xs(F,`sigil_b`)??xs(F,`sigilB`)??xs(F,`tintB`)??null;if(e===null||t===null||n===null)return{};let r={};return r[`--sigil-r`]=String(Ss(e)),r[`--sigil-g`]=String(Ss(t)),r[`--sigil-b`]=String(Ss(n)),r},[F]),ge=e=>{a(t=>new Set(t.map(e=>e.url)).has(e)?t:(H([e]),O(e),p([e]),[{url:e},...t]))},U=(0,M.useMemo)(()=>v?R(v)&&v.seal!==void 0:!1,[v]),ye=(0,M.useMemo)(()=>!!(U&&E&&F),[U,E,F]),W=(0,M.useCallback)(()=>{v&&(C(U?{status:`sealed`}:{status:`none`}),e.push(`success`,`Sealed`))},[v,U,e]),be=(0,M.useCallback)(async()=>{if(!v)return;let t=v.seal;if(!t){C({status:`error`,message:`No seal present on this payload.`});return}if(!E||!F){C({status:`error`,message:`Inhale your ΦKey to unseal.`});return}C({status:`opening`});try{C({status:`open`,content:await Ds({seal:t,meta:F,svgText:I??null})}),e.push(`success`,`Unsealed`)}catch(t){L(`unseal`,t),C({status:`error`,message:`Unseal failed. Wrong key, wrong seal, or missing postSeal implementation.`}),e.push(`warn`,`Unseal failed.`)}},[v,E,F,I,e]),xe=(0,M.useMemo)(()=>U&&S.status!==`open`,[U,S.status]),Ce=(0,M.useMemo)(()=>S.status===`open`?S.content.body:v?.body,[v,S]),we=(0,M.useMemo)(()=>S.status===`open`?S.content.caption??v?.caption:v?.caption,[v,S]),Te=(0,M.useMemo)(()=>S.status===`open`?S.content.attachments??v?.attachments:v?.attachments,[v,S]),Ee=(0,M.useMemo)(()=>Te?vs(Te):null,[Te]),[De,Oe]=(0,M.useState)(!1),ke=(0,M.useRef)(null);(0,M.useEffect)(()=>()=>{ke.current!==null&&window.clearTimeout(ke.current)},[]);let Ae=(0,M.useCallback)(()=>{let t=h??(typeof window<`u`?u():null),n=t?Ho(t):null;if(!n)return;let r=Ro(n),i=typeof window<`u`?as(window.location.href):[],a=i.length?qo(r,i):r;if(ds(a)){Oe(!0),ke.current!==null&&window.clearTimeout(ke.current),ke.current=window.setTimeout(()=>Oe(!1),1200),e.push(`success`,`Remembered`);return}let o=fs(a);if(o){Oe(!0),ke.current!==null&&window.clearTimeout(ke.current),ke.current=window.setTimeout(()=>Oe(!1),1200),e.push(`success`,`Remembered`),o.catch(t=>{L(`kopy clipboard.writeText`,t),Oe(!1),e.push(`warn`,`Remember failed. Select the address bar.`)});return}e.push(`warn`,`Remember failed. Select the address bar.`)},[h,e]),je=(0,M.useMemo)(()=>{if(!h)return[];let e=s.current;return ls(e,h).map(t=>us(e,t))},[h,l]);(0,M.useEffect)(()=>{h&&je.length!==0&&a(e=>{let t=new Set(e.map(e=>e.url)),n=je.filter(e=>!t.has(e));if(!n.length)return e;try{H(n)}catch(e){L(`prependUniqueToStorage (thread hydrate)`,e)}for(let e of n)try{O(e)}catch(e){L(`registerSigilUrl (thread hydrate)`,e)}return[...n.map(e=>({url:e})),...e]})},[h,je]);let Me=(0,M.useMemo)(()=>{let e=i.map(e=>e.url);if(!h||je.length===0)return e;let t=new Set,n=[];for(let e of je)t.has(e)||(t.add(e),n.push(e));for(let r of e)t.has(r)||(t.add(r),n.push(r));return n},[i,h,je]),Ne=E&&(F||I)?qe({meta:F,svgText:I||``}):null;return(0,P.jsxs)(`main`,{className:`sf`,"data-weekday":te.weekday,"data-chakra":te.chakra,style:he,children:[(0,P.jsxs)(`header`,{className:`sf-head`,role:`region`,"aria-labelledby":`glyph-stream-title`,children:[(0,P.jsx)(`nav`,{className:`sf-topnav`,"aria-label":`Back navigation`,children:(0,P.jsx)(le,{className:`sf-back`,to:`/keystream`,...r,children:`← Back to Keystream`})}),(0,P.jsx)(`h1`,{id:`glyph-stream-title`,children:`Memory Stream`}),(0,P.jsx)(Gn,{}),v&&h?(0,P.jsx)(Os,{token:h,payload:v,manifest:Ee,copied:De,onKopy:Ae,isSealed:U,unsealState:S,canUnseal:ye,verifiedThisSession:E,hasComposerMeta:!!F,onVerifiedNow:re,onResetVerified:ae,onUnseal:be,onForgetUnsealed:W,body:Ce,caption:we}):ee?(0,P.jsx)(`div`,{className:`sf-error`,role:`alert`,children:ee}):(0,P.jsxs)(`p`,{className:`sf-sub`,children:[`Open a payload link at `,(0,P.jsx)(`code`,{children:`/stream/p/<token>`}),` (or `,(0,P.jsx)(`code`,{children:`/stream#t=<token>`}),`). Replies are Kai-sealed and thread via `,(0,P.jsx)(`code`,{children:`#add=`}),`. Short alias accepted: `,(0,P.jsx)(`code`,{children:`/p~<token>`}),` `,`(and legacy `,(0,P.jsx)(`code`,{children:`/p#t=`}),`, `,(0,P.jsx)(`code`,{children:`/p?t=`}),`, `,(0,P.jsx)(`code`,{children:`/stream?p=`}),`).`]}),!v&&(0,P.jsx)(`section`,{className:`sf-inhaler`,"aria-labelledby":`inhaler-title`,children:(0,P.jsx)(Ye,{onAdd:ge})}),(0,P.jsx)(Fe,{phiKey:pe,kaiSignature:me}),Ne?.node?(0,P.jsx)(`section`,{className:`sf-sigilWrap`,"aria-label":`Sigil stage`,children:(0,P.jsx)(`div`,{className:`sf-sigilWrap__inner`,children:Ne.node})}):null,v&&!xe?(0,P.jsxs)(`section`,{className:`sf-reply`,"aria-labelledby":`reply-title`,children:[(0,P.jsx)(`h2`,{id:`reply-title`,className:`sf-reply-title`,children:`Reply`}),E?F?(0,P.jsx)(tn,{meta:F,svgText:I,onUseDifferentKey:ae}):(0,P.jsx)(`div`,{className:`sf-error`,role:`alert`,children:`Verified, but no sigil metadata found. Re-inhale your glyph.`}):(0,P.jsxs)(`div`,{className:`sf-reply-login`,children:[(0,P.jsx)(`p`,{className:`sf-sub`,children:`Inhale ΦKey to resonate a reply.`}),(0,P.jsx)(ne,{onVerified:re})]})]}):null]}),(0,P.jsx)(`section`,{className:`sf-list`,children:Me.length===0?(0,P.jsxs)(`div`,{className:`sf-empty`,children:[`No items yet. Paste a link above or open a `,(0,P.jsx)(`code`,{children:`/stream/p/<payload>`}),` link and reply to start a thread.`]}):(0,P.jsx)(Ha,{urls:Me})})]})}var js=ks;export{js as n,ks as t};