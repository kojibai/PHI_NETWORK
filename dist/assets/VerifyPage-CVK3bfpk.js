import{Rr as e,Wr as t,a as n,bt as r,c as i,l as a,s as o,st as s}from"./index-Bh1kRmLo.js";import{a as c,c as l,d as u,f as d,i as f,o as p,p as m,r as h,s as g,u as _}from"./webauthnKAS-C9sgo0dc.js";import"./prop-types-CHBpIKH2.js";import{t as v}from"./VerifierFrame-UDoTu9Rl.js";var y=t(e(),1);function b(e){let t=decodeURIComponent(e||``).trim(),n=t.match(/^(\d+)-([A-Za-z0-9]+)$/);if(!n)return{raw:t,pulse:null,shortSig:null};let r=Number(n[1]);return{raw:t,pulse:Number.isFinite(r)&&r>0?r:null,shortSig:n[2]?String(n[2]):null}}function x(e,t){return e.length<=t?e:e.slice(0,t)}async function S(e,t){try{let n=o(t),r=(n.kaiSignature??``).trim();if(!r)return{status:`error`,message:`No kaiSignature found in the SVG metadata.`,slug:e,embedded:n};let i=await s(r),a=(n.phiKey??``).trim(),c=n.pulseExact,l=c&&Number.isFinite(Number(c))?Number(c):n.pulse,u={hasSignature:!0,slugPulseMatches:e.pulse==null||l==null?null:e.pulse===l,slugShortSigMatches:e.shortSig==null?null:e.shortSig===x(r,e.shortSig.length),derivedPhiKeyMatchesEmbedded:a.length===0?null:i===a};return u.slugPulseMatches===!1||u.slugShortSigMatches===!1||u.derivedPhiKeyMatchesEmbedded===!1?{status:`error`,message:`Verification failed: one or more checks did not match.`,slug:e,embedded:n,derivedPhiKey:i,checks:u}:{status:`ok`,slug:e,embedded:{...n,pulse:l??n.pulse,phiKey:a.length>0?a:i},derivedPhiKey:i,checks:u}}catch(t){return{status:`error`,message:t instanceof Error?t.message:`Verification failed.`,slug:e}}}var C=t(r(),1);function w(e){if(e==null)return`—`;if(typeof e==`string`)return e;try{return JSON.stringify(e,null,2)}catch{return String(e)}}function T(){if(typeof window>`u`)return``;let e=window.location.pathname||``,t=window.location.hash||``,n=e.match(/\/verify\/([^/?#]+)/);if(n&&n[1])return n[1];let r=t.match(/\/verify\/([^/?#]+)/);return r&&r[1]?r[1]:``}async function E(e){return await new Promise((t,n)=>{let r=new FileReader;r.onerror=()=>n(Error(`Failed to read file.`)),r.onload=()=>t(String(r.result??``)),r.readAsText(e)})}function D(){let e=(0,y.useMemo)(()=>T(),[]),t=(0,y.useMemo)(()=>b(e),[e]),[r,o]=(0,y.useState)(``),[s,f]=(0,y.useState)({status:`idle`}),[x,D]=(0,y.useState)(!1),[O,k]=(0,y.useState)(null),[A,j]=(0,y.useState)(``),[M,N]=(0,y.useState)(``),[P,F]=(0,y.useState)(``),[I,L]=(0,y.useState)(null),[R,z]=(0,y.useState)(``),[B,V]=(0,y.useState)(null),[H,U]=(0,y.useState)(null),[W,G]=(0,y.useState)(null),K=(0,y.useMemo)(()=>I||(s.status!==`ok`||!s.embedded.zkProof&&!s.embedded.zkPublicInputs&&!s.embedded.zkPoseidonHash&&!s.embedded.proofHints?null:{zkPoseidonHash:s.embedded.zkPoseidonHash,zkProof:s.embedded.zkProof,zkPublicInputs:s.embedded.zkPublicInputs,proofHints:s.embedded.proofHints}),[I,s]),q=(0,y.useMemo)(()=>K?.zkProof?w(K.zkProof):``,[K]),J=(0,y.useMemo)(()=>K?.proofHints?w(K.proofHints):``,[K]),Y=(0,y.useMemo)(()=>K?.zkPublicInputs?w(K.zkPublicInputs):``,[K]),X=(0,y.useMemo)(()=>({pulse:t.pulse??0,kaiSignature:t.shortSig??`unknown-signature`,phiKey:`—`}),[t.pulse,t.shortSig]),Z=(0,y.useMemo)(()=>O?l(O.pulse,O.kaiSignature):``,[O]),Q=(0,y.useCallback)(async()=>{let e=r.trim();if(!e){f({status:`error`,message:`Paste the sealed SVG text or upload the sealed SVG file first.`,slug:t});return}D(!0);try{f(await S(t,e))}finally{D(!1)}},[t,r]),$=(0,y.useCallback)(async(e,t)=>{if(e)try{if(!navigator.clipboard?.writeText){z(`Clipboard unavailable. Use manual copy.`);return}await navigator.clipboard.writeText(e),z(`${t} copied.`)}catch(e){z(`Copy failed. Use manual copy.`),console.error(e)}},[]);y.useEffect(()=>{let e=!0;return(async()=>{if(s.status!==`ok`){k(null),j(``),N(``),F(``),L(null),V(null),z(``);return}let t=s.embedded.kaiSignature??``,n=s.embedded.pulse??s.slug.pulse??0,o={v:`KPV-1`,pulse:n,chakraDay:m(s.embedded.chakraDay??``)??`Crown`,kaiSignature:t,phiKey:s.derivedPhiKey,verifierSlug:g(n,t)},c=await d(r),l=i(r),f=l?.proofCapsule??o,v=await u(f),y=await _(p(l?.raw&&typeof l.raw==`object`&&l.raw!==null?{...l.raw,svgHash:c,capsuleHash:v,proofCapsule:f}:{hashAlg:l?.hashAlg??`sha256`,canon:l?.canon??`JCS`,proofCapsule:f,capsuleHash:v,svgHash:c,shareUrl:l?.shareUrl,verifierUrl:l?.verifierUrl,zkPoseidonHash:l?.zkPoseidonHash,zkProof:l?.zkProof,proofHints:l?.proofHints,zkPublicInputs:l?.zkPublicInputs,authorSig:l?.authorSig??null})),b=l?.authorSig,x=b?a(b)?await h(y,b):!1:null;e&&(k(f),N(c),j(v),F(y),L(l),V(x))})(),()=>{e=!1}},[s,t.raw,r]),y.useEffect(()=>{let e=!0;return(async()=>{if(!K?.zkProof||!K?.zkPublicInputs){e&&U(null);return}if(!W)try{let t=await fetch(`/zk/verification_key.json`,{cache:`no-store`});if(!t.ok)return;let n=await t.json();if(!e)return;G(n)}catch{return}let t=typeof K.zkPublicInputs==`string`?(()=>{try{return JSON.parse(K.zkPublicInputs)}catch{return[K.zkPublicInputs]}})():K.zkPublicInputs,r=await n({proof:K.zkProof,publicSignals:t,vkey:W??void 0,fallbackVkey:W??void 0});e&&U(r)})(),()=>{e=!1}},[K,W]);let ee=(0,y.useCallback)(async e=>{if(!e.name.toLowerCase().endsWith(`.svg`)){f({status:`error`,message:`Upload a sealed .svg (this verifier reads embedded <metadata> JSON).`,slug:t});return}o(await E(e)),f({status:`idle`})},[t]);return(0,C.jsxs)(`div`,{className:`verify-page`,children:[(0,C.jsxs)(`header`,{className:`verify-hero`,children:[(0,C.jsx)(`h1`,{className:`verify-title`,children:`Kai-Sigil Verifier`}),(0,C.jsx)(`p`,{className:`verify-subtitle`,children:`Open a sealed memory and verify its human origin by Kai Signature → Φ-Key.`}),(0,C.jsxs)(`div`,{className:`verify-slug`,children:[(0,C.jsx)(`span`,{className:`verify-slug-label`,children:`Link:`}),(0,C.jsxs)(`code`,{className:`verify-slug-value`,children:[`/verify/`,t.raw||`—`]})]})]}),(0,C.jsxs)(`main`,{className:`verify-main`,children:[(0,C.jsxs)(`section`,{className:`verify-card`,children:[(0,C.jsx)(`h2`,{className:`verify-card-title`,children:`1) Provide the sealed post`}),(0,C.jsxs)(`div`,{className:`verify-upload-row`,children:[(0,C.jsxs)(`label`,{className:`verify-upload`,children:[(0,C.jsx)(`input`,{type:`file`,accept:`.svg,image/svg+xml`,onChange:e=>{let t=e.currentTarget.files?.[0];t&&ee(t),e.currentTarget.value=``}}),`Upload sealed SVG`]}),(0,C.jsx)(`button`,{type:`button`,className:`verify-btn`,onClick:()=>void Q(),disabled:x,children:x?`Verifying…`:`Verify`})]}),(0,C.jsx)(`textarea`,{className:`verify-textarea`,value:r,onChange:e=>{o(e.currentTarget.value),f({status:`idle`})},placeholder:`Or paste the sealed SVG text here (must include <metadata>{...}</metadata> with kaiSignature + pulse + userPhiKey/phiKey).`,spellCheck:!1})]}),(0,C.jsxs)(`section`,{className:`verify-card`,children:[(0,C.jsx)(`h2`,{className:`verify-card-title`,children:`2) Proof capsule`}),s.status===`ok`?(0,C.jsx)(v,{pulse:s.embedded.pulse??t.pulse??0,kaiSignature:s.embedded.kaiSignature??t.shortSig??`unknown`,phiKey:s.derivedPhiKey,chakraDay:s.embedded.chakraDay,compact:!1}):(0,C.jsx)(v,{pulse:X.pulse,kaiSignature:X.kaiSignature,phiKey:X.phiKey,compact:!1}),(0,C.jsx)(`div`,{className:`verify-status`,children:s.status===`idle`?(0,C.jsx)(`p`,{className:`verify-muted`,children:`Upload/paste a sealed SVG, then click Verify.`}):s.status===`ok`?(0,C.jsxs)(`div`,{className:`verify-ok`,children:[(0,C.jsx)(`div`,{className:`verify-badge verify-badge--ok`,children:`Verified`}),(0,C.jsxs)(`p`,{className:`verify-line`,children:[`Sealed by Φ-Key: `,(0,C.jsx)(`code`,{children:s.derivedPhiKey})]}),(0,C.jsxs)(`ul`,{className:`verify-checks`,children:[(0,C.jsxs)(`li`,{children:[`slug pulse match:`,` `,(0,C.jsx)(`strong`,{children:s.checks.slugPulseMatches===null?`n/a`:String(s.checks.slugPulseMatches)})]}),(0,C.jsxs)(`li`,{children:[`slug shortSig match:`,` `,(0,C.jsx)(`strong`,{children:s.checks.slugShortSigMatches===null?`n/a`:String(s.checks.slugShortSigMatches)})]}),(0,C.jsxs)(`li`,{children:[`derived Φ-Key matches embedded:`,` `,(0,C.jsx)(`strong`,{children:s.checks.derivedPhiKeyMatchesEmbedded===null?`n/a (embed omitted phiKey)`:String(s.checks.derivedPhiKeyMatchesEmbedded)})]})]}),O?(0,C.jsxs)(`div`,{className:`verify-proof`,children:[(0,C.jsx)(`h3`,{className:`verify-proof-title`,children:`3) Proof bundle (capsule + SVG)`}),(0,C.jsx)(`p`,{className:`verify-proof-note`,children:`Deterministic capsule hash (capsuleHash) + SVG hash (svgHash) → bundleHash.`}),(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`Hash algorithm`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:c}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(c,`Hash algorithm`),children:`Copy`})]}),(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`Canonicalization`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:`JCS`}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(`JCS`,`Canonicalization`),children:`Copy`})]}),(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`Verifier URL`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:Z||`—`}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(Z,`Verifier URL`),disabled:!Z,children:`Copy`})]}),(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`SVG hash`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:M}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(M,`SVG hash`),children:`Copy`})]}),(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`Capsule hash`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:A}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(A,`Capsule hash`),children:`Copy`})]}),(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`Bundle hash`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:P}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(P,`Bundle hash`),children:`Copy`})]}),K?.zkPoseidonHash&&(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`ZK Poseidon hash`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:K.zkPoseidonHash}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(K.zkPoseidonHash??``,`ZK Poseidon hash`),children:`Copy`})]}),q&&(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`ZK proof`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:q}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(q,`ZK proof`),children:`Copy`})]}),Y&&(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`ZK public inputs`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:Y}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(Y,`ZK public inputs`),children:`Copy`})]}),J&&(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`Proof hints`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:J}),(0,C.jsx)(`button`,{type:`button`,className:`verify-copy-btn`,onClick:()=>void $(J,`Proof hints`),children:`Copy`})]}),H!==null&&(0,C.jsxs)(`div`,{className:`verify-proof-row`,children:[(0,C.jsx)(`span`,{className:`verify-proof-label`,children:`Groth16 verify`}),(0,C.jsx)(`code`,{className:`verify-proof-code`,children:H===null?`n/a`:H?`✓ verified`:`✕ invalid`})]}),(0,C.jsx)(`textarea`,{className:`verify-proof-textarea`,readOnly:!0,value:JSON.stringify({hashAlg:c,canon:`JCS`,proofCapsule:O,capsuleHash:A,svgHash:M,bundleHash:P,shareUrl:I?.shareUrl??null,verifierUrl:Z,authorSig:I?.authorSig??null,zkPoseidonHash:K?.zkPoseidonHash??null,zkProof:K?.zkProof??null,proofHints:K?.proofHints??null,zkPublicInputs:K?.zkPublicInputs??null},null,2)}),I?(0,C.jsxs)(`ul`,{className:`verify-checks`,children:[(0,C.jsxs)(`li`,{children:[`embedded hashAlg match:`,` `,(0,C.jsx)(`strong`,{children:I.hashAlg?String(I.hashAlg===c):`n/a`})]}),(0,C.jsxs)(`li`,{children:[`embedded canon match:`,` `,(0,C.jsx)(`strong`,{children:I.canon?String(I.canon===`JCS`):`n/a`})]}),(0,C.jsxs)(`li`,{children:[`embedded svgHash match:`,` `,(0,C.jsx)(`strong`,{children:I.svgHash?String(I.svgHash===M):`n/a`})]}),(0,C.jsxs)(`li`,{children:[`embedded capsuleHash match:`,` `,(0,C.jsx)(`strong`,{children:I.capsuleHash?String(I.capsuleHash===A):`n/a`})]}),(0,C.jsxs)(`li`,{children:[`embedded bundleHash match:`,` `,(0,C.jsx)(`strong`,{children:I.bundleHash?String(I.bundleHash===P):`n/a`})]}),(0,C.jsxs)(`li`,{children:[`author signature present:`,` `,(0,C.jsx)(`strong`,{children:I.authorSig?`true`:`false`})]}),(0,C.jsxs)(`li`,{children:[`author signature verified:`,` `,(0,C.jsx)(`strong`,{children:B===null?`n/a`:String(B)})]})]}):(0,C.jsx)(`p`,{className:`verify-proof-note`,children:`No embedded proof bundle detected in <metadata id="kai-voh-proof">.`}),R?(0,C.jsx)(`p`,{className:`verify-proof-note`,children:R}):null]}):null]}):(0,C.jsxs)(`div`,{className:`verify-fail`,children:[(0,C.jsx)(`div`,{className:`verify-badge verify-badge--fail`,children:`Not verified`}),(0,C.jsx)(`p`,{className:`verify-line`,children:s.message}),s.checks?(0,C.jsxs)(`ul`,{className:`verify-checks`,children:[(0,C.jsxs)(`li`,{children:[`slug pulse match:`,` `,(0,C.jsx)(`strong`,{children:s.checks.slugPulseMatches===null?`n/a`:String(s.checks.slugPulseMatches)})]}),(0,C.jsxs)(`li`,{children:[`slug shortSig match:`,` `,(0,C.jsx)(`strong`,{children:s.checks.slugShortSigMatches===null?`n/a`:String(s.checks.slugShortSigMatches)})]}),(0,C.jsxs)(`li`,{children:[`derived Φ-Key matches embedded:`,` `,(0,C.jsx)(`strong`,{children:s.checks.derivedPhiKeyMatchesEmbedded===null?`n/a (embed omitted phiKey)`:String(s.checks.derivedPhiKeyMatchesEmbedded)})]})]}):null]})})]})]})]})}export{D as default};