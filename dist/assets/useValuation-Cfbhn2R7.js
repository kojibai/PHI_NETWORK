import{Br as e,Cr as t,Er as n,Lr as r,Sr as i,Tr as a,_r as o,ai as s,br as c,di as l,gr as u,hr as d,mr as f,vr as p,wr as m,xr as h,yr as g}from"./index-B36chFNg.js";var _=l(s(),1);function v(){let[t,n]=(0,_.useState)(null),[i,a]=(0,_.useState)(r),o=(0,_.useRef)(null),s=(0,_.useRef)(null);return(0,_.useEffect)(()=>{let t=null,i=()=>{let t=e(new Date),i=Date.now();if(s.current==null||t.pulse!==s.current)s.current=t.pulse,o.current=i,n(t.pulse),a(r);else{let e=o.current,s=e==null?r:Math.max(0,r-(i-e));n(t.pulse),a(s)}};return t=window.setInterval(i,50),i(),()=>{t!=null&&window.clearInterval(t)}},[]),{pulse:t,msToNextPulse:i}}function y(){return(0,_.useMemo)(()=>async e=>{let t=new TextEncoder().encode(e),n=await crypto.subtle.digest(`SHA-256`,t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,`0`)).join(``)},[])}function b({payload:e,urlSearchParams:r,currentPulse:s}){let[l,v]=(0,_.useState)(null),[b,x]=(0,_.useState)(null),[S,C]=(0,_.useState)(null),w=(0,_.useRef)(null),T=(0,_.useRef)(null),E=y(),D=r?.get(`vpol`)??``;(0,_.useEffect)(()=>{let t=!0;return(async()=>{if(!e||!Number.isFinite(s??NaN)){if(!t)return;v(e=>e===null?e:null),x(e=>e===null?e:null),C(e=>e===null?e:null),w.current=null,T.current=null;return}let{seal:n}=await f({pulse:e.pulse,kaiPulse:e.pulse,beat:e.beat,stepIndex:e.stepIndex,stepsPerBeat:e.stepsPerBeat,seriesSize:e.seriesSize,quality:e.quality,creatorVerified:e.creatorVerified,creatorRep:e.creatorRep,frequencyHz:e.frequencyHz,chakraDay:e.chakraDay,chakraGate:e.chakraGate,transfers:e.transfers,cumulativeTransfers:e.cumulativeTransfers,segments:e.segments,segmentsMerkleRoot:e.segmentsMerkleRoot,transfersWindowRoot:e.transfersWindowRoot,ip:e.ip,kaiSignature:e.kaiSignature,userPhiKey:e.userPhiKey,valuationPolicyId:D||void 0},s,E);if(!t)return;T.current!==n.stamp&&(v(e=>e&&e.stamp===n.stamp?e:n),T.current=n.stamp);let r=n.valuePhi,i=w.current;i!==r&&(x(e=>e===r?e:r),i!=null&&Math.abs(r-i)>1e-9?C(e=>e===`up`&&r>i?e:r>i?`up`:`down`):C(e=>e===null?e:null),w.current=r)})(),()=>{t=!1}},[e,s,D,E]);let O=(0,_.useMemo)(()=>e?.pulse,[e]),k=(0,_.useMemo)(()=>Number.isFinite(O??NaN)?{score:h(O),lines:g(O)}:{score:null,lines:[]},[O]),A=(0,_.useMemo)(()=>{if(!Number.isFinite(O??NaN)||!Number.isFinite(s??NaN))return null;let t=l?.inputs?.pulsesPerBeat?Math.max(1,Math.round(l.inputs.pulsesPerBeat/11)):e?.stepsPerBeat??44,n=l?.inputs?.cadenceRegularity??1,r=l?.inputs?.resonancePhi??.5,i=e?.stepIndex;return p(O,s,{stepsPerBeat:t,cadenceRegularity:n,resonancePhi:r,stepIndexClaimOverride:i})},[O,s,l,e]),j=(0,_.useMemo)(()=>{let t=e?.transfers;return!t||!t.length?[`No closed transfers yet â€” lineage still forming.`]:o(t,{stepsPerBeat:e?.stepsPerBeat??44})},[e]);return{valSeal:l,livePrice:b,priceFlash:S,rarity:k,oscillation:A,lineageNarrative:j,trust:(0,_.useMemo)(()=>l?u(l.inputs):null,[l]),marketTier:(0,_.useMemo)(()=>Number.isFinite(O??NaN)?d(O,l??void 0):null,[O,l]),kairos:(0,_.useMemo)(()=>Number.isFinite(s??NaN)?{window:a(s,144,1,{stepsPerBeat:e?.stepsPerBeat??44})}:{window:[]},[s,e]),visuals:(0,_.useMemo)(()=>{if(!l||!Number.isFinite(O??NaN))return{spiralSVG:null,scrollSVG:null,scrollText:null,scrollHTML:null};let e=i(O),{scrollSVG:r,scrollText:a}=n(l,{title:`Kai-Sigil Valuation Scroll`});return{spiralSVG:e,scrollSVG:r,scrollText:a,scrollHTML:t(l,{title:`Kai-Sigil Valuation Scroll`})}},[l,O]),audio:(0,_.useMemo)(()=>{if(!Number.isFinite(O??NaN))return{dataURI:null,renderWav:void 0};let{dataURI:e}=m(O,2,44100,{stereo:!0});return{dataURI:e,renderWav:(e=2,t=44100,n)=>m(O,e,t,n)}},[O]),motifSimilarityWith:(0,_.useMemo)(()=>e=>!Number.isFinite(e??NaN)||!Number.isFinite(O??NaN)?null:c(O,e),[O]),helpers:(0,_.useMemo)(()=>({explainRarity:()=>k.lines,explainLineage:()=>j,scanKairos:(t,n,r=1,i)=>a(t,n,r,{stepsPerBeat:i??e?.stepsPerBeat??44}),makeScroll:e=>l?n(l,{title:e??`Kai-Sigil Valuation Scroll`}):null,makeScrollHTML:e=>l?t(l,{title:e}):null,makeSpiral:e=>Number.isFinite(e??O)?i(e??O):null}),[k.lines,j,e,l,O])}}export{v as n,b as t};