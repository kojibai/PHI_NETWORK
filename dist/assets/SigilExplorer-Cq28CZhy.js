import{$t as e,At as t,Bt as n,Cr as r,Ct as i,Dt as a,Et as o,Ft as s,Gt as c,Ht as l,It as u,Jt as d,Kt as f,Lt as p,Mr as m,Mt as h,Nt as g,Ot as _,Pt as v,Qt as y,Rr as b,Rt as x,Sn as S,St as C,Tt as ee,Ut as w,Vt as T,Wt as E,Xt as D,Yt as O,Zt as te,_n as ne,_t as re,bt as k,en as ie,gt as ae,ht as oe,i as se,jt as A,kt as ce,mt as j,n as le,qt as ue,r as M,t as de,tn as fe,vt as N,wt as pe,xt as P,yn as me,yt as he,zt as F}from"./index-CQRe4NZj.js";var I=b(m(),1);const L={root:`#ff3b3b`,sacral:`#ff8a3d`,solar:`#ffd54a`,heart:`#3dff9a`,throat:`#46d3ff`,thirdEye:`#6b6cff`,crown:`#c18bff`};function R(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`root`)?`root`:t.includes(`sacral`)?`sacral`:t.includes(`solar`)||t.includes(`plexus`)||t.includes(`sun`)?`solar`:t.includes(`heart`)?`heart`:t.includes(`throat`)?`throat`:t.includes(`third`)||t.includes(`eye`)||t.includes(`indigo`)?`thirdEye`:t.includes(`crown`)||t.includes(`krown`)||t.includes(`violet`)?`crown`:t===`1`?`root`:t===`2`?`sacral`:t===`3`?`solar`:t===`4`?`heart`:t===`5`?`throat`:t===`6`?`thirdEye`:t===`7`?`crown`:null:null}function z(e){let t=R(e),n=t?L[t]:`var(--sx-accent)`;return{"--sx-chakra":n}}function B(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function V(e){if(typeof e==`number`)return!Number.isFinite(e)||Math.abs(e)<1e-12?void 0:Math.abs(e);if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&Math.abs(t)>=1e-12)return Math.abs(t)}}function H(e){if(typeof e!=`string`)return null;let t=e.trim().toLowerCase();return t?t.includes(`receive`)||t.includes(`received`)||t.includes(`inhale`)?`receive`:t.includes(`send`)||t.includes(`sent`)||t.includes(`exhale`)?`send`:null:null}function U(e){if(typeof e==`number`)return!Number.isFinite(e)||e<=0?void 0:e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function W(e){if(typeof e==`number`&&Number.isFinite(e)&&e>0)return e;if(typeof e==`string`){let t=Number(e);if(!Number.isNaN(t)&&t>0)return t}}function G(e){let t=e,n=B(t.feed)?t.feed:null,r=e=>e?H(e.phiDirection)||H(e.transferDirection)||H(e.transferMode)||H(e.transferKind):null,i=e=>{if(e)return e.phiDelta??e.phiSigned??e.phiChange},a=e=>e?V(e.transferAmountPhi)??V(e.transferPhi)??V(e.amountPhi)??V(e.phiAmount)??V(e.childAllocationPhi)??V(e.branchBasePhi):void 0,o=e=>e?U(e.amountUsd)??U(e.usdAmount)??U(e.usdValue)??U(e.valueUsd)??U(e.usd):void 0,s=e=>e?U(e.usdPerPhi)??U(e.fxUsdPerPhi)??U(e.usd_per_phi):void 0,c=e=>e?W(e.atPulse)??W(e.sentPulse)??W(e.senderKaiPulse)??W(e.transferPulse):void 0,l=r(t)??r(n),u=i(t)??i(n),d=typeof u==`number`?u:void 0;d===void 0&&typeof u==`string`&&(d=Number(u));let f=l??(typeof d==`number`&&Number.isFinite(d)?d>=0?`receive`:`send`:null);if(!f)return;let p=a(t)??a(n)??(B(t.preview)?V(t.preview.amountPhi):void 0)??(B(n?.preview)?V(n.preview.amountPhi):void 0)??(typeof d==`number`&&Number.isFinite(d)?Math.abs(d):void 0);if(p===void 0)return;let m=o(t)??o(n)??(B(t.preview)?U(t.preview.amountUsd):void 0)??(B(n?.preview)?U(n.preview.amountUsd):void 0),h=s(t)??s(n)??(B(t.preview)?U(t.preview.usdPerPhi):void 0)??(B(n?.preview)?U(n.preview.usdPerPhi):void 0),g=c(t)??c(n)??(B(t.preview)?W(t.preview.atPulse):void 0)??(B(n?.preview)?W(n.preview.atPulse):void 0);return{direction:f,amount:p,amountUsd:m??(h===void 0?void 0:p*h),sentPulse:g,source:`payload`}}function K(e){for(let t of[`transferUrl`,`transferURL`,`transferLink`,`transfer_link`,`sealUrl`,`sealURL`,`sigilTransferUrl`]){let r=e[t];if(typeof r!=`string`||!r.trim())continue;let i=n(r.trim());if(!i)continue;let a=G(i);if(a)return a}}function ge(e,t){if(!e)return;let n=t.get(e.toLowerCase());if(!n)return;let r=V(n.amountPhi);if(r!==void 0)return{direction:n.direction,amount:r,amountUsd:U(n.amountUsd),sentPulse:W(n.sentPulse),source:`registry`}}function _e(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function ve(e,t){if(!_e(e))return;let n=e[t];return typeof n==`string`&&n.trim().length>0?n.trim():void 0}function q(e){let n=new Map,r=new Map;for(let[i,a]of e){let e=u(i),o=x(e),s=p(e,a),c=w(e,a);n.set(e,s);let l=r.get(s);if(!l){r.set(s,{payload:a,urls:new Set([e]),kind:o,momentKey:c});continue}t(a,l.payload)>0&&(l.payload=a),l.urls.add(e);let d=l.momentKey,f=c;d.startsWith(`u:`)&&!f.startsWith(`u:`)&&(l.momentKey=f),d.startsWith(`h:`)&&(f.startsWith(`k:`)||f.startsWith(`sig:`)||f.startsWith(`tok:`))&&(l.momentKey=f)}let i=new Map;for(let[e,t]of r){let n=c(Array.from(t.urls),t.kind);i.set(e,{id:e,payload:t.payload,urls:t.urls,primaryUrl:n,kind:t.kind,momentKey:t.momentKey})}let a=new Map;for(let e of i.values()){let t=e.momentKey;a.has(t)||a.set(t,[]),a.get(t).push(e.id)}let o=new Map,s=new Map,l=new Map;for(let[e,t]of a){let n=t.map(e=>i.get(e)).filter(Boolean),r=n.filter(e=>e.kind===`post`),a;a=r.length>0?r.slice().sort((e,t)=>f(t.primaryUrl,`post`)-f(e.primaryUrl,`post`))[0]:n.slice().sort((e,t)=>f(t.primaryUrl,t.kind)-f(e.primaryUrl,e.kind))[0];let c=a?.id??t[0];o.set(e,c);for(let e of t)s.set(e,c);for(let e of t){let t=i.get(e);if(t)for(let e of t.urls)l.set(e,c)}}let d=new Map;for(let e of i.values()){let t=s.get(e.id)??e.id;if(e.id!==t)continue;let r=ve(e.payload,`originUrl`),i=r?u(r):T(e.primaryUrl)??e.primaryUrl,a=n.get(i),o=l.get(i)??(a?s.get(a):void 0);d.set(t,o??t)}let m=new Map;for(let e of i.values()){let t=s.get(e.id)??e.id,r=d.get(t)??t,i;if(e.id!==t)i=t;else{let t=ve(e.payload,`parentUrl`);if(t){let r=u(t),a=n.get(r),o=l.get(r)??(a?s.get(a):void 0);o&&o!==e.id&&(i=o)}}m.set(e.id,{id:e.id,payload:e.payload,urls:e.urls,primaryUrl:e.primaryUrl,kind:e.kind,momentKey:e.momentKey,parentId:i,originId:r,momentParentId:t})}return m}function ye(e,n){let r=[];for(let[t,i]of n)i.parentId===e&&r.push(t);return r.sort((e,r)=>t(n.get(r).payload,n.get(e).payload)),r}function be(e,t,n=new Set){let r=t.get(e);if(!r)return null;if(n.has(e))return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:[]};n.add(e);let i=ye(e,t).map(e=>be(e,t,n)).filter(Boolean);return{id:r.id,url:r.primaryUrl,urls:Array.from(r.urls),payload:r.payload,children:i}}function J(e){let n=0,r=e.payload,i=e=>{n+=1,t(e.payload,r)>0&&(r=e.payload),e.children.forEach(i)};return i(e),{nodeCount:n,latest:r}}function xe(e){let n=q(e),r=new Map;for(let[e,t]of n){let n=t.originId;r.has(n)||r.set(n,[]),r.get(n).push(e)}let i=[];for(let e of r.keys()){let t=be(e,n);if(!t)continue;let r=J(t);i.push({root:t,nodeCount:r.nodeCount,latest:r.latest})}return i.sort((e,n)=>{let r=t(n.latest,e.latest);return r===0?n.nodeCount===e.nodeCount?t(n.root.payload,e.root.payload):n.nodeCount-e.nodeCount:r}),i.map(e=>e.root)}function Y(e){let t=e.payload;if(_e(t)&&typeof t.canonicalHash==`string`)return t.canonicalHash;let r=E(e.url);if(r)return r;for(let t of e.urls){let e=E(t);if(e)return e;let r=n(t);if(!r)continue;let i=r;if(_e(i)&&typeof i.canonicalHash==`string`)return i.canonicalHash}}var X=b(j(),1),Z=typeof window<`u`,Se=`sigil:explorer:open`,Ce=`sigil:explorer:bc:v1`,we=520,Te=900,Ee=80,Q=80,De=25e4,Oe=18,ke=3236,Ae=2e3;function je(){let e;for(let[,t]of P){let n=t.pulse;typeof n!=`number`||!Number.isFinite(n)||(e==null||n>e)&&(e=n)}return e}function Me(e){let t=e?.pulse??e?.latestPulse??e?.latest_pulse;if(!(typeof t!=`number`||!Number.isFinite(t)))return t}var Ne=`/phi.svg`;function $(){return Date.now()}function Pe(){return Z?new Promise(e=>{if(typeof window.requestAnimationFrame==`function`){window.requestAnimationFrame(()=>e());return}window.setTimeout(e,0)}):Promise.resolve()}function Fe(e){let t=(Z?window:null)?.CSS?.escape;return typeof t==`function`?t(e):e.replace(/["\\]/g,`\\$&`)}function Ie(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function Le(e,t){return Ie(e)&&typeof e[t]==`string`}function Re(e){if(!Z||typeof Worker>`u`||e.length<De)return Promise.resolve(JSON.parse(e));let t=null,n=``;try{let e=new Blob([`
    self.onmessage = (event) => {
      try {
        const parsed = JSON.parse(event.data);
        self.postMessage({ ok: true, value: parsed });
      } catch (err) {
        self.postMessage({ ok: false, error: err && err.message ? err.message : "parse-failed" });
      }
    };
  `],{type:`text/javascript`});n=URL.createObjectURL(e),t=new Worker(n)}catch{return n&&URL.revokeObjectURL(n),Promise.resolve(JSON.parse(e))}return new Promise((r,i)=>{let a=()=>{t?.terminate(),n&&URL.revokeObjectURL(n)};t.onmessage=e=>{let t=e.data;a(),t?.ok?r(t.value):i(Error(t?.error??`parse-failed`))},t.onerror=()=>{a(),i(Error(`parse-failed`))},t.postMessage(e)})}function ze(e,t){let r=ge(Y(e),t);if(r)return r;let i=G(e.payload);if(i)return i;let a=e.payload,o=K(a);if(o)return o;if(Ie(a.feed)){let e=K(a.feed);if(e)return e}for(let t of e.urls){let e=n(t);if(!e)continue;let r=G(e);if(r)return r;let i=K(e);if(i)return i}}function Be(e,t,n){let r=e.payload,i=[],a=new Set,o=g(e.payload);o!==void 0&&i.push({label:`This glyph Φ`,value:`${A(o)} Φ`});let c=ze(e,n);if(c){i.push({label:`Φ ${c.direction===`receive`?`Received`:`Sent`}`,value:`${c.direction===`receive`?`+`:`-`}${A(c.amount)} Φ`}),c.amountUsd!==void 0&&i.push({label:`USD value`,value:`$${h(c.amountUsd)}`}),c.sentPulse!==void 0&&i.push({label:`Sent pulse`,value:String(c.sentPulse)});let e=c;Le(e,`txHash`)&&i.push({label:`Tx hash`,value:e.txHash})}let u=r.feed,d=typeof u?.author==`string`?u.author:typeof r.author==`string`?r.author:void 0,f=u?u.usernameClaim:void 0,p=f?S(f.payload?.normalized||f.payload?.username||``):``,m=S(d??``),_=p||m;if(_){let e=t[_],n=typeof d==`string`&&d.trim().length>0?d.trim():`@${_}`;e?(i.push({label:`Username (claimed)`,value:`${n} → glyph ${v(e.claimHash,10)}`}),i.push({label:`Claim glyph`,value:s(e.claimUrl)})):i.push({label:`Username`,value:n})}let y=(e,t)=>{let n=r[e];typeof n==`string`&&n.trim().length>0&&!a.has(e)&&(i.push({label:t,value:n.trim()}),a.add(e))};y(`userPhiKey`,`PhiKey`),y(`phiKey`,`PhiKey`),y(`phikey`,`PhiKey`),y(`kaiSignature`,`Kai Signature`),typeof r.parentUrl==`string`&&r.parentUrl.length>0&&i.push({label:`Parent URL`,value:s(r.parentUrl)}),typeof r.originUrl==`string`&&r.originUrl.length>0&&i.push({label:`Origin URL`,value:s(r.originUrl)});let b=r.label??r.title??r.type??r.note??r.description;typeof b==`string`&&b.trim().length>0&&i.push({label:`Label / Type`,value:b.trim()}),i.push({label:`Primary URL`,value:s(e.url)});let x=e.urls.filter(e=>!l(e)).map(e=>s(e));return e.urls.length>1&&i.push({label:`URL variants`,value:x.length===0?`${e.urls.length} urls (kept in data; hidden from browser view)`:x.length<=3?x.join(` | `):`${e.urls.length} urls (kept in data; rendered once)`}),i.slice(0,12)}async function Ve(e){if(Z){try{if(navigator.clipboard&&typeof navigator.clipboard.writeText==`function`){await navigator.clipboard.writeText(e);return}}catch{}try{let t=document.createElement(`textarea`);t.value=e,t.setAttribute(`readonly`,`true`),t.style.position=`fixed`,t.style.left=`-9999px`,t.style.top=`-9999px`,document.body.appendChild(t),t.select(),document.execCommand(`copy`),document.body.removeChild(t)}catch{}}}async function He(e){if(Z)try{await fetch(e,{method:`GET`,cache:`force-cache`,mode:`cors`,credentials:`omit`,redirect:`follow`})}catch{}}function Ue({p:e}){let t=typeof e.pulse==`number`?e.pulse:0,n=typeof e.stepsPerBeat==`number`&&e.stepsPerBeat>0?e.stepsPerBeat:44,i=typeof e.stepIndex==`number`?e.stepIndex:typeof e.pulse==`number`?r(e.pulse,n):0,a=typeof e.beat==`number`?e.beat:0;return(0,X.jsxs)(`span`,{className:`k-stamp`,title:`pulse ${t} • beat ${a} • step ${i}`,children:[(0,X.jsxs)(`span`,{className:`k-pill`,children:[`☤KAI `,t]}),(0,X.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,X.jsxs)(`span`,{className:`k-pill`,children:[`beat `,a]}),(0,X.jsx)(`span`,{className:`k-dot`,children:`•`}),(0,X.jsxs)(`span`,{className:`k-pill`,children:[`step `,i]})]})}function We({node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a}){let o=t.has(e.id),s=Y(e),c=e.payload.kaiSignature,l=e.payload.chakraDay,u=typeof e.payload.pulse==`number`?e.payload.pulse:void 0,d=u==null?void 0:r.get(u),f=F(e.url),p=o?Be(e,i,a):[],m=ze(e,a);return(0,X.jsxs)(`div`,{className:`node`,style:z(l),"data-chakra":String(l??``),"data-node-id":e.id,children:[(0,X.jsxs)(`div`,{className:`node-row`,children:[(0,X.jsxs)(`div`,{className:`node-main`,children:[(0,X.jsx)(`button`,{className:`twirl`,"aria-label":o?`Collapse memories`:`Expand memories`,"aria-expanded":o,onClick:()=>n(e.id),title:o?`Collapse`:`Expand`,type:`button`,children:(0,X.jsx)(`span`,{className:`tw ${o?`open`:``}`})}),(0,X.jsx)(`a`,{className:`node-link`,href:f,target:`_blank`,rel:`noopener noreferrer`,title:f,children:(0,X.jsx)(`span`,{children:v(c??s??`glyph`,12)})})]}),(0,X.jsxs)(`div`,{className:`node-meta`,children:[(0,X.jsx)(Ue,{p:e.payload}),l&&(0,X.jsx)(`span`,{className:`chakra`,title:String(l),children:String(l)}),m&&(0,X.jsxs)(`span`,{className:`phi-move phi-move--${m.direction}`,title:`Φ ${m.direction===`receive`?`received`:`sent`}: ${A(m.amount)} Φ${m.amountUsd===void 0?``:` • $${h(m.amountUsd)}`}${m.sentPulse===void 0?``:` • sent pulse ${m.sentPulse}`}`,children:[(0,X.jsx)(`img`,{className:`phi-move__mark`,src:Ne,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`lazy`,draggable:!1}),(0,X.jsx)(`span`,{className:`phi-move__sign`,"aria-hidden":`true`,children:m.direction===`receive`?`+`:`-`}),(0,X.jsxs)(`span`,{className:`phi-move__amount`,children:[A(m.amount),` Φ`]}),m.amountUsd!==void 0&&(0,X.jsxs)(`span`,{className:`phi-move__usd`,children:[`$`,h(m.amountUsd)]})]}),d!==void 0&&(0,X.jsxs)(`span`,{className:`phi-pill`,title:`Total Φ on pulse ${e.payload.pulse??``}`,children:[`Φ pulse: `,A(d),`Φ`]}),(0,X.jsx)(`button`,{className:`node-copy`,"aria-label":`Copy URL`,onClick:()=>void Ve(f),title:`Copy URL`,type:`button`,children:`⧉`})]})]}),o&&(0,X.jsxs)(`div`,{className:`node-open`,children:[(0,X.jsx)(`div`,{className:`node-detail`,children:p.length===0?(0,X.jsx)(`div`,{className:`node-detail-empty`,children:`No additional memory fields recorded on this glyph.`}):(0,X.jsx)(`div`,{className:`node-detail-grid`,children:p.map(e=>(0,X.jsxs)(I.Fragment,{children:[(0,X.jsx)(`div`,{className:`detail-label`,children:e.label}),(0,X.jsx)(`div`,{className:`detail-value`,title:e.value,children:e.value})]},e.label))})}),e.children.length>0&&(0,X.jsx)(`div`,{className:`node-children`,"aria-label":`Memory Imprints`,children:e.children.map(e=>(0,X.jsx)(We,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a},e.id))})]})]})}function Ge({root:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a}){let o=(0,I.useMemo)(()=>{let t=0,n=e=>{t+=1,e.children.forEach(n)};return n(e),t},[e]),s=E(e.url),c=e.payload.kaiSignature,l=F(e.url),u=e.payload.chakraDay;return(0,X.jsxs)(`section`,{className:`origin`,"aria-label":`Sigil origin stream`,style:z(u),"data-chakra":String(u??``),"data-node-id":e.id,children:[(0,X.jsxs)(`header`,{className:`origin-head`,children:[(0,X.jsxs)(`div`,{className:`o-meta`,children:[(0,X.jsx)(`span`,{className:`o-title`,children:`Origin`}),(0,X.jsx)(`a`,{className:`o-link`,href:l,target:`_blank`,rel:`noopener noreferrer`,title:l,children:v(c??s??`origin`,14)}),u&&(0,X.jsx)(`span`,{className:`o-chakra`,title:String(u),children:String(u)})]}),(0,X.jsxs)(`div`,{className:`o-right`,children:[(0,X.jsx)(Ue,{p:e.payload}),(0,X.jsxs)(`span`,{className:`o-count`,title:`Total content keys in this lineage`,children:[o,` keys`]}),(0,X.jsx)(`button`,{className:`o-copy`,onClick:()=>void Ve(l),title:`Copy origin URL`,type:`button`,children:`Remember Origin`})]})]}),(0,X.jsx)(`div`,{className:`origin-body`,children:e.children.length===0?(0,X.jsx)(`div`,{className:`kx-empty`,children:`No memories yet. The stream begins here.`}):(0,X.jsx)(`div`,{className:`tree`,children:e.children.map(e=>(0,X.jsx)(We,{node:e,expanded:t,toggle:n,phiTotalsByPulse:r,usernameClaims:i,transferRegistry:a},e.id))})})]})}function Ke({onAdd:e,onImport:t,onExport:n,total:r,lastAdded:i}){let[a,o]=(0,I.useState)(``);return(0,X.jsx)(`div`,{className:`kx-toolbar`,role:`region`,"aria-label":`Explorer toolbar`,children:(0,X.jsxs)(`div`,{className:`kx-toolbar-inner`,children:[(0,X.jsxs)(`div`,{className:`kx-brand`,children:[(0,X.jsx)(`div`,{className:`kx-glyph`,"aria-hidden":!0,children:(0,X.jsx)(`img`,{className:`kx-glyph__mark`,src:Ne,alt:``,"aria-hidden":`true`,decoding:`async`,loading:`eager`,draggable:!1})}),(0,X.jsxs)(`div`,{className:`kx-title`,children:[(0,X.jsxs)(`h1`,{children:[`KAIROS `,(0,X.jsx)(`span`,{children:`Keystream`})]}),(0,X.jsx)(`div`,{className:`kx-tagline`,children:`Sovereign Lineage • No DB • Pure Φ`})]})]}),(0,X.jsxs)(`div`,{className:`kx-controls`,children:[(0,X.jsxs)(`form`,{className:`kx-add-form`,onSubmit:t=>{t.preventDefault(),a.trim()&&(e(a.trim()),o(``))},children:[(0,X.jsx)(`input`,{className:`kx-input`,placeholder:`Inhale a sigil (or memory)…`,spellCheck:!1,value:a,onChange:e=>o(e.target.value),"aria-label":`Sigil Key`}),(0,X.jsx)(`button`,{className:`kx-button`,type:`submit`,children:`Inhale`})]}),(0,X.jsxs)(`div`,{className:`kx-io`,role:`group`,"aria-label":`Import and export`,children:[(0,X.jsxs)(`label`,{className:`kx-import`,title:`Import a JSON list of Keys (or krystals)`,children:[(0,X.jsx)(`input`,{type:`file`,accept:`application/json`,onChange:e=>{let n=e.target.files?.[0];n&&t(n)},"aria-label":`Import JSON`}),`Inhale`]}),(0,X.jsx)(`button`,{className:`kx-export`,onClick:n,"aria-label":`Export registry to JSON`,type:`button`,children:`Exhale`})]}),(0,X.jsxs)(`div`,{className:`kx-stats`,"aria-live":`polite`,children:[(0,X.jsxs)(`span`,{className:`kx-pill`,title:`Total KEYS in registry (includes variants)`,children:[r,` KEYS`]}),i&&(0,X.jsxs)(`span`,{className:`kx-pill subtle`,title:i,children:[`Last: `,v(i,8)]})]})]})]})})}var qe=()=>{let[t,r]=(0,I.useState)(()=>he()?1:0),[c,l]=(0,I.useState)(0),[p,m]=(0,I.useState)(void 0),[h,v]=(0,I.useState)(()=>ne()),b=(0,I.useRef)(!1),S=(0,I.useRef)(new Set),T=(0,I.useRef)(null),E=(0,I.useRef)(!1),A=(0,I.useRef)(null),j=(0,I.useRef)(0),M=(0,I.useRef)(null),L=(0,I.useRef)(!1),R=(0,I.useRef)(void 0),z=(0,I.useRef)([]),B=(0,I.useRef)(null),V=(0,I.useCallback)(e=>{let t=$()+e;t>j.current&&(j.current=t)},[]),H=(0,I.useCallback)(()=>{if(!Z||b.current)return;let e=$(),t=j.current-e;if(t>0){M.current!=null&&window.clearTimeout(M.current),M.current=window.setTimeout(()=>{M.current=null,H()},t+Ee);return}let n=z.current.splice(0);if(n.length>0&&(0,I.startTransition)(()=>{v(e=>{let t=e;for(let e of n){let n=t[e.normalized];n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===(e.originHash??n.originHash)&&n.ownerHint===(e.ownerHint??n.ownerHint)||(t={...t,[e.normalized]:{...n,normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash??n?.originHash,ownerHint:e.ownerHint??n?.ownerHint??null,updatedAt:n?.updatedAt??0}})}return t})}),R.current!==void 0){let e=R.current;R.current=void 0,(0,I.startTransition)(()=>m(e))}L.current&&(L.current=!1,(0,I.startTransition)(()=>r(e=>e+1)))},[V]),U=(0,I.useCallback)(()=>{if(!Z||M.current!=null)return;let e=$(),t=j.current-e,n=Math.max(0,t)+Ee;M.current=window.setTimeout(()=>{M.current=null,H()},n)},[H]),W=(0,I.useCallback)(()=>{if(!b.current){if($()<j.current||E.current){L.current=!0,U();return}(0,I.startTransition)(()=>r(e=>e+1))}},[U]),G=(0,I.useCallback)(e=>{if(!b.current){if($()<j.current||E.current){R.current=e,U();return}(0,I.startTransition)(()=>m(e))}},[U]),K=(0,I.useRef)(null),[ge,_e]=(0,I.useState)(()=>new Set),ve=(0,I.useCallback)(e=>{V(Te);let t=T.current;if(t){let n=`[data-node-id="${Fe(e)}"]`,r=t.querySelector(n);K.current={id:e,scrollTop:t.scrollTop,rectTop:r?r.getBoundingClientRect().top:0}}_e(t=>{let n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n}),U()},[V,U]);(0,I.useEffect)(()=>{if(!Z)return;let e=document.documentElement,t=document.body,n=document.scrollingElement||document.documentElement,r={htmlOverscroll:e?.style.overscrollBehavior??``,htmlOverscrollY:e?.style.overscrollBehaviorY??``,bodyOverscroll:t?.style.overscrollBehavior??``,bodyOverscrollY:t?.style.overscrollBehaviorY??``,rootOverscroll:n?.style.overscrollBehavior??``,rootOverscrollY:n?.style.overscrollBehaviorY??``};return e&&(e.style.overscrollBehavior=`none`,e.style.overscrollBehaviorY=`none`),t&&(t.style.overscrollBehavior=`none`,t.style.overscrollBehaviorY=`none`),n&&(n.style.overscrollBehavior=`none`,n.style.overscrollBehaviorY=`none`),()=>{e&&(e.style.overscrollBehavior=r.htmlOverscroll,e.style.overscrollBehaviorY=r.htmlOverscrollY),t&&(t.style.overscrollBehavior=r.bodyOverscroll,t.style.overscrollBehaviorY=r.bodyOverscrollY),n&&(n.style.overscrollBehavior=r.rootOverscroll,n.style.overscrollBehaviorY=r.rootOverscrollY)}},[]),(0,I.useEffect)(()=>{if(!Z)return;let e=T.current;if(!e)return;let t=0,n=0,r=e=>{e.touches.length===1&&(t=e.touches[0]?.clientY??0,n=e.touches[0]?.clientX??0)},i=r=>{if(!r.cancelable||r.touches.length!==1)return;let i=r.touches[0]?.clientY??0,a=r.touches[0]?.clientX??0,o=i-t,s=a-n;if(t=i,n=a,Math.abs(o)<=Math.abs(s))return;let c=e.scrollHeight-e.clientHeight;if(c<=0)return;let l=e.scrollTop<=0,u=e.scrollTop>=c-1,d=o>0,f=o<0;(l&&d&&window.scrollY<=0||u&&f)&&r.preventDefault()};return e.addEventListener(`touchstart`,r,{passive:!0}),e.addEventListener(`touchmove`,i,{passive:!1}),()=>{e.removeEventListener(`touchstart`,r),e.removeEventListener(`touchmove`,i)}},[]),(0,I.useEffect)(()=>{if(!Z)return;let e=T.current;if(!e)return;let t=()=>{E.current=!0,V(we),A.current!=null&&window.clearTimeout(A.current),A.current=window.setTimeout(()=>{E.current=!1,A.current=null,U()},180)};return e.addEventListener(`scroll`,t,{passive:!0}),()=>{e.removeEventListener(`scroll`,t),A.current!=null&&window.clearTimeout(A.current),A.current=null,E.current=!1}},[V,U]),(0,I.useLayoutEffect)(()=>{let e=K.current;if(!e)return;K.current=null;let t=T.current;if(!t)return;let n=`[data-node-id="${Fe(e.id)}"]`,r=t.querySelector(n);if(!r)return;let i=r.getBoundingClientRect().top-e.rectTop;Number.isFinite(i)&&Math.abs(i)>1&&(t.scrollTop=Math.max(0,e.scrollTop+i))},[ge]);let q=(0,I.useRef)(null),ye=(0,I.useRef)(!1),be=(0,I.useRef)(null);(0,I.useEffect)(()=>{if(b.current=!1,e(),ie(),ue(),a(),he()&&W(),Z){let e=u(window.location.href);if(n(e)){let t=N(e,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0});G(s(e)),t&&W()}}let t=window.__SIGIL__?.registerSigilUrl,r=window.__SIGIL__?.registerSend;window.__SIGIL__||(window.__SIGIL__={}),window.__SIGIL__.registerSigilUrl=fe,window.__SIGIL__.registerSend=e=>{if(!e||typeof e!=`object`)return;let t=e.url;typeof t!=`string`||!t.trim()||N(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(G(s(t)),W())};let o=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&N(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(G(s(t)),W())};window.addEventListener(`sigil:url-registered`,o);let c=e=>{let t=e?.detail?.url;typeof t==`string`&&t.length&&N(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(G(s(t)),W())};window.addEventListener(`sigil:minted`,c);let d=Z&&`BroadcastChannel`in window?new BroadcastChannel(Ce):null,f=e=>{let t=e.data;t?.type===`sigil:add`&&typeof t.url==`string`&&N(t.url,{includeAncestry:!0,broadcast:!1,persist:!0,source:`local`,enqueueToApi:!0})&&(G(s(t.url)),W())};d?.addEventListener(`message`,f);let p=e=>{if(!e.key)return;let t=e.key===re,n=e.key===ae;if(e.key===`kai:sigil-transfer:v1`){l(e=>e+1);return}if(!(!t&&!n)&&e.newValue)try{let t=JSON.parse(e.newValue);if(!Array.isArray(t))return;let n=!1;for(let e of t)typeof e==`string`&&N(e,{includeAncestry:!0,broadcast:!1,persist:!1,source:`local`,enqueueToApi:!0})&&(n=!0);G(void 0),n&&(i(),W())}catch{}};window.addEventListener(`storage`,p);let m=()=>l(e=>e+1);window.addEventListener(le,m);let h=Z&&`BroadcastChannel`in window?new BroadcastChannel(de):null,g=e=>{e.data?.type===`transfer:update`&&l(e=>e+1)};h?.addEventListener(`message`,g);let x=()=>{_(),ee()};window.addEventListener(`pagehide`,x);let S=me(e=>{if($()<j.current||E.current){z.current.push({normalized:e.normalized,claimHash:e.claimHash,claimUrl:e.claimUrl,originHash:e.originHash,ownerHint:e.ownerHint}),U();return}(0,I.startTransition)(()=>{v(t=>{let n=t[e.normalized];return n&&n.claimHash===e.claimHash&&n.claimUrl===e.claimUrl&&n.originHash===e.originHash&&n.ownerHint===e.ownerHint?t:{...t,[e.normalized]:e}})})}),C=new AbortController,w=async e=>{b.current||k()&&(E.current||$()<j.current&&(e===`pulse`||e===`import`)||await ee())},T=async e=>{if(!b.current&&k()&&!ye.current&&!E.current&&!($()<j.current&&(e===`pulse`||e===`import`))){ye.current=!0;try{let t=q.current,n=await y(e=>new URL(te,e).toString(),{method:`GET`,cache:`no-store`,signal:C.signal,headers:void 0});if(!n||n.status===304||!n.ok)return;let r=``,i;try{let e=await n.json();r=typeof e?.seal==`string`?e.seal:``,i=Me(e)}catch{return}let a=i==null?void 0:je();if(t&&r&&t===r&&!(i!=null&&(a==null||i>a))){q.current=r;return}let o=await oe(C.signal);o.pulled&&(q.current=o.remoteSeal??r??t??null),o.imported>0&&(G(void 0),W());let s=q.current;(e===`open`||(e===`visible`||e===`focus`||e===`online`||e===`import`)&&s!==be.current)&&(ce(),be.current=s,await ee())}finally{ye.current=!1}}};B.current=T,ce(),w(`open`),T(`open`);let D=null,O=null,ne=()=>{Z&&(b.current||(D!=null&&window.clearInterval(D),D=window.setInterval(()=>{document.visibilityState===`visible`&&k()&&w(`pulse`)},ke)))},se=()=>{Z&&(b.current||(O!=null&&window.clearInterval(O),O=window.setInterval(()=>{document.visibilityState===`visible`&&k()&&T(`pulse`)},Ae)))},A=()=>{ne(),se()};A();let pe=()=>{document.visibilityState===`visible`&&(A(),w(`visible`),T(`visible`))};document.addEventListener(`visibilitychange`,pe);let P=()=>{A(),w(`focus`),T(`focus`)},F=()=>{A(),w(`online`),T(`online`)};return window.addEventListener(`focus`,P),window.addEventListener(`online`,F),()=>{window.__SIGIL__&&(window.__SIGIL__.registerSigilUrl=t,window.__SIGIL__.registerSend=r),window.removeEventListener(`sigil:url-registered`,o),window.removeEventListener(`sigil:minted`,c),window.removeEventListener(`storage`,p),window.removeEventListener(le,m),h?.removeEventListener(`message`,g),h?.close(),window.removeEventListener(`pagehide`,x),window.removeEventListener(`focus`,P),window.removeEventListener(`online`,F),document.removeEventListener(`visibilitychange`,pe),d?.removeEventListener(`message`,f),d?.close(),typeof S==`function`&&S(),M.current!=null&&window.clearTimeout(M.current),M.current=null,D!=null&&window.clearInterval(D),D=null,O!=null&&window.clearInterval(O),O=null,C.abort(),B.current=null,b.current=!0}},[W,V,U,G]);let J=(0,I.useCallback)(e=>{let t=B.current;t&&t(e)},[]);(0,I.useEffect)(()=>{if(!Z)return;let e=()=>J(`visible`);return window.addEventListener(Se,e),()=>window.removeEventListener(Se,e)},[J]);let Y=(0,I.useMemo)(()=>xe(P),[t]),De=(0,I.useMemo)(()=>se(),[c]),Ne=(0,I.useMemo)(()=>{let e=0;for(let[,]of P)e+=1;return e},[t]),Ie=(0,I.useMemo)(()=>{let e=new Map,t=new Map;for(let[n,r]of P){let i=typeof r.pulse==`number`?r.pulse:void 0;if(i==null)continue;let a=w(u(n),r),o=t.get(i);if(o||(o=new Set,t.set(i,o)),o.has(a))continue;o.add(a);let s=g(r);s!==void 0&&e.set(i,(e.get(i)??0)+s)}return e},[t]),Le=(0,I.useMemo)(()=>{let e=[];for(let[t]of P){let n=u(F(t));e.includes(n)||e.push(n)}return e},[t]);(0,I.useEffect)(()=>{if(!Z||Le.length===0)return;let e=Le.filter(e=>!S.current.has(e));if(e.length===0)return;let t=!1,n=async()=>{for(let n of e){if(t)break;S.current.add(n),await He(n)}},r=window,i=null;if(typeof r.requestIdleCallback==`function`){let e=r.requestIdleCallback(()=>void n(),{timeout:1e3});i=()=>r.cancelIdleCallback?.(e)}else{let e=window.setTimeout(()=>void n(),120);i=()=>window.clearTimeout(e)}return()=>{t=!0,i?.()}},[Le]);let ze=(0,I.useCallback)(async()=>{if(!Z||E.current||!k()||$()<j.current)return;let e=[],t=n=>{if(n.urls.length>1){let t=x(n.url),r=[...n.urls].map(e=>u(s(e))).filter((e,t,n)=>n.indexOf(e)===t).sort((e,n)=>f(n,t)-f(e,t));for(let t of r.slice(0,2)){let n=u(t);!D.has(n)&&!e.includes(n)&&e.push(n)}}n.children.forEach(t)};for(let e of Y)t(e);if(e.length!==0)for(let t of e.slice(0,Oe)){let e=await d(t);e===`ok`&&O(t,1),e===`bad`&&O(t,-1)}},[Y]);(0,I.useEffect)(()=>{if(!Z)return;let e=!1,t=()=>{e||ze()},n=window,r=null;if(typeof n.requestIdleCallback==`function`){let e=n.requestIdleCallback(t,{timeout:900});r=()=>n.cancelIdleCallback?.(e)}else{let e=window.setTimeout(t,250);r=()=>window.clearTimeout(e)}return()=>{e=!0,r?.()}},[t,ze]);let Be=(0,I.useCallback)(e=>{V(Te),N(e,{includeAncestry:!0,broadcast:!0,persist:!0,source:`local`,enqueueToApi:!0})&&(G(s(e)),W())},[W,V,G]),Ve=(0,I.useCallback)(async e=>{V(0);let t=await e.text(),n;try{n=await Re(t)}catch{return}let{urls:r,rawKrystals:i}=C(n);if(r.length===0&&i.length===0)return;let a=!1;for(let e=0;e<i.length;e+=Q){for(let t of i.slice(e,e+Q))pe(t);e+Q<i.length&&await Pe()}for(let e=0;e<r.length;e+=Q){for(let t of r.slice(e,e+Q))N(t,{includeAncestry:!0,broadcast:!0,persist:!0,source:`import`,enqueueToApi:!0})&&(a=!0);a&&(G(void 0),W()),e+Q<r.length&&await Pe()}r.length>0&&o(r),a&&(G(void 0),W()),J(`import`)},[W,V,J,G]),Ue=(0,I.useCallback)(()=>{V(Te);let e=[];for(let[t]of P)e.push(t);let t=new Blob([JSON.stringify({urls:e},null,2)],{type:`application/json`}),n=document.createElement(`a`);n.href=URL.createObjectURL(t),n.download=`sigil-registry-${Date.now()}.json`,n.click(),URL.revokeObjectURL(n.href)},[V]);return(0,X.jsxs)(`div`,{className:`sigil-explorer`,"aria-label":`Kairos Keystream Explorer`,children:[(0,X.jsx)(Ke,{onAdd:Be,onImport:Ve,onExport:Ue,total:Ne,lastAdded:p}),(0,X.jsx)(`div`,{className:`explorer-scroll`,ref:T,role:`region`,"aria-label":`Explorer scroll viewport`,children:(0,X.jsxs)(`div`,{className:`explorer-inner`,children:[Y.length===0?(0,X.jsxs)(`div`,{className:`kx-empty`,children:[(0,X.jsx)(`p`,{children:`No sigil-glyphs in your keystream yet.`}),(0,X.jsxs)(`ol`,{children:[(0,X.jsx)(`li`,{children:`Import your keystream memories.`}),(0,X.jsx)(`li`,{children:`Seal a moment — auto-registered here.`}),(0,X.jsx)(`li`,{children:`Inhale any sigil-glyph or memory key above — lineage aligns instantly.`})]})]}):(0,X.jsx)(`div`,{className:`forest`,"aria-label":`Sigil forest`,children:Y.map(e=>(0,X.jsx)(Ge,{root:e,expanded:ge,toggle:ve,phiTotalsByPulse:Ie,usernameClaims:h,transferRegistry:De},e.id))}),(0,X.jsx)(`footer`,{className:`kx-footer`,"aria-label":`Explorer footer`,children:(0,X.jsxs)(`span`,{className:`row`,children:[(0,X.jsx)(`span`,{children:`Determinate • Stateless • Kairos-Memory`}),(0,X.jsx)(`span`,{className:`dot`,children:`•`}),(0,X.jsx)(`span`,{children:k()?`online`:`offline`}),(0,X.jsx)(`span`,{className:`dot`,children:`•`}),(0,X.jsxs)(`span`,{children:[Ne,` keys`]})]})})]})})]})};export{qe as default};