import{Cr as e,Y as t,Z as n,_r as r,a as i,ut as a}from"./index-C6RwhGKF.js";import{n as o}from"./SigilAuthContext-DNKPUlS0.js";var s=e(r(),1),c=e(a(),1);function l(e){return typeof e==`string`?e.toLowerCase():``}function u(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function d(e){return typeof e==`string`&&e.length>0}function f(e){return typeof e==`number`&&Number.isFinite(e)}function p(e){if(typeof e!=`string`||!e)return!1;try{let t=new URL(e);return t.protocol===`https:`||t.protocol===`http:`}catch{return!1}}function m(e){if(typeof e!=`object`||!e)throw Error(`Malformed sigil metadata.`);let t=e;for(let e of[`pulse`,`beat`,`stepIndex`,`chakraDay`])if(!u(t,e))throw Error(`Missing Kai field: ${e}`);if(!u(t,`kaiSignature`))throw Error(`Invalid Kai Signature — tampered or unsigned sigil.`);if(!f(t.pulse))throw Error(`Invalid field: pulse`);if(!f(t.beat))throw Error(`Invalid field: beat`);if(!f(t.stepIndex))throw Error(`Invalid field: stepIndex`);if(!d(t.chakraDay))throw Error(`Invalid field: chakraDay`);if(!d(t.kaiSignature))throw Error(`Invalid field: kaiSignature`)}function h(e){try{let t=new DOMParser().parseFromString(e,`image/svg+xml`),n=Array.from(t.getElementsByTagName(`metadata`)),r=[`valuation`,`ledger`,`dht`,`source`];for(let e of n){let t=e.getAttribute(`id`)??``;if(r.some(e=>t.includes(e)))continue;let n=(e.textContent??``).trim();if(!n)continue;let i=n.replace(/^<!\[CDATA\[/,``).replace(/\]\]>$/,``);try{let e=JSON.parse(i);if(typeof e==`object`&&e&&u(e,`pulse`)&&u(e,`beat`)&&u(e,`stepIndex`)&&u(e,`chakraDay`)&&u(e,`kaiSignature`))return e}catch{}}return null}catch{return null}}function g(e,t){let n=[`sigilActionUrl`,`sigilUrl`,`actionUrl`,`url`,`claimedUrl`,`loginUrl`,`sourceUrl`,`originUrl`,`link`,`href`];if(t)for(let e of n){let n=t[e];if(p(n))return n}try{let t=new DOMParser().parseFromString(e,`image/svg+xml`);for(let e of Array.from(t.getElementsByTagName(`metadata`))){let t=(e.textContent??``).trim();if(!t)continue;let r=t.replace(/^<!\[CDATA\[/,``).replace(/\]\]>$/,``);try{let e=JSON.parse(r);if(typeof e==`object`&&e){let t=e;for(let e of n){let n=t[e];if(p(n))return n}}}catch{let e=r.match(/https?:\/\/[^\s"'<>)#]+/i);if(e&&p(e[0]))return e[0]}}for(let e of Array.from(t.getElementsByTagName(`a`))){let t=e.getAttribute(`href`)||e.getAttribute(`xlink:href`);if(p(t))return t}}catch{}return null}function _(){return(0,c.jsxs)(`svg`,{className:`kai-orb-svg`,viewBox:`0 0 88 88`,role:`img`,"aria-label":`Kai Orb`,children:[(0,c.jsx)(`defs`,{children:(0,c.jsxs)(`radialGradient`,{id:`orbGlow`,cx:`50%`,cy:`50%`,r:`50%`,children:[(0,c.jsx)(`stop`,{offset:`0%`,stopColor:`#ffffff`,stopOpacity:`1`}),(0,c.jsx)(`stop`,{offset:`55%`,stopColor:`#00ffd0`,stopOpacity:`1`}),(0,c.jsx)(`stop`,{offset:`100%`,stopColor:`#00ffd0`,stopOpacity:`0`})]})}),(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`41`,fill:`none`,stroke:`#00ffd0`,strokeOpacity:`0.38`,strokeWidth:`1.6`}),(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`32`,fill:`none`,stroke:`#8a2be2`,strokeOpacity:`0.45`,strokeWidth:`1.4`}),(0,c.jsxs)(`g`,{opacity:`0.45`,children:[(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`20`,fill:`none`,stroke:`rgba(255,255,255,.3)`,strokeWidth:`.8`}),(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`10`,fill:`none`,stroke:`rgba(255,255,255,.25)`,strokeWidth:`.7`}),(0,c.jsx)(`line`,{x1:`44`,y1:`4`,x2:`44`,y2:`84`,stroke:`rgba(255,255,255,.2)`,strokeWidth:`.8`}),(0,c.jsx)(`line`,{x1:`4`,y1:`44`,x2:`84`,y2:`44`,stroke:`rgba(255,255,255,.2)`,strokeWidth:`.8`})]}),(0,c.jsx)(`circle`,{cx:`44`,cy:`44`,r:`10`,fill:`url(#orbGlow)`}),(0,c.jsx)(`path`,{d:`M44 14 L72 68 H16 Z`,fill:`none`,stroke:`#00b4ff`,strokeOpacity:`0.35`,strokeWidth:`1.2`})]})}function v({onVerified:e}){let r=(0,s.useRef)(null),[a,d]=(0,s.useState)(null),[f,p]=(0,s.useState)(!1),[v,y]=(0,s.useState)(!1),[b,x]=(0,s.useState)(null),{setAuth:S}=o(),C=(0,s.useCallback)(async a=>{p(!0),d(null),x(null);try{if(a.type!==`image/svg+xml`&&!a.name.endsWith(`.svg`))throw Error(`Please upload an SVG sigil file.`);let r=await a.text(),{meta:o,contextOk:s,typeOk:c}=await i(a),d=o&&u(o,`kaiSignature`)&&u(o,`pulse`)?o:h(r);if(!d||!s||!c)throw Error(`Malformed or unrecognized sigil structure.`);m(d);let f=d,p=await t(f);if(!p||l(p)!==l(f.kaiSignature))throw Error(`Invalid Kai Signature — tampered or unsigned sigil.`);let _=await n(f.kaiSignature);if(typeof f.userPhiKey==`string`){if(l(_)!==l(f.userPhiKey))throw Error(`Φ-Key mismatch — identity invalid.`)}else f.userPhiKey=_;let v=g(r,f)??void 0;S(r,{pulse:f.pulse,beat:f.beat,stepIndex:f.stepIndex,chakraDay:f.chakraDay,kaiSignature:f.kaiSignature,userPhiKey:f.userPhiKey,...typeof f.sigilId==`string`?{sigilId:f.sigilId}:{},...v?{sigilActionUrl:v}:{}}),x(f),e(r,f)}catch(e){d(e instanceof Error?e.message:`Invalid sigil file. Ensure it’s a Kai-sealed SVG with embedded JSON <metadata>.`)}finally{p(!1),r.current&&(r.current.value=``)}},[e,S]),w=async e=>{let t=e.target.files?.[0];t&&await C(t)};return(0,c.jsx)(`div`,{className:`sigil-login-only w-full max-w-xl mx-auto`,children:(0,c.jsxs)(`div`,{onDrop:async e=>{e.preventDefault(),e.stopPropagation(),y(!1);let t=e.dataTransfer.files?.[0];t&&await C(t)},onDragOver:e=>{e.preventDefault(),e.stopPropagation(),y(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),y(!1)},onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),r.current?.click())},className:[`sigil-dropzone`,v?`sigil-dropzone--over`:``,f?`sigil-dropzone--loading`:``,b?`sigil-dropzone--ok`:``,a?`sigil-dropzone--err`:``].join(` `),role:`button`,tabIndex:0,title:`Drag & drop your Kai-sealed SVG here, or tap to browse`,"aria-label":`inhale or drop your Kai-sealed SVG sigil`,"aria-describedby":`sigil-instructions sigil-trustline`,onClick:()=>r.current?.click(),children:[(0,c.jsx)(`div`,{className:`sigil-grid`,"aria-hidden":!0}),(0,c.jsx)(`div`,{className:`sigil-ring sigil-ring--outer`,"aria-hidden":!0}),(0,c.jsx)(`div`,{className:`sigil-ring sigil-ring--inner`,"aria-hidden":!0}),(0,c.jsxs)(`div`,{className:`sigil-center`,children:[(0,c.jsx)(`div`,{className:`sigil-orb`,"aria-hidden":!0,children:(0,c.jsx)(_,{})}),(0,c.jsxs)(`p`,{id:`sigil-instructions`,className:`sigil-instructions`,children:[`Inhale, `,(0,c.jsx)(`span`,{className:`sigil-accent`,children:`Φkey here.`})]}),(0,c.jsxs)(`div`,{className:`sigil-status`,"aria-live":`polite`,children:[f&&(0,c.jsxs)(`div`,{className:`sigil-status__row`,children:[(0,c.jsx)(`span`,{className:`sigil-spinner`}),(0,c.jsx)(`span`,{children:`Verifying signature & deriving Φ-Key…`})]}),!f&&b&&(0,c.jsxs)(`div`,{className:`sigil-status__ok`,children:[(0,c.jsx)(`span`,{className:`ok-dot`}),(0,c.jsx)(`span`,{children:`Verified — Φ-Key bound`})]}),!f&&a&&(0,c.jsx)(`div`,{className:`sigil-status__err`,children:a})]})]}),(0,c.jsx)(`input`,{ref:r,type:`file`,accept:`.svg,image/svg+xml`,onChange:w,className:`sigil-file-input`,tabIndex:-1,"aria-hidden":`true`})]})})}const y=[`Solhara`,`Aquaris`,`Flamora`,`Verdari`,`Sonari`,`Kaelith`],b={Solhara:`Root`,Aquaris:`Sacral`,Flamora:`Solar Plexus`,Verdari:`Heart`,Sonari:`Throat`,Kaelith:`Krown`},x=[`Aethon`,`Virelai`,`Solari`,`Amarin`,`Kaelus`,`Umbriel`,`Noktura`,`Liora`],S=[`Awakening Flame`,`Flowing Heart`,`Radiant Will`,`Harmonic Voh`,`Inner Mirror`,`Dreamfire Memory`,`Krowned Light`];function C(e){return String(e).padStart(2,`0`)}function w(e,t){let n=e%t;return n<0n?n+(t<0n?-t:t):n}function T(e,t){let n=e/t,r=e%t;return r!==0n&&r>0n!=t>0n?n-1n:n}function E(e){if(!Number.isFinite(e))return 0n;let t=e<0?-1:1,n=Math.abs(e),r=Math.trunc(n),i=n-r;return i<.5?BigInt(t*r):i>.5?BigInt(t*(r+1)):BigInt(t*(r%2==0?r:r+1))}function D(e,t){try{let n=t instanceof Error?t.message:String(t);console.warn(`[SigilStream:${e}] ${n}`)}catch{}}function O(e){return typeof e==`object`&&!!e}function k(e){try{let t=new URL(e);return t.protocol===`https:`||t.protocol===`http:`}catch{return!1}}function A(e,t){if(!O(e))return;let n=e[t];if(typeof n==`string`)return n;let r=e.meta;if(O(r)){let e=r[t];if(typeof e==`string`)return e}}function j(e){let t=e;if(O(t)&&`auth`in t&&(t=t.auth),O(t)){let e=t.meta,n=t.svgText;return{meta:O(e)?e:null,svgText:typeof n==`string`?n:null}}return{meta:null,svgText:null}}const M=Date.UTC(2024,4,10,6,45,41,888),N=3+Math.sqrt(5),P=N*1e3,F=1000000n,I=17491270421n;(I+18n)/36n;var L=36n,R=BigInt(44);function z(e,t,n){return Math.min(Math.max(e,t),n)}function B(e){return Number(e*L/I)}function V(e){let t=BigInt(e),n=t*I/L,r=(t+1n)*I/L;return{beatStart:n,beatEnd:r,beatLen:r-n}}function H(e,t){return t>0n?Number(e*R/t):0}function U(e,t){let n=BigInt(e),r=n*t/R,i=(n+1n)*t/R;return{stepStart:r,stepEnd:i,stepLen:i-r}}function W(e){return E((e.getTime()-M)/1e3/N*1e6)}function G(e){let t=W(e),n=w(t,I),r=T(t,I),i=z(B(n),0,35),{beatStart:a,beatLen:o}=V(i),s=n-a,c=z(H(s,o),0,43),{stepStart:l,stepLen:u}=U(c,o),d=s-l,f=u>0n?Number(d)/Number(u):0,p=Number(T(t,F)),m=Number(s/F),h=Number(n/F),g=y[Number(w(r,BigInt(6)))],_=b[g],v=Number(r),E=(v%42+42)%42+1,D=(Math.floor(v/42)%8+8)%8,O=D+1,k=x[D],A=Math.floor(v/336),j=Math.floor((E-1)/6),M=S[j];return{pulse:p,beat:i,step:c,stepPct:f,pulsesIntoBeat:m,pulsesIntoDay:h,harmonicDay:g,chakraDay:_,chakraStepString:`${i}:${C(c)}`,dayOfMonth:E,monthIndex0:D,monthIndex1:O,monthName:k,yearIndex:A,weekIndex:j,weekName:M,_pμ_in_day:n,_pμ_in_beat:s}}function K(e){let[t,n]=(0,s.useState)(e?N:null),r=(0,s.useRef)(null),i=(0,s.useRef)(null),a=()=>{let e=Date.now();i.current=M+Math.ceil((e-M)/P)*P};return(0,s.useEffect)(()=>{if(!e){r.current!=null&&window.cancelAnimationFrame(r.current),r.current=null,i.current=null,n(null);return}a();let t=()=>{let e=i.current;if(e==null)n(null);else{let t=Date.now();t>=e?(a(),n(0)):n((e-t)/1e3)}r.current=window.requestAnimationFrame(t)};r.current=window.requestAnimationFrame(t);let o=()=>{document.visibilityState===`visible`&&a()};return document.addEventListener(`visibilitychange`,o),()=>{r.current!=null&&window.cancelAnimationFrame(r.current),r.current=null,document.removeEventListener(`visibilitychange`,o)}},[e]),t}function q(){let[e,t]=(0,s.useState)(()=>G(new Date)),n=(0,s.useRef)(null),r=()=>{if(typeof document>`u`)return;let e=document.documentElement,t=(P-(Date.now()-M)%P)%P;e.style.setProperty(`--pulse-dur`,`${P}ms`),e.style.setProperty(`--pulse-offset`,`-${Math.round(t)}ms`)},i=()=>{n.current&&window.clearTimeout(n.current);let e=Date.now(),a=e-M,o=M+Math.ceil(a/P)*P,s=Math.max(0,o-e);r(),n.current=window.setTimeout(()=>{t(G(new Date)),i()},s)};return(0,s.useEffect)(()=>{i();let e=()=>{document.visibilityState===`visible`&&(t(G(new Date)),i())};return document.addEventListener(`visibilitychange`,e),()=>{n.current&&window.clearTimeout(n.current),n.current=null,document.removeEventListener(`visibilitychange`,e)}},[]),e}export{O as a,A as c,j as i,D as l,K as n,k as o,G as r,C as s,q as t,v as u};