import{_ as e,a as t,b as n,v as r,y as i}from"./index-BcTFNoUi.js";var a=`kai:kas1:passkey:`;function o(){return typeof window<`u`&&typeof navigator<`u`&&typeof PublicKeyCredential<`u`&&typeof navigator.credentials?.create==`function`&&typeof navigator.credentials?.get==`function`}async function s(){try{if(!navigator.storage?.persist||await navigator.storage.persisted?.())return;await navigator.storage.persist()}catch{}}function c(e){if(typeof window>`u`)return null;let t=window.localStorage.getItem(`${a}${e}`);if(!t)return null;try{let e=JSON.parse(t);if(!e||typeof e!=`object`)return null;let n=e;return typeof n.credId!=`string`||!n.pubKeyJwk||typeof n.pubKeyJwk!=`object`?null:{credId:n.credId,pubKeyJwk:n.pubKeyJwk}}catch(e){throw Error(`Failed to read passkey cache: ${e instanceof Error?e.message:String(e)}`)}}function l(e,t){typeof window>`u`||window.localStorage.setItem(`${a}${e}`,JSON.stringify(t))}function u(e){typeof window>`u`||window.localStorage.removeItem(`${a}${e}`)}function d(e){if(e.length<37)throw Error(`AuthData too short to contain attested credential data.`);let t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(!(e[32]&64))throw Error(`Attestation missing credential data (AT flag not set).`);let n=37;if(n+=16,n+2>e.length)throw Error(`AuthData missing credentialId length.`);let r=t.getUint16(n,!1);if(n+=2,n+r>e.length)throw Error(`AuthData credentialId length out of bounds.`);let i=e.slice(n,n+r);n+=r;let a=e.slice(n);if(a.length===0)throw Error(`Credential public key missing from attestation data.`);return{credentialId:i,credentialPublicKey:a}}function f(e,t){if(e instanceof Map)return e.get(t);if(typeof e==`object`&&e){let n=e;return n[t]??n[String(t)]}}function p(e){if(e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer||Array.isArray(e))return new Uint8Array(e);throw Error(`Invalid COSE coordinate data.`)}function m(e){let t=p(f(e,-2)),n=p(f(e,-3));return{kty:`EC`,crv:`P-256`,x:r(t),y:r(n),ext:!0}}function h(e){let t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(e),t}function g(e,t){let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}function _(e,t){if(e.length<8||e[0]!==48||e[1]+2!==e.length)return null;let n=2;if(e[n]!==2)return null;let r=e[n+1];n+=2;let i=e.slice(n,n+r);if(n+=r,e[n]!==2)return null;let a=e[n+1];n+=2;let o=e.slice(n,n+a),s=i[0]===0?i.slice(1):i,c=o[0]===0?o.slice(1):o;if(s.length>t||c.length>t)return null;let l=new Uint8Array(t*2);return l.set(s,t-s.length),l.set(c,t*2-c.length),l}async function v(e){return crypto.subtle.importKey(`jwk`,e,{name:`ECDSA`,namedCurve:`P-256`},!1,[`verify`])}function y(e){let t=e instanceof Map?e.get(`authData`):typeof e==`object`&&e?e.authData:void 0;if(!t)throw Error(`Attestation missing authData.`);if(t instanceof Uint8Array)return t;if(t instanceof ArrayBuffer||Array.isArray(t))return new Uint8Array(t);throw Error(`Attestation authData is not a byte array.`)}async function b(e){if(!o())throw Error(`WebAuthn is not available in this browser.`);await s();let i=c(e);if(i)return i;let a=(await n(`KAS-1|phiKey|${e}`)).slice(0,16),u=crypto.getRandomValues(new Uint8Array(32)),f=await navigator.credentials.create({publicKey:{challenge:u,rp:{name:`Kai-Voh`,id:window.location.hostname},user:{id:a,name:e,displayName:e},pubKeyCredParams:[{type:`public-key`,alg:-7}],authenticatorSelection:{userVerification:`required`,residentKey:`required`,requireResidentKey:!0},timeout:6e4,attestation:`none`}})??null;if(!f)throw Error(`Passkey creation was canceled or failed.`);let p=f.response,h=m(t(d(y(t(new Uint8Array(p.attestationObject)))).credentialPublicKey)),g={credId:r(new Uint8Array(f.rawId)),pubKeyJwk:h};return l(e,g),g}async function x(t,n){if(!o())throw Error(`WebAuthn is not available in this browser.`);let a=await b(t),s=i(n),c=s.slice(),l=async t=>{let n=h(e(t.credId)),i=await navigator.credentials.get({publicKey:{challenge:c,allowCredentials:[{id:n,type:`public-key`}],userVerification:`required`}})??null;if(!i)throw Error(`Signature request was canceled or failed.`);let a=i.response;return{v:`KAS-1`,alg:`webauthn-es256`,credId:t.credId,pubKeyJwk:t.pubKeyJwk,challenge:r(s),signature:r(new Uint8Array(a.signature)),authenticatorData:r(new Uint8Array(a.authenticatorData)),clientDataJSON:r(new Uint8Array(a.clientDataJSON))}};try{return await l(a)}catch(e){let n=e instanceof DOMException?e.name:``;if(n===`NotAllowedError`||n===`NotFoundError`||n===`InvalidStateError`)return u(t),await l(await b(t));throw e}}async function S(t,a){try{let o=r(i(t));if(a.challenge!==o)return!1;let s=e(a.clientDataJSON),c=new TextDecoder().decode(s),l=JSON.parse(c);if(!l||typeof l!=`object`)return!1;let u=l;if(typeof u.challenge!=`string`||u.challenge!==o)return!1;let d=g(e(a.authenticatorData),await n(s)),f=e(a.signature),p=await v(a.pubKeyJwk);if(await crypto.subtle.verify({name:`ECDSA`,hash:`SHA-256`},p,h(f),h(d)))return!0;let m=_(f,32);return m?crypto.subtle.verify({name:`ECDSA`,hash:`SHA-256`},p,h(m),h(d)):!1}catch{return!1}}function C(){return o()}export{S as i,C as n,x as r,b as t};